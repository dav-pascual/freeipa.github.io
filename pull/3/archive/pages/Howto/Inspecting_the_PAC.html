<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Inspecting the PAC &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Create a System Account" href="Integrating_Dell_EMC_Isilon_OneFS.html" />
    <link rel="prev" title="&lt;no title&gt;" href="ISC_DHCPd_and_Dynamic_DNS_update.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="inspecting-the-pac">
<span id="id1"></span><h1>Inspecting the PAC<a class="headerlink" href="#inspecting-the-pac" title="Permalink to this heading">¶</a></h1>
<p>The <a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc237917.aspx">PAC</a> is a
part of a <a class="reference external" href="Kerberos">Kerberos</a> ticket, the so called <a class="reference external" href="https://tools.ietf.org/html/rfc4120#section-5.2.6">Authorization
Data</a>. For more
details see:</p>
<ul class="simple">
<li><p>RFC 4120: The Kerberos Network Authentication Service (V5)
` &lt;<a class="reference external" href="https://tools.ietf.org/html/rfc4120">https://tools.ietf.org/html/rfc4120</a>&gt;`__<a class="reference external" href="https://tools.ietf.org/html/rfc4120">https://tools.ietf.org/html/rfc4120</a></p></li>
<li><p>Micosoft Technical Document [MS-PAC]: Privilege Attribute Certificate
Data Structure
` &lt;<a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc237917.aspx">http://msdn.microsoft.com/en-us/library/cc237917.aspx</a>&gt;`__<a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc237917.aspx">http://msdn.microsoft.com/en-us/library/cc237917.aspx</a></p></li>
<li><p>Microsoft Technical Document [MS-KILE]: Kerberos Protocol Extensions
` &lt;<a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc233855.aspx">http://msdn.microsoft.com/en-us/library/cc233855.aspx</a>&gt;`__<a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc233855.aspx">http://msdn.microsoft.com/en-us/library/cc233855.aspx</a></p></li>
</ul>
<p>In general the PAC is processed by applications like
<a class="reference external" href="http://www.samba.org">Samba</a> or
<a class="reference external" href="https://fedorahosted.org/sssd/">SSSD</a> to retrieve information about
the authenticated user and e.g. assign access rights or group
memberships. Since the PAC is buried NDR encoded inside the encrypted
part of the Kerberos ticket it is not easy for a user to access it and
inspect the content.</p>
<p>Luckily there is a largely unknown tool in the Samba treasure chest
called <strong>net ads kerberos pac</strong>. It was originally developed with only
the Samba use case in mind because at that time there was only Samba
using the PAC.</p>
<section id="ad-client">
<span id="id2"></span><h2>AD client<a class="headerlink" href="#ad-client" title="Permalink to this heading">¶</a></h2>
<p>By default <strong>net ads kerberos pac</strong> tries to get a Kerberos service
ticket for the local host (<a class="reference external" href="mailto:HOSTNAME$&#37;&#52;&#48;AD&#46;DOMAIN">HOSTNAME$<span>&#64;</span>AD<span>&#46;</span>DOMAIN</a>) for an AD user given by
<em>-U username</em>. The keys needed to encrypt the PAC are the Kerberos host
keys which means that the user calling <strong>net ads kerberos pac</strong>. must
have access to the host keytab. Typically this is only the <em>root</em> user.</p>
<p>If the Linux client is joined to the AD domain with Samba/Winbind you
can call:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># net ads kerberos pac dump -U tu1</span>
<span class="n">Enter</span> <span class="n">tu1</span><span class="s1">&#39;s password:</span>
<span class="n">The</span> <span class="n">Pac</span><span class="p">:</span>     <span class="n">info</span><span class="p">:</span> <span class="n">struct</span> <span class="n">PAC_LOGON_INFO</span>
        <span class="n">info3</span><span class="p">:</span> <span class="n">struct</span> <span class="n">netr_SamInfo3</span>
            <span class="n">base</span><span class="p">:</span> <span class="n">struct</span> <span class="n">netr_SamBaseInfo</span>
<span class="o">.....</span>
</pre></div>
</div>
<p>If SSSD is used to connect to the AD domain and no Samba configuration
file <em>smb.conf</em> is available you have to give two addition options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># net ads kerberos pac dump --option=&#39;realm = AD.DOMAIN&#39; --option=&#39;kerberos method = system keytab&#39; -U tu1</span>
<span class="n">Enter</span> <span class="n">tu1</span><span class="s1">&#39;s password:</span>
<span class="n">The</span> <span class="n">Pac</span><span class="p">:</span>     <span class="n">info</span><span class="p">:</span> <span class="n">struct</span> <span class="n">PAC_LOGON_INFO</span>
        <span class="n">info3</span><span class="p">:</span> <span class="n">struct</span> <span class="n">netr_SamInfo3</span>
            <span class="n">base</span><span class="p">:</span> <span class="n">struct</span> <span class="n">netr_SamBaseInfo</span>
</pre></div>
</div>
<p>The restriction to the hardcoded service name (<a class="reference external" href="mailto:HOSTNAME$&#37;&#52;&#48;AD&#46;DOMAIN">HOSTNAME$<span>&#64;</span>AD<span>&#46;</span>DOMAIN</a>) made
it hard to use this tool in other environments. But recently Samba Team
member Günther Deschner enhanced the tool and opened it for other use
cases.</p>
</section>
<section id="freeipa-client">
<span id="id3"></span><h2>FreeIPA client<a class="headerlink" href="#freeipa-client" title="Permalink to this heading">¶</a></h2>
<p>A client enrolled to a FreeIPA server has a host keytab as well but the
AD-style <a class="reference external" href="mailto:HOSTNAME$&#37;&#52;&#48;KRB&#46;REALM">HOSTNAME$<span>&#64;</span>KRB<span>&#46;</span>REALM</a> host principals are not available. With the
recent enhancements to <strong>net ads kerberos pac</strong> an alternative service
principal can be given which makes it possible to use it with FreeIPA as
well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Usage</span><span class="p">:</span>
<span class="n">net</span> <span class="n">ads</span> <span class="n">kerberos</span> <span class="n">pac</span> <span class="n">dump</span> <span class="p">[</span><span class="n">impersonate</span><span class="o">=</span><span class="n">string</span><span class="p">]</span> <span class="p">[</span><span class="n">local_service</span><span class="o">=</span><span class="n">string</span><span class="p">]</span> <span class="p">[</span><span class="n">pac_buffer_type</span><span class="o">=</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">Dump</span> <span class="n">the</span> <span class="n">Kerberos</span> <span class="n">PAC</span>
</pre></div>
</div>
<p>You can call</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="n">ads</span> <span class="n">kerberos</span> <span class="n">pac</span> <span class="n">dump</span> <span class="o">--</span><span class="n">option</span><span class="o">=</span><span class="s1">&#39;realm = IPA.DOMAIN&#39;</span> <span class="o">--</span><span class="n">option</span><span class="o">=</span><span class="s1">&#39;kerberos method = system keytab&#39;</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="n">local_service</span><span class="o">=</span><span class="n">host</span><span class="o">/</span><span class="n">ipa</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">domain</span><span class="nd">@IPA</span><span class="o">.</span><span class="n">DOMAIN</span> <span class="o">-</span><span class="n">U</span> <span class="n">ipa_user</span>
<span class="n">Enter</span> <span class="n">ipa_user</span><span class="s1">&#39;s password:</span>
<span class="n">The</span> <span class="n">Pac</span><span class="p">:</span>     <span class="n">pac_data_ctr</span><span class="o">-&gt;</span><span class="n">pac_data</span><span class="p">:</span> <span class="n">struct</span> <span class="n">PAC_DATA</span>
        <span class="n">num_buffers</span>              <span class="p">:</span> <span class="mh">0x00000004</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">version</span>                  <span class="p">:</span> <span class="mh">0x00000000</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">buffers</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">buffers</span><span class="p">:</span> <span class="n">struct</span> <span class="n">PAC_BUFFER</span>
                <span class="nb">type</span>                     <span class="p">:</span> <span class="n">PAC_TYPE_LOGON_INFO</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">_ndr_size</span>                <span class="p">:</span> <span class="mh">0x000001c8</span> <span class="p">(</span><span class="mi">456</span><span class="p">)</span>
                <span class="n">info</span>                     <span class="p">:</span> <span class="o">*</span>
                    <span class="n">info</span>                     <span class="p">:</span> <span class="n">union</span> <span class="n">PAC_INFO</span><span class="p">(</span><span class="n">case</span> <span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>This is basically the same scheme as for the SSSD AD client example
above with the exception of the <em>-s /dev/null</em> option. You can drop this
option if there is no Samba configuration on your system, e.g. on a
typical FreeIPA client. However, on FreeIPA server with
<a class="reference external" href="Trusts">Trusts</a> configured <em>ipa-adtrust-install</em> creates a Samba
configuration which might have unexpected side effects and <em>-s
/dev/null</em> will start <strong>net ads kerberos pac</strong> with an empty Samba
configuration.</p>
<p>As you can see the new version not only prints LOGON_INFO buffer but all
buffers and tries to decode as much as possible. The new version also
provides additionally to the <em>dump</em> option a <em>save</em> option. This is
useful if you need a real PAC blob to test PAC processing in unit tests.
If you have to decode the binary PAC later you can use the <strong>ndrdump</strong>
utility form the samba-test package</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ndrdump krb5pac decode_pac in /tmp/pac.bla</span>
<span class="n">pull</span> <span class="n">returned</span> <span class="n">NT_STATUS_OK</span>
    <span class="n">decode_pac</span><span class="p">:</span> <span class="n">struct</span> <span class="n">decode_pac</span>
        <span class="ow">in</span><span class="p">:</span> <span class="n">struct</span> <span class="n">decode_pac</span>
            <span class="n">pac</span><span class="p">:</span> <span class="n">struct</span> <span class="n">PAC_DATA</span>
                <span class="n">num_buffers</span>              <span class="p">:</span> <span class="mh">0x00000004</span> <span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">version</span>                  <span class="p">:</span> <span class="mh">0x00000000</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">buffers</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">buffers</span><span class="p">:</span> <span class="n">struct</span> <span class="n">PAC_BUFFER</span>
                        <span class="nb">type</span>                     <span class="p">:</span> <span class="n">PAC_TYPE_LOGON_INFO</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">_ndr_size</span>                <span class="p">:</span> <span class="mh">0x000001c8</span> <span class="p">(</span><span class="mi">456</span><span class="p">)</span>
                        <span class="n">info</span>                     <span class="p">:</span> <span class="o">*</span>
                            <span class="n">info</span>                     <span class="p">:</span> <span class="n">union</span> <span class="n">PAC_INFO</span><span class="p">(</span><span class="n">case</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">logon_info</span><span class="p">:</span> <span class="n">struct</span> <span class="n">PAC_LOGON_INFO_CTR</span>
<span class="o">...</span>
</pre></div>
</div>
<p>If you want to use a different Kerberos service where the keys are not
stored in the host keytab you can use the following options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">net</span> <span class="n">ads</span> <span class="n">kerberos</span> <span class="n">pac</span> <span class="n">dump</span> <span class="o">--</span><span class="n">option</span><span class="o">=</span><span class="s1">&#39;realm = IPA.DOMAIN&#39;</span> <span class="o">--</span><span class="n">option</span><span class="o">=</span><span class="s1">&#39;kerberos method = dedicated keytab&#39;</span> <span class="o">--</span><span class="n">option</span><span class="o">=</span><span class="s1">&#39;dedicated keytab file = FILE:/etc/dirsrv/ds.keytab&#39;</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">zero</span> <span class="n">local_service</span><span class="o">=</span><span class="n">ldap</span><span class="o">/</span><span class="n">ipa</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">ipa</span><span class="o">.</span><span class="n">domain</span><span class="nd">@IPA</span><span class="o">.</span><span class="n">DOMAIN</span> <span class="o">-</span><span class="n">U</span> <span class="n">admin</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/Howto/Inspecting_the_PAC.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
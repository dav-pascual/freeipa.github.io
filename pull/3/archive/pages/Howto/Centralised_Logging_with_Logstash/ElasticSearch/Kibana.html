<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Introduction &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="../../Integrating_a_Samba_File_Server_With_IPA/NTMLSSP.html" />
    <link rel="prev" title="Creating a wildcard certificate profile in FreeIPA" href="../../Wildcard_certificates.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h1>
<p>This page covers my personal findings when trying to get FreeIPA logs
sent through to our central log consolidation infrastructure.</p>
</section>
<section id="requirements">
<h1>Requirements<a class="headerlink" href="#requirements" title="Permalink to this heading">¶</a></h1>
<p>These IPA servers are running RHEL 6.6. I have a pair of Logstash
servers to receive and parse logs and a cluster of 5 ElasticSearch
database servers. Kibana is used as the interface to view log data from
the ES cluster.</p>
</section>
<section id="base-log-sending">
<span id="id1"></span><h1>Base Log Sending<a class="headerlink" href="#base-log-sending" title="Permalink to this heading">¶</a></h1>
<p>The basic rsyslog configuration is modified by adding the file
/etc/rsyslog.d/logstash.conf</p>
<p><code class="docutils literal notranslate"><span class="pre">*.* &#64;logserver.example.com:5544</span></code></p>
<p>This will get rsyslog sending everything it receives to logserver via
UDP on port 5544.</p>
</section>
<section id="advanced-log-sending">
<span id="id2"></span><h1>Advanced Log Sending<a class="headerlink" href="#advanced-log-sending" title="Permalink to this heading">¶</a></h1>
<p>Whilst this will work perfectly well for sending basic logs via UDP, for
bonus points I’m actually doing the following on our Dev IPA servers.
These servers have the basic rsyslog package replaced by rsyslog7 which
is rsyslog version 7.4.10. This allows us to do some more complex
logging to assist the central log servers. I create the
/etc/rsyslog.d/logstash.conf file, which looks as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>template(name=&quot;ls_json&quot; type=&quot;list&quot; option.json=&quot;on&quot;)
  { constant(value=&quot;{&quot;)
    constant(value=&quot;\&quot;@timestamp\&quot;:\&quot;&quot;)         property(name=&quot;timegenerated&quot; dateFormat=&quot;rfc3339&quot;)
    constant(value=&quot;\&quot;,\&quot;@version\&quot;:\&quot;1&quot;)
    constant(value=&quot;\&quot;,\&quot;message\&quot;:\&quot;&quot;)         property(name=&quot;msg&quot;)
    constant(value=&quot;\&quot;,\&quot;host\&quot;:\&quot;&quot;)            property(name=&quot;fromhost&quot;)
    constant(value=&quot;\&quot;,\&quot;host_ip\&quot;:\&quot;&quot;)         property(name=&quot;fromhost-ip&quot;)
    constant(value=&quot;\&quot;,\&quot;my_environment\&quot;:\&quot;Development&quot;)
    constant(value=&quot;\&quot;,\&quot;my_project\&quot;:\&quot;IPA&quot;)
    constant(value=&quot;\&quot;,\&quot;my_use\&quot;:\&quot;Auth&quot;)
    constant(value=&quot;\&quot;,\&quot;logsource\&quot;:\&quot;&quot;)       property(name=&quot;fromhost&quot;)
    constant(value=&quot;\&quot;,\&quot;severity_label\&quot;:\&quot;&quot;)  property(name=&quot;syslogseverity-text&quot;)
    constant(value=&quot;\&quot;,\&quot;severity\&quot;:\&quot;&quot;)        property(name=&quot;syslogseverity&quot;)
    constant(value=&quot;\&quot;,\&quot;facility_label\&quot;:\&quot;&quot;)  property(name=&quot;syslogfacility-text&quot;)
    constant(value=&quot;\&quot;,\&quot;facility\&quot;:\&quot;&quot;)        property(name=&quot;syslogfacility&quot;)
    constant(value=&quot;\&quot;,\&quot;program\&quot;:\&quot;&quot;)         property(name=&quot;programname&quot;)
    constant(value=&quot;\&quot;,\&quot;pid\&quot;:\&quot;&quot;)             property(name=&quot;procid&quot;)
    constant(value=&quot;\&quot;,\&quot;rawmsg\&quot;:\&quot;&quot;)          property(name=&quot;rawmsg&quot;)
    constant(value=&quot;\&quot;,\&quot;syslogtag\&quot;:\&quot;&quot;)       property(name=&quot;syslogtag&quot;)
    constant(value=&quot;\&quot;}\n&quot;)
  }

*.* @@logstash01.example.com:5500;ls_json
$ActionExecOnlyWhenPreviousIsSuspended on
&amp; @@logstash02.example.com:5500;ls_json
&amp; /var/log/localbuffer
$ActionExecOnlyWhenPreviousIsSuspended off
</pre></div>
</div>
<p>This lets us send the log in JSON format, whilst adding the extra fields
my_environment, my_project, and my_use. You don’t need these, but they
will help separate out different log types from the log-viewing UI. Our
network has, for example, 2 IPA servers in Development, with a further 8
in Production. These extra fields allow us to pull out only the logs
that match “my_environment=Dev” AND “my_project=IPA”.</p>
<p>The other rsyslog properties that are sent are my current best-guess at
what I need when reviewing the logs through the Kibana UI.</p>
</section>
<section id="getting-dirsrv-logs-sending">
<span id="id3"></span><h1>Getting dirsrv Logs Sending<a class="headerlink" href="#getting-dirsrv-logs-sending" title="Permalink to this heading">¶</a></h1>
<p>The best way I have so far of doing this is to add another file in the
/etc/rsyslog.d directory which configures rsyslog to look at external
log files. /etc/rsyslog.d/dirsrv.conf contains the following:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">module(load=&quot;imfile&quot; PollingInterval=&quot;2&quot;)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">input(type=&quot;imfile&quot;</span></code></div>
<div class="line">``      File=”/var/log/dirsrv/slapd-EXAMPLE-COM/access”``</div>
<div class="line">``      Tag=”dirsrv”``</div>
<div class="line">``      StateFile=”statedirsrv”``</div>
<div class="line">``      Facility=”local0”)``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">input(type=&quot;imfile&quot;</span></code></div>
<div class="line">``      File=”/var/log/dirsrv/slapd-EXAMPLE-COM/errors”``</div>
<div class="line">``      Tag=”dirsrv”``</div>
<div class="line">``      StateFile=”statedirsrverr”``</div>
<div class="line">``      Severity=”error”``</div>
<div class="line">``      Facility=”local0”)``</div>
</div>
<p>This uses the imfile module in rsyslog to monitor changes in the dirsrv
access and errors log files. The log files are polled every 2 seconds
(although I know dirsrv also buffers, so I should change this) and the
new log data is pulled in by rsyslog and then sent on to the Logstash
server(s) via the logstash.conf file above.</p>
</section>
<section id="logstash-configuration">
<span id="id4"></span><h1>Logstash Configuration<a class="headerlink" href="#logstash-configuration" title="Permalink to this heading">¶</a></h1>
<p>Logstash 1.4.2 is installed via RPM and configured to accept log data.
Create file /etc/logstash/conf.d/syslog.conf with the following
contents:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">input {</span></code></div>
<div class="line">``  syslog {``</div>
<div class="line">``    type =&gt; syslog``</div>
<div class="line">``    port =&gt; 5544``</div>
<div class="line">``  }``</div>
<div class="line">``  tcp {``</div>
<div class="line">``    type =&gt; syslogjson``</div>
<div class="line">``    port =&gt; 5500``</div>
<div class="line">``    codec =&gt; “json”``</div>
<div class="line">``  }``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">filter {</span></code></div>
<div class="line">``  # This replaces the host field (UDP source) with the host that generated the message (sysloghost)``</div>
<div class="line">``  if [sysloghost] {``</div>
<div class="line">``    mutate {``</div>
<div class="line">``      replace =&gt; [ “host”, “%{sysloghost}” ]``</div>
<div class="line">``      remove_field =&gt; “sysloghost” # prune the field after successfully replacing “host”``</div>
<div class="line">``    }``</div>
<div class="line">``  }``</div>
<div class="line">``  if [type] == “syslog” {``</div>
<div class="line">``    grok {``</div>
<div class="line">``      patterns_dir =&gt; “/opt/logstash/patterns”``</div>
<div class="line">``      match =&gt; { “message” =&gt; “%{FWGROK}” }``</div>
<div class="line">``      match =&gt; { “message” =&gt; “%{AUDITAVC}” }``</div>
<div class="line">``    }``</div>
<div class="line">``  }``</div>
<div class="line">``  if [type] == “syslogjson” {``</div>
<div class="line">``    grok {``</div>
<div class="line">``      patterns_dir =&gt; “/opt/logstash/patterns”``</div>
<div class="line">``      match =&gt; { “message” =&gt; “%{FWGROK}” }``</div>
<div class="line">``      match =&gt; { “message” =&gt; “%{AUDITAVC}” }``</div>
<div class="line">``      match =&gt; { “message” =&gt; “%{COMMONAPACHELOG}” }``</div>
<div class="line">``      tag_on_failure =&gt; []``</div>
<div class="line">``    }``</div>
<div class="line">``  }``</div>
<div class="line">``  # This filter populates the &#64;timestamp field with the timestamp that’s in the actual message``</div>
<div class="line">``  # dirsrv logs are currently pulled in every 2 minutes, so &#64;timestamp is wrong``</div>
<div class="line">``  if [syslogtag] == “dirsrv” {``</div>
<div class="line">``    mutate {``</div>
<div class="line">``      remove_field =&gt; [ ‘rawmsg’ ]``</div>
<div class="line">``    }``</div>
<div class="line">``    grok {``</div>
<div class="line">``      match =&gt; [ “message”, “%{HTTPDATE:log_timestamp}” ]``</div>
<div class="line">``    }``</div>
<div class="line">``    date {``</div>
<div class="line">``      match =&gt; [ “log_timestamp”, “dd/MMM/YYY:HH:mm:ss Z”]``</div>
<div class="line">``      locale =&gt; “en”``</div>
<div class="line">``      remove_field =&gt; [ “log_timestamp” ]``</div>
<div class="line">``    }``</div>
<div class="line">``  }``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">output {</span></code></div>
<div class="line">``  elasticsearch {``</div>
<div class="line">``    protocol =&gt; node``</div>
<div class="line">``    node_name =&gt; “Indexer01”``</div>
<div class="line">``  }``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<p>This instructs Logstash to listen on port 5544 for basic log data, and
also on port 5500 for JSON formatted data. The FWGROK and AUDITAVC lines
force Logstash to run 2 bespoke grok filters on the data to get iptables
and auditavc lines into better shape.</p>
<p>The section for “dirsrv” is there to force Logstash to replace the
incoming timestamp for dirsrv data (which will be based on when rsyslog
first saw the data - and is therefore next to useless) with the
timestamp that appears in the actual log line. This is an improvement,
but will only be to the resolution of 1 second.</p>
</section>
<section id="issues">
<h1>Issues<a class="headerlink" href="#issues" title="Permalink to this heading">¶</a></h1>
<ol class="arabic simple">
<li><p>dirsrv logs are timestamped with a resolution that allows dozens of
log lines to share the same timestamp. Increased resolution of
timestamp from dirsrv would help fix this.</p></li>
<li><p>An unwanted side-effect at the moment is that the dirsrv logs are
written to /var/log/messages as well. This needs fixing, but the main
aim here has been to get the logs onto a remote server.</p></li>
<li><p>Needs further thought with regards the rsyslog properties that are
passed in the JSON template.</p></li>
<li><p>Failure of both logstash servers will result in logs writing to
/var/log/localbuffer, where they will simply remain. This is
sub-optimal.</p></li>
</ol>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../../index.html">
              <img class="logo" src="../../../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../../_sources/archive/pages/Howto/Centralised_Logging_with_Logstash/ElasticSearch/Kibana.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Sources &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Resources" href="V1.html" />
    <link rel="prev" title="Installing Red Hat Directory Server" href="UsingRhdsWithIpa.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>Goal of this page is to show how to:</p>
<ul class="simple">
<li><p>issue certificate and store it on Yubikey 4 Nano,</p></li>
<li><p>add the certificate to FreeIPA User,</p></li>
<li><p>configure FreeIPA client to authenticate user with certificate stored
on Yubikey 4 Nano.</p></li>
</ul>
<section id="sources">
<h1>Sources<a class="headerlink" href="#sources" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://blog-ftweedal.rhcloud.com/2016/08/smart-card-login-with-yubikey-neo/">https://blog-ftweedal.rhcloud.com/2016/08/smart-card-login-with-yubikey-neo/</a></p></li>
<li><p><a class="reference external" href="https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html">https://developers.yubico.com/yubico-piv-tool/YubiKey_PIV_introduction.html</a></p></li>
</ul>
<section id="prepare-yubikey">
<span id="id1"></span><h2>Prepare yubikey<a class="headerlink" href="#prepare-yubikey" title="Permalink to this heading">¶</a></h2>
</section>
</section>
<section id="install-packages">
<span id="id2"></span><h1>Install packages<a class="headerlink" href="#install-packages" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># dnf install -y ykpers yubico-piv-tool pcsc-lite opensc</span></code></p>
</section>
<section id="start-pcscd">
<span id="id3"></span><h1>Start pcscd<a class="headerlink" href="#start-pcscd" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># systemctl start systemctl start pcscd</span></code></p>
</section>
<section id="verify-readers">
<span id="id4"></span><h1>Verify readers<a class="headerlink" href="#verify-readers" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># opensc-tool --list-readers</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Detected readers (pcsc)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Nr.  Card  Features  Name</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">0    Yes             Yubico Yubikey 4 OTP+U2F+CCID 00 00</span></code></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a status -v</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">trying to connect to reader 'Yubico Yubikey 4 OTP+U2F+CCID 00 00'.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Action 'status' does not need authentication.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Now processing for action 'status'.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">CHUID:  No data available</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">CCC:    No data available</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">PIN tries left: 3</span></code></div>
</div>
</section>
<section id="reset-yubikey-optional">
<span id="id5"></span><h1>Reset Yubikey (optional)<a class="headerlink" href="#reset-yubikey-optional" title="Permalink to this heading">¶</a></h1>
<p>Useful if you’ve lost PIN/PUK.</p>
<p id="first-we-need-to-get-the-yubikey-blocked">Blocking the yubikey is straighforward. First enter wrong PIN tree times
then enter wrong PUK tree times.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a verify -P 000000</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a verify -P 000000</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a verify -P 000000</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a unblock-pin -P 000000 -N 000000</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a unblock-pin -P 000000 -N 000000</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a unblock-pin -P 000000 -N 000000</span></code></div>
</div>
<p id="now-we-can-reset-it"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a reset</span></code></p>
</section>
<section id="set-new-management-key-pin-and-puk">
<span id="id6"></span><h1>Set new Management Key, PIN and PUK<a class="headerlink" href="#set-new-management-key-pin-and-puk" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># KEY=$(hexdump -v -e '/1 &quot;%x&quot;' /dev/urandom | head -c 48)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># PIN=$(hexdump -v -e '/1 &quot;%u&quot;' /dev/urandom | head -c 6)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># PUK=$(hexdump -v -e '/1 &quot;%u&quot;' /dev/urandom | head -c 8)</span></code></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a set-mgm-key -n $KEY</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a change-pin -P 123456 -N $PIN</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a change-puk -P 12345678 -N $PUK</span></code></div>
</div>
</section>
<section id="create-certificate">
<span id="id7"></span><h1>Create certificate<a class="headerlink" href="#create-certificate" title="Permalink to this heading">¶</a></h1>
<p id="generate-private-key"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool --key=$KEY -a generate -s 9a -A RSA2048 -o pub.pem</span></code></p>
<p id="generate-certificate-signing-request"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool -a verify -a request -s 9a -P $PIN -S '/CN=test/O=EXAMPLE.ORG/' -i pub.pem -o req.pem</span></code></p>
<p id="sign-certificate-signing-request">In production environment the CSR is sent to Security Administrator (or
similar role) and he will provide the certificate. But for testing it’s
OK to generate self-sign CA certificate and use it to sign the request.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># head -c 40 /dev/urandom &gt; noise</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># base64 /dev/urandom | head -c 20 &gt; pwfile</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># mkdir /tmp/nssdb</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># certutil -d /tmp/nssdb/ -f pwfile -N</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># echo -e &quot;y\n\ny\n&quot; | certutil -d /tmp/nssdb/ -f pwfile -S -x -n ca -t T,, -m 1 -s &quot;CN=Smart Card CA,O=EXAMPLE.ORG&quot; -z noise -2</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># certutil -d /tmp/nssdb/ -f pwfile -C -c ca -m $RANDOM -a -i req.pem -o cert.pem --keyUsage digitalSignature,nonRepudiation,keyEncipherment,dataEncipherment</span></code></div>
</div>
<p>The CA certificate (will be needed later) can be exported to file:</p>
<p><code class="docutils literal notranslate"><span class="pre"># certutil -d /tmp/nssdb/ -f pwfile -L -n ca -a -o ca.pem</span></code></p>
<p id="import-the-certificate-into-yubikey"><code class="docutils literal notranslate"><span class="pre"># yubico-piv-tool --key=$KEY -a import-certificate -i cert.pem -s 9a</span></code></p>
<section id="assign-the-certificate-to-freeipa-user">
<span id="id8"></span><h2>Assign the certificate to FreeIPA user<a class="headerlink" href="#assign-the-certificate-to-freeipa-user" title="Permalink to this heading">¶</a></h2>
<p>user-add-cert command expects only the base64 encoded blob:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">- `tail -n +2</span></code> omits the —–BEGIN CERTIFICATE—- line`</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">- `head -n -1</span></code> omits the —–END CERTIFICATE—- line`</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">- `tr -d 'nr'</span></code> joins all lines into one`</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit test</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># cat cert.pem | tail -n +2 | head -n -1 | tr -d '\n\r' | ipa user-add-cert test</span></code></div>
</div>
</section>
<section id="enable-support-on-freeipa-client">
<span id="id9"></span><h2>Enable support on FreeIPA client<a class="headerlink" href="#enable-support-on-freeipa-client" title="Permalink to this heading">¶</a></h2>
</section>
</section>
<section id="install-packages-1">
<span id="id10"></span><h1>Install packages<a class="headerlink" href="#install-packages-1" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># dnf install -y opensc python{2,3}-sssdconfig</span></code></p>
</section>
<section id="add-smart-card-to-etc-pki-nssdb">
<span id="add-smart-card-to-etcpkinssdb"></span><h1>Add Smart Card to /etc/pki/nssdb<a class="headerlink" href="#add-smart-card-to-etc-pki-nssdb" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># modutil -dbdir /etc/pki/nssdb -add &quot;OpenSC&quot; -libfile opensc-pkcs11.so</span></code></p>
</section>
<section id="start-and-enable-pc-smart-card-daemon">
<span id="id11"></span><h1>Start and enable PC Smart Card Daemon<a class="headerlink" href="#start-and-enable-pc-smart-card-daemon" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># systemctl start pcscd.service pcscd.socket</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># systemctl enable pcscd.service pcscd.socket</span></code></div>
</div>
</section>
<section id="enable-authentication-using-certificates-in-sssd">
<span id="id12"></span><h1>Enable authentication using certificates in SSSD<a class="headerlink" href="#enable-authentication-using-certificates-in-sssd" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># python &lt;&lt; EOF</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">from SSSDConfig import SSSDConfig</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c = SSSDConfig()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c.import_config()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c.set('pam', 'pam_cert_auth', 'True')</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c.write()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EOF</span></code></div>
</div>
</section>
<section id="disable-ocsp-if-oscp-unreachable">
<span id="id13"></span><h1>Disable OCSP (if oscp unreachable)<a class="headerlink" href="#disable-ocsp-if-oscp-unreachable" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># python &lt;&lt; EOF</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">from SSSDConfig import SSSDConfig</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c = SSSDConfig()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c.import_config()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c.set('sssd', 'certificate_verification', 'no_ocsp')</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">c.write()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EOF</span></code></div>
</div>
</section>
<section id="import-ca-certificates-for-smart-cards">
<span id="id14"></span><h1>Import CA certificates for Smart Cards<a class="headerlink" href="#import-ca-certificates-for-smart-cards" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># certutil -d /etc/pki/nssdb -A -i ca.pem -n &quot;Smart Card CA ($RANDOM)&quot; -t T,,</span></code></p>
</section>
<section id="restart-sssd">
<span id="id15"></span><h1>Restart SSSD<a class="headerlink" href="#restart-sssd" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># systemctl restart sssd.service</span></code></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/Using_Yubikey_4_Nano_to_authenticate_to_FreeIPA_enrolled_host.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
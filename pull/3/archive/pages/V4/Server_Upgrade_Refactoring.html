<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="Service_Constraint_Delegation.html" />
    <link rel="prev" title="Overview" href="Server_Roles.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>FreeIPA server becomes full of new features and enhancements over the
time, which makes upgrade process hard to keep in shape.</p>
<p>Following improvements, listed in this design, should make server update
process more deterministic, robust and working well in various update
environments (%posttrans update, containers, etc.).</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Make update process more deterministic</p></li>
<li><p>Merge server update commands into the one command
(<code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code>)</p></li>
<li><p>Solve upgrades in containers</p></li>
<li><p>Prevent to run IPA service, if code version and configuration version
does not match</p>
<ul>
<li><p>ipactl should execute ipa-server-upgrade if needed</p></li>
</ul>
</li>
<li><p>Prevent user to use <code class="docutils literal notranslate"><span class="pre">ipa-upgradeconfig</span></code> and <code class="docutils literal notranslate"><span class="pre">ipa-ldap-updater</span></code></p>
<ul>
<li><p>remove ipa-upgradeconfig</p></li>
<li><p>refactor ipa-ldap-updater to allow execute updates for specified
files with HUGE warning (disallow to execute overall update)</p></li>
</ul>
</li>
</ul>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="make-upgrade-process-more-deterministic">
<span id="id1"></span><h2>Make upgrade process more deterministic<a class="headerlink" href="#make-upgrade-process-more-deterministic" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="http://www.redhat.com/archives/freeipa-devel/2014-December/msg00183.html">Freeipa-devel list
discussion</a></p>
<p>Currently update process do several optimizations which may prevent some
errors during update (do update in proper relation parent to children,
respectively children to parent during removing). In other hand, the
parent to child relation, is not the only one restriction. We use
several plugins in 389 directory server, which require proper order of
updates in different sub trees.</p>
<p>It causes unexpected errors because the order of updates in files is not
the same as real update. Developers should be responsible for proper
order of updates, as is not possible to create effective updates
sorting, which will respect all 389 DS plugins requirements.</p>
<p>This effort consist of following steps:</p>
<ul class="simple">
<li><p>Do not sort order of updates based on length of DN.</p></li>
<li><p>Do not use dictionary to store updates. Dictionary mixes the order of
particular updates per file. Using lists achieve, the order of
updates will be same as order in files.</p></li>
<li><p>Apply updates per file, in specified order from top to bottom.</p></li>
</ul>
<section id="ordering-ldap-updates">
<span id="id2"></span><h3>Ordering LDAP updates<a class="headerlink" href="#ordering-ldap-updates" title="Permalink to this heading">¶</a></h3>
<p>All LDAP update files are ordered/executed in alphabetical order. Update
files should keep the number prefix, but this is not required anymore by
updater.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">05-pre-update-plugins.update</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">10-config.update</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">20-syncrepl.update</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">...</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">90-last.update</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ZZ.update  # this will work, but we should avoid of using number less update files</span></code></div>
</div>
</section>
<section id="plugin-the-new-update-file-directive">
<span id="id3"></span><h3><em>plugin</em> - the new update file directive<a class="headerlink" href="#plugin-the-new-update-file-directive" title="Permalink to this heading">¶</a></h3>
<p>Plugins are called from update files, using new directive <strong>plugin:</strong></p>
<p>Plugins which edits ldap data directly, without using modlists, should
be in separate files.</p>
</section>
<section id="update-plugins-modifications">
<span id="id4"></span><h3>Update plugins modifications<a class="headerlink" href="#update-plugins-modifications" title="Permalink to this heading">¶</a></h3>
<p>Execution order of plugins is specified in .update files. There is no
need to keep PRE_UPDATE and POST_UPDATE plugin classes and FIRST,
MIDDLE, LAST order specifications.</p>
<p>Class <strong>Updater</strong> is used for all update plugins instead of <em>PreUpdate</em>
and <em>Postupdate</em> classes.</p>
<p>The <strong>execute</strong> method of the class, returns only 2 values
(<em>restart_ds</em>, <em>modlist</em>)</p>
<ul class="simple">
<li><p><em>restart_ds</em> - boolean value, DS server will be restarted after
<em>modlist</em> application</p></li>
<li><p><em>modlist</em> - list of required changes</p></li>
</ul>
</section>
</section>
<section id="merge-server-update-commands-into-the-one-command">
<span id="id5"></span><h2>Merge server update commands into the one command<a class="headerlink" href="#merge-server-update-commands-into-the-one-command" title="Permalink to this heading">¶</a></h2>
<p>Related ticket:
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4834">#4834</a>,
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3351">#3351</a></p>
<p>Currently two commands exist, which have to be exucuted in proper order
to upgrade IPA:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa-ldap-updater --upgrade</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa-upgradeconfig</span></code></div>
</div>
<p>Using these commands in wrong order, or execute ipa-upgradecofig if
ipa-ldap-updater failed, can break the system.</p>
<p>To resolve issues mentioned above only one command should do upgrade:
<code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code>.</p>
<section id="ipa-server-upgrade-characteristics">
<span id="id6"></span><h3>ipa-server-upgrade characteristics<a class="headerlink" href="#ipa-server-upgrade-characteristics" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>LDAPI only is used for upgrade (no binding using DM password)</p></li>
<li><p>check the version of configuration and code version, run only if
installed version is newer than configuration version
(<em>–skip-version-check</em> overrides this check, see steps).</p></li>
<li><p>upgrade steps:</p></li>
</ul>
<ol class="arabic simple">
<li><p>stop IPA services</p></li>
<li><p>check build and installed platform, if platform mismatch abort
upgrade</p></li>
<li><p>check build version and installed version</p>
<ol class="arabic simple">
<li><p>newer build than data: continue</p></li>
<li><p>same version of data and build: skip data upgrade</p></li>
<li><p>older version of build: abort upgrade</p></li>
</ol>
</li>
<li><p>prepare DS to upgrade (stop DS, save configuration, disabling
listeners, start DS)</p></li>
<li><p>SCHEMA update</p></li>
<li><p>LDAP data update + update plugins (update of user data in LDAP, and
cn=config LDAP configurations)</p></li>
<li><p>upgrade configuration (upgrade of services: httpd, named, etc…)</p></li>
<li><p>restore DS (stop DS, restoring configuration)</p></li>
<li><p>(re)start IPA services</p></li>
</ol>
<ul class="simple">
<li><p>update configuration version, if update was successful</p></li>
<li><p>only former <strong>–upgrade</strong>/offline method is supported</p></li>
</ul>
</section>
</section>
<section id="prevent-to-run-ipa-if-version-mismatch">
<span id="id7"></span><h2>Prevent to run IPA if version mismatch<a class="headerlink" href="#prevent-to-run-ipa-if-version-mismatch" title="Permalink to this heading">¶</a></h2>
<p>Related ticket: <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3849">#3849</a></p>
<p><code class="docutils literal notranslate"><span class="pre">ipactl</span> <span class="pre">{start|restart}</span></code></p>
<ol class="arabic simple">
<li><p>compare build platform and platform from the last
upgrade/installation (based on <em>ipaplatform</em> file)</p>
<ol class="arabic simple">
<li><p>if platform mismatch, raise error and prevent to start IPA
services</p></li>
</ol>
</li>
<li><p>compare version of LDAP data(+schema included) and build version
(<em>VENDOR_VERSION</em> will be used)</p>
<ol class="arabic simple">
<li><p>if LDAP data version <strong>&gt;</strong> build version: raise error and prevent
services to start (newer data than IPA build)</p></li>
<li><p>if LDAP data version <strong>&lt;</strong> build version: upgrade required (data
are older than IPA build)</p></li>
<li><p>if LDAP data version <strong>==</strong> build version: continue (data up to
date)</p></li>
</ol>
</li>
<li><p>check if any of services requires upgrade<strong>**</strong></p>
<ol class="arabic simple">
<li><p>if any service requires upgrade, upgrade is required</p></li>
<li><p>if any service raises an error about wrong configuration (which
requires manual fix by user), raise error and prevent to start
services</p></li>
</ol>
</li>
<li><p>if any upgrade is required, prevent to start services and prompt user
to run <em>ipa-server-upgrade</em> (ipactl will not execute upgrade itself)</p></li>
<li><p>(otherwise) start services</p></li>
</ol>
<p><strong>**</strong> will be available after installers refactoring</p>
<p>This behavior is required in container environments (or fedup), where
the ipa-server-upgrade can not be executed as RPM %postrans operation,
but data and configuration must be updated before first start of newer
IPA.</p>
<p><code class="docutils literal notranslate"><span class="pre">ipactl</span> <span class="pre">start|restart</span></code> option <code class="docutils literal notranslate"><span class="pre">--skip-version-check</span></code> overrides this
check.</p>
</section>
<section id="refactor-ipa-upgradeconfig-into-modules-plugins-used-by-ipa-server-update">
<span id="refactor-ipa-upgradeconfig-into-modulesplugins-used-by-ipa-server-update"></span><h2>Refactor ipa-upgradeconfig into modules/plugins used by ipa-server-update<a class="headerlink" href="#refactor-ipa-upgradeconfig-into-modules-plugins-used-by-ipa-server-update" title="Permalink to this heading">¶</a></h2>
<p>This will be done during the installer refactoring.</p>
</section>
<section id="requirements-for-using-updates-in-containers">
<span id="id8"></span><h2>Requirements for using updates in containers<a class="headerlink" href="#requirements-for-using-updates-in-containers" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Upgrade must run before first start of IPA services (if required)</p></li>
<li><p>Switching between images based on different OS distribution is not
supported, upgrade can’t handle differences in distribution patches.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ipactl</span> <span class="pre">start</span> <span class="pre">|</span> <span class="pre">restart</span></code> refuse to start IPA services if
ipaplatform doesn’t match the platform in configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code> refuse to start upgrading if ipaplatform
doesn’t match the platform in configuration</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--skip-version-check</span></code> option allows to override this check, but
there is no guarantee the IPA will work as expected</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<section id="storing-configuration-version-and-platform-place-format">
<span id="id9"></span><h2>Storing configuration version and platform (place, format)<a class="headerlink" href="#storing-configuration-version-and-platform-place-format" title="Permalink to this heading">¶</a></h2>
<p>The ipapython.version.IPA_VENDOR_VERSION variable is used to determine
IPA version. The format is 4.1.2-0.fc21.</p>
<p>The platform value consist of ipaplatform file name which is used for a
build. The platform name is detected during first run of
ipa-server-upgrade on existing systems, respectively during installation
IPA 4.2+ servers.</p>
<p>Values are stored into <strong>sysupgrade.state</strong> file as <strong>ipa_version</strong> and
<strong>ipa_platform</strong></p>
</section>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<p>N/A</p>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ipa-server-upgrade</p></td>
<td><table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>–skip-v
ersion-check</p></td>
<td><p>do not check
IPA version</p></td>
</tr>
<tr class="row-even"><td><p>–version</p></td>
<td><p>show
program’s
version
number and
exit</p></td>
</tr>
<tr class="row-odd"><td><p>-h, –help</p></td>
<td><p>show this
help message
and exit</p></td>
</tr>
<tr class="row-even"><td><p>-d, –debug</p></td>
<td><p>print
debugging
information</p></td>
</tr>
<tr class="row-odd"><td><p>-q, –quiet</p></td>
<td><p>output only
errors</p></td>
</tr>
<tr class="row-even"><td><p>–l
og-file=FILE</p></td>
<td><p>log to the
given file</p></td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<p>N/A</p>
</section>
</section>
<section id="how-to-test">
<span id="how-to-test36"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<p>Run <code class="docutils literal notranslate"><span class="pre">ipa-server-update</span></code> on various old versions of IPA.</p>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="http://www.freeipa.org/page/V4/Server_Upgrade_Refactoring/Test_Plan">Test
Plan</a></p>
</section>
<section id="author">
<h1>Author<a class="headerlink" href="#author" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="User:Mbasti">Martin Basti</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Server_Upgrade_Refactoring.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="Keytab_Retrieval_Management.html" />
    <link rel="prev" title="&lt;no title&gt;" href="Kerberos_principal_aliases.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>Currently, once a Kerberos key has been created it is not possible to
retrieve it from the <a class="reference external" href="Kerberos">KDC</a>. The only option is to generate
a new key. However it is suboptimal when multiple machines (e.g. a
cluster) need to share the same key (high availability/load balancing
purposes). In these cases distributing the key needs to be performed
completely through out of band/custom channels.</p>
<p>A mechanism to be able to retrieve an existing key from the
<a class="reference external" href="Kerberos">KDC</a> (subject to access control) resolves the <em>secure
distribution channel</em> problem. Leaving to the cluster members only the
problem of retrieving the key when a new one is created or an old one
rotated.</p>
<p>Additionally, the current <code class="docutils literal notranslate"><span class="pre">setkeytab</span></code> extended operation is suboptimal
as it creates keys on the client system. This has 2 bad side effects:</p>
<ol class="arabic simple">
<li><p>Password policies can’t be applied because the server never sees the
plain text</p></li>
<li><p>Keys for algorithms unknown to the client but known to the server
cannot be generated (useful when admins workstations request keys on
behalf of other systems).</p></li>
</ol>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<section id="a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation">
<span id="a-load-balancing-cluster-of-http-server-that-allow-gssapikrb5-negotiation"></span><h2>A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation<a class="headerlink" href="#a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation" title="Permalink to this heading">¶</a></h2>
<p>The load balancing servers need to be able to share the same Service
Principal Name (SPN) for <code class="docutils literal notranslate"><span class="pre">HTTP/public-http-server-name&#64;REALM</span></code> and key
so that whichever cluster member a client contact can decrypt the ticket
and authenticate the client.</p>
<p>This may be coupled with throwaway machines, where for example the
number of load balancer cluster members increase dynamically with the
traffic, so new machines are added to the pool dynamically.</p>
<p>In this case, assuming provisioning of individual machines credentials
is taken care of by the provisioning software, each machine can be given
the right to fetch the key for the common SPN, so that they can obtain
the necessary key material via an authenticated request to the IPA
server.</p>
</section>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>The solution is to extend the password management plugin in FreeIPA to
also allow retrieving existing keys, and subject retrieval to <strong>strict
access control</strong>.</p>
<p>One of the problems of designing access control is that we cannot rely
just on making the <code class="docutils literal notranslate"><span class="pre">KrbPrincipalKey</span></code> attribute readable. Because that
attribute is actually encrypted and needs to be decrypted before a
keytab can be returned. It would also mean the attribute can be
explicitly fetched and brute force attacks run on it.</p>
<p>Because we need to process a request we need to create a new extended
operation similar to the <code class="docutils literal notranslate"><span class="pre">setkeytab</span></code> extended operation already
available.</p>
<section id="new-extended-operation">
<span id="id1"></span><h2>New Extended operation<a class="headerlink" href="#new-extended-operation" title="Permalink to this heading">¶</a></h2>
<p>New Extended operation OID: <strong>2.16.840.1.113730.3.8.10.5</strong></p>
<p>The new extended operation allows to create a new keytab or get an
existing one and aim to supplant the current setkeytab extended
operation, allowing to eventually turn off the old one.</p>
<p>The following is the psudo-ASN.1 code definition for the extended
operation payload:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">KeytabGetRequest ::= CHOICE {</span></code></div>
<div class="line">``    newkey s     [0] NewKeys,``</div>
<div class="line">``    curkey s     [0] CurrentKeys,``</div>
<div class="line">``    reply        [2] Reply``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">NewKeys ::= SEQUENCE {</span></code></div>
<div class="line">``    serviceIdentity [0] OCTET STRING,``</div>
<div class="line">``    enctypes        [1] SEQUENCE OF Int16,``</div>
<div class="line">``    password        [2] OCTET STRING OPTIONAL``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">CurrentKeys ::= SEQUENCE {</span></code></div>
<div class="line">``    serviceIdentity [0] OCTET STRING``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<p>If the getNew attribute is true a new keytab is being requested. In this
case a password may be provided or not. If not one is generated
randomly. In case a password is provided it is subject to password
policy checking as per policies defined on the entry for which a keytab
is being requested. A list of enctypes is always necessary in input when
a new keytab is requested. However the list is filtered though the
allowable enctypes list and if nothing is left the operation is refused.</p>
<p>If the getNew attribute is false, then the existing key is being
requested. In this case password and enctypes MUST NOT be set.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Reply ::= SEQUENCE {</span></code></div>
<div class="line">``    new_kvno        Int32``</div>
<div class="line">``    keys            SEQUENCE OF KrbKey,``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">KrbKey ::= SEQUENCE {</span></code></div>
<div class="line">``    key       [0] EncryptionKey,``</div>
<div class="line">``    salt      [1] KrbSalt OPTIONAL,``</div>
<div class="line">``    s2kparams [2] OCTET STRING OPTIONAL,``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">EncryptionKey ::= SEQUENCE {</span></code></div>
<div class="line">``    keytype   [0] Int32,``</div>
<div class="line">``    keyvalue  [1] OCTET STRING``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">KrbSalt ::= SEQUENCE {</span></code></div>
<div class="line">``    type      [0] Int32,``</div>
<div class="line">``    salt      [1] OCTET STRING``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<p>The reply actually is very similar to the current <code class="docutils literal notranslate"><span class="pre">setkeytab</span></code> request
format.</p>
<p>A kvno is returned, followed by a sequence of <code class="docutils literal notranslate"><span class="pre">KrbKeys</span></code>. Each
<code class="docutils literal notranslate"><span class="pre">KrbKey</span></code> is constituted of an <code class="docutils literal notranslate"><span class="pre">EncryptionKey</span></code> buffer which includes
an integer that indicated the encryption type used and an octet string
that holds the actual key material. Optionally a <code class="docutils literal notranslate"><span class="pre">KrbSalt</span></code> is added
again indicating type and optionally a value.</p>
<p>This is the information actually needed by a client to be able to write
out a keytab after receiving the reply.</p>
</section>
<section id="access-control">
<span id="id2"></span><h2>Access Control<a class="headerlink" href="#access-control" title="Permalink to this heading">¶</a></h2>
<p>It would be nice, at this point to be able to have a way to express
access control related to actions taken by extended operations rather
than just direct access to attributes and to relate this access to
actors and targets.</p>
<p>The actors are the users attempting the operation as authenticated by
the <a class="reference external" href="Directory_Server">Directory Server</a>. The targets are the objects
that hold the information. What is missing is a way to describe
permissions that tie a specific extended operation to them.</p>
<p>For this a new schema is necessary, based on a nice feature that is
available in LDAP - <em>sub-types</em>.</p>
</section>
<section id="new-schema">
<span id="id3"></span><h2>New Schema<a class="headerlink" href="#new-schema" title="Permalink to this heading">¶</a></h2>
<p>Attributes:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">IPA_OID.11.51 NAME 'ipaAllowedToPerform'</span></code></div>
<div class="line">``              DESC ‘DNs allowed to perform an operation’``</div>
<div class="line">``              SUP distinguishedName X-ORIGIN ‘IPA-v3’)``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">IPA_OID.11.52 NAME 'ipaProtectedOperation'</span></code></div>
<div class="line">``              DESC ‘Operation to be protected’``</div>
<div class="line">``              EQUALITY caseIgnoreMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.15{128} )``</div>
</div>
<p>Objectclasses:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">IPA_OID.12.22 NAME 'ipaAllowedOperations'</span></code></div>
<div class="line">``              SUP top AUXILIARY``</div>
<div class="line">``              DESC ‘Class to apply access controls to arbitrary operations’``</div>
<div class="line">``              MAY ( ipaAllowedToPerform $ ipaProtectedOperation ) X-ORIGIN ‘IPA v3’)``</div>
</div>
<p>This schema allows to add the <code class="docutils literal notranslate"><span class="pre">ipaAllowedToPerform</span></code> attribute to an
object, with a sub-type that indicates what special operation we want to
allow. The DN in the value indicates who is allowed to perform the
operation. The <code class="docutils literal notranslate"><span class="pre">ipaProtectedOperation</span></code> attribute is “virtual” and is
only ever used in ACI instructions. An extended plugin that want to
check if an operation is possible will check if operating on the
<code class="docutils literal notranslate"><span class="pre">ipaProtectedOperation;sub-type</span></code> attribute is allowed but that
operation will never actually be performed. However if it were nothing
would really happen, a useless attribute may end up being added to an
object, but that wouldn’t change the security properties of the
operation.</p>
</section>
<section id="new-acis">
<span id="id4"></span><h2>New ACIs<a class="headerlink" href="#new-acis" title="Permalink to this heading">¶</a></h2>
<p>The extended operation uses 2 named sub-types: read_keys/write_keys. The
read_keys sub-type identify the ability to retrieve a key, while
write_keys allows someone to create a new key (from a password or a
randomly generated one).</p>
<p>An example ACI rule to allow retrieval is this:</p>
<p><code class="docutils literal notranslate"><span class="pre">aci: (targetattr=&quot;ipaProtectedOperation;read_keys&quot;)(version 3.0; acl &quot;Users allowed to retrieve keytab keys&quot;; allow(read) userattr=&quot;ipaAllowedToPerform;read_keys#USERDN&quot;;)</span></code></p>
<p>For this ACI to have effect an attribute needs to be added to a target
service entry like this:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">dn: HTTP/www.example.com&#64;EXAMPLE.COM,cn=services,cn=accounts,dc=example,dc=com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">changetype: modify</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">add: objectclass</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectclass: ipaAllowedOperations</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">-</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">add: ipaAllowedToPerform;read_key</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaAllowedToPerform;read_key: fqdn=clustermember1.example.com,cn=computers,cn=accounts,dc=example,dc=com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaAllowedToPerform;read_key: fqdn=clustermember2.example.com,cn=computers,cn=accounts,dc=example,dc=com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaAllowedToPerform;read_key: fqdn=clustermember3.example.com,cn=computers,cn=accounts,dc=example,dc=com</span></code></div>
</div>
<p>With this ACI and attributes in place clustermember1.example.com,
clustermember2.example.com and clustermember3.example.com hosts can
retrieve an existing keytab for the service HTTP on the www.example.com
host.</p>
<p><a class="reference external" href="V4/Keytab_Retrieval_Management">V4/Keytab Retrieval Management</a>
design page describes administration interface for setting the
ipaAllowedToPerform attribute. CLI equivalent for the LDIF above is:</p>
<p><code class="docutils literal notranslate"><span class="pre">ipa service-allow-retrieve-keytab HTTP/www.example.com --hosts={clustermember1.example.com,clustermember2.example.com,clustermember3.example.com}</span></code></p>
</section>
<section id="compatibility-with-older-freeipa-servers">
<span id="id5"></span><h2>Compatibility with older FreeIPA servers<a class="headerlink" href="#compatibility-with-older-freeipa-servers" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ipa-getkeytab</span></code> falls back to the old extended operation for fetching
new keys when an old server does not have the new extended operation.</p>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>The old setkeytab operation was used in conjunction with the
<code class="docutils literal notranslate"><span class="pre">managedBy</span></code> attribute to allow to set keytabs by other entities. For
example the host keytab is allowed, by default to request arbitrary
services keys on the same hosts via the <code class="docutils literal notranslate"><span class="pre">managedBy</span></code> attribute.</p>
<p>In order to preserve this feature an additional ACI has been provided:</p>
<p><code class="docutils literal notranslate"><span class="pre">aci: (targetattr=&quot;ipaProtectedOperation;write_keys&quot;)(version 3.0; acl &quot;Entities are allowed to rekey managed entries&quot;; allow(write) userattr=&quot;managedby#USERDN&quot;;)</span></code></p>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<p>N/A.</p>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">ipa-getkeytab</span></code> has a new <code class="docutils literal notranslate"><span class="pre">-r</span></code> switch:</p>
<p>``  -r, –retrieve                                           Retrieve current keys without changing them``</p>
</section>
</section>
<section id="how-to-test">
<span id="how-to-test28"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<section id="use-case-a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation-tbd">
<span id="use-case-a-load-balancing-cluster-of-http-server-that-allow-gssapikrb5-negotiation-tbd"></span><h2>Use Case: A load balancing cluster of HTTP server that allow GSSAPI/Krb5 negotiation (TBD)<a class="headerlink" href="#use-case-a-load-balancing-cluster-of-http-server-that-allow-gssapi-krb5-negotiation-tbd" title="Permalink to this heading">¶</a></h2>
<ol class="arabic">
<li><p>Install FreeIPA server with DNS on a host, e.g. with hostname
<code class="docutils literal notranslate"><span class="pre">server.example.test</span></code></p></li>
<li><p>Enroll FreeIPA clients <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and
<code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code></p></li>
<li><p>Create DNS A record <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code> that has 2 forward
addresses of <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code></p></li>
<li><p>Add a new host <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code> - there will be no client
enrolled to it:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">host-add</span> <span class="pre">client.example.test</span></code></p>
</div></blockquote>
</li>
<li><p>Add a new service HTTP/client.example.test:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">service-add</span> <span class="pre">HTTP/client.example.test</span></code></p>
</div></blockquote>
</li>
<li><p>Allow <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code> to read
<code class="docutils literal notranslate"><span class="pre">client.example.test</span></code> Kerberos key by configuring
<code class="docutils literal notranslate"><span class="pre">ipaAllowedToPerform;read_key</span></code> attribute following the example in
<a class="reference external" href="#New_ACIs">New ACIs</a> section.</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">service-allow-retrieve-keytab</span> <span class="pre">HTTP/client.example.test</span> <span class="pre">--hosts={client1.example.test,client2.example.test}</span></code></p>
</div></blockquote>
</li>
<li><p>On both <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> and <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code> read
the keytab for <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code></p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ipa-getkeytab</span> <span class="pre">-r</span> <span class="pre">-s</span> <span class="pre">server.example.test</span> <span class="pre">-p</span> <span class="pre">HTTP/client.example.test</span> <span class="pre">-k</span> <span class="pre">/etc/httpd/conf/client.keytab</span></code></p>
</div></blockquote>
</li>
<li><p>Configure Apache with mod_auth_kerb on both clients and secure it
with Kerberos</p></li>
<li><p>With any FreeIPA user with valid Kerberos ticket, try to access web
server on <code class="docutils literal notranslate"><span class="pre">client.example.test</span></code>. It should work fine whether
forwarded to <code class="docutils literal notranslate"><span class="pre">client1.example.test</span></code> or <code class="docutils literal notranslate"><span class="pre">client2.example.test</span></code></p></li>
</ol>
<p><a class="reference external" href="Category:FreeIPA_V4_Test_Plan">Category:FreeIPA V4 Test Plan</a>
<a class="reference external" href="Category:FreeIPA_Test_Plan">Category:FreeIPA Test Plan</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Keytab_Retrieval.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
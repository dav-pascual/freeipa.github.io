<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="External_Authentication.html" />
    <link rel="prev" title="Overview" href="Domain_Levels.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>Currently on FreeIPA <a class="reference external" href="Client">clients</a> the full list of
group-memberships for users from trusted domains is only available for
authenticated users. Authentication is needed because the
group-memberships are extracted from the PAC which is a part of the
<a class="reference external" href="Kerberos">Kerberos</a> ticket of the user. For un-authenticated users
only the primary POSIX group is available.</p>
<p>With the introduction of SSSD’s ipa-server-mode IPA servers can resolve
the group memberships for user from trusted domains even for
un-authenticated users by reading them from the AD DCs of the trusted
domains directly. This data should be made available to the IPA clients
as well.</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Calling the ‘id’ command on a IPA client or calling getgrouplist() in
a process should return the full list of secondary groups for any
user from a trusted domain without requiring that the user has to log
in first</p></li>
</ul>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>The IPA extdom plugin is already called by SSSD running on the IPA
clients to translate SID to names or POSIX IDs. It can be enhanced to
return the secondary groups as well.</p>
<p>To make this change backward compatible in the sense that newer client
can still work with older servers</p>
<ul class="simple">
<li><p>a new OID can be added to the extdom plugin, currently it uses
2.16.840.1.113730.3.8.10.4 , if we agree on this approach it might be
possible to just add a “.1” to the OID. With this the client can
determine from reading the rootDSE if the server supports this
operation or not.</p></li>
<li><p>the client just sends the new request and assumes in the case of a
specific error the request is not supported. A suitable error code
might be LDAP_UNWILLING_TO_PERFORM which is currently only returned
by the extdom plugin if either there is no request data or if there
are issues reading and understanding the first enumeration in the
request data (see Implementation section for more details).</p></li>
</ul>
<p>If the request was parsed successful the extdom plugin will return the
secondary groups for the given user as a list of fully qualified group
names. Additionally the POSIX user data (UID, GID, gecos, home-directory
and shell) can be send. This would reduce the number of requests to the
extdom plugin, because refreshing user and group-membership data often
happen together. Please note that UID and GID may change due to
user-views. But as long as this feature is implemented after user-views
everything what is needed will be available.</p>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<section id="request">
<h2>Request<a class="headerlink" href="#request" title="Permalink to this heading">¶</a></h2>
<p>The current request looks like this:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/* We expect the following request:</span></code></div>
<div class="line">`` * ExtdomRequestValue ::= SEQUENCE {``</div>
<div class="line">`` *    inputType ENUMERATED {``</div>
<div class="line">`` *        sid (1),``</div>
<div class="line">`` *        name (2),``</div>
<div class="line">`` *        posix uid (3),``</div>
<div class="line">`` *        posix gid (3)``</div>
<div class="line">`` *    },``</div>
<div class="line">`` *    requestType ENUMERATED {``</div>
<div class="line">`` *        simple (1),``</div>
<div class="line">`` *        full (2)``</div>
<div class="line">`` *    },``</div>
<div class="line">`` *    data InputData``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id1"><span class="problematic" id="id2">*</span></a><a href="#id3"><span class="problematic" id="id4">``</span></a></div>
<div class="line">`` * InputData ::= CHOICE {``</div>
<div class="line">`` *    sid OCTET STRING,``</div>
<div class="line">`` *    name NameDomainData``</div>
<div class="line">`` *    uid PosixUid,``</div>
<div class="line">`` *    gid PosixGid``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id5"><span class="problematic" id="id6">*</span></a><a href="#id7"><span class="problematic" id="id8">``</span></a></div>
<div class="line">`` * NameDomainData ::= SEQUENCE {``</div>
<div class="line">`` *    domain_name OCTET STRING,``</div>
<div class="line">`` *    object_name OCTET STRING``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id9"><span class="problematic" id="id10">*</span></a><a href="#id11"><span class="problematic" id="id12">``</span></a></div>
<div class="line">`` * PosixUid ::= SEQUENCE {``</div>
<div class="line">`` *    domain_name OCTET STRING,``</div>
<div class="line">`` *    uid INTEGER``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id13"><span class="problematic" id="id14">*</span></a><a href="#id15"><span class="problematic" id="id16">``</span></a></div>
<div class="line">`` * PosixGid ::= SEQUENCE {``</div>
<div class="line">`` *    domain_name OCTET STRING,``</div>
<div class="line">`` *    gid INTEGER``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id17"><span class="problematic" id="id18">*</span></a>/``</div>
</div>
<p>Basically only a new request type must be added, e.g.</p>
<div class="line-block">
<div class="line">`` *    requestType ENUMERATED {``</div>
<div class="line">`` *        simple (1),``</div>
<div class="line">`` *        full (2)``</div>
<div class="line">`` *        full_with_groups (3)``</div>
<div class="line">`` *    },``</div>
</div>
<p>But as mentioned before the LDAP_UNWILLING_TO_PERFORM error code is only
send if there are issues with the inputType. The requestType is
evaluated later in the existing code and the quite generic
LDAP_OPERATIONS_ERROR error code is returned if an unexpected value is
found. This would make the detection based on error code much more
fragile. I would suggest if we do not want to use a new OID to indicate
the feature, that the inputType is extended as well, e.g. by adding 128
or 256 to the values. Nevertheless I think it is less error prone to use
a new OID.</p>
</section>
<section id="processing-the-request">
<span id="id19"></span><h2>Processing the request<a class="headerlink" href="#processing-the-request" title="Permalink to this heading">¶</a></h2>
<p>The extdom plugin will call getgrouplist() and the resolve the fully
qualified names by calling getgrgid(). By default groups from the local
IPA domain are returned unqualified and the local domain name should be
added in this case so that the response only contains fully qualified
group names.</p>
<p>There are two things to note here. First getgrgid() returns the full
list of group members which might cause some unneeded overhead e.g. with
respect to memory allocation. Second easiest way to determine if a
domain name is fully qualified is to look for a ‘&#64;’ character. But this
will only work if the full_name_format option is not changed from the
default. Both can be fixed by adding a call to libsss_nss_idmap to map a
GID to user and domain name. If it turns out the such a call is needed
it can be added later and the extdom plugin can be updated accordingly.</p>
<p>Additionally the extdom plugin call getpwnam() with user-view code to
get the data of the POSIX user entry.</p>
</section>
<section id="response">
<h2>Response<a class="headerlink" href="#response" title="Permalink to this heading">¶</a></h2>
<p>Currently the response looks like:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">/* We send to follwing response:</span></code></div>
<div class="line">`` * ExtdomResponseValue ::= SEQUENCE {``</div>
<div class="line">`` *    responseType ENUMERATED {``</div>
<div class="line">`` *        sid (1),``</div>
<div class="line">`` *        name (2),``</div>
<div class="line">`` *        posix_user (3),``</div>
<div class="line">`` *        posix_group (4)``</div>
<div class="line">`` *    },``</div>
<div class="line">`` *    data OutputData``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id20"><span class="problematic" id="id21">*</span></a><a href="#id22"><span class="problematic" id="id23">``</span></a></div>
<div class="line">`` * OutputData ::= CHOICE {``</div>
<div class="line">`` *    sid OCTET STRING,``</div>
<div class="line">`` *    name NameDomainData,``</div>
<div class="line">`` *    user PosixUser,``</div>
<div class="line">`` *    group PosixGroup``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id24"><span class="problematic" id="id25">*</span></a><a href="#id26"><span class="problematic" id="id27">``</span></a></div>
<div class="line">`` * NameDomainData ::= SEQUENCE {``</div>
<div class="line">`` *    domain_name OCTET STRING,``</div>
<div class="line">`` *    object_name OCTET STRING``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id28"><span class="problematic" id="id29">*</span></a><a href="#id30"><span class="problematic" id="id31">``</span></a></div>
<div class="line">`` * PosixUser ::= SEQUENCE {``</div>
<div class="line">`` *    domain_name OCTET STRING,``</div>
<div class="line">`` *    user_name OCTET STRING,``</div>
<div class="line">`` *    uid INTEGER``</div>
<div class="line">`` *    gid INTEGER``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id32"><span class="problematic" id="id33">*</span></a><a href="#id34"><span class="problematic" id="id35">``</span></a></div>
<div class="line">`` * PosixGroup ::= SEQUENCE {``</div>
<div class="line">`` *    domain_name OCTET STRING,``</div>
<div class="line">`` *    group_name OCTET STRING,``</div>
<div class="line">`` *    gid INTEGER``</div>
<div class="line">`` * }``</div>
<div class="line">`` <a href="#id36"><span class="problematic" id="id37">*</span></a>/``</div>
</div>
<p>Here a new responds type e.g.</p>
<p><code class="docutils literal notranslate"><span class="pre">posix_user_grouplist (5)</span></code></p>
<p>is needed which returns OutputData</p>
<p><code class="docutils literal notranslate"><span class="pre">user_grouplist PosixUserGrouplist</span></code></p>
<p>as</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PosixUser ::= SEQUENCE {</span></code></div>
<div class="line">``   domain_name OCTET STRING,``</div>
<div class="line">``   user_name OCTET STRING,``</div>
<div class="line">``   uid INTEGER``</div>
<div class="line">``   gid INTEGER``</div>
<div class="line">``   gecos OCTET STRING,``</div>
<div class="line">``   home_directory OCTET STRING,``</div>
<div class="line">``   shell OCTET STRING,``</div>
<div class="line">``   grouplist GroupNameList``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">GroupNameList ::= SEQUENCE OF groupname OCTET STRING</span></code></p>
<p>Since the new response type will only be returned if requested by the
client there are no compatibility concerns because older clients cannot
request it.</p>
</section>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>The extdom plugin is automatically configured during
ipa-adtrust-install. No additional configuration is needed.</p>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<p>No additional configuration is needed. If chosen a new OID can indicate
that the feature is available.</p>
</section>
</section>
<section id="how-to-test">
<span id="how-to-test25"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<p>It is possible to test the new feature using an IPA client or directly
call into the plugin.</p>
<section id="integration-tests-with-sssd">
<span id="id38"></span><h2>Integration tests with SSSD<a class="headerlink" href="#integration-tests-with-sssd" title="Permalink to this heading">¶</a></h2>
<p>The user-visible effect of this feature is that group members, POSIX
attributes and user’s group memberships can all be resolved with the
help of the extdom plugin.</p>
<p>Please make sure to run these tests on an IPA client as the IPA server
doesn’t use the plugin but connects to the server directly!</p>
<ol class="arabic simple">
<li><p>Prepare a user who is a member of at least one non-primary group in
Active Directory</p></li>
<li><p>Make sure the that hasn’t logged in previously. Clearing the cache
ensures a clean state.</p></li>
<li><p>Run “id user”. The output would show all groups the user is a member
of</p></li>
<li><p>Run “getent group $groupname” where $groupname is an AD group that
contains at least one user. All the member users need to be displayed
on the command line.</p></li>
</ol>
</section>
<section id="manual-tests-of-the-plugin">
<span id="id39"></span><h2>Manual tests of the plugin<a class="headerlink" href="#manual-tests-of-the-plugin" title="Permalink to this heading">¶</a></h2>
<p>Besides running integration tests with a separate IPA client the plugin
can be exercised manually on the server as well and since the extdom
plugin uses standard libc and SSS interfaces IPA users can be requested
via the extdom plugin as well. This mean the plugin can be tested on the
server without established trust which I think would make it possible to
include it in the CI tests as well.</p>
<p>The current version of the extdom plugin can be manually tested in the
following way:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ cat extdom_req_user_admin.asc</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Example Example.Sid2NameRequestValue</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">inputType 2</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">requestType 1</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">data name</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">data.name.domain_name ipa20.devel</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">data.name.object_name admin</span></code></div>
<div class="line"><a href="#id40"><span class="problematic" id="id41">``</span></a>$ asn1Coding extdom_req.asn extdom_req_user_admin.asc ``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Parse: done.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">var=Example, value=Example.Sid2NameRequestValue</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">var=inputType, value=2</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">var=requestType, value=1</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">var=data, value=name</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">var=data.name.domain_name, value=ipa20.devel</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">var=data.name.object_name, value=admin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">name:NULL  type:SEQUENCE</span></code></div>
<div class="line">``  name:inputType  type:ENUMERATED  value:0x02``</div>
<div class="line">``  name:requestType  type:ENUMERATED  value:0x01``</div>
<div class="line">``  name:data  type:CHOICE``</div>
<div class="line">``    name:name  type:SEQUENCE``</div>
<div class="line">``      name:domain_name  type:OCT_STR  value:69706132302e646576656c``</div>
<div class="line">``      name:object_name  type:OCT_STR  value:61646d696e``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Coding: SUCCESS</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">-----------------</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Number of bytes=30</span></code></div>
<div class="line"><a href="#id42"><span class="problematic" id="id43">``</span></a>30 1c 0a 01 02 0a 01 01 30 14 04 0b 69 70 61 32 30 2e 64 65 76 65 6c 04 05 61 64 6d 69 6e ``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">-----------------</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">OutputFile=extdom_req_user_admin.out</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Writing: done.</span></code></div>
<div class="line"><a href="#id44"><span class="problematic" id="id45">``</span></a>$ cat extdom_req_user_admin.out | base64 ``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MBwKAQIKAQEwFAQLaXBhMjAuZGV2ZWwEBWFkbWlu</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ ldapexop -Y GSSAPI 2.16.840.1.113730.3.8.10.4::MBwKAQIKAQEwFAQLaXBhMjAuZGV2ZWwEBWFkbWlu</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SASL/GSSAPI authentication started</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SASL username: admin&#64;IPA20.DEVEL</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SASL SSF: 56</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SASL data security layer installed.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># extended operation response</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">oid: 2.16.840.1.113730.3.8.10.4</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">data:: MDIKAQEELVMtMS01LTIxLTEyMjMyODkxODgtMzE5ODQ0MDM1My0zMzAwMjExMDMyLTUwMA=</span></code></div>
<div class="line">`` =``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ echo -n MDIKAQEELVMtMS01LTIxLTEyMjMyODkxODgtMzE5ODQ0MDM1My0zMzAwMjExMDMyLTUwMA== |base64 -d &gt; extdom_resp_user_admin.bin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ asn1Decoding extdom_resp.asn extdom_resp_user_admin.bin Example.Sid2NameResponseValue</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Parse: done.</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Decoding: SUCCESS</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">DECODING RESULT:</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">name:NULL  type:SEQUENCE</span></code></div>
<div class="line">``  name:responseType  type:ENUMERATED  value:0x01``</div>
<div class="line">``  name:data  type:CHOICE``</div>
<div class="line">``    name:sid  type:OCT_STR  value:532d312d352d32312d313232333238393138382d333139383434303335332d333330303231313033322d353030``</div>
<div class="line"><a href="#id46"><span class="problematic" id="id47">``</span></a>$ echo  532d312d352d32312d313232333238393138382d333139383434303335332d333330303231313033322d353030 | xxd -r -p ``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">S-1-5-21-1223289188-3198440353-3300211032-500</span></code></div>
</div>
</section>
</section>
<section id="rfe-author">
<h1>RFE Author<a class="headerlink" href="#rfe-author" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="User:Sbose">Sumit Bose</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Extdom_plugin_enhancement_grouplist.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Overview" href="Schema.html" />
    <link rel="prev" title="Overview" href="../Authentication_Indicators/Test_Plan.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>Certificate Mapping Rule objects, as defined in
<a class="reference external" href="V4/Automatic_Certificate_Request_Generation#Mapping_data_to_fields">V4/Automatic_Certificate_Request_Generation#Mapping_data_to_fields</a>,
need a mechanism for defining how to use the data stored in IPA objects
to construct the configuration strings that are passed to the CSR
generation helper. This document aims to elaborate on the features
required for this mapping, and describe the current implementation as
well as possible alternatives.</p>
</section>
<section id="requirements">
<h1>Requirements<a class="headerlink" href="#requirements" title="Permalink to this heading">¶</a></h1>
<p>There are two different types of mapping rules used in CSR data
formatting:</p>
<dl class="simple">
<dt>Data rules</dt><dd><p>Describe how to format an individual data item</p>
</dd>
<dt>Syntax rules</dt><dd><p>Describe how to combine data rules in order to create a complete
certificate field</p>
</dd>
</dl>
<section id="data-rules">
<span id="id1"></span><h2>Data rules<a class="headerlink" href="#data-rules" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Include data attribute values</p></li>
<li><p>Include literal values</p></li>
<li><p>Include values requested from the user via a prompt</p></li>
<li><p>For certutil: replace commas with a different separator character (;
or +) within a DN-type subject alternative name</p></li>
<li><p>For certutil: shell quoting of parameters to prevent injection
attacks</p></li>
<li><p>Suppress rendering of a rule if necessary data is missing</p></li>
</ul>
</section>
<section id="syntax-rules">
<span id="id2"></span><h2>Syntax rules<a class="headerlink" href="#syntax-rules" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Distinguish between generated config files and command-line arguments</p></li>
<li><p>For openssl: produce and reference new config file sections</p></li>
<li><p>For openssl: place config value in root or extensions section as
appropriate</p></li>
<li><p>Combine several values for same field (e.g. comma-separated list)</p></li>
<li><p>Suppress rendering of a rule if none of the data rules it contains
are going to be rendered</p></li>
</ul>
</section>
</section>
<section id="planned-implementation">
<span id="id3"></span><h1>Planned implementation<a class="headerlink" href="#planned-implementation" title="Permalink to this heading">¶</a></h1>
<p>We will use Jinja2 for templating. Data rules and syntax rules will both
be snippets of Jinja2 markup. The formatting process will be as follows:</p>
<ol class="arabic simple">
<li><p>Syntax rules will be rendered using Jinja2. Data rules (rule text,
not rendered) will be passed as the <code class="docutils literal notranslate"><span class="pre">datarules</span></code> attribute.</p></li>
<li><p>Rendered syntax rules will be processed by the Formatter class for
the selected CSR generation helper. The formatter combines these
partial rules into a full template for the config.</p></li>
<li><p>The template will be rendered using Jinja2. Several objects from the
IPA server (discussed below) will be available in the context for
this rendering.</p></li>
<li><p>The final rendered template will be returned to the caller, labeled
with its function (e.g. a command line or a config file)</p></li>
</ol>
<section id="data-available-during-final-render">
<span id="id4"></span><h2>Data available during final render<a class="headerlink" href="#data-available-during-final-render" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">subject</span></code></dt><dd><p>dict of data from the IPA object corresponding to the subject of this
certificate</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">config</span></code></dt><dd><p>dict of IPA configuration data (result of the config_show API call)</p>
</dd>
</dl>
</section>
<section id="special-features">
<span id="id5"></span><h2>Special features<a class="headerlink" href="#special-features" title="Permalink to this heading">¶</a></h2>
<p>Some less-than-obvious features will be required to support generating
the needed configs. Some of them will require extensions to the Jinja2
language, others just require specific usage of the tools that Jinja2
already provides.</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">section</span> <span class="pre">%}{%</span> <span class="pre">endsection</span> <span class="pre">%}</span></code></dt><dd><p>This tag will be introduced to make the included block into a new
section, as for an openssl config file.</p>
</dd>
<dt>Easy escaping</dt><dd><p>Some tags, like <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">section</span> <span class="pre">%}</span></code>, are only meaningful during the
second (full-template) render. During the first render they will be
implemented to just insert the same tag in the output.</p>
</dd>
<dt>Location specifier</dt><dd><p>Rules must be able to provide guidance to the formatter about where
they belong in the config file (for example, whether a rule is an
extension or goes in the base <code class="docutils literal notranslate"><span class="pre">[req]</span></code> section). This is
accomplished by setting a template variable in the syntax rule, for
example <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">set</span> <span class="pre">location</span> <span class="pre">=</span> <span class="pre">&quot;req&quot;</span> <span class="pre">%}</span></code></p>
</dd>
</dl>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h2>
<p>Example data rules:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">email={{subject.email}}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">O={{config.ipacertificatesubjectbase}}\nCN={{subject.username}}</span></code></div>
</div>
<p>Example syntax rule:</p>
<p><code class="docutils literal notranslate"><span class="pre">subjectAltName=&#64;{% section %}{{datarules|join('\n')}}{% endsection %}</span></code></p>
<p>Example composed config template:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">[ req ]</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">prompt = no</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">encrypt_key = no</span></code></div>
<div class="line"><a href="#id6"><span class="problematic" id="id7">``</span></a><a href="#id8"><span class="problematic" id="id9">``</span></a></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">distinguished_name = {% section %}O={{config.ipacertificatesubjectbase}}</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">CN={{subject.username}}{% endsection %}</span></code></div>
<div class="line"><a href="#id10"><span class="problematic" id="id11">``</span></a><a href="#id12"><span class="problematic" id="id13">``</span></a></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">req_extensions = exts</span></code></div>
<div class="line"><a href="#id14"><span class="problematic" id="id15">``</span></a><a href="#id16"><span class="problematic" id="id17">``</span></a></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">[ exts ]</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">subjectAltName=&#64;{% section %}email={{subject.email}}{% endsection %}</span></code></div>
</div>
</section>
</section>
<section id="current-status">
<span id="id18"></span><h1>Current status<a class="headerlink" href="#current-status" title="Permalink to this heading">¶</a></h1>
<p>The code <a class="reference external" href="https://www.redhat.com/archives/freeipa-devel/2016-July/msg00462.html">currently under
review</a>
implements most of the features described above, with some exceptions:</p>
<section id="macros-not-tags">
<span id="id19"></span><h2>Macros, not tags<a class="headerlink" href="#macros-not-tags" title="Permalink to this heading">¶</a></h2>
<p>It was convenient to use jinja2 macros to implement some of the
<a class="reference external" href="#Special_features">#Special features</a> instead of adding new tags
which requires extending the parser. So, instead of
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">section</span> <span class="pre">%}{%</span> <span class="pre">endsection</span> <span class="pre">%}</span></code>, one has to use
<code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">call</span> <span class="pre">section()</span> <span class="pre">%}{%</span> <span class="pre">endcall</span> <span class="pre">%}</span></code> to enclose the contents of an
openssl config section. Similarly, the features that allow suppressing
rules with no data are implemented using jinja2 macros. If the macros
turn out to be problematic, we may want to move to using tags after all.</p>
</section>
<section id="rule-suppression">
<span id="id20"></span><h2>Rule suppression<a class="headerlink" href="#rule-suppression" title="Permalink to this heading">¶</a></h2>
<p>It is important that the final output does not contain
partially-constructed strings, reference empty sections, or provide
command-line flags missing their arguments. So, we must be able to
prevent rendering an entire rule, when some parts of it can not be
rendered due to missing data. That is currently implemented using three
macros: syntaxrule, datarule, and datafield.</p>
<ul class="simple">
<li><p>syntaxrule wraps the contents of a syntax rule and renders it only
when at least one of the included datarules will be rendered.</p></li>
<li><p>datarule wraps the contents of a data rule and renders it only when
all of the included datafields contain data. It informs the enclosing
syntaxrule whether the data rule will be rendered.</p></li>
<li><p>datafield wraps an individual data item. If the wrapped value is
empty, the enclosing datarule will not be rendered.</p></li>
</ul>
<p>The syntaxrule and datarule macros are applied automatically by the
framework code, so users should only be concerned about datafield. All
data items in the data rules must be marked as such using this macro,
for example:</p>
<p><code class="docutils literal notranslate"><span class="pre">email:{{ipa.datafield(subject.mail.0)|quote}}</span></code></p>
</section>
</section>
<section id="alternatives-considered">
<span id="id21"></span><h1>Alternatives considered<a class="headerlink" href="#alternatives-considered" title="Permalink to this heading">¶</a></h1>
<section id="template-languages">
<span id="id22"></span><h2>Template languages<a class="headerlink" href="#template-languages" title="Permalink to this heading">¶</a></h2>
<p>Several possible tools were considered and tested for implementing these
relationships before settling on jinja2:</p>
<ul class="simple">
<li><p>For prototyping only: built-in python code. This could take advantage
of the ability to query the API from within FreeIPA. However, it
would be unsafe to allow administrators to add new mappings that run
arbitrary code, so this does not satisfy the goal of giving
administrators the ability to define their own mappings.</p></li>
<li><p>Jinja2. Nice because it doesn’t reinvent the wheel by defining a new
syntax, but would add a dependency to FreeIPA. Would also probably
need to use its sandboxing features to prevent becoming a vector for
arbitrary code execution.</p></li>
<li><p>Custom syntax, perhaps similar to <a class="reference external" href="https://git.fedorahosted.org/cgit/slapi-nis.git/plain/doc/format-specifiers.txt">NIS format
specifiers</a>.
Would only need to define syntax for what we need, but a whole
language would need to be defined and implemented.</p></li>
</ul>
</section>
<section id="data-interpolation">
<span id="id23"></span><h2>Data interpolation<a class="headerlink" href="#data-interpolation" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="http://blog.benjaminlipton.com/2016/07/19/csr-generation-templating.html">This blog
post</a>
(<a class="reference external" href="V4/Automatic_Certificate_Request_Generation/Thinking_About_Templating_Post">archived
here</a>)
analyzes some alternative ways of using jinja2 to format rules, besides
the current option of substituting data rules into syntax rules.</p>
</section>
<section id="rule-suppression-1">
<span id="id24"></span><h2>Rule suppression<a class="headerlink" href="#rule-suppression-1" title="Permalink to this heading">¶</a></h2>
<p>In retrospect, the definitions of the syntaxrule, datarule, and
datafield macros are difficult to understand and modify, in part because
it is difficult to avoid introducing unintended whitespace into the
produced output. As a result of this, the code has a couple of minor
bugs where sections are produced that should not be, which are difficult
to fix because of the brittleness of the macros. We may want to consider
an alternative implementation, such as:</p>
<ul class="simple">
<li><p>It may be possible to write a more flexible implementation as a
jinja2 tag rather than macros. Although not necessarily easier to
understand, a parser extension might be able to handle the
relationship between syntax rules, data rules, data fields, and
openssl sections better because it has access to the internal AST of
the template.</p></li>
<li><p>Instead of simply rendering things to see if they produce output, we
could explicitly tag data rules with the data items they depend on.
Then we could automatically insert <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">if</span> <span class="pre">%}</span></code> statements into the
code to suppress things when those data items are unavailable. Of
course, if the tagged data items were incorrect the suppression would
not work correctly.</p></li>
<li><p>Finally, if we were interpolating user data during each render rather
than just the final one (<a class="reference external" href="http://blog.benjaminlipton.com/2016/07/19/csr-generation-templating.html#two-pass-data-interpolation">this
solution</a>
for example) we could easily drop any rules that didn’t produce
output. However, then we would be at much higher risk of template
injection attacks.</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../_sources/archive/pages/V4/Automatic_Certificate_Request_Generation/Mapping_Rules.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
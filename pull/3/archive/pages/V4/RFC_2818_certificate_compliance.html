<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Refactorings and infrastructure improvements" href="Refactorings.html" />
    <link rel="prev" title="Overview" href="Pull-Request_CI.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="http://tools.ietf.org/html/rfc2818#section-3.1">RFC 2818 - HTTP Over
TLS</a> deprecates the
practice of carrying the subject hostname in the Subject DN Common Name
(CN) field. Pursuant to RFC 2818 some TLS libraries now issue warnings
when they encounter certificates that do not have the DNS name at which
the service was accessed in the subjectAltName (SAN) extension. FreeIPA
currently does not take measures to ensure that host or service
certificates it issues are compliant with RFC 2818. This design proposes
a measure to, where appropriate, copy the contents of the CN into the
subjectAltName extension as a dNSName, resulting in an RFC
2818-compliant certificate.</p>
<p><a class="reference external" href="https://tools.ietf.org/html/rfc6125">RFC 6125 - Best Practices for Checking of Server Identities in the
Context of Transport Layer Security
(TLS)</a> further clarifies that
certificates SHOULD include a DNS-ID and that CAs SHOULD NOT issue
certificates with a CN-ID unless another specification explicitly
requires or encourages it. RFC 6125 has greater scope than this design,
all work for this design should comply with RFC 6125.</p>
<p><a class="reference external" href="http://tools.ietf.org/html/rfc5280#section-4.1.2.6">RFC 5280</a>
defines the maximum length of the CN to be 64 characters (the maximum
size in bytes depends on the string encoding used). It is now common to
encounter DNS names longer than 64 characters, particularly in cloud
infrastructure (see ticket
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4415">#4415</a> for an example
of an issue caused by hostnames exceeding this limit). To support
service and host certificates where the hostname is longer than 64
characters, FreeIPA must support carrying the subject information in the
subjectAltName extension <em>only</em> (the subjectAltName extension must be
marked <em>critical</em> in this scenario).</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<p>Per the overview, the goal of this design is to avoid deprecated ways of
providing subject naming information in a certificate (which some TLS
libraries are now warning about) and to support subject DNS names longer
than 64 characters.</p>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="copying-cn-to-san-dnsname">
<span id="id1"></span><h2>Copying CN to SAN dNSName<a class="headerlink" href="#copying-cn-to-san-dnsname" title="Permalink to this heading">¶</a></h2>
<p>This measure involves the creation of a new Dogtag profile component
that, on profiles that enable it, performs the following steps:</p>
<ol class="arabic simple">
<li><p>Retrieve the Subject Common Name from the certificate data.</p></li>
<li><p>Retrieve the subjectAltName extension from the certificate data, or
create an empty subjectAltName extension if it does not exist.</p></li>
<li><p>Search the subjectAltName extension for a dNSName value that matches
the Common Name. If not found, add the Common Name to the
subjectAltName extension as a dNSName.</p></li>
</ol>
<p>The component shall be called <code class="docutils literal notranslate"><span class="pre">SubjectAltNameCopyCNDefault</span></code>. Its
instantiation shall be called <code class="docutils literal notranslate"><span class="pre">subjectAltNameCopyCNDefaultImpl</span></code>. The
<code class="docutils literal notranslate"><span class="pre">caIPAserviceCert</span></code> profile shall be updated to use this profile
component.</p>
<section id="caveats">
<h3>Caveats<a class="headerlink" href="#caveats" title="Permalink to this heading">¶</a></h3>
<p>The profile component that performs these steps must execute after other
profile components that add or modify the Common Name and subjectAltName
extension. It is preferable that this condition be encoded as part of
the definition of the component itself, such that Dogtag can enforce it.
However, if this is not possible, it would be required that the profile
configuration introduce the component after the other components which
must run first; any such requirement must be clearly documented.</p>
</section>
</section>
<section id="san-only-certificate-support">
<span id="id2"></span><h2>SAN-only certificate support<a class="headerlink" href="#san-only-certificate-support" title="Permalink to this heading">¶</a></h2>
<p>Let’s first clarify the requirement for SAN-only certificates:</p>
<ol class="arabic">
<li><p>A DNS name longer than 64 characters <em>cannot</em> be carried in the CN
but can (and therefore must) be carried as a dNSName value in the
subjectAltName extension.</p></li>
<li><p>In the absense of other distinguishing data in the Subject DN, the
entire Subject DN must be the empty sequence, because RFC 5280
states:</p>
<blockquote>
<div><p>Where it is non-empty, the subject field MUST contain an X.500
distinguished name (DN). The DN MUST be unique for each subject
entity certified by the one CA as defined by the issuer field.</p>
</div></blockquote>
</li>
<li><p>If the Subject DN is empty, the subjectAltName extension must be
marked <em>critical</em>.</p></li>
</ol>
<p>The existing subject name profile policy component,
<code class="docutils literal notranslate"><span class="pre">SubjectNameDefault</span></code>, does not offer enough flexibility to handle
either the presence or absense of a Subject DN field (e.g. CN). For
example, the <code class="docutils literal notranslate"><span class="pre">caIPAserviceCert</span></code> profile configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>policyset.serverCertSet.1.default.class_id=subjectNameDefaultImpl
policyset.serverCertSet.1.default.name=Subject Name Default
policyset.serverCertSet.1.default.params.name=CN=$request.req_subject_name.cn$,O=IPA.LOCAL
</pre></div>
</div>
<p>shows that:</p>
<ul class="simple">
<li><p>The “substituted” Subject DN will be invalid if there is no CN in the
CSR. (The <code class="docutils literal notranslate"><span class="pre">&quot;CN=&quot;</span></code> key is an immutable part of the template string),
and;</p></li>
<li><p>There is no mechanism that provides for “optional” fields in the
Subject DN. (A separate profile would be needed).</p></li>
</ul>
<section id="subjectnamefieldsdefault-profile-policy-component">
<span id="id3"></span><h3><code class="docutils literal notranslate"><span class="pre">SubjectNameFieldsDefault</span></code> profile policy component<a class="headerlink" href="#subjectnamefieldsdefault-profile-policy-component" title="Permalink to this heading">¶</a></h3>
<p>It is clear that a new Subject Name profile policy component is needed
to handle the case of possibly-absent Subject DN fields. This component
would need to support configuration that allows a profile to define:</p>
<ul class="simple">
<li><p>Which Subject DN fields, if any, are optional (if any)</p></li>
<li><p>Which Subject DN fields, if absent, cause the final Subject DN to be
the empty sequence (i.e. fields that <em>distinguish</em> the subject).</p></li>
</ul>
<p>With these requirements in mind, a configuration suitable to replace the
above configuration would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>policyset.serverCertSet.1.default.class_id=subjectNameFieldsDefaultImpl
policyset.serverCertSet.1.default.name=Subject Name Fields Default
policyset.serverCertSet.1.default.params.cn=$request.req_subject_name.cn$
policyset.serverCertSet.1.default.params.o=IPA.LOCAL
policyset.serverCertSet.1.default.params.excludeIfEmpty=cn
policyset.serverCertSet.1.default.params.emptySubjectIfFieldEmpty=cn
policyset.serverCertSet.1.default.params.order=cn,o
</pre></div>
</div>
<p>Breaking this configuration down:</p>
<ul class="simple">
<li><p>A template is provided for each field (<code class="docutils literal notranslate"><span class="pre">cn</span></code>, <code class="docutils literal notranslate"><span class="pre">o</span></code>, etc.) that
<em>may</em> be included in the final Subject DN. The existing template
substitution mechanism is used to format the value for each field.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">excludeIfEmpty</span></code> parameter is a (possibly empty)
comma-separated list of fields that shall be omitted from the final
Subject DN if their values (after substitution) are empty. It is an
error if a field that is <em>not</em> included in the list is empty (after
substitution). This parameter is <strong>optional</strong> and defaults to the
empty list.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">emptySubjectIfFieldEmpty</span></code> parameter is a (possibly empty)
comma-separated list of fields that if empty (after substitution)
cause the final Subject DN to be the empty list. This parameter is
<strong>optional</strong> and defaults to the empty list.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">order</span></code> parameter is a comma-separated list defining the order
(from “most specific” to “least specific”) of the RDNs in the final
Subject DN. This parameter is <strong>required</strong>. Each listed field must
have a corresponding template in the configuration.</p></li>
</ul>
<p>The profile policy component shall be called
<code class="docutils literal notranslate"><span class="pre">SubjectNameFieldsDefault</span></code>. Its instantiation shall be called
<code class="docutils literal notranslate"><span class="pre">subjectNameFieldsDefaultImpl</span></code>. The <code class="docutils literal notranslate"><span class="pre">caIPAserviceCert</span></code> profile shall
be updated to use this component instead of <code class="docutils literal notranslate"><span class="pre">SubjectNameDefault</span></code>.</p>
</section>
<section id="marking-the-san-extension-as-critical">
<span id="id4"></span><h3>Marking the SAN extension as critical<a class="headerlink" href="#marking-the-san-extension-as-critical" title="Permalink to this heading">¶</a></h3>
<p>The SAN extension must be marked critical when subject naming
information is present only the subjectAltName extension.</p>
<p><strong>TODO</strong> need to define mechanism to achieve this. It would definitely
be possible with another profile component to run at the end, but a less
intrusive mechanism would be better.</p>
</section>
<section id="ipa-cert-request-changes">
<span id="id5"></span><h3><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-request</span></code> changes<a class="headerlink" href="#ipa-cert-request-changes" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-request</span></code> command must be updated to handle CSRs where no
subject information is carried in CSR Subject DN (CN field in
particular). This will be achieved with the following changes.</p>
<ul class="simple">
<li><p>Initialise an empty <em>DNS names</em> list.</p></li>
<li><p>The existing “CN matches principal name” check is deferred for
certificate requests where the target principal is a <em>host</em> or
<em>service</em>. (The check is retained for <em>user</em> principals).</p></li>
<li><p>For hosts and services, the CN, if present, is appended to the list
of <em>DNS names</em>.</p></li>
<li><p>For each dNSName in the subjectAltName extension, ensure that the
name corresponds to a principal that is <em>managed by</em> the target
principal, then append the name to the list of <em>DNS names</em>.</p></li>
<li><p>For hosts and services, after processing of the SAN extension is
complete, ensure that one name in the <em>DNS names</em> list matches the
target principal. This is to prevent issuance of a certificate that
omits the target principal.</p></li>
</ul>
</section>
</section>
<section id="wildcard-certificates">
<span id="id6"></span><h2>Wildcard certificates<a class="headerlink" href="#wildcard-certificates" title="Permalink to this heading">¶</a></h2>
<p>FreeIPA currently does not support wildcard certificates, although
<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3475">ticket #3475</a> is an
RFE to support them. It should also be noted that <a class="reference external" href="https://tools.ietf.org/html/rfc6125">RFC
6125</a> essentially deprecates the
issuance of wildcard certificates, but several established use cases
still require them.</p>
<p>Regarding this design, no special handling of names containing wildcards
is required. Enforcement of restrictions on where wildcards may appear
in names is assumed. The <code class="docutils literal notranslate"><span class="pre">SubjectAltNameCopyCNDefault</span></code> component, if
used, will copy a CN whether or not it contains a wildcard. Wildcards
are also allowed in SAN dNSNames, so there is no bearing on SAN-only
certificates.</p>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>No UI or CLI is required to manage these features.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">certutil</span></code> instructions “New certificate for Host/Service” dialog
in the Web UI should be updated to indicate how to add a DNS names to
the subjectAltName request extension, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># certutil -R -d &amp;lt;database path&amp;gt; -a -g &amp;lt;key size&amp;gt;</span>
  <span class="o">-</span><span class="n">s</span> <span class="s1">&#39;CN=f23-2.ipa.local,O=IPA.LOCAL&#39;</span> <span class="o">-</span><span class="mi">8</span> <span class="s1">&#39;f23-2.ipa.local&#39;</span>
</pre></div>
</div>
<p>The new Dogtag profile policy components must be documented so that
administrators can understand their purpose and how to use them in
custom profiles.</p>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
<p>Each CA clone has the file <code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/ca/registry.cfg</span></code>,
which defines the name and class of each profile policy component to
instantiate. This file must be updated to instantiate the new profile
policy components. This should be done as part of Dogtag’s upgrade
procedure.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">caIPAserviceCert</span></code> profile configuration must be updated to use
the new profile policy components. Because FreeIPA now owns its
profiles, this shall be done as part of the FreeIPA upgrade procedure.</p>
</section>
<section id="how-to-test">
<span id="how-to-test33"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
</section>
<section id="test-plan">
<span id="test-plan33"></span><h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="V4/RFC_2818_certificate_compliance/Test_Plan">RFC 2818 certificate compliance V4.4 test
plan</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/RFC_2818_certificate_compliance.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
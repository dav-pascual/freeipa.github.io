<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="External_DNS_integration_with_installer.html" />
    <link rel="prev" title="Overview" href="Extdom_plugin_enhancement_grouplist.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>In modern systems sometimes users need to be allowed to authenticate
using alternative protocols, like Federation protocols (SAML) or
Hardware Security Modules like Smart Cards (X509). This Feature captures
the changes needed to allow these alternative authentication methods to
interact with the FreeIPA UI and HTTP RPC pipes.</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<p>An Active Directory Domain User uses ADFS (SAML) to authenticate to a
trusted IPA server, the user is known to the system but doesn’t have
Krb5 creds to interact with the framework.</p>
<p>A Smartcard owner wants to log in to the Web UI using the smartcard
without having to rely on PKINIT for Single Sign On. The user can be
authenticated via X509 certs to Apache but lacks krb5 creds to interact
with the framework.</p>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>The solution is to allow the apache authentication modules to map the
user to an identity known by IPA and then impersonate the user by
requesting a ticket from the KDC (Protocol Transitioning).</p>
<figure class="align-default" id="id6">
<img alt="Ext-Auth.svg" src="../../../_images/Ext-Auth.svg" /><figcaption>
<p><span class="caption-text">Ext-Auth.svg</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The image above represent the final architecture implementing external
authentication.</p>
<section id="workflows">
<h2>Workflows<a class="headerlink" href="#workflows" title="Permalink to this heading">¶</a></h2>
<p>The classic workflow where mod_auth_gssapi obtains a ticket and stores
it in a credential cache to be used by the ipa sever framework changes
to handle two different workflows: - External Authentication workflow. -
Negotiate authentication with kerberos credentials workflow. The form
based authentication internal workflow also changes slightly but it is
substantially the same as the Negotiate workflow so it won’t be
explicitly covered.</p>
<section id="external-authentication-workflow">
<span id="id1"></span><h3>External Authentication workflow<a class="headerlink" href="#external-authentication-workflow" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>A user authenticates to an Apache module (A1)</p></li>
<li><p>After positive authentication the mod_lookup_identity module matches
the authenticated user to the correct IPA user via SSSD (A2).</p></li>
<li><p>With the correct principal name, mod_auth_gssapi performs a s4u2self
operation to obtain a ticket for the HTTP service on behalf of the
authenticating users (A3). The s4u2self step is actually done via
privilege separation interposition by gssproxy.</p></li>
<li><p>An (encrypted) credential is returned to mod_auth_gssapi, which
proceeds to store it in a ccache file (A4) that can be read by both
the Apache user and the ‘ipaapi’ user used to run the framework.</p></li>
<li><p>The workflow proceeds with step X described later.</p></li>
</ol>
</section>
<section id="negotiate-authentication-with-kerberos-credentials-workflow">
<span id="id2"></span><h3>Negotiate authentication with kerberos credentials workflow<a class="headerlink" href="#negotiate-authentication-with-kerberos-credentials-workflow" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>A user with a kerberos ticket authenticates to mod_auth_gssapi (B1),
this happens via gssproxy interposition (B2) as the Apache server
does not have direct access to the HTTP keytab.</p></li>
<li><p>An (encrypted) credential is returned to mod_auth_gssapi, which
proceeds to store it (B3) in a ccache file that can be read by both
the Apache user and the ‘ipaapi’ user used to run the framework.</p></li>
<li><p>The wrokflow proceeds with step X described later.</p></li>
</ol>
</section>
<section id="applications-operations">
<span id="id3"></span><h3>Applications operations<a class="headerlink" href="#applications-operations" title="Permalink to this heading">¶</a></h3>
<blockquote>
<div><p>X. When the applications (ipa framewrok/dogtag/etc..) needs to talk
to the LDAP server (C1) it performs the usual s4u2proxy step using
these encrypted credentials (C2). the encrypted credentials are read
from the file ccache and are passed back to gssproxy which performs
the actual s4u2proxy operation as well as the context establishment
operation between HTTP and LDAP.</p>
</div></blockquote>
</section>
</section>
<section id="main-changes">
<span id="id4"></span><h2>Main Changes<a class="headerlink" href="#main-changes" title="Permalink to this heading">¶</a></h2>
<p>A few key changes to the current FreeIPA framework setup are needed:</p>
<ul class="simple">
<li><p>GSS-Proxy will need to be started on the box and given exclusive
access to the HTTP keytab, the configuration of GSS-Proxy must allow
impersonation only by the apache process (either via SELinux labels
or process uid) and allow proxying only by the Framework process
(again SELinux labels or process uid).
<a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/4189">4189</a></p></li>
<li><p>All the processes comprising the FreeIPA framework (Apache, framework
user, helper scrips) will need to be configured to be intercepted by
GSS-Proxy <a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/4189">4189</a></p></li>
<li><p>The Framework will need to be moved to a separate process interfaced
via mod_wsgi, so that the framework is not operating as the apache
user. <a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/5959">5959</a></p></li>
<li><p>credentials caches will need to be passed between the apache process
and the framework process, either by setting up a shared file area,
or by message passing of some kind (initially a shared file area
where both the apache user and the framework user can write is
probably sufficient).</p></li>
<li><p>The dogtag integration will finally need to be changed to use GSSAPI
authentication instead of using a certificate for the RA agent.
<a class="reference external" href="https://www.fedorahosted.org/freeipa/ticket/5011">5011</a> (this
step can be done separately after the rest)</p></li>
</ul>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>The implementation requires changed to mod_auth_gssapi
(<a class="reference external" href="https://github.com/modauthgssapi/mod_auth_gssapi/pull/92">PR92</a>)
and other parts of the apache authentication configuration. It also
requires the introduction of GSS-Proxy to properly separate privileges
between the components.</p>
<ul class="simple">
<li><p><strong>Dependencies</strong>:</p>
<ul>
<li><p>New mod_auth_gssapi module including upstream PR92</p></li>
<li><p>New GSS-Proxy including access control for s4u2self VS s4u2proxy
functionality</p></li>
</ul>
</li>
</ul>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<p>How the feature will be managed via the Web UI.</p>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<p>Authntication plugins for the CLI are TBD, the first goal is to get the
browser workflow working.</p>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<p>Any configuration options? Any commands to enable/disable the feature or
turn on/off its parts?</p>
</section>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
<p>Configureation changes will be needed in various parts of FreeIPA. The
Framework will need to operate as a different user from the local apache
user:</p>
<ul class="simple">
<li><p>Create a new system user</p></li>
<li><p>Change/check file permissions for this new user</p></li>
<li><p>Change/check access permissions for any socket based interaction</p></li>
</ul>
<p>GSS-Proxy needs to be started:</p>
<ul class="simple">
<li><p>New service to be started by FreeIPA</p></li>
<li><p>New configuration snippets specific to the FreeIPA use case</p></li>
<li><p>SELinux Policy to make sure all the parts can properly communicate
with GSS-Proxy</p></li>
<li><p>IPA Keytab permissions need to be changed so that only GSS-Proxy can
access it</p></li>
</ul>
</section>
<section id="how-to-use">
<h1>How to Use<a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h1>
<p>Easy to follow instructions how to use the new feature according to the
<a class="reference external" href="#Use_Cases">use cases</a> described above. FreeIPA user needs to be
able to follow the steps and demonstrate the new features.</p>
<p>The chapter may be divided in sub-sections per <a class="reference external" href="#Use_Cases">Use
Case</a>.</p>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p>Test scenarios that will be transformed to test cases for FreeIPA
<a class="reference external" href="V3/Integration_testing">Continuous Integration</a> during
implementation or review phase. This can be also link to <a class="reference external" href="https://git.fedorahosted.org/cgit/freeipa.git/">source in
cgit</a> with the test,
if appropriate.</p>
</section>
<section id="external-links">
<span id="id5"></span><h1>External links<a class="headerlink" href="#external-links" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="V4/External_Authentication/Setup">The current smart card/x509 certificate
setup</a></p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/gss-proxy/ticket/133_GSS-Proxy_ticket">https://fedorahosted.org/gss-proxy/ticket/133 GSS-Proxy
ticket</a></p></li>
<li><p><a class="reference external" href="V4/External_Authentication/NSS_Impersonation">Using mod_nss’s NSSVerifyClient require + LookupUserByCertificate +
GssapiImpersonate</a>
– developer investigation</p></li>
</ul>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/External_Authentication.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
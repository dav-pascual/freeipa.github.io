<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Introduction &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Architecture" href="Architecture.html" />
    <link rel="prev" title="*** DRAFT VERSION - WORK IN PROGRESS TO BE COMPLETED ***" href="Apache_Group_Based_Authorization.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p><strong>Apache Namebased SSL VirtualHosts with optional kerberos login</strong></p>
<section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h1>
<p>Apache 2.2.12 added SNI to the TLS support of mod_ssl and RHEL6 brought
2.2.15 which then includes this.</p>
<p>This technology allows for multiple sites utilising a single IP - with
their own certificates … basically name based virtual hosting for SSL
enabled sites.</p>
<p>There are a couple of caveats however - this capability is client
dependant as well as server dependant - an approximate list can be found
<a class="reference external" href="http://en.wikipedia.org/wiki/Server_Name_Indication">here</a> - and
since this requires the host header in the initial request it leaves it
open to packet inspection and logging unlike traditional SSL.</p>
<p>The dogtag part of IPA can be used to handle these certificates and
optionally IPA can handle the login details afterwards.</p>
<p>This documentation is an example from my own implementations at my
workplace.</p>
</section>
<section id="ipa-sssd-configuration">
<span id="ipasssd-configuration"></span><h1>IPA/SSSD Configuration<a class="headerlink" href="#ipa-sssd-configuration" title="Permalink to this heading">¶</a></h1>
<p>SSSD does not need any special configuration however if:</p>
<p>`` ipa-getcert list``</p>
<p>shows any errors such as CA_UNREACHABLE when there are multiple replicas
in the topology it is worth checking</p>
<p>`` /etc/ipa/default.conf``</p>
<p>to see which server is being used for certificate requests. Ensure that
the server is accepting requests against the IPA topology and kerberos
tickets are being generated before continuing.</p>
</section>
<section id="apache-configuration">
<span id="id1"></span><h1>Apache Configuration<a class="headerlink" href="#apache-configuration" title="Permalink to this heading">¶</a></h1>
<p>There are several parts to this. Initially the default host will be
configured to ensure there are no basic issues before adding the
complexity of SNI. This guide assumes selinux is enforcing with the
default targeted type in RHEL6.</p>
<section id="default-ssl-apache-config">
<span id="id2"></span><h2>Default SSL apache config<a class="headerlink" href="#default-ssl-apache-config" title="Permalink to this heading">¶</a></h2>
<p>Before carrying out configuration of the web server on a system with
ipa-admintools:</p>
<p>`` ipa service-add HTTP/``</p>
<p>This adds the service to IPA for the purposes of adding an SSL
certificate to it and then later on for a keytab to the kerberos
principal.</p>
<p>As usual the only requirements to install an SSL capable web server are:</p>
<p>`` yum install httpd mod_ssl``</p>
<p>which will provide for a self signed standard HTTPS server with content
served from /var/www/html.</p>
<p>Certmonger and Apache will need a common area to read and/or write
certificates as such I’d recommend creating a directory for these such
as /etc/httpd/certs.</p>
<p>Certmonger needs to be allowed to write to this area - although it runs
as root selinux will restrict it:</p>
<p>`` semanage fcontext -a -t cert_t ‘/etc/httpd/certs(/.*)?’ &amp;&amp; restorecon -v /etc/httpd/certs``</p>
<p>The apache process is able to read directories of type cert_t to obtain
its certificates and certmonger can then write to this safely.</p>
<p>A certificate/key pair can then be requested through certmonger on the
web server for the default instance via:</p>
<p>:literal:` ipa-getcert request -r -f /etc/httpd/certs/default.crt -k /etc/httpd/certs/default.key -N CN=`uname -n` -D <cite>uname -n</cite> -K HTTP/<cite>uname -n`</cite></p>
<p>To check the status of the request use:</p>
<p>`` ipa-getcert list``</p>
<p>If all is well there should be output similar to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Request</span> <span class="n">ID</span> <span class="s1">&#39;20120618111406&#39;</span><span class="p">:</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">MONITORING</span>
    <span class="n">stuck</span><span class="p">:</span> <span class="n">no</span>
    <span class="n">key</span> <span class="n">pair</span> <span class="n">storage</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="n">FILE</span><span class="p">,</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/certs/default.key&#39;</span>
    <span class="n">certificate</span><span class="p">:</span> <span class="nb">type</span><span class="o">=</span><span class="n">FILE</span><span class="p">,</span><span class="n">location</span><span class="o">=</span><span class="s1">&#39;/etc/httpd/certs/default.crt&#39;</span>
    <span class="n">CA</span><span class="p">:</span> <span class="n">IPA</span>
    <span class="n">issuer</span><span class="p">:</span> <span class="n">CN</span><span class="o">=</span><span class="n">Certificate</span> <span class="n">Authority</span><span class="p">,</span><span class="n">O</span><span class="o">=&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
    <span class="n">subject</span><span class="p">:</span> <span class="n">CN</span><span class="o">=&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;</span><span class="p">,</span><span class="n">O</span><span class="o">=&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
    <span class="n">expires</span><span class="p">:</span> <span class="mi">2014</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">19</span> <span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">07</span> <span class="n">UTC</span>
    <span class="n">eku</span><span class="p">:</span> <span class="nb">id</span><span class="o">-</span><span class="n">kp</span><span class="o">-</span><span class="n">serverAuth</span><span class="p">,</span><span class="nb">id</span><span class="o">-</span><span class="n">kp</span><span class="o">-</span><span class="n">clientAuth</span>
    <span class="n">track</span><span class="p">:</span> <span class="n">yes</span>
    <span class="n">auto</span><span class="o">-</span><span class="n">renew</span><span class="p">:</span> <span class="n">yes</span>
</pre></div>
</div>
<p>The files should be visible in /etc/httpd/certs - the owner should be
changed to make them readable by apache.</p>
<p>Following this edit /etc/httpd/conf.d/ssl.conf to make sure the
following entries read as so:</p>
<div class="line-block">
<div class="line">`` SSLCertificateFile /etc/httpd/certs/default.crt``</div>
<div class="line">`` SSLCertificateKeyFile /etc/httpd/certs/default.key``</div>
</div>
<p>If you require client validation link or copy /etc/ipa/ca.crt to
/etc/httpd/certs and include:</p>
<p>`` SSLCACertificateFile /etc/httpd/certs/ca.crt``</p>
<p>At the time of writing there is no GUI for client certificates in IPA so
any further configuration down that avenue is left as an exercise to the
reader.</p>
<p>Ensure that TCP/443 is open and then start httpd to give it a test. If
all is well the browser should show a certificate chain starting at the
IPA server and with the certificate requested being served. If there are
any problems here then backtrack and amend before proceeding.</p>
</section>
<section id="adding-namebased-virtual-sites-with-ssl">
<span id="id3"></span><h2>Adding NameBased Virtual Sites with SSL<a class="headerlink" href="#adding-namebased-virtual-sites-with-ssl" title="Permalink to this heading">¶</a></h2>
<p>To allow IPA to handle the certificates there’s some work that needs to
be carried out in the IPA topology before the web server is further
configured.</p>
<p>IPA requires the hostname in the services to match the hostname in the
hosts for permission reasons - without this certmonger will show a
permissions error when submitting the certificate request.</p>
<p>So the first step is to add a dummy host in the ‘hosts’ tab of IPA.</p>
<p>My preference to make this clearer as a dummy host was to put ‘dummy
host’ in the description to make it easy to search for in future and to
put the location as the fully qualified domain name of the actual host.
A DNS record should already be in place for this (or just use the
–force option when adding the host).</p>
<p>To do this via the ipa-admin tools do as follows (or just use the GUI):</p>
<div class="line-block">
<div class="line">`` ipa dnsrecord-add example.com dummyhost –a-rec=10.180.80.1``</div>
<div class="line">`` ipa host-add dummyhost.example.com –desc=”Dummy Host” –location=”<code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``&quot;</span></code></div>
<div class="line">`` ipa host-add-managedby dummyhost.example.com –hosts=”<code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``&quot;</span></code></div>
<div class="line">`` ``</div>
</div>
<p>Now that the dummy host is in place (no enrollment, keytabs or
certificates needed for this bit) the service can be added.</p>
<div class="line-block">
<div class="line">`` ipa service-add HTTP/dummyhost.example.com``</div>
<div class="line">`` ipa service-add-host HTTP/dummyhost.example.com –hosts=”<code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``&quot;</span></code></div>
</div>
<p>The IPA topology is then ready to add this as a virtual host on the web
server.</p>
<p>Back on the web server itself the new certificate can now be requested:</p>
<p>`` ipa-getcert request -r -f /etc/httpd/certs/dummyhost.crt -k /etc/httpd/certs/dummyhost.key -N CN=dummyhost.example.com -D dummyhost.example.com -K HTTP/dummyhost.example.com``</p>
<p>Checking the /etc/httpd/certs directory should show the new
certificate/key pair and as before these should be made readable to
apache.</p>
<p>Now that the backend is in place to support the virtual host apache
itself can be configured for it.</p>
<p>Configure Apache to use name based virtual hosts on port 443 (in
addition to the standard 80):</p>
<div class="line-block">
<div class="line">`` NameVirtualHost <a href="#id4"><span class="problematic" id="id5">*</span></a>:80``</div>
<div class="line">`` NameVirtualHost <a href="#id6"><span class="problematic" id="id7">*</span></a>:443``</div>
</div>
<p>Optionally add a redirect from non-SSL to SSL if you want it as a
requirement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;VirtualHost *:80&gt;
ServerName dummyhost.example.com
ServerAlias dummyhost
RewriteEngine on
RewriteRule ^/(.*)$ https://dummyhost.example.com/$1
&lt;/VirtualHost&gt;
</pre></div>
</div>
<p>And then add the SSL enabled virtual host:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;VirtualHost *:443&gt;
ServerName dummyhost.example.com
ServerAlias dummyhost
SSLEngine on
SSLProtocol all -SSLv2
SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM:+LOW
SSLCertificateFile /etc/httpd/certs/dummyhost.crt
SSLCertificateKeyFile /etc/httpd/certs/dummyhost.key
SSLOptions +StdEnvVars
&lt;Location /&gt;
SSLRequireSSL
&lt;/Location&gt;
&lt;/Virtualhost&gt;
</pre></div>
</div>
<p>All the usual SSL/VirtualHost possibilities exist - just ensure the
ServerName is present in the configuration.</p>
<p>If a client does not support SNI then the first virtual host defined
will be used for any SSL session - similar to a non HTTP/1.1 client
requesting a site from a name based virtual host system.</p>
<p>The exception to this is using
<a class="reference external" href="http://httpd.apache.org/docs/2.2/mod/mod_ssl.html#sslstrictsnivhostcheck">SSLStrictSNIVHostCheck</a>
to alter the behaviour as described in the Apache documentation.</p>
<p>Restart the httpd service and check the logs - if all is working the
following should appear in error_log:</p>
<p>`` [Mon Jun 18 13:25:44 2012] [warn] Init: Name-based SSL virtual hosts only work for clients with TLS server name indication support (RFC 4366)``</p>
<p>At this point <a class="reference external" href="https://dummyhost.example.com">https://dummyhost.example.com</a> should then work to show the
virtual host as defined and the certificate chain should be
IPA-&gt;dummyhost when checked. If the IPA root certificate is trusted by
the browser then there should be no certificate errors (name mismatches
etc)… if there are any errors double check the logs and permissions on
the certificates.</p>
<p>This procedure can be repeated for additional virtual hosts off the same
server as required.</p>
</section>
<section id="adding-kerberos-authentication-to-the-sites">
<span id="id8"></span><h2>Adding kerberos authentication to the sites<a class="headerlink" href="#adding-kerberos-authentication-to-the-sites" title="Permalink to this heading">¶</a></h2>
<p>With the sites having communication to the clients encrypted with SSL
authentication can then be added. This authentication can be added
without SSL but be aware that if fallback is enabled in mod_auth_kerb
this will be basic authentication (ie insecure) without SSL in place.</p>
<p>Add the appropriate module for kerberos authentication on the web
server:</p>
<p>`` yum install mod_auth_kerb``</p>
<p>Create a directory to store keytabs for authenticating against IPA:</p>
<div class="line-block">
<div class="line">`` mkdir /etc/httpd/keytabs``</div>
<div class="line">`` semanage fcontext -a -t httpd_keytab_t ‘/etc/httpd/keytabs/(.*)?’``</div>
</div>
<p>Note that with the selinux context the directory should maintain the
httpd_config_t type (default for anything in /etc/httpd/) but only the
contents has the httpd_keytabs_t type.</p>
<p>The default keytab for the host (for any ‘default’ site requests) can be
obtained via:</p>
<p>`` ipa-getkeytab -s <a href="#id9"><span class="problematic" id="id10">``</span></a>:literal:` -p HTTP/<cite>uname -n</cite> -k /etc/httpd/keytabs/default`</p>
<p>To get a site specific keytab use:</p>
<p>`` ipa-getkeytab -s <code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">`` -p HTTP/dummyhost.example.com -k /etc/httpd/keytabs/dummyhost</span></code></p>
<p>Although segregation of keytabs isn’t necessarily required (all hosts
could use the default keytab in principle) separation allows for fine
grained controls later on when integrating with other systems.</p>
<p>Check the contents of the keytab to ensure the expected principals are
present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klist</span> <span class="o">-</span><span class="n">k</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">default</span>
<span class="n">Keytab</span> <span class="n">name</span><span class="p">:</span> <span class="n">WRFILE</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">default</span>
<span class="n">KVNO</span> <span class="n">Principal</span>
<span class="o">----</span> <span class="o">--------------------------------------------------------------------------</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/&lt;</span><span class="n">fqdn</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">webserver</span><span class="o">&gt;@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>

<span class="n">klist</span> <span class="o">-</span><span class="n">k</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">dummyhost</span>
<span class="n">KVNO</span> <span class="n">Principal</span>
<span class="o">----</span> <span class="o">--------------------------------------------------------------------------</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
   <span class="mi">1</span> <span class="n">HTTP</span><span class="o">/</span><span class="n">dummyhost</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">@&lt;</span><span class="n">KERBEROS</span><span class="o">-</span><span class="n">REALM</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>To require login for all pages in a virtual host add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">Location</span> <span class="o">/&gt;</span>
  <span class="n">AuthType</span> <span class="n">Kerberos</span>
  <span class="n">AuthName</span> <span class="s2">&quot;Web Server Login&quot;</span>
  <span class="n">KrbMethodNegotiate</span> <span class="n">On</span>
  <span class="n">KrbMethodK5Passwd</span> <span class="n">On</span>
  <span class="n">Krb5KeyTab</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">keytabs</span><span class="o">/</span><span class="n">default</span>
  <span class="n">require</span> <span class="n">valid</span><span class="o">-</span><span class="n">user</span>
<span class="o">&lt;/</span><span class="n">Location</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For a non-default keytab (eg the dummyhost above) add/amend as
appropriate:</p>
<div class="line-block">
<div class="line">`` KrbServiceName HTTP/dummyhost.example.com``</div>
<div class="line">`` Krb5KeyTab /etc/httpd/keytabs/dummyhost``</div>
</div>
<p>The REMOTE_USER environment variable will be set to username&#64; by
default. For some systems it’s preferable to just have the shorter
‘username’. This behaviour is obtainable by adding:</p>
<p>`` KrbLocalUserMapping On``</p>
<p>If it is desirable to disable the basic authentication fallback and
restrict the system to kerberos tokens only change KrbMethodK5Passwd to
off and leave KrbMethodNegotiate on.</p>
</section>
</section>
<section id="conclusion">
<h1>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this heading">¶</a></h1>
<p>If all the steps above have been followed and everything is working
properly the server should then be configured in such a way new virtual
hosts can easily be added to present new sites each with their own SSL
certificates (being tracked and renewed via certmonger) and the IPA
infrastructure being utilised for all authentication on a standard RHEL6
install with nothing outside of the standard RHEL repositories.</p>
<p><a class="reference external" href="Category:CheckUpdate">Category:CheckUpdate</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/Apache_SNI_With_Kerberos.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
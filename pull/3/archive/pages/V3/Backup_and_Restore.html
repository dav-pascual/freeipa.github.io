<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="CA-less_install.html" />
    <link rel="prev" title="Map of the UI - Full Size" href="../V2/Second_Round_Of_UI_design/mapofui_fullsize.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="Backup_and_Restore">Backup and Restore</a> is a loaded topic that means
different things to different people. The general principle that has
driven IPA to date is to run several masters as a way to ensure that
data is preserved in case of catastrophic failure. So back up has meant
continuity of service by keeping several copies of the data in multiple
servers.</p>
<p>Backup can also mean offline backups, for which our answer has been to
fully back up a machine. We have been resistant to providing a list of
files to back up because this has been a moving target as new services
are added and others are enhanced (like switching from the MIT LDAP
backend to our own).</p>
<p>This design will focus on the following scenarios:</p>
<ol class="arabic simple">
<li><p>Critical IPA system backup and restoration</p></li>
<li><p>LDAP data backup and restoration</p></li>
</ol>
<p>To be done later:</p>
<ol class="arabic simple">
<li><p>Partial data restoration (pick and choose entries to restore)</p></li>
</ol>
<p>Full metal backup is left as an exercise for the system administrator.
The only requirement is that the backup be done with the IPA services
offline.</p>
</section>
<section id="use-cases">
<span id="use-cases110"></span><h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<section id="catastrophic-hardware-failure-on-a-machine">
<span id="id1"></span><h2>Catastrophic hardware failure on a machine.<a class="headerlink" href="#catastrophic-hardware-failure-on-a-machine" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Backup would be full-metal or VM snapshot</p></li>
<li><p>Restore would be full-metal or restore VM snapshot</p></li>
</ul>
<p>Basically, the machine dies. You use a full system backup, done using
your preferred method.</p>
<p>An optional method would be:</p>
<ul class="simple">
<li><p>Reinstall the OS from scratch</p></li>
<li><p>Configure with same FQDN, hostname</p></li>
<li><p>Install IPA packages</p></li>
<li><p>Restore from an IPA full backup</p></li>
</ul>
<p>This carries some limited risk that the packages do not match exactly,
or that the administrator forgets to install some optional packages like
bind, bind-dyndb-ldap, samba4-<a href="#id2"><span class="problematic" id="id3">*</span></a>, etc.</p>
<p>Once restored, replication will handle applying any missing changes. The
replication protocol will detect if a replica is too out of date. In
this case a re-init would be required.</p>
</section>
<section id="failed-upgrade-on-an-isolated-machine">
<span id="id4"></span><h2>Failed upgrade on an isolated machine.<a class="headerlink" href="#failed-upgrade-on-an-isolated-machine" title="Permalink to this heading">¶</a></h2>
<p>The OS is still fine but the IPA data is somehow corrupted in such a way
that you want to restore to a known good state.</p>
<p>This one is a bit more complicated, as it is not predictable what an
upgrade might touch. One could in theory simply do a restoration of the
files that we back up and the IPA data but this wouldn’t cover, for
example, any new services that were enabled as part of the upgrade.</p>
<p>In other words we could only restore the files we know about. The data
is another matter, see <a class="reference external" href="V3/Backup_and_Restore#Returning_to_a_known_good_state">Returning to a known good
state</a></p>
</section>
<section id="restore-accidentally-deleted-data">
<span id="id5"></span><h2>Restore Accidentally deleted data<a class="headerlink" href="#restore-accidentally-deleted-data" title="Permalink to this heading">¶</a></h2>
<p>This will need to be covered separately. There are currently no tools or
processes for restoring individual LDAP entries. This will be
investigated with help from the 389-ds team. The issues are:</p>
<ul class="simple">
<li><p>A tool to pick the entries to be restored</p></li>
<li><p>How to deal with uuid, modifiedby, creator, etc.</p></li>
<li><p>How to restore a deleted entry w/o the changelog intervening</p></li>
<li><p>How automatically to deal with membership and other relationships</p></li>
<li><p>What to do when restoring managed entries</p></li>
</ul>
</section>
<section id="returning-to-a-known-good-state">
<span id="id6"></span><h2>Returning to a known good state<a class="headerlink" href="#returning-to-a-known-good-state" title="Permalink to this heading">¶</a></h2>
<p>Because we lack the ability to restore individual entries, the most that
one can do is restore to a last known good state. This requires that ALL
masters be restored at the same time, and all offline, until they are
all restored and ready to go.</p>
<p>The issue is the 389-ds changelog. If one server is left with the
corrupted data it will replay that to the other servers after they have
been restored.</p>
<p>The restore program will disable all replication agreements on all
masters before restoring the data.</p>
<p>The act of re-initializing a master will re-enable its agreement.</p>
</section>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="basic-process">
<span id="id7"></span><h2>Basic Process<a class="headerlink" href="#basic-process" title="Permalink to this heading">¶</a></h2>
<p>As stated previously, there are four basic types of backup/restore, of
which we will provide scripts/process for two.</p>
<p>The four possibilities are:</p>
<ul class="simple">
<li><p>Full system backup/restore</p></li>
<li><p>Offline full IPA server backup/restore (e.g monthly)</p></li>
<li><p>Online full LDAP data backup/restore (e.g. daily or weekly)</p></li>
<li><p>Individual LDAP data backup/restore</p></li>
</ul>
<p>This design covers only the middle two.</p>
</section>
<section id="full-ipa-backup">
<span id="id8"></span><h2>Full IPA backup<a class="headerlink" href="#full-ipa-backup" title="Permalink to this heading">¶</a></h2>
<section id="files-for-full-ipa-backup">
<span id="id9"></span><h3>Files for full IPA backup<a class="headerlink" href="#files-for-full-ipa-backup" title="Permalink to this heading">¶</a></h3>
<p>IPA touches hundreds of files. We will need to back up a mix of specific
files and all files within a set of directories (e.g. certmonger, files
needed for IPA uninstall, etc).</p>
<p>It will be incumbent upon developers to maintain this list as new files
are modified/added to IPA.</p>
<p>Logs will be optionally backed up and restored.</p>
<p>The full list is included at the end of this document.</p>
</section>
<section id="full-system-backup-process-offline">
<span id="id10"></span><h3>Full System Backup Process (offline)<a class="headerlink" href="#full-system-backup-process-offline" title="Permalink to this heading">¶</a></h3>
<p>This is a raw file-based backup which is why it is done offline. All IPA
services need to be stopped in order to ensure a safe backup.</p>
<p>This will include the LDAP DB files so this is a standalone backup. A
scripted process would include this:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipactl stop</span></code></div>
<div class="line"><a href="#id11"><span class="problematic" id="id12">``</span></a># tar –xattrs –selinux -czf /path/to/backup ``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipactl start</span></code></div>
</div>
<p>Note that this a simplified view and doesn’t include the metadata we
will package as well.</p>
</section>
<section id="full-system-restore-process">
<span id="id13"></span><h3>Full System Restore Process<a class="headerlink" href="#full-system-restore-process" title="Permalink to this heading">¶</a></h3>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipactl stop</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># cd / &amp;&amp; tar -xzf /path/to/backup</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipactl start</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># service sssd restart</span></code></div>
</div>
<p>Note that this a simplified view and doesn’t include the metadata we
will package as well.</p>
<p>We will not verify in advance of restoration that the system services
match the data (e.g. IPA is configured to start bind but the bind
packages aren’t installed). This can be a future enhancement.</p>
</section>
</section>
<section id="ldap">
<h2>LDAP<a class="headerlink" href="#ldap" title="Permalink to this heading">¶</a></h2>
<p>The db2bak method should be used to perform the LDAP backup. This will
also back up (and can restore) the changelog. The scripts provided by
389-ds are not adequate for our purposes because they require either an
operator to provide the DM password or to store it in a file.</p>
<p>The perl equivalents will do online backup/restore which is what we want
but we want it to be seamless. The solution is to provide our own
scripts which uses ldapi and autobind, allowing password-less
backup/restore.</p>
<p>The scripts will need to be robust enough automatically handle the case
of multiple instances (PKI-IPA and the IPA-REALM) as well as the case of
a single instance. For the case of a single instance we will need to
provide the list of backends to backup.</p>
<p>The 389-ds team recommends an LDIF back up as well because it is easier
to move to another machine and is human readable. Therefore we will
perform a db2ldif -r backup at the same time, and store the ldif with
the backup files. The restore command will provide an option to extract
the ldif.</p>
<section id="instances">
<h3>Instances<a class="headerlink" href="#instances" title="Permalink to this heading">¶</a></h3>
<p>Depending on the upgrade path of IPA, there will be one or two 389-ds
instances: one for IPA and one for the CA. Both will be backed up in all
cases. An option for ipa-restore will allow one to conditionally restore
instance data if needed. The possible instances are slapd-REALM and
slapd-PKI-CA</p>
</section>
<section id="backends">
<h3>Backends<a class="headerlink" href="#backends" title="Permalink to this heading">¶</a></h3>
<p>Depending on the upgrade path of IPA, there will be one or two 389-ds
instances: one for IPA and one for the CA. Both will be backed up in all
cases. An option for ipa-restore will allow one to conditionally restore
instance data if needed. The possible backends are userRoot (basically
$SUFFIX) and o=ipaca.</p>
</section>
<section id="data-backup-restore-process-online">
<span id="id14"></span><h3>Data Backup &amp; Restore Process (online)<a class="headerlink" href="#data-backup-restore-process-online" title="Permalink to this heading">¶</a></h3>
<p>The connection will be made to the ldapi port and using autobind as root
we will not be required to provide the DM password.</p>
<p>The default should be to back up and restore both instances (if
installed) or both the IPA (userRoot) and dogtag (ipara) backends.</p>
</section>
</section>
<section id="file-naming-convention">
<span id="id15"></span><h2>File Naming Convention<a class="headerlink" href="#file-naming-convention" title="Permalink to this heading">¶</a></h2>
<p>Files will be stored in /var/lib/ipa/backup</p>
<section id="full-backups">
<span id="id16"></span><h3>Full Backups<a class="headerlink" href="#full-backups" title="Permalink to this heading">¶</a></h3>
<p>ipa-full-%Y-%m-%d-%H-%M-%S.bak</p>
</section>
<section id="data-backups">
<span id="id17"></span><h3>Data Backups<a class="headerlink" href="#data-backups" title="Permalink to this heading">¶</a></h3>
<p>ipa-data–%Y-%m-%d-%H-%M-%S.bak</p>
</section>
</section>
<section id="version-wrapper">
<span id="id18"></span><h2>Version wrapper<a class="headerlink" href="#version-wrapper" title="Permalink to this heading">¶</a></h2>
<p>We will want to maintain some metadata with each backup file. I propose
we include:</p>
<ul class="simple">
<li><p>Date/time of backup, store as Generalized Time in GMT</p></li>
<li><p>FQDN</p></li>
<li><p>IPA version number (ipapython.version.NUM_VERSION)</p></li>
<li><p>A backup format version number (start with 1)</p></li>
<li><p>List of services configured for the master. This may help us now or
in the future verify that the system can be properly restored.</p></li>
</ul>
<p>The format of this file will be a set of name/value pairs separated by
=. Extra white space will be ignored. Comment is #.</p>
<p>We will prevent full restores on a different host.</p>
<p>Data restore should be allowed on any host.</p>
</section>
<section id="restore-validation">
<span id="id19"></span><h2>Restore Validation<a class="headerlink" href="#restore-validation" title="Permalink to this heading">¶</a></h2>
<p>Backing up is easy, restoring is hard, especially verifying that you
actually backed everything up (and restored it properly).</p>
<section id="full-restoration">
<span id="id20"></span><h3>Full restoration<a class="headerlink" href="#full-restoration" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Run full backup</p></li>
<li><p>ipa-server-install –uninstall -U</p></li>
<li><p>ipa-server-install</p></li>
<li><p>Restore backup</p></li>
</ol>
</section>
<section id="data-restoration">
<span id="id21"></span><h3>Data restoration<a class="headerlink" href="#data-restoration" title="Permalink to this heading">¶</a></h3>
<p>In the case of a single IPA master you can:</p>
<ol class="arabic simple">
<li><p>Back up data</p></li>
<li><p>Delete some data</p></li>
<li><p>Restore from backup</p></li>
</ol>
<p>Confirm that the data was restored. This will <strong>not</strong> automatically sync
the restored data to other masters. Any pending changes will not be
applied to the restored master but similarly any changes restored will
not be sent out to the other masters. After the restoration the other
masters will need to be reinitialized from the restored master:</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-replica-manage re-initialize --from=</span></code></p>
</section>
</section>
<section id="replication">
<h2>Replication<a class="headerlink" href="#replication" title="Permalink to this heading">¶</a></h2>
<p>Because we are going to backup and restore the changelog we should be ok
when it comes to replication.</p>
<section id="agreements">
<h3>Agreements<a class="headerlink" href="#agreements" title="Permalink to this heading">¶</a></h3>
<p>A very big issue will be what agreements exist at the time that a backup
is made and restored.</p>
<p>For example, lets say you have a single IPA server. You add a bunch of
records and then take a backup.</p>
<p>You add a replica, maybe even delete some records (oops).</p>
<p>So you do a restore.</p>
<p>Your data is back but your agreement is now gone because you restored a
backup from prior to the agreement! The remote server will need to
uninstalled and re-installed (no re-initialize is possible because the
restored server doesn’t know about the replica at all).</p>
<p>This could potentially strand a number of servers.</p>
</section>
</section>
<section id="external-impact">
<h2>External Impact<a class="headerlink" href="#external-impact" title="Permalink to this heading">¶</a></h2>
<p>The sssd service will need a restart. If the assumption is that the
server is not in a known good state then it would be good practice to
restart this service after restoring its files.</p>
<p>In fact, we may want to consider recommending a reboot to be sure things
are in a good state, or we may need to think about extending ipactl to
include other daemons.</p>
</section>
<section id="more-on-partial-restores">
<span id="id22"></span><h2>More on partial restores<a class="headerlink" href="#more-on-partial-restores" title="Permalink to this heading">¶</a></h2>
<p>Quite a bit of infrastructure is required to be able to pick and choose
what to restore from a backup. In order to provide per-entry restoration
we would need the backup in a more readable form, say LDIF, then provide
a means to search for, pick and then execute restoration.</p>
<p>The restoration may take the form of:</p>
<ul class="simple">
<li><p>an entry</p></li>
<li><p>a subtree</p></li>
<li><p>attributes within an entry, e.g. membership</p></li>
</ul>
<p>Restoration of an entry may trigger other things to happen. Take the
case where a group is accidentally removed. Not only does the group need
to be restored but its membership needs to be recovered as well. Members
of the group will be managed automatically but since we handle nested
groups and groups can be members of other objects (HBAC, sudo, etc) we
need to restore that as well.</p>
</section>
<section id="qualifying">
<h2>Qualifying<a class="headerlink" href="#qualifying" title="Permalink to this heading">¶</a></h2>
<p>Here is a list of some things to test</p>
<ul class="simple">
<li><p>Run IPA unit tests</p></li>
<li><p>Create a new replica</p></li>
<li><p>Manage existing replicas</p></li>
<li><p>Enroll a client</p></li>
<li><p>Unenroll a client</p></li>
<li><p>Verify that replication is still working, and working with dogtag as
well</p></li>
</ul>
</section>
<section id="open-questions">
<span id="id23"></span><h2>Open Questions<a class="headerlink" href="#open-questions" title="Permalink to this heading">¶</a></h2>
<section id="size-of-backup">
<span id="id24"></span><h3>Size of backup?<a class="headerlink" href="#size-of-backup" title="Permalink to this heading">¶</a></h3>
<p>Should we attempt to predict the resulting file size and try to
determine if there is adequate space before starting the backup? We may
be able to stat each file, sum the size, and check. It would just take a
bit of time and I/O.</p>
</section>
<section id="encrypt-backup-files">
<span id="id25"></span><h3>Encrypt backup files?<a class="headerlink" href="#encrypt-backup-files" title="Permalink to this heading">¶</a></h3>
<p>Should we prompt for and/or encrypt with gpg the backup files? <strong>Yes</strong></p>
</section>
<section id="should-i-delete-everything-before-doing-a-restore">
<span id="id26"></span><h3>Should I delete everything before doing a restore?<a class="headerlink" href="#should-i-delete-everything-before-doing-a-restore" title="Permalink to this heading">¶</a></h3>
<p>For example, if you have a single master, you do a backup, then you add
a replica. If you then restore the backup and try to create another
replica it will fail because the changelog directory already exists. Who
knows what other problems might be lurking.</p>
<p>I’m inclined to suggest/force uninstalling the server first. We just may
not be in any position to do that depending on how hosed things are.</p>
<p>The other alternative is to create a list of these corner cases and test
for them on reinstall.</p>
</section>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<section id="full-restore">
<span id="id27"></span><h2>Full Restore<a class="headerlink" href="#full-restore" title="Permalink to this heading">¶</a></h2>
<p>If you do a full backup without the logs and do a restoration into a FS
that doesn’t have an installed IPA server then tomcat will not stop.
This is because the log files needed by the CA are created on-the-fly by
the instance creation process. If the directory structure is created
manually then things will work.</p>
</section>
<section id="uninstall">
<h2>Uninstall<a class="headerlink" href="#uninstall" title="Permalink to this heading">¶</a></h2>
<p>The backup files are NOT removed on uninstall. When it comes to data, I
prefer not to delete things automatically.</p>
</section>
<section id="development-notes-semi-interesting-testing">
<span id="id28"></span><h2>Development notes (semi-interesting testing)<a class="headerlink" href="#development-notes-semi-interesting-testing" title="Permalink to this heading">¶</a></h2>
<p>As part of developing the backups I tried a couple of fairly outlandish
things. Here are those things and the outcomes. I’m not sure if these
will ever be eventually interesting or helpful, but I don’t want to lose
anything.</p>
<section id="backup-uninstall-reinstall-restore-just-the-ldap-server">
<span id="id29"></span><h3>Backup, uninstall, reinstall, restore JUST the LDAP server<a class="headerlink" href="#backup-uninstall-reinstall-restore-just-the-ldap-server" title="Permalink to this heading">¶</a></h3>
<p>So I wanted to verify that the restoration actually worked, so what I
did was:</p>
<ol class="arabic simple">
<li><p>ipa-server-install …</p></li>
<li><p>kinit admin</p></li>
<li><p>ipa user-add tuser1</p></li>
<li><p>ipa user-add tuser2</p></li>
<li><p>db2bak</p></li>
<li><p>ipa-server-install –uninstall -U</p></li>
<li><p>ipa-server-install (same options as above)</p></li>
<li><p>bak2db</p></li>
<li><p>ipa-getkeytab -k /etc/dirsrv/ds.keytab -p ldap/<a href="#id30"><span class="problematic" id="id31">`</span></a>hostname` -s
`hostname` -D ‘cn=directory manager’ -w password</p></li>
<li><p>service dirsrv restart</p></li>
<li><p>kdestroy</p></li>
<li><p>kinit admin</p></li>
<li><p>ipa-getkeytab -k /etc/httpd/conf/ipa.keytab -p HTTP/<a href="#id32"><span class="problematic" id="id33">`</span></a>hostname` -s
`hostname`</p></li>
<li><p>ipa-getkeytab -k /etc/krb5.keytab -p host/<a href="#id34"><span class="problematic" id="id35">`</span></a>hostname` -s `hostname`</p></li>
<li><p>ipactl restart</p></li>
<li><p>service sssd restart</p></li>
<li><p>ipa user-show admin</p></li>
<li><p>ipa user-find (confirm that I have the 2 new users)</p></li>
<li><p>id tuser1 (to confirm that sssd is working)</p></li>
</ol>
<p>So what does this do? Well, it replaces the CA for one. And it
invalidates all certificates.</p>
<p>It is also, if all you have is the data backup, is a way to restore an
IPA system.</p>
<p>A lot more work would be needed to actually make things work. All
clients and services would need new certs.</p>
<p>And we overwrote the 389-ds and Apache server certs when we reimported
the data, so those would need to be re-issued.</p>
<p>For the most part, any certificates in the data should be deleted
because they are for a CA that no longer exists, so revocation will
fail.</p>
<p>There may be quite a bit of certmonger rework needed, or it could be
that certmonger could fix all the certs for us using: ipa-getcert
resubmit.</p>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Directory_Server/9.0/html/Administration_Guide/Populating_Directory_Databases-Backing_Up_and_Restoring_Data.html#Backing_Up_and_Restoring_Data-Restoring_Databases_That_Include_Replicated_Entries">https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Directory_Server/9.0/html/Administration_Guide/Populating_Directory_Databases-Backing_Up_and_Restoring_Data.html#Backing_Up_and_Restoring_Data-Restoring_Databases_That_Include_Replicated_Entries</a></p></li>
<li><p><a class="reference external" href="https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Directory_Server/9.0/html/Administration_Guide/Managing_Replication-Initializing_Consumers.html#Initializing_Consumers-Filesystem_Replica_Initialization">https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Directory_Server/9.0/html/Administration_Guide/Managing_Replication-Initializing_Consumers.html#Initializing_Consumers-Filesystem_Replica_Initialization</a></p></li>
</ul>
</section>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<p>The backup/restore commands will need to be executed as root so it is
unlikely that system backup/recovery can be managed from the UI. It
could also represent a chicken-and-egg problem on restoration.</p>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<p>There will be two basic, standalone commands:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa-backup OPTIONS</span></code></div>
<div class="line">``   –data    Back up just the data. Default is full system backup.``</div>
<div class="line">``   –gpg     Encrypt the backup``</div>
<div class="line">``   –gpg-keyring <code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``   The gpg key name to be used (or full path)</span></code></div>
<div class="line">``   –logs    Include logs in backup``</div>
<div class="line">``   –online Perform the LDAP backups online, for data only.``</div>
</div>
<p>We will only encrypt the payload. The header will be in the clear.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipa-restore OPTIONS /path/to/backup</span></code></div>
<div class="line">``   –data             If the backup is a full backup, restore only the data``</div>
<div class="line">``   –extract        Extract the backup files, do not restore (including the LDIF)``</div>
<div class="line">``   –gpg-keyring <code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``    The key name to be used by gpg</span></code></div>
<div class="line">``   –data             Restore only the data``</div>
<div class="line">``   –online          Perform the LDAP restores online, for data only.``</div>
<div class="line">``   –instance=INSTANCE   The 389-ds instance to restore (defaults to all found)``</div>
<div class="line">``   –backend=BACKEND     The backend to restore within the instance or``</div>
<div class="line">``                                              instances``</div>
<div class="line">``   –no-logs         Do not restore log files from the backup``</div>
<div class="line">``   -U, –unattended      Unattended restoration never prompts the user``</div>
</div>
<p>ipa-restore will detect if the backup file provide contains only the
data, but if provided a full backup it should be able to restore just
the data component.</p>
<p>There are also common options:</p>
<div class="line-block">
<div class="line">``   –version             show program’s version number and exit``</div>
<div class="line">``   -h, –help            show this help message and exit``</div>
<div class="line">``   -p PASSWORD, –password=PASSWORD``</div>
<div class="line">``                       Directory Manager password``</div>
<div class="line">``   -v, –verbose       print debugging information``</div>
<div class="line">``   -d, –debug         alias for –verbose (deprecated)``</div>
<div class="line">``   -q, –quiet         output only errors``</div>
<div class="line">``   –log-file=FILE     log to the given file``</div>
</div>
</section>
</section>
<section id="full-list-of-files-and-directories-to-back-up">
<span id="id36"></span><h1>Full list of files and directories to back up<a class="headerlink" href="#full-list-of-files-and-directories-to-back-up" title="Permalink to this heading">¶</a></h1>
<section id="directories">
<h2>Directories<a class="headerlink" href="#directories" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>/usr/share/ipa/html</p></li>
<li><p>/etc/pki-ca</p></li>
<li><p>/etc/httpd/alias</p></li>
<li><p>/var/lib/pki-ca</p></li>
<li><p>/var/lib/ipa-client/sysrestore</p></li>
<li><p>/var/lib/sss/pubconf/krb5.include.d</p></li>
<li><p>/var/lib/authconfig/last</p></li>
<li><p>/var/lib/certmonger</p></li>
<li><p>/var/lib/ipa</p></li>
<li><p>/var/run/dirsrv</p></li>
<li><p>/var/lock/dirsrv</p></li>
</ul>
</section>
<section id="files">
<h2>Files<a class="headerlink" href="#files" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>/etc/named.conf</p></li>
<li><p>/etc/sysconfig/pki-ca</p></li>
<li><p>/etc/sysconfig/dirsrv</p></li>
<li><p>/etc/sysconfig/ntpd</p></li>
<li><p>/etc/sysconfig/krb5kdc</p></li>
<li><p>/etc/sysconfig/pki/ca/pki-ca</p></li>
<li><p>/etc/sysconfig/authconfig</p></li>
<li><p>/etc/resolv.conf</p></li>
<li><p>/etc/pki/nssdb/cert8.db</p></li>
<li><p>/etc/pki/nssdb/key3.db</p></li>
<li><p>/etc/pki/nssdb/secmod.db</p></li>
<li><p>/etc/nsswitch.conf</p></li>
<li><p>/etc/krb5.keytab</p></li>
<li><p>/etc/sssd/sssd.conf</p></li>
<li><p>/etc/openldap/ldap.conf</p></li>
<li><p>/etc/security/limits.conf</p></li>
<li><p>/etc/httpd/conf/password.conf</p></li>
<li><p>/etc/httpd/conf/ipa.keytab</p></li>
<li><p>/etc/httpd/conf.d/ipa-pki-proxy.conf</p></li>
<li><p>/etc/httpd/conf.d/ipa-rewrite.conf</p></li>
<li><p>/etc/httpd/conf.d/nss.conf</p></li>
<li><p>/etc/httpd/conf.d/ipa.conf</p></li>
<li><p>/etc/ssh/sshd_config</p></li>
<li><p>/etc/ssh/ssh_config</p></li>
<li><p>/etc/krb5.conf</p></li>
<li><p>/etc/group</p></li>
<li><p>/etc/passwd</p></li>
<li><p>/etc/ipa/ca.crt</p></li>
<li><p>/etc/ipa/default.conf</p></li>
<li><p>/etc/named.keytab</p></li>
<li><p>/etc/ntp.conf</p></li>
<li><p>/etc/dirsrv/ds.keytab</p></li>
<li><p>/etc/sysconfig/dirsrv-REALM</p></li>
<li><p>/etc/sysconfig/dirsrv-PKI-IPA</p></li>
<li><p>/root/ca-agent.p12</p></li>
<li><p>/root/cacert.p12</p></li>
<li><p>/var/kerberos/krb5kdc/kdc.conf</p></li>
<li><p>/etc/dirsrv/slapd-REALM</p></li>
<li><p>/var/lib/dirsrv/scripts-realm</p></li>
<li><p>/var/lib/dirsrv/slapd-realm</p></li>
<li><p>/usr/lib64/dirsrv/slapd-PKI-IPA</p></li>
<li><p>/etc/dirsrv/slapd-PKI-IPA</p></li>
<li><p>/var/lib/dirsrv/slapd-PKI-IPA</p></li>
</ul>
</section>
<section id="logs">
<h2>Logs<a class="headerlink" href="#logs" title="Permalink to this heading">¶</a></h2>
<p>This is a mix of files and directories</p>
<ul class="simple">
<li><p>/var/log/pki-ca</p></li>
<li><p>/var/log/dirsrv/slapd-REALM-COM</p></li>
<li><p>/var/log/dirsrv/slapd-PKI-IPA</p></li>
<li><p>/var/log/httpd</p></li>
<li><p>/var/log/ipaserver-install.log</p></li>
<li><p>/var/log/kadmind.log</p></li>
<li><p>/var/log/pki-ca-install.log</p></li>
<li><p>/var/log/messages</p></li>
<li><p>/var/log/ipaclient-install.log</p></li>
<li><p>/var/log/secure</p></li>
<li><p>/var/log/ipaserver-uninstall.log</p></li>
<li><p>/var/log/pki-ca-uninstall.log</p></li>
<li><p>/var/log/ipaclient-uninstall.log</p></li>
<li><p>/var/named/data/named.run</p></li>
</ul>
</section>
</section>
<section id="gpg-encryption">
<span id="id37"></span><h1>GPG encryption<a class="headerlink" href="#gpg-encryption" title="Permalink to this heading">¶</a></h1>
<p>The backup can be optionally encrypted using GPG. To create a key you
can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat &gt;keygen &lt;&lt;EOF</span>
     <span class="o">%</span><span class="n">echo</span> <span class="n">Generating</span> <span class="n">a</span> <span class="n">standard</span> <span class="n">key</span>
     <span class="n">Key</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">RSA</span>
     <span class="n">Key</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">2048</span>
     <span class="n">Name</span><span class="o">-</span><span class="n">Real</span><span class="p">:</span> <span class="n">IPA</span> <span class="n">Backup</span>
     <span class="n">Name</span><span class="o">-</span><span class="n">Comment</span><span class="p">:</span> <span class="n">IPA</span> <span class="n">Backup</span>
     <span class="n">Name</span><span class="o">-</span><span class="n">Email</span><span class="p">:</span> <span class="n">root</span><span class="nd">@example</span><span class="o">.</span><span class="n">com</span>
     <span class="n">Expire</span><span class="o">-</span><span class="n">Date</span><span class="p">:</span> <span class="mi">0</span>
     <span class="o">%</span><span class="n">pubring</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">backup</span><span class="o">.</span><span class="n">pub</span>
     <span class="o">%</span><span class="n">secring</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">backup</span><span class="o">.</span><span class="n">sec</span>
     <span class="o">%</span><span class="n">commit</span>
     <span class="o">%</span><span class="n">echo</span> <span class="n">done</span>
<span class="n">EOF</span>
<span class="c1"># gpg --batch --gen-key keygen</span>
<span class="c1"># gpg --no-default-keyring --secret-keyring /root/backup.sec \</span>
      <span class="o">--</span><span class="n">keyring</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">backup</span><span class="o">.</span><span class="n">pub</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">keys</span>
</pre></div>
</div>
<p>This will create the key <code class="docutils literal notranslate"><span class="pre">backup</span></code> and can be passed to ipa-backup
using:</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-backup --gpg --gpg-keyring=/root/backup ...</span></code></p>
</section>
<section id="troubleshooting">
<h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading">¶</a></h1>
<p>gpg2 now requires an external program to enter pins to make it “easier”
for desktop folks.</p>
<p>To run purely from a console add
<code class="docutils literal notranslate"><span class="pre">&quot;pinentry-program</span> <span class="pre">/usr/bin/pinentry-curses&quot;</span></code> to
<code class="docutils literal notranslate"><span class="pre">.gnupg/gpg-agent.conf</span></code> before generating a key.</p>
</section>
<section id="how-to-test">
<span id="how-to-test9"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<section id="general-test-outline">
<span id="id38"></span><h2>General test outline<a class="headerlink" href="#general-test-outline" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Install server</p></li>
<li><p>Do a LDAP search for <code class="docutils literal notranslate"><span class="pre">uid=admin,cn=users,cn=accounts,$SUFFIX</span></code>. Note
the result.</p></li>
<li><p>Verify that the commands <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-show</span> <span class="pre">admin</span></code>, <code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">admin</span></code>,
<code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-find</span></code>, <code class="docutils literal notranslate"><span class="pre">host</span></code><em>``$HOSTNAME``</em><code class="docutils literal notranslate"><span class="pre">localhost</span></code>,
<code class="docutils literal notranslate"><span class="pre">kinit</span> <span class="pre">admin</span></code> work. This checks basic functionality of IPA client,
PAM, CA, DNS and Kerberos. Note the output of these commands</p></li>
<li><p>(Do backup &amp; restore)</p></li>
<li><p>Do a LDAP search on admin again; check that all attributes except
<code class="docutils literal notranslate"><span class="pre">krbLastSuccessfulAuth</span></code> match</p></li>
<li><p>Run the above commands again, check that they are successful and the
output matches.</p></li>
<li><p>Uninstall server</p></li>
</ul>
</section>
<section id="test-full-backup-and-restore">
<span id="id39"></span><h2>Test Full Backup and Restore<a class="headerlink" href="#test-full-backup-and-restore" title="Permalink to this heading">¶</a></h2>
<p>The “Do backup &amp; restore” steps are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span> <span class="pre">-v</span></code></p></li>
<li><p>Uninstall server</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span></code><em>``$BACKUP_PATH``</em></p></li>
</ul>
</section>
<section id="test-backup-and-restore-with-removed-users">
<span id="id40"></span><h2>Test Backup and Restore with Removed Users<a class="headerlink" href="#test-backup-and-restore-with-removed-users" title="Permalink to this heading">¶</a></h2>
<p>The “Do backup &amp; restore” steps are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span> <span class="pre">-v</span></code></p></li>
<li><p>Uninstall server</p></li>
<li><p>Remove users <code class="docutils literal notranslate"><span class="pre">dirsrv</span></code> and <code class="docutils literal notranslate"><span class="pre">pkiuser</span></code></p></li>
<li><p>Add system user <code class="docutils literal notranslate"><span class="pre">ipatest_user1</span></code> (to claim the UID of a removed
user)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span></code><em>``$BACKUP_PATH``</em></p></li>
</ul>
<p>At the end of the test, remove user <code class="docutils literal notranslate"><span class="pre">ipatest_user1</span></code></p>
</section>
<section id="test-backup-and-restore-with-selinux-booleans-off">
<span id="id41"></span><h2>Test Backup and Restore with SELinux Booleans Off<a class="headerlink" href="#test-backup-and-restore-with-selinux-booleans-off" title="Permalink to this heading">¶</a></h2>
<p>The “Do backup &amp; restore” steps are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span> <span class="pre">-v</span></code></p></li>
<li><p>Uninstall server</p></li>
<li><p>Turn SELinux booleans <code class="docutils literal notranslate"><span class="pre">httpd_can_network_connect</span></code> and
<code class="docutils literal notranslate"><span class="pre">httpd_manage_ipa</span></code> off</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span></code><em>``$BACKUP_PATH``</em></p></li>
</ul>
<p>After restoring, check that the above booleans are on.</p>
</section>
<section id="test-backup-and-restore-from-heavily-upgraded-instance">
<span id="id42"></span><h2>Test Backup and Restore from heavily upgraded instance<a class="headerlink" href="#test-backup-and-restore-from-heavily-upgraded-instance" title="Permalink to this heading">¶</a></h2>
<p>Start with a master that has been in-place-upgraded since there was a
separate 389-ds instance for IPA.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span> <span class="pre">-v</span></code></p></li>
<li><p>Uninstall server</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span> <span class="pre">...</span></code></p></li>
</ul>
<p>Backup and Restore is NOT a method of eliminating that extra instance.</p>
</section>
<section id="data-backup-only">
<span id="id43"></span><h2>Data backup only<a class="headerlink" href="#data-backup-only" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span> <span class="pre">--data</span></code></p></li>
<li><p>Add a new user</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span> <span class="pre">/var/lib/ipa/ipa-data-...</span></code></p></li>
<li><p>Ensure that the new user is gone</p></li>
</ul>
</section>
<section id="online-data-restore">
<span id="id44"></span><h2>Online data restore<a class="headerlink" href="#online-data-restore" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span> <span class="pre">--data</span></code></p></li>
<li><p>Add a new user</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span> <span class="pre">--online</span> <span class="pre">/var/lib/ipa/ipa-data-...</span></code></p></li>
<li><p>Ensure that the new user is gone</p></li>
<li><p>Ensure IPA is still functioning properly</p></li>
</ul>
</section>
<section id="encryption-decryption-of-backup-files">
<span id="encryptiondecryption-of-backup-files"></span><h2>Encryption/decryption of Backup files<a class="headerlink" href="#encryption-decryption-of-backup-files" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span> <span class="pre">--gpg</span> <span class="pre">--gpg-keyring=/path/to/keyring</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-server-install</span> <span class="pre">--uninstall</span> <span class="pre">-U</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span> <span class="pre">--gpg-keyring=/path/to/keyring</span> <span class="pre">/var/lib/ipa/ipa-...</span></code></p></li>
</ul>
</section>
<section id="client-replica-installation-with-restored-master">
<span id="clientreplica-installation-with-restored-master"></span><h2>Client/Replica installation with restored Master<a class="headerlink" href="#client-replica-installation-with-restored-master" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-backup</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ipa-restore</span></code></p></li>
<li><p>Create new replica</p></li>
<li><p>Enroll client</p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V3/Backup_and_Restore.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
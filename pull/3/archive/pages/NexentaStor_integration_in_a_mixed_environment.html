<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>First part: CIFS + NFS no-kerberos &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="NoLink.html" />
    <link rel="prev" title="Email Updates" href="News.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p><strong>NexentaStor integration with IPA in a mixed environment</strong></p>
<hr class="docutils" />
<p>Provided by: Sigbjorn Lie</p>
<p>Making NexentaStor speak to AD and LDAP/IPA is easy, adding krb5 for NFS
is a bit more tricky.</p>
<section id="first-part-cifs-nfs-no-kerberos">
<span id="id1"></span><h1>First part: CIFS + NFS no-kerberos<a class="headerlink" href="#first-part-cifs-nfs-no-kerberos" title="Permalink to this heading">¶</a></h1>
<p>Configure the CIFS service to join to AD, and configure the LDAP client
to point at IPA. Use the following configuration for LDAP,</p>
<p>REMEBER to edit /etc/nsswitch.ldap before applying LDAP configuration.
Failing to do so will freeze NexentaStor as all services will be
configured to use LDAP, and maps such as protocols and service is not
served by IPA. You’ll do this in a shell using expert_mode in the NMC.
The only maps in /etc/nsswitch.ldap that should be configured for ldap
lookup is passwd, group, and netgroup.</p>
<p>Make the following changes under Settings -&gt; Misc Services -&gt; LDAP
client -&gt; Configure.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDAP</span> <span class="n">config</span> <span class="nb">type</span><span class="p">:</span> <span class="n">manual</span>
<span class="n">Profile</span> <span class="n">name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Groups</span> <span class="n">Service</span> <span class="n">Descriptor</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">compat</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">test</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">Netgroup</span> <span class="n">Service</span> <span class="n">Descriptor</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">ng</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">compat</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">test</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">Credential</span> <span class="n">Level</span><span class="p">:</span> <span class="n">anonymous</span>
<span class="n">Domain</span> <span class="n">name</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Base</span> <span class="n">DN</span><span class="p">:</span> <span class="n">dc</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">test</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">LDAP</span> <span class="n">Authentication</span> <span class="n">password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">LDAP</span> <span class="n">Servers</span><span class="p">:</span> <span class="n">ipa01</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">ipa02</span><span class="o">.</span><span class="n">ix</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">com</span>
<span class="n">Authentication</span> <span class="n">Method</span><span class="p">:</span> <span class="n">none</span>
<span class="n">Proxy</span> <span class="n">DN</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Proxy</span> <span class="n">Password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Users</span> <span class="n">Service</span> <span class="n">Descriptor</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">users</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">compat</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">ix</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">test</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
</pre></div>
</div>
<p>In a shell using expert_mode, edit the nsswitch.conf as the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">passwd</span><span class="p">:</span>   <span class="n">files</span> <span class="n">ldap</span> <span class="n">ad</span>
<span class="n">group</span><span class="p">:</span>    <span class="n">files</span> <span class="n">ldap</span> <span class="n">ad</span>
</pre></div>
</div>
<p>This will make Nexenta look for Unix accounts and ground in IPA first,
before looking up the rest from Active Directory.</p>
</section>
<section id="second-part-adding-kerberos-to-nfs4-nfs-krb5">
<span id="id2"></span><h1>Second part, adding kerberos to NFS4: NFS + KRB5<a class="headerlink" href="#second-part-adding-kerberos-to-nfs4-nfs-krb5" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>After the server has been joined to AD, scp the /etc/krb5/krb5.keytab
file from the NexentaStor server to the IPA server.</p></li>
<li><p>Add a host entry for the NexentaStor server to IPA, and retrieve the
kerberos keytab and add them to the krb5.keytab file copied from the
NexentaStor machine. This is required as the NFS service and the CIFS
service share the same krb5.keytab file.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-getkeytab -s ipa-server -p nexentastorserver.fqdn -k /path/to/nexentastor/krb5.keytab</span></code></p>
<ul class="simple">
<li><p>scp the modified krb5.keytab file back into the NexentaStor server at
/etc/krb5/krb5.keytab.</p></li>
<li><p>Edit /etc/nsswitch.conf again, make sure “ad” is still present for
passwd and group, if not, add it back in.</p></li>
<li><p>Remove /etc/krb5/krb5.conf,v (bug in NexentaStor makes this file
re-appear with old contents, even if it’s edited trough the NMC.</p></li>
<li><p>Edit /etc/krb5/krb5.conf, add a sections under [realms] for your IPA
domain. I’ve specified admin_server, kdc, and kpasswd_server for all
my IPA servers.</p></li>
<li><p>Add “allow_weak_crypto = true” under libdefaults to widen the support
for Linux clients.</p></li>
<li><p>Set “default_realm = IPA-REALM-CAPITAL-LETTERS”</p></li>
<li><p>Add a section for the IPA domain under [domain_realm]:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">ipa</span><span class="o">-</span><span class="n">domain</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">IPA</span><span class="o">-</span><span class="n">REALM</span><span class="o">-</span><span class="n">CAPITAL</span><span class="o">-</span><span class="n">LETTERS</span>
<span class="n">ipa</span><span class="o">-</span><span class="n">domain</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">IPA</span><span class="o">-</span><span class="n">REALM</span><span class="o">-</span><span class="n">CAPITAL</span><span class="o">-</span><span class="n">LETTERS</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Edit /etc/defaultdomain, create the file if it does not exist
already, and add the IPA domain.</p></li>
<li><p>Edit /etc/resolv.conf:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">search</span> <span class="n">addomain</span><span class="o">.</span><span class="n">com</span> <span class="n">ipadomain</span><span class="o">.</span><span class="n">com</span>
<span class="n">domain</span> <span class="n">addomain</span><span class="o">.</span><span class="n">com</span>
<span class="n">nameserver</span> <span class="o">&lt;</span><span class="n">ipa</span><span class="o">-</span><span class="n">dns</span><span class="o">-</span><span class="n">ip</span><span class="o">&gt;</span>
<span class="n">nameserver</span> <span class="o">&lt;</span><span class="n">ad</span><span class="o">-</span><span class="n">dns</span><span class="o">-</span><span class="n">ip</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>I have also configured my IPA DNS server to forward any requests for my
AD domain directly to the AD dns servers. This should not be required if
your domains is delegated properly, but it speeds AD requests up a bit.
:)</p>
<p>The addomain must be the first domain listed to make the nss_ad module
work.</p>
<ul class="simple">
<li><p>Switch back to the NMC, and edit the nfs defaults file:</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre"># NMC: $ setup network service nfs-server edit-settings</span></code></p>
<ul class="simple">
<li><p>Uncomment and modify:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NFSMAPID_DOMAIN</span><span class="o">=</span><span class="n">ipa</span><span class="o">-</span><span class="n">domain</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Restart the NFS service.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre"># NMC $ setup network service nfs-server restart</span></code></p>
<p>That’s it. Your NexentaStor server will now look up LDAP/IPA users and
groups first, and then generate UID/GID’s for any other users/groups
only found in AD.</p>
<p><a class="reference external" href="Category:How_to">Category:How to</a> <a class="reference external" href="Category:Draft_documentation">Category:Draft
documentation</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/NexentaStor_integration_in_a_mixed_environment.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
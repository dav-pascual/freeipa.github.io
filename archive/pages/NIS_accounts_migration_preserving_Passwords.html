<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Enable IPA migration mode &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Known NTP services" href="NTP_Server.html" />
    <link rel="prev" title="&lt;no title&gt;" href="NIS_Compatibility.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p><strong>HOWTO: Migrate NIS accounts to IPA preserving user’s passwords.</strong></p>
<p><em>Provided by Giulio Fidente</em></p>
<p>The below details will walk you through how to migrate some existing NIS
accounts over IPA preserving the NIS passwords.</p>
<p>Details of this example are as follows:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">Domain name: example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">IPA Server: ipa1.example.com</span></code></div>
</div>
<p>To have a user auth successfully on IPA, you need to get the proper
Kerberos hashes in LDAP, but you can’t just paste the NIS passwords as
Kerberos keys; SSSD can work instead with FreeIPA to solve this and
mitigate the user impact on migration by generating the required user
keys.</p>
<section id="enable-ipa-migration-mode">
<span id="id1"></span><h1>Enable IPA migration mode<a class="headerlink" href="#enable-ipa-migration-mode" title="Permalink to this heading">¶</a></h1>
<p>This step is needed to have FreeIPA regenerate the hashes and store them
in the user entry when users successfully bind via LDAPs.</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa config-mod --enable-migration=true</span></code></p>
</section>
<section id="export-the-nis-accounts-details">
<span id="id2"></span><h1>Export the NIS accounts details<a class="headerlink" href="#export-the-nis-accounts-details" title="Permalink to this heading">¶</a></h1>
<p>Consider a single line of your YP passwd map:</p>
<p><code class="docutils literal notranslate"><span class="pre">gfidente:v4sL5vFQjQWQ2:4009:20:,,,:/home/gfidente:/bin/bash</span></code></p>
<p>the first field is a username and the second field is a DES encrypted
password. You may want to script the export saving the id/pwd couples in
a temporary file.</p>
</section>
<section id="import-users-into-ipa">
<span id="id3"></span><h1>Import users into IPA<a class="headerlink" href="#import-users-into-ipa" title="Permalink to this heading">¶</a></h1>
<p>From your export file, import the users into IPA using the admin tools
and set the original hashed password:</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa user-add [username] --setattr userpassword={crypt}yourencryptedpass</span></code></p>
<p>You should be able now to bind on the LDAP using your migrated NIS
credentials. FreeIPA will intercepts the bind request and if the user
also has a Kerberos principal but no Kerberos hashes, then it will
rewrite create the principal key.</p>
<p>Obviously you don’t know the passwords of your users so you can’t bind
manually on LDAP for each of them, but SSSD can do this for you, if
configured properly, when users log in for the first time.</p>
<p><strong>NOTE</strong>: Use {crypt} for any password taken from an NIS dump or
/etc/shadow. It defines the password storage scheme that crypt(3) uses.</p>
</section>
<section id="add-systems-to-the-ipa-domain">
<span id="id4"></span><h1>Add systems to the IPA Domain<a class="headerlink" href="#add-systems-to-the-ipa-domain" title="Permalink to this heading">¶</a></h1>
<p>First, ensure DNS is working correctly otherwise this step will fail.</p>
<p>Configure manually an IPA client os use the ipa-client package and run
the install utility. You can even run that on a system where the NIS
client tools are already set in place, it won’t break things.</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-client-install -U -p admin -w mysecretpassword</span></code></p>
<p>Double check your nsswitch.conf file, it should have added the ‘sss’
keyword to a number of lines:</p>
<p><code class="docutils literal notranslate"><span class="pre"># passwd: files nis sss</span></code></p>
</section>
<section id="deploy-the-server-ca-cert-on-the-client-systems">
<span id="id5"></span><h1>Deploy the server CA cert on the client systems<a class="headerlink" href="#deploy-the-server-ca-cert-on-the-client-systems" title="Permalink to this heading">¶</a></h1>
<p>The IPA CA cert is provided by the IPA httpd server and you just need to
download it in /etc/openldap/cacerts:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># wget ``\</span> <span class="pre">```http://ipa1.example.com/ipa/config/ca.crt</span></code> &lt;<a class="reference external" href="http://ipa1.example.com/ipa/config/ca.crt">http://ipa1.example.com/ipa/config/ca.crt</a>&gt;`__`` -O /etc/openldap/cacerts/ipa.ca``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># cacertdir_rehash /etc/openldap/cacerts</span></code></div>
</div>
<p>When users will try to log on the client, SSSD will try to acquire a
kerberos ticket but if that doesn’t work, it will retry then with a bind
over LDAPs; if this works the IPA server will rewrite the kerberos
principal key for you and the user will actually be logged in with his
old password.</p>
</section>
<section id="troubleshooting">
<h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading">¶</a></h1>
<p>If users still can’t login, you can enable the SSSD debug mode editing
/etc/sssd/sssd.conf and adding the following in your
[domain/example.com] stanza:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">debug_level = 6</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ldap_tls_reqcert = never (or allow)</span></code></div>
</div>
<p>You will get the details in /var/log/sssd/sssd_example.com.log</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/NIS_accounts_migration_preserving_Passwords.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Overview" href="Samba_4_Storing_SID_in_String_Format.html" />
    <link rel="prev" title="Overview" href="Samba_4_Schema_Mapping.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>In the initial implementation the password synchronization will be
implemented by storing the clear text password in the LDAP backend. In
the final implementation this will be replaced using an LDB module. See
also <a class="reference external" href="Obsolete:IPAv3_Password_Synchronization">this page</a>.</p>
<p>By default Samba encrypts user password before storing it into the
backend. Samba can be configured to store clear text password by
enabling the DOMAIN_PASSWORD_STORE_CLEARTEXT flag in the pwdProperties
attribute of the domain object.</p>
<p>The flag is defined as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define DOMAIN_PASSWORD_STORE_CLEARTEXT ( 0x00000010 )</span>
</pre></div>
</div>
</section>
<section id="current-code">
<span id="id1"></span><h1>Current Code<a class="headerlink" href="#current-code" title="Permalink to this heading">¶</a></h1>
<section id="password-hash-module">
<span id="id2"></span><h2>Password Hash Module<a class="headerlink" href="#password-hash-module" title="Permalink to this heading">¶</a></h2>
<p>The password encryption is done in
source4/dsdb/samdb/ldb_modules/password_hash.c.</p>
<p>When a new password is being set using LDAP add or modify operation, the
module will check the password policy using the
build_domain_data_request() function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">search</span> <span class="n">password</span> <span class="n">policy</span> <span class="ow">in</span> <span class="n">domain</span> <span class="nb">object</span>
<span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;pwdProperties&quot;</span><span class="p">,</span> <span class="s2">&quot;pwdHistoryLength&quot;</span><span class="p">,</span> <span class="n">NULL</span> <span class="p">};</span>
<span class="k">return</span> <span class="n">ldb_build_search_req</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">dom_req</span><span class="p">,</span> <span class="n">ldb</span><span class="p">,</span> <span class="n">ac</span><span class="p">,</span>
    <span class="n">ldb_get_default_basedn</span><span class="p">(</span><span class="n">ldb</span><span class="p">),</span>
    <span class="n">LDB_SCOPE_BASE</span><span class="p">,</span>
    <span class="n">NULL</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span>
    <span class="n">NULL</span><span class="p">,</span>
    <span class="n">ac</span><span class="p">,</span> <span class="n">get_domain_data_callback</span><span class="p">,</span>
    <span class="n">ac</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">);</span>
</pre></div>
</div>
<p>The get_domain_data_callback() function will check the
DOMAIN_PASSWORD_STORE_CLEARTEXT bit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwdProperties</span> <span class="o">=</span> <span class="n">samdb_result_uint</span><span class="p">(</span><span class="n">ares</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;pwdProperties&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">data</span><span class="o">-&gt;</span><span class="n">store_cleartext</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwdProperties</span> <span class="o">&amp;</span> <span class="n">DOMAIN_PASSWORD_STORE_CLEARTEXT</span><span class="p">;</span>
</pre></div>
</div>
<p>The clear text password will be stored in the supplementalCredentials
attribute by the setup_supplemental_field() function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">check</span> <span class="n">password</span> <span class="n">policy</span>
<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">store_cleartext</span> <span class="o">&amp;&amp;</span>
    <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">u</span><span class="o">.</span><span class="n">user_account_control</span> <span class="o">&amp;</span> <span class="n">UF_ENCRYPTED_TEXT_PASSWORD_ALLOWED</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">do_cleartext</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">add</span> <span class="n">a</span> <span class="n">package</span> <span class="k">for</span> <span class="n">clear</span> <span class="n">text</span> <span class="n">password</span>
<span class="k">if</span> <span class="p">(</span><span class="n">do_cleartext</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">/*</span> <span class="n">Packages</span> <span class="o">*/</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packages</span><span class="p">[</span><span class="n">num_packages</span><span class="o">++</span><span class="p">];</span>

    <span class="o">/*</span> <span class="n">Primary</span><span class="p">:</span><span class="n">CLEARTEXT</span> <span class="o">*/</span>
    <span class="n">nc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">names</span><span class="p">[</span><span class="n">num_names</span><span class="o">++</span><span class="p">];</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">packages</span><span class="p">[</span><span class="n">num_packages</span><span class="o">++</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">store</span> <span class="n">clear</span> <span class="n">text</span> <span class="n">password</span> <span class="n">into</span> <span class="n">the</span> <span class="n">package</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pc</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">nc</span>     <span class="o">=</span> <span class="s2">&quot;CLEARTEXT&quot;</span><span class="p">;</span>
    <span class="n">pcb</span><span class="o">.</span><span class="n">cleartext</span>   <span class="o">=</span> <span class="o">*</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">n</span><span class="o">.</span><span class="n">cleartext_utf16</span><span class="p">;</span>
    <span class="n">ndr_err</span> <span class="o">=</span> <span class="n">ndr_push_struct_blob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcb_blob</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">,</span>
        <span class="n">lp_iconv_convenience</span><span class="p">(</span><span class="n">ldb_get_opaque</span><span class="p">(</span><span class="n">ldb</span><span class="p">,</span> <span class="s2">&quot;loadparm&quot;</span><span class="p">)),</span>
        <span class="o">&amp;</span><span class="n">pcb</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ndr_push_flags_fn_t</span><span class="p">)</span><span class="n">ndr_push_package_PrimaryCLEARTEXTBlob</span><span class="p">);</span>

    <span class="n">pcb_hexstr</span> <span class="o">=</span> <span class="n">data_blob_hex_string_upper</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcb_blob</span><span class="p">);</span>

    <span class="n">pc</span><span class="o">-&gt;</span><span class="n">name</span>    <span class="o">=</span> <span class="s2">&quot;Primary:CLEARTEXT&quot;</span><span class="p">;</span>
    <span class="n">pc</span><span class="o">-&gt;</span><span class="n">reserved</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pc</span><span class="o">-&gt;</span><span class="n">data</span>    <span class="o">=</span> <span class="n">pcb_hexstr</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">store</span> <span class="n">package</span> <span class="n">into</span> <span class="n">supplementalCredentials</span>
<span class="n">scb</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">num_packages</span>    <span class="o">=</span> <span class="n">num_packages</span><span class="p">;</span>
<span class="n">scb</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">packages</span>    <span class="o">=</span> <span class="n">packages</span><span class="p">;</span>

<span class="n">ndr_push_struct_blob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">g</span><span class="o">.</span><span class="n">supplemental</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">,</span>
        <span class="n">lp_iconv_convenience</span><span class="p">(</span><span class="n">ldb_get_opaque</span><span class="p">(</span><span class="n">ldb</span><span class="p">,</span> <span class="s2">&quot;loadparm&quot;</span><span class="p">)),</span>
        <span class="o">&amp;</span><span class="n">scb</span><span class="p">,</span>
        <span class="p">(</span><span class="n">ndr_push_flags_fn_t</span><span class="p">)</span><span class="n">ndr_push_supplementalCredentialsBlob</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="encoder-and-decoder-functions">
<span id="id3"></span><h2>Encoder and Decoder Functions<a class="headerlink" href="#encoder-and-decoder-functions" title="Permalink to this heading">¶</a></h2>
<p>The clear text encoder &amp; decoder functions are defined in
librpc/gen_ndr/ndr_drsblobs.c:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_PUBLIC_</span> <span class="n">enum</span> <span class="n">ndr_err_code</span> <span class="n">ndr_push_package_PrimaryCLEARTEXTBlob</span><span class="p">(</span><span class="n">struct</span> <span class="n">ndr_push</span> <span class="o">*</span><span class="n">ndr</span><span class="p">,</span> <span class="nb">int</span> <span class="n">ndr_flags</span><span class="p">,</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">package_PrimaryCLEARTEXTBlob</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ndr_flags</span> <span class="o">&amp;</span> <span class="n">NDR_SCALARS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NDR_CHECK</span><span class="p">(</span><span class="n">ndr_push_align</span><span class="p">(</span><span class="n">ndr</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
        <span class="p">{</span>
            <span class="n">uint32_t</span> <span class="n">_flags_save_DATA_BLOB</span> <span class="o">=</span> <span class="n">ndr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
            <span class="n">ndr_set_flags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">LIBNDR_FLAG_REMAINING</span><span class="p">);</span>
            <span class="n">NDR_CHECK</span><span class="p">(</span><span class="n">ndr_push_DATA_BLOB</span><span class="p">(</span><span class="n">ndr</span><span class="p">,</span> <span class="n">NDR_SCALARS</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">cleartext</span><span class="p">));</span>
            <span class="n">ndr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">_flags_save_DATA_BLOB</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">NDR_CHECK</span><span class="p">(</span><span class="n">ndr_push_trailer_align</span><span class="p">(</span><span class="n">ndr</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ndr_flags</span> <span class="o">&amp;</span> <span class="n">NDR_BUFFERS</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">NDR_ERR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">_PUBLIC_</span> <span class="n">enum</span> <span class="n">ndr_err_code</span> <span class="n">ndr_pull_package_PrimaryCLEARTEXTBlob</span><span class="p">(</span><span class="n">struct</span> <span class="n">ndr_pull</span> <span class="o">*</span><span class="n">ndr</span><span class="p">,</span> <span class="nb">int</span> <span class="n">ndr_flags</span><span class="p">,</span> <span class="n">struct</span> <span class="n">package_PrimaryCLEARTEXTBlob</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ndr_flags</span> <span class="o">&amp;</span> <span class="n">NDR_SCALARS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NDR_CHECK</span><span class="p">(</span><span class="n">ndr_pull_align</span><span class="p">(</span><span class="n">ndr</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
        <span class="p">{</span>
            <span class="n">uint32_t</span> <span class="n">_flags_save_DATA_BLOB</span> <span class="o">=</span> <span class="n">ndr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
            <span class="n">ndr_set_flags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">LIBNDR_FLAG_REMAINING</span><span class="p">);</span>
            <span class="n">NDR_CHECK</span><span class="p">(</span><span class="n">ndr_pull_DATA_BLOB</span><span class="p">(</span><span class="n">ndr</span><span class="p">,</span> <span class="n">NDR_SCALARS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">cleartext</span><span class="p">));</span>
            <span class="n">ndr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">_flags_save_DATA_BLOB</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">NDR_CHECK</span><span class="p">(</span><span class="n">ndr_pull_trailer_align</span><span class="p">(</span><span class="n">ndr</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ndr_flags</span> <span class="o">&amp;</span> <span class="n">NDR_BUFFERS</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">NDR_ERR_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="proposed-solution">
<span id="id4"></span><h1>Proposed Solution<a class="headerlink" href="#proposed-solution" title="Permalink to this heading">¶</a></h1>
<p>There is no code changes required in Samba. However, after installing
Samba the clear text password needs to be enabled by executing the
following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">ldapmodify</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">D</span> <span class="s2">&quot;cn=Administrator,cn=Users,dc=samba,dc=example,dc=com&quot;</span> <span class="o">-</span><span class="n">W</span>
<span class="n">dn</span><span class="p">:</span> <span class="n">dc</span><span class="o">=</span><span class="n">samba</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">example</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="n">com</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">replace</span><span class="p">:</span> <span class="n">pwdProperties</span>
<span class="n">pwdProperties</span><span class="p">:</span> <span class="mi">17</span>
</pre></div>
</div>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="http://msdn.microsoft.com/en-us/library/aa375371%28VS.85%29.aspx">DOMAIN_PASSWORD_INFORMATION
Structure</a></p></li>
<li><p><a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc245682%28PROT.10%29.aspx">Primary:CLEARTEXT
Property</a></p></li>
<li><p><a class="reference external" href="http://msdn.microsoft.com/en-us/library/cc245686%28PROT.13%29.aspx">clearTextPassword</a></p></li>
<li><p><a class="reference external" href="http://www.opengroup.org/onlinepubs/9629399/chap14.htm">DCE 1.1:Remote Procedure Call - Transfer Syntax
NDR</a></p></li>
</ul>
<p><a class="reference external" href="Category:Obsolete">Category:Obsolete</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/Samba_4_Storing_Clear_Text_Password.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="Certificate_revocation_behaviour_standardisation.html" />
    <link rel="prev" title="Overview" href="Certificate_Request_Queues.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>FreeIPA includes a variety of certificate profiles for various use
cases. The profile primarily consists of a Dogtag profile configuration,
and a small amount of FreeIPA-specific configuration. Occasionally we
need to update the Dogtag configuration for a profile, typically to make
use of new profile policy components in Dogtag, to improve usable,
increase the range of supported use cases, and/or improve the
compatibility of issued certificates with server and client software.</p>
<p>FreeIPA configures Dogtag to use LDAP-based storage for profiles, so
that profile configuration changes made on one CA master are
automatically replicated to the other CA masters in the topology.</p>
<p>When updating a profile to use a profile component that is only
available from a particular version of Dogtag, we hit a problem. Because
FreeIPA can run in a mixed-version topology (i.e. different replicas,
including CA replicas, at different releases), updating a profile to
include a policy component only avaiabile in a newer release of Dogtag
potentially breaks certificate issuance on older releases of Dogtag in
the topology. This is undesirable.</p>
<p>Until now, our approach has been to ship the updated profile to be
included in new installations, but to leave the profile unchanged on
existing deployments to avoid potential breakage. This is also
undesirable, because it leaves the topology with a suboptimal profile
configuration, even when all CA masters in the topology are at a version
that could support the updated configuration.</p>
<p>The purpose of this design is to introduce a general, topology-aware
profile update mechanism that ensures that the latest version of a
profile that can be supported by the topology gets used, providing safe,
automatic profile updates.</p>
<section id="terminology">
<h2>Terminology<a class="headerlink" href="#terminology" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt><em>included profile</em></dt><dd><p>A profile that is included with FreeIPA</p>
</dd>
<dt><em>profile (configuration) template</em></dt><dd><p>The profile template that is shipped with FreeIPA, containing various
installation-specific substitutions to be performed to produce a
valid Dogtag profile configuration</p>
</dd>
<dt><em>profile configuration</em></dt><dd><p>A complete Dogtag profile configuration.</p>
</dd>
</dl>
</section>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>There is no user or administrator interaction involved in this mechanism
(modulo conflict resolution; see <em>Dealing with modified profiles</em>
below).</p>
<p>From a development perspective, updating a profile will involve the
following:</p>
<ul class="simple">
<li><p>If the updated profile configuration will require a higher minimum
version of FreeIPA than the current profile configuration, copy the
profile template to a new file, with the new <code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code> in
the filename.</p></li>
<li><p>Modify the profile configuration template, and increment the
<code class="docutils literal notranslate"><span class="pre">template-version</span></code>.</p></li>
</ul>
<p>See <em>Profile template versioning</em> below for a discussion of these
requirements.</p>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="design-at-a-glance">
<span id="id1"></span><h2>Design at a glance<a class="headerlink" href="#design-at-a-glance" title="Permalink to this heading">¶</a></h2>
<p>Each profile configuration shall now be accompanied by a version <em>of
that profile</em>. FreeIPA <code class="docutils literal notranslate"><span class="pre">certprofile</span></code> objects shall be updated to
include the profile configuration version that is currently active.</p>
<p>Each profile configuration shall now also be accompanied by the minimum
version of FreeIPA that supports that profile. Each profile may have
multiple configurations available, with different lower bounds.</p>
<p>FreeIPA master entries shall be updated to include the version of
FreeIPA that the master is currently at.</p>
<p>During server upgrade, the highest version of the profile configuration
that is supported by all CA masters in the topology shall be selected.
If the current version of that profile is lower than the selected
version, the profile shall be updated in Dogtag.</p>
</section>
<section id="profile-template-versioning">
<span id="id2"></span><h2>Profile template versioning<a class="headerlink" href="#profile-template-versioning" title="Permalink to this heading">¶</a></h2>
<p>Each profile template shall have a version consisting of two parts.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code> part shall be the earliest version of FreeIPA
that supports that version of the profile template. When a profile
template update requires a newer version of FreeIPA, a <strong>copy</strong> of the
profile template is made, and the <code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code> of that copy shall
be the version of FreeIPA it requires. The older version of the profile
template is kept. An example <code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code> value is <code class="docutils literal notranslate"><span class="pre">4.5.3</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">template-version</span></code> part shall be a non-negative integer. Whenever
a profile template is updated, whether or not it requires a newer
version of FreeIPA, the <code class="docutils literal notranslate"><span class="pre">template-version</span></code> is incremented. If the
profile does not require a newer version of FreeIPA, the changes are
performed in-place (i.e. no copy of the profile template is made).</p>
<section id="filesystem-storage">
<span id="id3"></span><h3>Filesystem storage<a class="headerlink" href="#filesystem-storage" title="Permalink to this heading">¶</a></h3>
<p>Profile templates are currently stored as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ipa</span><span class="o">/</span><span class="n">profiles</span><span class="o">/&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">profile</span><span class="o">-</span><span class="n">name</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>Now that we need to store multiple versions of a profile template, we
shall use the following schema:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ipa</span><span class="o">/</span><span class="n">profiles</span><span class="o">/&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">profile</span><span class="o">-</span><span class="n">name</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span><span class="o">.&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">ipa</span><span class="o">-</span><span class="n">lower</span><span class="o">-</span><span class="n">bound</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</pre></div>
</div>
<p>Each template file shall contain a <code class="docutils literal notranslate"><span class="pre">template-version</span></code> directive
asserting the template version.</p>
</section>
</section>
<section id="schema-changes">
<span id="id4"></span><h2>Schema changes<a class="headerlink" href="#schema-changes" title="Permalink to this heading">¶</a></h2>
<section id="certificate-profile-objects">
<span id="id5"></span><h3>Certificate profile objects<a class="headerlink" href="#certificate-profile-objects" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ipaCertProfile</span></code> object class shall be updated with a new optional
integer attribute for storing the version of the profile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># New attribute
attributeTypes: ( 2.16.840.1.113730.3.8.21.1.9
  NAME &#39;ipaCertProfileVersion&#39;
  DESC &#39;Profile version&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.27
  EQUALITY integerMatch
  ORDERING integerOrderingMatch
  SINGLE-VALUE
  X-ORIGIN &#39;IPA v4.6 Profile update mechanism&#39; )

objectClasses: ( 2.16.840.1.113730.3.8.21.2.1
  NAME &#39;ipaCertProfile&#39; SUP top STRUCTURAL
  MUST ( cn $ description $ ipaCertProfileStoreIssued )
  MAY ipaCertProfileVersion
  X-ORIGIN &#39;IPA v4.2&#39; )
</pre></div>
</div>
<p>The absense of the <code class="docutils literal notranslate"><span class="pre">ipaCertProfile</span></code> attribute value implies the
starting value of <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</section>
<section id="ipa-master-entries">
<span id="id6"></span><h3>IPA master entries<a class="headerlink" href="#ipa-master-entries" title="Permalink to this heading">¶</a></h3>
<p>Information about IPA masters is stored in entries
<code class="docutils literal notranslate"><span class="pre">cn=$FQDN,cn=masters,cn=ipa,cn=etc,$SUFFIX</span></code>. These entries shall be
updated to assert the version of FreeIPA currently installed on that
master.</p>
<p><strong>QUESTION</strong> the master entries have auxiliary object classes
<code class="docutils literal notranslate"><span class="pre">ipaConfigObject</span></code> and <code class="docutils literal notranslate"><span class="pre">ipaSupportedDomainLevelConfig</span></code>. Should we…</p>
<ol class="arabic simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">ipaConfigString:</span> <span class="pre">ipa-version</span> <span class="pre">$VERSION</span></code> to indicate the current
IPA version of the master?</p></li>
<li><p>Add a new attribute to the <code class="docutils literal notranslate"><span class="pre">ipaSupportedDomainLevelConfig</span></code> to
indicate the IPA version of the master?</p></li>
<li><p>Define a new auxiliary object class and an associated attribute for
the purpose of indicating the IPA version of the master, and add this
object class and attribute to master entries.</p></li>
</ol>
<p>I lean towards 3, or 2.</p>
</section>
</section>
<section id="changes-to-ipa-server-upgrade">
<span id="id7"></span><h2>Changes to <code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code><a class="headerlink" href="#changes-to-ipa-server-upgrade" title="Permalink to this heading">¶</a></h2>
<section id="ipa-version-update">
<span id="id8"></span><h3>IPA version update<a class="headerlink" href="#ipa-version-update" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">/usr/share/ipa/master-entry.ldif</span></code> template shall be updated to
include the current IPA version information, according to the <em>IPA
master entries</em> schema changes outlined above. The template substitution
dictionary shall be updated to include this datum.</p>
<p>This is small enhancement to the domain level bounds update already
performed by <code class="docutils literal notranslate"><span class="pre">ipa-server-upgrade</span></code>.</p>
</section>
<section id="profile-update">
<span id="id9"></span><h3>Profile update<a class="headerlink" href="#profile-update" title="Permalink to this heading">¶</a></h3>
<p><em>Note that the IPA version update_ must be performed before profile
updates.</em></p>
<p>During upgrade, the right template for the topology must be chosen and,
if not the version currently in use, the profile must be updated in
Dogtag.</p>
<p>Find all CA masters in the topology (search base
<code class="docutils literal notranslate"><span class="pre">cn=masters,cn=ipa,cn=etc,$SUFFIX</span></code> with filter <code class="docutils literal notranslate"><span class="pre">(cn=CA)</span></code>).</p>
<p>For each CA master entry returned, query the IPA version of the parent
entry, according to the <em>IPA master entries</em> schema changes outlined
above. Choose the lowest version (denoted the <em>target IPA version</em>).</p>
<p>For each included profile, glob
<code class="docutils literal notranslate"><span class="pre">/usr/share/ipa/profiles/&lt;profile-name&gt;.*</span></code> to find templates for that
profile. Each template file is suffixed with the <code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code>.
Eliminate templates with an <code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code> that exceeds the <em>target
IPA version</em>. Then choose the template with the highest
<code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code> (denoted the <em>target template</em>).</p>
<p>Read the <em>target template</em> to discover its <code class="docutils literal notranslate"><span class="pre">template-version</span></code>. Read
the LDAP <code class="docutils literal notranslate"><span class="pre">certprofile</span></code> object to discover its current version. If the
<code class="docutils literal notranslate"><span class="pre">template-version</span></code> exceeds the current profile version, format the
template and update the profile.</p>
</section>
<section id="dealing-with-modified-profiles">
<span id="id10"></span><h3>Dealing with modified profiles<a class="headerlink" href="#dealing-with-modified-profiles" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">certprofile</span></code> plugin currently allows included profiles to be
modified. Admins may have modified the configurations of included
profiles (e.g. to change the validity period of issued certificates).
The main question to answer here is:</p>
<p><strong>QUESTION</strong></p>
<blockquote>
<div><p><em>Should we try to detect customisations and incorporate them in the
updated profile configuration?</em></p>
</div></blockquote>
<p>Implications of <strong>yes</strong> to the question:</p>
<ul class="simple">
<li><p>More complexity and more data to retain so that we can detect user
modifications and attempt to merge them into the new profile
configuration. For example, it may be necessary to retain <em>every</em>
version of a profile that has been shipped, rather than just versions
for each <code class="docutils literal notranslate"><span class="pre">ipa-lower-bound</span></code>, so that diffs against the “pristine”
version of the current profile version can be performed. Essentially
a 3-way diff must be performed.</p></li>
<li><p>The possibility of merge conflicts, therefore the need of a conflict
resolution process of some kind, possibly requiring the involvement
of an admin, or explicit and clear reporting of the conflicts that
were encountered and how they were resolved.</p></li>
<li><p>The possibility of configuration choices made by admins resulting in
invalid or otherwise problematic configurations or problematic issued
certificates, even where there were not merge conflicts.</p></li>
</ul>
<p>Implications of <strong>no</strong> to the question:</p>
<ul class="simple">
<li><p>Profile configuration customisations will be reverted, possibly
resulting in changed profile behaviour that is is contrary to user
expectations.</p></li>
<li><p>Profile configurations should be backed up, so that admins can easily
restore custom configurations (preferably as a separate profile).</p></li>
<li><p>Release notes will have to prominently notify of this change and
discuss its implications.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">certprofile-mod</span></code> command should be updated to prohibit future
modification of included profile configurations.</p></li>
</ul>
</section>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
</section>
<section id="how-to-use">
<h1>How to Use<a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h1>
<p>There is no user or administrator action required to use this mechanism.</p>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Certificate_profile_update_mechanism.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Introduction" href="Smart_Proxy.html" />
    <link rel="prev" title="Overview" href="Server_Upgrade_Refactoring.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>IPA uses the Kerberos
<a class="reference external" href="http://k5wiki.kerberos.org/wiki/Projects/Services4User">S4U2Proxy</a>
feature to allow the web server framework to obtain an ldap service
ticket on the user’s behalf. Similarly, it is also used by the trust
system to obtain a cifs principal. This eliminates the need for the user
to delegate their full TGT.</p>
<p>The access control for these rules is controlled by several LDAP entries
contained in cn=s4u2proxy,cn=etc,$SUFFIX. Rules define what principals
can obtain service tickets for which other services, and optionally for
which subset of users. Targets define the list of services that may be
delegated.</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<p>Delegation of obtaining an ldap service principal for the HTTP service.
Two entries are required:</p>
<p>The first is a rule which defines the ACL:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">dn: cn=ipa-http-delegation,...</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectClass: ipaKrb5DelegationACL</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectClass: groupOfPrincipals</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">cn: ipa-http-delegation</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">memberPrincipal: HTTP/ipaserver.example.com&#64;EXAMPLE.COM</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ipaAllowedTarget: cn=ipa-ldap-delegation-targets,...</span></code></div>
</div>
<p>The second is a target of this rule which defines which principals may
be obtained:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">dn: cn=ipa-ldap-delegation-targets,...</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">objectClass: groupOfPrincipals</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">cn: ipa-ldap-delegation-targets</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">memberPrincipal: ldap/ipaserver.example.com&#64;EXAMPLE.COM</span></code></div>
</div>
<p>Both types of entries contain members in the form of memberPrincipal. In
the case of a rule these are the members that the rule applies to. In
the case of a target the members are the targets of the delegation. In
this case the rule has a member of HTTP/ and a rule with a member of
ldap/ which means that the HTTP principal can obtain an ldap service
ticket on behalf of the bound user.</p>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>The tricky bit here is that all entries are stored in the same container
and the only real distinguishing feature between a rule and a target is
the objectClass ipaKrb5DelegationACL.</p>
<p>A rule will have these objectClasses: top, groupOfPrincipals,
ipaKrb5DelegationACL.</p>
<p>A target will have these objectClasses: top, groupOfPrincipals.</p>
<p>This is only an issue when doing a find for targets because it will also
find rules. A new filter will need to be prepared to exclude
ipaKrb5DelegationACL.</p>
<p>Several entries may not be removed but need to be user-modifiable. This
could still result in an unusable system. The entries are
ipa-http-delegation, ipa-ldap-delegation-targets and
ipa-cifs-delegation-targets.</p>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>Some major methods of the standard LDAPAddMember and LDAPRemoveMember
classes need to be overridden since memberPrincipal is not a DN, nor
should it be. One reason is that the principal may not necessarily be
local so there may not be a DN to reference. There are also performance
reasons within the kdb code.</p>
<p>These built-in add/remove methods assume, and require via asserts, that
all members be a DN. get_member_dns() will need to ignore any
memberPrincipal values and return only the DN-based values when adding
targets to rules to let the standard mechanics of LDAP*Member do their
work.</p>
<p>In order to handle the memberPrinicpal values a post_callback() is
required. This also means that there will be at worst two writes per
membership update. Given that this feature is not expected to be
frequently used then speed and efficiency are not a factor.</p>
<p>Similarly, we need to enforce that only a target is a member of a rule,
and not another rule. That would be an undefined relationship. To do
this each member will need to be retrieved and evaluated before adding
as a member.</p>
<p>A referential integrity rule will be needed for ipaallowedtarget.</p>
<p>A referential integrity rule is needed, but is not possible, for
memberPrincipal. It is not possible because it is a DN. This adds the
potential to have dangling pointers.</p>
<p>The ACL system also provides a means of limiting which user’s a ticket
may be obtained for using the ipaAllowToImpersonate attribute. This is
not implemented.</p>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<p>TBD <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5044">https://fedorahosted.org/freeipa/ticket/5044</a></p>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<p>Overview of the CLI commands.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>servicedelegationrule-add RULE</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>servicedelegationrule-find</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>servicedelegationrule-del RULE</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>servicedelegationrule-add-member</p></td>
<td><p>–principals={PRINC,PRINC2}</p></td>
</tr>
<tr class="row-even"><td><p>servicedelegationrule-remove-member</p></td>
<td><p>–principals={PRINC,PRINC2}</p></td>
</tr>
<tr class="row-odd"><td><p>servicedelegationrule-add-target</p></td>
<td><p>–targets={TARGET,TARGET2}</p></td>
</tr>
<tr class="row-even"><td><p>servicedelegationrule-remove-target</p></td>
<td><p>–targets= {TARGET,TARGET2}</p></td>
</tr>
<tr class="row-odd"><td><p>servicedelegationtarget-add TARGET</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>servicedelegationtarget-find</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>servicedelegationtarget-del TARGET</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>servicedelegationtarget-add_member TARGET</p></td>
<td><p>–principals={PRINC,PRINC2}</p></td>
</tr>
<tr class="row-odd"><td><p>servicedelegationtarget-remove_member TARGET</p></td>
<td><p>–principals={PRINC,PRINC2}</p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<p>N/A</p>
</section>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
<p>N/A</p>
</section>
<section id="how-to-test">
<span id="how-to-test37"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<p>Simple test to create a couple of principals, a constraint rule, then
fetch a ticket on behalf of a user for one of the principals.</p>
<p><strong>NOTE</strong>: This uses kvno which requires S4U2Self to operate for some
reason, hence having to use +ok_to_auth_as_delegate. Whatever you do,
<strong>DON’T</strong> do this in production.</p>
<p>Become admin:</p>
<p><code class="docutils literal notranslate"><span class="pre"># kinit admin</span></code></p>
<p>Create the service for the rule and allow it to impersonate users:
[<strong>NOTE</strong>: DO NOT DO THIS IN PRODUCTION, this allows the ‘test’ service
to impersonate *any* user to itself and then by proxy to the target
services]</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa service-add test/ipa.example.com --force</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kadmin.local</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">kadmin.local: modprinc +ok_to_auth_as_delegate test/ipa.example.com</span></code></div>
</div>
<p>Create the second service:</p>
<p><code class="docutils literal notranslate"><span class="pre"># ipa service-add test2/ipa.example.com --force</span></code></p>
<p>Get keytabs for these services:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa-getkeytab -s ipa.example.com -k /tmp/test.keytab -p test/ipa.example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa-getkeytab -s ipa.example.com -k /tmp/test2.keytab -p test2/ipa.example.com</span></code></div>
</div>
<p>Show that we can’t do delegation yet:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kdestroy -A</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit -kt /tmp/test.keytab  test/ipa.example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kvno -k /tmp/test.keytab -U admin -P test/ipa.example.com test2/ipa.example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">kvno: KDC returned error string: NOT_ALLOWED_TO_DELEGATE test2/ipa.example.com&#64;EXAMPLE.COM: constrained delegation failed</span></code></div>
</div>
<p>Add the service constraint delegation:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kdestroy -A</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit admin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa servicedelegationrule-add test</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa servicedelegationtarget-add target-test</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa servicedelegationrule-add-target --servicedelegationtargets=target-test test</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa servicedelegationrule-add-member --principals test/ipa.example.com test</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa servicedelegationtarget-add-member --principals=test2/ipa.example.com target-test</span></code></div>
</div>
<p>Now try again:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kdestroy -A</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit -kt /tmp/test.keytab  test/ipa.example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kvno -k /tmp/test.keytab -U admin -P test/ipa.example.com test2/ipa.example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">test/ipa.example.com&#64;EXAMPLE.COM: kvno = 2, keytab entry valid</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">test2/ipa.example.com&#64;EXAMPLE.COM: kvno = 2, keytab entry valid</span></code></div>
</div>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p>TBD</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Service_Constraint_Delegation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
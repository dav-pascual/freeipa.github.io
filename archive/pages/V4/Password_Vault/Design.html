<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Overview" href="Test_Plan.html" />
    <link rel="prev" title="&lt;no title&gt;" href="Clevis_Pin.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>Users often want a way to securely store passwords so they don’t have to
remember them. This is often handled by a password keyring type
functionality on a client system. This works fine from a single client
system, but it doesn’t work well if a user wants to access their
passwords from multiple systems. A network-based approach allows an
authenticated user to retrieve passwords from multiple client systems.</p>
<p>It is also common for services to require knowledge of passwords or
keys, which is typically handled by storing those secrets locally on the
system where the service is installed. Storing these secrets locally is
inconvenient and has security risk. This inconvenience and risk is also
compounded when multiple instances of the same service require knowledge
of the same secrets. Storing these secrets centrally makes
authorization, distribution and rollover of secrets for services much
easier to maintain.</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<ol class="arabic simple">
<li><p>A service wants to securely store passwords in a centralized location
and have the ability to easily retrieve them programatically when the
password needs to be used. Nobody other than the service and the
service administrator should be able to access the password.</p></li>
<li><p>A user wants to securely store passwords in a centralized location
and have the ability to easily retrieve them manually when the
password is forgotten. An escrow key will optionally be available to
authorized administrators to prevent loss of the passwords.</p></li>
</ol>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>A user or service who archives secrets in the password vault will
encrypt their secrets on the client side prior to sending them to IPA.
This encryption will use a symmetric key that is generated from a vault
password that is only known by the user or service. This approach
ensures that IPA never has direct knowledge of one of the clear-text
secrets that a user or service is storing.</p>
<p>If escrow functionality is desired, an escrow officer will need to be
created. This entails generating an escrow officer keypair that will be
used to encrypt/decrypt the vault encryption key associated with a user
or service. The ability to have multiple escrow officers is possible.
This would allow different groups of users to be assigned to different
escrow officers, which could be used to have different levels of
security with regards to escrowed key access. The escrow officer public
keys must be available to IPA clients. The escrow officer private keys
can be stored on an IPA server, or offline (preferred for security
paranoid situations).</p>
<section id="definitions">
<h2>Definitions<a class="headerlink" href="#definitions" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><strong>Secret</strong> - A <em>Secret</em> is a password or key that a user or service
wants to securely archive in the Password Vault.</p></li>
<li><p><strong>Vault Password</strong> - A password that is used by a user or a service
when archiving or retrieving secrets from the Password Vault. A
<em>Vault Password</em> is used to derive a <em>Vault Encryption Key</em> for a
user or service. The <em>Vault Password</em> is only known by the user or
service who owns it.</p></li>
<li><p><strong>Vault Encryption Key</strong> - A symmetric key that is used to encrypt
secrets that a user or a service stores in the Password Vault. Each
user or service usually has their own encryption key, though an
encryption key might be shared among multiple instances of a service
if desired.</p></li>
<li><p><strong>Data Recovery Manager (DRM)</strong> - A Dogtag subsystem that is designed
for secure archival and retrieval of keys. A <em>DRM</em> subsystem will be
created when the Password Vault feature is enabled.</p></li>
<li><p><strong>Secret ID</strong> - An identifier that the user or service uses to
identify a <em>Secret</em>. This identifier is a simple name that is unique
per user or service. The user or service will use this identifier
directly when performing archival and retrieval operations.</p></li>
<li><p><strong>Client ID</strong> - An identifier that the <em>DRM</em> uses as a convenience
label for an archived key. This identifier is a simple name. The
<em>DRM</em> does not enforce the uniqueness of this identifier, though IPA
should. This identifier is not exposed to the user or service.</p></li>
<li><p><strong>Key ID</strong> - An identifier that the <em>DRM</em> uses to identify an
archived key. This is a unique hexadecimal identifer that the <em>DRM</em>
generates when a key is archived. This identifier is later used
during key retrieval. This identifier is not exposed to the user or
service.</p></li>
</ul>
</section>
<section id="authentication-and-authorization">
<span id="id1"></span><h2>Authentication and Authorization<a class="headerlink" href="#authentication-and-authorization" title="Permalink to this heading">¶</a></h2>
<p>For simplicity, the workflow diagrams in this document do not show
details about authentication or authorization. This section describes
how authentication and authorization are handed.</p>
<p>A user or service authenticates to the IPA Server using Kerberos/GSSAPI
just as they do when running any of the IPA client commands. The IPA
Server is responsible for authorizing a user or service to retrieve or
store a secret.</p>
<p>The IPA Server authenticates to the DRM as a special <em>Agent</em> user using
an x.509 certificate. This <em>Agent</em> is allowed to archive or retrieve any
secret that is stored in the DRM, though it is important to note that
the secrets are encrypted such that the IPA Server is unable to decrypt
them.</p>
</section>
<section id="common-workflows">
<span id="id2"></span><h2>Common Workflows<a class="headerlink" href="#common-workflows" title="Permalink to this heading">¶</a></h2>
<p>The following workflows apply to the common use-cases of archiving and
retrieving secrets from the Password Vault.</p>
<section id="archival">
<h3>Archival<a class="headerlink" href="#archival" title="Permalink to this heading">¶</a></h3>
<p>The following diagram illustrates the workflow that is used when a user
or service wants to archive a secret in the Password Vault. From the
user or service’s point of view, they simply supply their <em>Vault
Password</em>, the <em>Secret</em> that they want to store, and the <em>Secret ID</em>
that they want to use to identify the <em>Secret</em> for future retrieval.</p>
<figure class="align-default" id="id15">
<img alt="Password_Vault_Archival.png" src="../../../../_images/Password_Vault_Archival.png" />
<figcaption>
<p><span class="caption-text">Password_Vault_Archival.png</span><a class="headerlink" href="#id15" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="retrieval">
<h3>Retrieval<a class="headerlink" href="#retrieval" title="Permalink to this heading">¶</a></h3>
<p>The following diagram illustrates the workflow that is used when a user
or service wants to retrieve a secret from the Password Vault. From the
user or service’s point of view, they simply supply their <em>Vault
Password</em> and the <em>Secret ID</em> that identifies the <em>Secret</em> that they
want to retrieve. They will be given the clear-text <em>Secret</em> in
response.</p>
<figure class="align-default" id="id16">
<img alt="Password_Vault_Retrieval.png" src="../../../../_images/Password_Vault_Retrieval.png" />
<figcaption>
<p><span class="caption-text">Password_Vault_Retrieval.png</span><a class="headerlink" href="#id16" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="vault-password-reset">
<span id="id3"></span><h3>Vault Password Reset<a class="headerlink" href="#vault-password-reset" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>User uses IPA CLI reset their vault password.</p></li>
<li><p>User supplies old vault password, which derives the current symmetric
encryption key on the client side.</p></li>
<li><p>User supplies a new vault password, which derives a new symmetric
encryption key on the client side.</p></li>
<li><p>Client CLI contacts IPA to retrieve all stored secrets.</p></li>
<li><p>Retrieved secrets are decrypted using the current encryption key,
then re-encrypted using the new encryption key.</p></li>
<li><p>Newly encrypted secrets are sent to IPA as archival requests.</p></li>
</ul>
</section>
</section>
<section id="service-workflows">
<span id="id4"></span><h2>Service Workflows<a class="headerlink" href="#service-workflows" title="Permalink to this heading">¶</a></h2>
<p>The following workflows apply to the use case where a service is storing
secrets in the Password Vault. These workflows assume that the process
of a service retrieving and decrypting secrets is handled in an
automated fashion. In particular, this changes things with respect to
the use of a vault password, as there is no way for the service to
interactively provide this password to encrypt/decrypt secrets.</p>
<p>Instead of simply storing the service’s vault password (that might be
shared by multiple instances of a service) in a file on the system where
the service is installed, public key cryptography is used to allow the
service to securely retrieve it’s vault password from the password
vault. This requires each instance of a service to have it’s own
public/private key pair that a service administrator sets up on the
system where the service runs. The private key could be protected by
file system permissions to allow it to be used in a completely automated
fashion, or it could be password protected (requiring it to be manually
unlocked each time the service is started).</p>
<p>A vault password for a service (or a group of services that need to
access the same archived secrets) is stored in the password vault using
a service administrator vault password. This is done using the user use
case workflow described above. This allows the service administrator to
retrieve the service vault password when they set up a new instance of
the service. The service administrator can then archive a copy of the
service vault password that is encrypted using the service instance’s
public key so it can only be decrypted by that single instance of the
installed service. This approach allows an administrator to add or
remove instances of a service without affecting other instances of the
same service. It also allows an admin to change the service vault
password for all instances of a service by archiving encrypted copies
the new vault password with the public keys of the service instances.</p>
<section id="archival-of-a-service-vault-password-at-service-set-up-time">
<span id="id5"></span><h3>Archival of a service vault password (at service set up time)<a class="headerlink" href="#archival-of-a-service-vault-password-at-service-set-up-time" title="Permalink to this heading">¶</a></h3>
<p>The following diagram illustrates the workflow that is used when a
service administrator is setting up a new instance of a service. This
workflow assumes that a few prerequisite tasks have been completed:</p>
<ul class="simple">
<li><p>The service administrator has the desired <em>Service Vault Password</em>
archived as one of their personal secrets. This can be completed
using the normal archival workflow.</p></li>
<li><p>The new service instance has been defined in IPA.</p></li>
<li><p>IPA has issued a certificate for the new service instance.</p></li>
</ul>
<p>From the service administrator’s point of view, they simply supply their
<em>Vault Password</em>, the <em>Secret ID</em> that identifies the <em>Service Vault
Password</em> that is shared by all instances of the service, and the
<em>Service Principal</em> that identifies the instance of the service that
they are setting up. The result is that a copy of the <em>Service Vault
Password</em> is archived that can only be retrieved and decrypted by the
new service instance.</p>
<figure class="align-default" id="id17">
<img alt="Password_Vault_Service_Password_Archival.png" src="../../../../_images/Password_Vault_Service_Password_Archival.png" />
<figcaption>
<p><span class="caption-text">Password_Vault_Service_Password_Archival.png</span><a class="headerlink" href="#id17" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="retrieval-of-service-vault-password-automated">
<span id="id6"></span><h3>Retrieval of service vault password (automated)<a class="headerlink" href="#retrieval-of-service-vault-password-automated" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>The service retrieves it’s copy of the encrypted service vault
password from the password vault.</p></li>
<li><p>The service decrypts the service vault password using it’s private
key. This decrypted vault password can be used to decrypt retrieved
secrets that the service is allowed to access.</p></li>
</ul>
</section>
</section>
<section id="escrow-workflows">
<span id="id7"></span><h2>Escrow Workflows<a class="headerlink" href="#escrow-workflows" title="Permalink to this heading">¶</a></h2>
<section id="archival-1">
<span id="id8"></span><h3>Archival<a class="headerlink" href="#archival-1" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>If escrow functionality is desired, the IPA client framework
retrieves escrow officer public key from LDAP and uses it to encrypt
the new encryption key. This encrypted encryption key is sent to IPA
over a GSSAPI protected connection and is stored in the DRM.</p></li>
</ul>
</section>
<section id="retrieval-escrow-officer-initiated">
<span id="id9"></span><h3>Retrieval (escrow officer initiated)<a class="headerlink" href="#retrieval-escrow-officer-initiated" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>Authenticated escrow officer requests administrative retrieval of a
user’s secret from IPA CLI.</p></li>
<li><p>IPA receives the administrative retrieval request and requests
retrieval from the DRM using the agent certificate to authenticate.</p></li>
<li><p>IPA receives the encrypted secret from the DRM and sends it back to
the escrow officer.</p></li>
<li><p>IPA retrieves the user’s encrypted escrowed encryption key and sends
it back to the escrow officer.</p></li>
<li><p>IPA client framework decrypts the encrypted encryption key using the
escrow officer’s private key on the escrow officer’s workstation.</p></li>
<li><p>IPA client framework uses the encryption key to decrypt the secret
and presents it to the escrow officer.</p></li>
</ul>
</section>
<section id="vault-password-reset-with-escrowed-encryption-key">
<span id="id10"></span><h3>Vault Password Reset (with escrowed encryption key)<a class="headerlink" href="#vault-password-reset-with-escrowed-encryption-key" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><p>User forgets their vault password.</p></li>
<li><p>User requests to reset their vault password from CLI.</p></li>
<li><p>User supplies a new vault password, which derives a new symmetric
encryption key on the client side.</p></li>
<li><p>IPA client framework retrieves escrow officer public key from LDAP
and uses it to encrypt the new encryption key.</p></li>
<li><p>Encrypted new encryption key is sent to IPA over a GSSAPI protected
connection.</p></li>
<li><p>IPA accesses the online private escrow officer key that is associated
with this user.</p>
<ul>
<li><p>For the offline private key case, admin intervention is required
here to perform the stored secret rewrapping. This will require a
two-step process or an admin initiated password reset.</p></li>
</ul>
</li>
<li><p>Escrowed user encryption key is fetched and decrypted using the
private escrow officer key on the IPA server.</p>
<ul>
<li><p>This would happen on the escrow officer workstation for the
offline private key case.</p></li>
</ul>
</li>
<li><p>New user encryption key is decrypted using the private escrow officer
key on the IPA server.</p>
<ul>
<li><p>This would happen on the escrow officer workstation for the
offline private key case.</p></li>
</ul>
</li>
<li><p>User’s stored secrets are extracted from the DRM, decrypted using the
escrowed user encryption key, and re-encrypted using the new user
encryption key. The re-encrypted secrets are stored in the DRM,
replacing the old secrets. This all takes place on the IPA server.</p>
<ul>
<li><p>This decryption/encryption would happen on the escrow officer
workstation for the offline private key case. The escrow officer
would need to be allowed to retrieve and store secrets for users
they are assigned to.</p></li>
</ul>
</li>
<li><p>New encryption key (encrypted with the escrow officer’s public key)
is stored, replacing the old escrowed encryption key.</p></li>
</ul>
</section>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>The <a class="reference external" href="V4/Password_Vault_Implementation">implementation details</a> still
need to be defined. Consider this section as a work in progress.</p>
<section id="drm-namespace">
<span id="id11"></span><h2>DRM Namespace<a class="headerlink" href="#drm-namespace" title="Permalink to this heading">¶</a></h2>
<p>The namespace used to store secrets in the DRM needs to be defined. We
likely want a naming scheme that gives each user a namespace. One
possible naming scheme is:</p>
<p><code class="docutils literal notranslate"><span class="pre">-</span></code></p>
</section>
<section id="ldap-implementation-details">
<span id="id12"></span><h2>LDAP Implementation Details<a class="headerlink" href="#ldap-implementation-details" title="Permalink to this heading">¶</a></h2>
<section id="escrow-officer-assignment">
<span id="id13"></span><h3>Escrow Officer Assignment<a class="headerlink" href="#escrow-officer-assignment" title="Permalink to this heading">¶</a></h3>
<p>The LDAP schema used to assign an escrow officer to users and groups
needs to be defined.</p>
</section>
<section id="stored-secret-tracking">
<span id="id14"></span><h3>Stored Secret Tracking<a class="headerlink" href="#stored-secret-tracking" title="Permalink to this heading">¶</a></h3>
<p>We will need to track the secrets that are stored for users in LDAP. The
main reason for this is to keep track of the names of secrets that a
user has stored in the DRM. This will allow IPA to perform some basic
access control checks, such as rejecting attempts to retrieve a secret
that IPA is not aware of.</p>
<p>Having entries that track the stored secrets will also allow us to have
some more advanced access control, such as host-based restrictions. An
LDAP entry that represents a stored secret could hold attributes that
list hosts or hostgroups that are allowed to retrieve a stored secret.</p>
<p>The LDAP schema and entry location for this needs to be defined.</p>
</section>
</section>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<p>TBD</p>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<p>TBD</p>
</section>
</section>
<section id="major-configuration-options-and-enablement">
<h1>Major configuration options and enablement<a class="headerlink" href="#major-configuration-options-and-enablement" title="Permalink to this heading">¶</a></h1>
<p>The password vault should be an optional feature that is enabled at
install time, or afterwards. This will require changes to
ipa-server-install as well as a new command such as ipa-enable-vault.
When a vault is desired, a new DRM instance will need to be created and
configured using pkispawn.</p>
</section>
<section id="replication">
<h1>Replication<a class="headerlink" href="#replication" title="Permalink to this heading">¶</a></h1>
<p>The password vault should be replicated for redundancy. This would
leverage the existing Dogtag cloning functionality for the DRM
subsystem. This would require separate replication agreements since the
DRM internal database would be stored in a separate suffix in 389 DS.
This would allow some FreeIPA replicas to have a password vault while
other do not.</p>
</section>
<section id="updates-and-upgrades">
<h1>Updates and Upgrades<a class="headerlink" href="#updates-and-upgrades" title="Permalink to this heading">¶</a></h1>
<p>The password vault requires that a DRM instance is created on each
FreeIPA replica. If an existing IPA replica does not have a DRM created,
the new functionality will not be available. We should not create a DRM
at upgrade time. Instead, one would have to manually enable the password
vault feature on existing FreeIPA replicas, which would trigger DRM
creation.</p>
<p>Currently, the Dogtag DRM subsystem requires a CA subsystem. This means
we will not be able to offer password vault functionality in a CA-less
installation. There are plans for Dogtag to support a standalone DRM,
which will allow FreeIPA to have a password vault without a CA.</p>
</section>
<section id="dependencies">
<h1>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h1>
<p>The password vault would use the Dogtag DRM subsystem. FreeIPA already
relies on Dogtag for it’s CA subsystem, but the DRM subsystem is
contained in an additional package. This dependency should be optional
since not everyone would have the password vault functionality enabled.</p>
</section>
<section id="external-impact">
<h1>External Impact<a class="headerlink" href="#external-impact" title="Permalink to this heading">¶</a></h1>
<p>Development of this functionality will require working closely with the
Dogtag development team. There might be new DRM interfaces that are
required by this feature that will require RFEs for Dogtag. One such RFE
that is known is support for a standalone DRM subsystem to allow it to
work in a CA-less FreeIPA installation.</p>
</section>
<section id="backup-and-restore">
<h1>Backup and Restore<a class="headerlink" href="#backup-and-restore" title="Permalink to this heading">¶</a></h1>
<p>The password vault will need to be backed up. This will require backing
up the DRM data from LDAP, DRM certificate databases, and DRM
configuration files.</p>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="http://www.freeipa.org/page/V4/Password_Vault/Test_Plan">Test
Plan</a></p></li>
</ul>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://developer.mozilla.org/en-US/docs/JavaScript_crypto">JavaScript
crypto</a></p></li>
<li><p><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/keygen">keygen</a></p></li>
<li><p><a class="reference external" href="http://code.google.com/p/crypto-js/">crypto-js</a></p></li>
<li><p><a class="reference external" href="https://github.com/digitalbazaar/forge">Forge</a></p></li>
<li><p><a class="reference external" href="https://crackstation.net/hashing-security.htm">Salted Password Hashing - Doing it
Right</a></p></li>
</ul>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../../_sources/archive/pages/V4/Password_Vault/Design.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
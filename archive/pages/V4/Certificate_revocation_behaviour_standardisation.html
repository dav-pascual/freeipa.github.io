<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="Certificates_Refactoring.html" />
    <link rel="prev" title="Overview" href="Certificate_profile_update_mechanism.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>In the past, FreeIPA automatically revoked certificates upon renewal.
This behaviour was acceptable when the <em>one certificate per service</em> was
the only thing that was possible.</p>
<p>With the implementation of <a class="reference external" href="V4/Certificate%20Profiles">custom certificate
profiles</a> and <a class="reference external" href="V4/User%20Certificates">user
certificates</a>, it was decided to stop
revoking certificates upon renewal. Because of the possibility of
multiple certificates (for different purposes) per principal, it was not
always known which certificate should be revoked. Revocation list growth
was also a concern.</p>
<p>This change in behaviour continues to confuse users and developers. For
example, <a class="reference external" href="https://pagure.io/freeipa/issue/7482">https://pagure.io/freeipa/issue/7482</a> was filed, suggesting the
lack of revocation of the old certificate upon renewal was a regression.
A patch and <a class="reference external" href="https://github.com/freeipa/freeipa/pull/1915#issuecomment-388295460">pull
request</a>
were created before, in the ensuing discussion, it was discovered that
this was the intended behaviour. This episode prompted a debate about
what our certificate revocation behaviour should be.</p>
<p>The purpose of this design is to formalise what FreeIPA’s certificate
revocation behaviour(s) should be (being the canonical reference for
such behaviour), and to outline any changes necessary to implement the
behaviour(s).</p>
<section id="terminology">
<h2>Terminology<a class="headerlink" href="#terminology" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt><em>IPA-managed CA</em></dt><dd><p>The IPA CA, any lightweight CA hosted in the Dogtag instance, or any
other CA that FreeIPA can cause to revoke certificates.</p>
</dd>
</dl>
</section>
<section id="design-guidelines">
<span id="id1"></span><h2>Design guidelines<a class="headerlink" href="#design-guidelines" title="Permalink to this heading">¶</a></h2>
<p>The following guidelines inform this design. They are important
considerations, not unbreakable rules. Deviations should be justified.</p>
<ul class="simple">
<li><p>Command behaviour should be consistent across use cases. For example,
a command should not revoke a certificate in some circumstances but
not others (unless explicitly told to do so).</p></li>
<li><p>Similar commands for different principal types should have similar
behaviour. For example, if <code class="docutils literal notranslate"><span class="pre">service-disable</span></code> revokes certificates,
then <code class="docutils literal notranslate"><span class="pre">user-disable</span></code> should revoke certificates.</p></li>
<li><p>Specialised behaviour should belong to specialised commands. For
example, a general command for manipulating LDAP objects should not
have specialised behaviours for some attributes, such as revoking
removed <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> values.</p></li>
<li><p>Multiple simpler commands are better than single commands with
complex behaviour and many options. Yes, it might mean an
administrator has to type more commands. But automation reduces that
concern, and it is easier for the administrator to get it right.</p></li>
<li><p>Ideally, there should be a single command to accomplish a given
action. Administrators should not have to ask <em>“should I use
service-mod or service-remove-cert?”</em></p></li>
</ul>
</section>
<section id="assumptions">
<h2>Assumptions<a class="headerlink" href="#assumptions" title="Permalink to this heading">¶</a></h2>
<p><strong>Hosts and services can have multiple certificates.</strong> The common case
is when host or services principals only need one certificate. Although
it may seem desirable to automatically revoke an old certificate when it
is renewed, in the general case where a subject principal can have
multiple certificates, it is not decidable which of their existing
certificates is being renewed (and should be revoked, removed).</p>
<p><strong>A certificate is included in the ``userCertificate`` attribute of at
most one principal.</strong> In this design we ignore the possibility of a
single <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> attribute value occurring on multiple
principals. This situation does not arise in normal use.</p>
</section>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<section id="issuance-of-a-new-certificate-non-renewal">
<span id="id2"></span><h2>Issuance of a new certificate (non-renewal)<a class="headerlink" href="#issuance-of-a-new-certificate-non-renewal" title="Permalink to this heading">¶</a></h2>
<p>A host, service or user certificate is being requested for some new
purpose. The subject may already have certificates for other purposes.
Existing certificates <em>must not be revoked</em>.</p>
</section>
<section id="renewal-due-to-impending-expiry">
<span id="id3"></span><h2>Renewal due to impending expiry<a class="headerlink" href="#renewal-due-to-impending-expiry" title="Permalink to this heading">¶</a></h2>
<p>A certificate is requested to renew an existing certificate. After the
new certificate is issued, it does no harm to revoke the old
certificate. But it is <em>not necessary to revoke</em> the old certificate,
because it will soon expire.</p>
</section>
<section id="renewal-for-other-reasons">
<span id="id4"></span><h2>Renewal for other reasons<a class="headerlink" href="#renewal-for-other-reasons" title="Permalink to this heading">¶</a></h2>
<p>A certificate could be renewed before its expiration time is near, for
any reason (e.g. re-key due to compromise, add a Subject Alternative
Name, etc.) As a simplifying assumption, we’ll treat all revocation
reasons the same way. It is therefore <em>necessary to revoke</em> the
certificate that is being replaced (and only that certificate).</p>
</section>
<section id="revocation-without-renewal">
<span id="id5"></span><h2>Revocation without renewal<a class="headerlink" href="#revocation-without-renewal" title="Permalink to this heading">¶</a></h2>
<p>A certificate (or its subject) may cease operation such that revocation
is required. If a single certificate requires revocation, in the common
case, it should also be removed from the subject’s <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code>
attribute (if present). If the principal is being disabled or deleted,
all of its certificates should be revoked, whether it is a host, service
or user principal.</p>
<p><strong>TODO</strong> is there any case where an administrator would want to
disable/preserve a user but <em>not revoke certificates</em>?</p>
</section>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="cert-request">
<span id="id6"></span><h2><code class="docutils literal notranslate"><span class="pre">cert-request</span></code><a class="headerlink" href="#cert-request" title="Permalink to this heading">¶</a></h2>
<p>Based on the use cases above, requesting a new certificate is
<em>sometimes</em> associated with a desire to revoke <em>one</em> certificate.
Revocation as a default behaviour is wrong.</p>
<p>Could we make <code class="docutils literal notranslate"><span class="pre">cert-request</span></code> smart enough to guess what it should do?
Fuzzy heuristics that could be employed to make a guess, e.g. by
examining certificate attributes, validity period, the subject public
key, the profile and CA that were used, and so on. The guessing logic
would be complex, and could not guarantee a correct answer. It is not
the right approach.</p>
<p>Keeping in mind the desire for consistent behaviour of commands, and the
fact that <code class="docutils literal notranslate"><span class="pre">cert-request</span></code> is already a complicated command, the correct
behaviour is for <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-request</span></code> to <strong>never revoke any
certificate</strong>, nor remove any <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> attribute value from
the subject principal’s entry.</p>
<section id="differences-from-current-behaviour">
<span id="id7"></span><h3>Differences from current behaviour<a class="headerlink" href="#differences-from-current-behaviour" title="Permalink to this heading">¶</a></h3>
<p>None.</p>
</section>
</section>
<section id="host-service-user-mod">
<span id="hostserviceuser-mod"></span><h2><code class="docutils literal notranslate"><span class="pre">{host,service,user}-mod</span></code><a class="headerlink" href="#host-service-user-mod" title="Permalink to this heading">¶</a></h2>
<p>Removal of a <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> attribute value <strong>shall not revoke the
certificate</strong>.</p>
<p>Rationale: The <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code> command already provides revocation
behaviour. Non-IPA-managed certificates cannot be revoked by FreeIPA, so
revoking IPA-managed certificates violates the consistency guideline.
Not all certificates that need revocation will appear in the subject’s
<code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> attribute (e.g. if the profile does not store
certificates), so explicit <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code> is still needed. Furthermore,
forcing the operator to use <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code> allows them to specify a
revocation reason.</p>
<section id="differences-from-current-behaviour-1">
<span id="id8"></span><h3>Differences from current behaviour<a class="headerlink" href="#differences-from-current-behaviour-1" title="Permalink to this heading">¶</a></h3>
<p>Revocation behaviour needs to be removed from the <code class="docutils literal notranslate"><span class="pre">service-mod</span></code> and
<code class="docutils literal notranslate"><span class="pre">host-mod</span></code> commands. (<strong>Backwards compatibility concern.</strong>)</p>
</section>
</section>
<section id="host-service-user-remove-cert">
<span id="hostserviceuser-remove-cert"></span><h2><code class="docutils literal notranslate"><span class="pre">{host,service,user}-remove-cert</span></code><a class="headerlink" href="#host-service-user-remove-cert" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">{host,service,user}-remove-cert</span></code> commands <strong>shall not revoke
certificates</strong>.</p>
<p>Rationale: The <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code> command already provides revocation
behaviour. Non-IPA-managed certificates cannot be revoked by FreeIPA, so
revoking IPA-managed certificates violates the consistency guideline.
Not all certificates that need revocation will appear in the subject’s
<code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> attribute (e.g. if the profile does not store
certificates), so explicit <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code> is still needed. Furthermore,
forcing the operator to use <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code> allows them to specify a
revocation reason.</p>
<section id="differences-from-current-behaviour-2">
<span id="id9"></span><h3>Differences from current behaviour<a class="headerlink" href="#differences-from-current-behaviour-2" title="Permalink to this heading">¶</a></h3>
<p>Revocation behaviour needs to be removed from the
<code class="docutils literal notranslate"><span class="pre">service-remove-cert</span></code> and <code class="docutils literal notranslate"><span class="pre">host-remove-cert</span></code> commands. (<strong>Backwards
compatibility concern.</strong>)</p>
</section>
</section>
<section id="host-service-user-del-disable">
<span id="hostserviceuser-deldisable"></span><h2><code class="docutils literal notranslate"><span class="pre">{host,service,user}-{del,disable}</span></code><a class="headerlink" href="#host-service-user-del-disable" title="Permalink to this heading">¶</a></h2>
<p>When deleting or disabling a user, host or service it makes sense to
revoke certifiates. (<strong>QUESTION</strong> counterexamples?) Should
<code class="docutils literal notranslate"><span class="pre">{host,service,user}-{del,disable}</span></code> revoke certificates, or not?</p>
<p>Points in favour:</p>
<ul class="simple">
<li><p>Unlike other commands that deal with individual certificates, there
is no alternative command for revoking <em>all of a principal’s
certificates</em>. Command proliferation is undesirable.</p></li>
<li><p>This is the current behaviour for the <code class="docutils literal notranslate"><span class="pre">host-</span></code> and <code class="docutils literal notranslate"><span class="pre">service-</span></code>
commands. Fewer behavioural changes are required.</p></li>
</ul>
<p>Points against:</p>
<ul class="simple">
<li><p>A principal may have a mix of IPA-managed and non-IPA-managed
certificates. IPA cannot revoke the latter. This violates the
consistency guideline.</p></li>
</ul>
<p>The decided behaviour is that these commands <strong>shall revoke all
IPA-managed certificates</strong> and, for the <code class="docutils literal notranslate"><span class="pre">-disable</span></code> and
<code class="docutils literal notranslate"><span class="pre">user-del</span> <span class="pre">--preserve</span></code> commands, <strong>all IPA-managed certificates shall
be removed from the entry</strong>. The revocation reason shall be
<code class="docutils literal notranslate"><span class="pre">unspecified</span></code>.</p>
<p>Command output shall be updated to advise of any non-IPA-managed
certificates, so that an administrator may take appropriate actions.</p>
<section id="differences-from-current-behaviour-3">
<span id="id10"></span><h3>Differences from current behaviour<a class="headerlink" href="#differences-from-current-behaviour-3" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">user-del</span></code> and <code class="docutils literal notranslate"><span class="pre">user-disable</span></code> commands need to have the
revocation behaviour implemented.</p>
<p>The affected commands need to be enhanced to report the non-IPA-managed
certificates.</p>
</section>
</section>
<section id="ipa-cert-revoke">
<span id="id11"></span><h2><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-revoke</span></code><a class="headerlink" href="#ipa-cert-revoke" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code> command shall revoke the nominated certificate. It
shall not remove the revoked certificate from LDAP entries.</p>
<section id="differences-from-current-behaviour-4">
<span id="id12"></span><h3>Differences from current behaviour<a class="headerlink" href="#differences-from-current-behaviour-4" title="Permalink to this heading">¶</a></h3>
<p>None.</p>
</section>
</section>
<section id="certmonger">
<h2>Certmonger<a class="headerlink" href="#certmonger" title="Permalink to this heading">¶</a></h2>
<p>Unlike the <code class="docutils literal notranslate"><span class="pre">cert-request</span></code> command, Certmonger renewal helpers have
precise knowledge of the certificate being renewed. It is also the case
that for any renewal performed via Certmonger, it is either desirable to
revoke the certificate (e.g. key rotation due to compromise), or it is
not a significant operational concern to revoke the certificate (e.g.
renewal due to impending expiry; the revoked certificate appear on CRL
only for a short time).</p>
<p>Therefore the <code class="docutils literal notranslate"><span class="pre">ipa</span></code> renewal helper <strong>shall revoke the superseded
certificate</strong> after successful issuance of a new certificate.</p>
<p>Furthermore, the accumulation of <code class="docutils literal notranslate"><span class="pre">userCertificate</span></code> attribute values in
principal entries where short-lived certificates are used is a known
pain point. Therefore, Certmonger <strong>shall remove the superseded
certificate from the principal’s entry</strong>.</p>
<p><strong>QUESTION</strong> is this actually a good idea? What are customer
expectations? If you’re rekeying due to compromise, surely it is not too
much a burden to <code class="docutils literal notranslate"><span class="pre">getcert</span> <span class="pre">rekey</span></code> <em>and</em> <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-revoke</span></code>?</p>
<section id="differences-from-current-behaviour-5">
<span id="id13"></span><h3>Differences from current behaviour<a class="headerlink" href="#differences-from-current-behaviour-5" title="Permalink to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ipa</span></code> renewal helper needs to be updated to invoke <code class="docutils literal notranslate"><span class="pre">cert-revoke</span></code>
and <code class="docutils literal notranslate"><span class="pre">{user,host,service}-remove-cert</span></code> (or equivalent) after a
successfull renewal.</p>
</section>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>TODO</p>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>There are no management knobs for controlling the revocation behaviour.</p>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
<p>No specific upgrade steps are required.</p>
<p>Behavioural changes need to be prominently and clearly outlined in
release notes. Changes in revocation behaviour could catch users off
guard. It is important not to rush any changes through. We’ll need to
engage with our user base to explain the changes, and outline steps to
preserve the existing revocation behaviour if so desired.</p>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p>TODO</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Certificate_revocation_behaviour_standardisation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
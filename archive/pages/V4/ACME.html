<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="AD_User_Short_Names.html" />
    <link rel="prev" title="Top Level" href="../V3/User_Life-Cycle_Management/Implementation.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p><em>Automated Certificate Management Environment (ACME)</em> is a protocol for
automated identity verification and issuance of certificates asserting
those identities. The initial and predominant use case is for Web PKI,
i.e. automated issuance of <em>domain validated (DV)</em> certificates.
Automation enables better security through shorter-lived certificates,
more pervasive security through automatic deployment of TLS and
cost-savings by eliminating repetitive human effort.</p>
<p>Dogtag PKI has implemented an ACME server. The purpose of this design is
to use the Dogtag ACME service to support ACME use cases in FreeIPA.</p>
</section>
<section id="acme-overview">
<span id="id1"></span><h1>ACME overview<a class="headerlink" href="#acme-overview" title="Permalink to this heading">¶</a></h1>
<p>ACME is defined and extended in the following IETF documents:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8555">RFC 8555</a>: The main spec,
<code class="docutils literal notranslate"><span class="pre">dns</span></code> identifier, <code class="docutils literal notranslate"><span class="pre">http-01</span></code> and <code class="docutils literal notranslate"><span class="pre">dns-01</span></code> challenges</p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8737">RFC 8737</a>: <code class="docutils literal notranslate"><span class="pre">tls-alpn-01</span></code>
challenge</p></li>
<li><p><a class="reference external" href="https://tools.ietf.org/html/rfc8738">RFC 8738</a>: <code class="docutils literal notranslate"><span class="pre">ip</span></code> identifier</p></li>
<li><p>Others already published or being developed by the <a class="reference external" href="https://datatracker.ietf.org/wg/acme/documents/">ACME working
group</a></p></li>
</ul>
<p>ACME currently has two validation challenges defined: DNS (client
creates some DNS records to prove control of a domain) and HTTP (client
creates some HTTP records to prove control of a domain).</p>
<p>ACME clients create accounts on an ACME server by registering a public
key; future messages are authenticated and communications between server
and client are encrypted using the client’s key. There is no specific
provision for using ACME with existing accounts, or creating an ACME
account linked to some other account.</p>
<p>An ACME account <em>orders</em> a certificate for a set of <em>identifiers</em>. The
currently defined identifer types are <code class="docutils literal notranslate"><span class="pre">dns</span></code> and <code class="docutils literal notranslate"><span class="pre">ip</span></code>. The server
creates <em>challenges</em> that they client can use to prove “control” of the
identifiers. Currently defined challenge types are <code class="docutils literal notranslate"><span class="pre">http-01</span></code>
(provision an HTTP resource at the location reached via the identifier),
<code class="docutils literal notranslate"><span class="pre">dns-01</span></code> (provision a DNS TXT record at the forward or IP-reverse
name) and <code class="docutils literal notranslate"><span class="pre">tls-alpn-01</span></code> (TLS-based challenge using ALPN extension).
After completing challenges, the client <em>finalizes</em> the order and the
server issues the certificate.</p>
<p>ACME also defines operations for certificate revocation and account key
rollover. RFC 8555 does not state whether ACME servers or clients are
required to support these operations.</p>
</section>
<section id="use-cases-stories">
<span id="id2"></span><h1>Use cases (stories)<a class="headerlink" href="#use-cases-stories" title="Permalink to this heading">¶</a></h1>
<p>As a developer I want to use FreeIPA to issue my certificates over ACME
protocol so that I can develop and test using the same protocol I will
utilize in production.</p>
<p>As a system administrator I want the FreeIPA CA to provide an ACME
server so that I can automatically acquire and renew certificates.</p>
<p>As a IT security officer I want the organisation’s CA to provide ACME to
reduce costs and barriers to using TLS for all internal services.</p>
</section>
<section id="scope">
<h1>Scope<a class="headerlink" href="#scope" title="Permalink to this heading">¶</a></h1>
<p>The motivating (and so far only) use case of ACME is essentially
anonymous clients create accounts, prove “control” of (DNS) names, then
request certificates for those names. The question that arises is: how
does ACME fit into an enterprise environment where hosts and services
already have identities, can prove those identities to a CA, and a CA
can enforce rules about which identities can be issued what kinds of
certificates? There is no clear, general answer to this question at
present.</p>
<p>There is also the matter of ACME clients and what features they support.
They support what has been defined: the <code class="docutils literal notranslate"><span class="pre">dns</span></code> identifier and some or
all of the defined challenges (<code class="docutils literal notranslate"><span class="pre">http-01</span></code>, <code class="docutils literal notranslate"><span class="pre">dns-01</span></code>,
<code class="docutils literal notranslate"><span class="pre">tls-alpn-01</span></code>). They generally do not support additional layers of
authentication (e.g. GSS-API). There are specifications in development
for an “authority token” challenge, and challenges for other kinds of
names (e.g. email addresses for S/MIME use case, IP address
certificates, code signing certificates). But these have not been
finalised.</p>
<p>The conclusion is that people are asking for ACME as it is defined and
in use today, i.e. anonymous ACME clients using the aforementioned
challenges to prove control of a domain name, and acquire a certificate
for it. It is the same as what is done out on the open Internet by Let’s
Encrypt and others, only behind the corporate firewall. The FreeIPA CA
is the issuer, and the prevailing DNS view is used when validating
challenges.</p>
<p>Additional authentication and authorisation layers are deferred. We can
implement them when we have a clear use case. It would be a separate
design proposal.</p>
</section>
<section id="feature-management">
<h1>Feature management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>Initially the only configuration available is to enable or disable the
servicing of requests by the Dogtag ACME service. This is accomplished
via the <code class="docutils literal notranslate"><span class="pre">ipa-acme-manage</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># enable the service</span>
<span class="n">ipa</span><span class="o">-</span><span class="n">acme</span><span class="o">-</span><span class="n">manage</span> <span class="n">enable</span>

<span class="c1"># disable the service</span>
<span class="n">ipa</span><span class="o">-</span><span class="n">acme</span><span class="o">-</span><span class="n">manage</span> <span class="n">disable</span>
</pre></div>
</div>
<p>These commands operate on a per-server basis. Subsequent work will
enable deployment-wide configuration of the ACME service (by replicating
the configuration over LDAP). With that change, an <code class="docutils literal notranslate"><span class="pre">acme</span></code> plugin for
the FreeIPA API will allow users with the appropriate privileges to
control the ACME service. The <code class="docutils literal notranslate"><span class="pre">ipa-acme-manage</span></code> command will be
deprecated or removed. Examples of what the commands may look like
(non-prescriptive):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># enable service</span>
<span class="n">ipa</span> <span class="n">acme</span><span class="o">-</span><span class="n">manage</span> <span class="o">--</span><span class="n">enabled</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># enable issuance of wildcard certificates</span>
<span class="n">ipa</span> <span class="n">acme</span><span class="o">-</span><span class="n">manage</span> <span class="o">--</span><span class="n">wildcard</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># set profile to use</span>
<span class="n">ipa</span> <span class="n">acme</span><span class="o">-</span><span class="n">manage</span> <span class="o">--</span><span class="n">profile</span><span class="o">=</span><span class="n">customProfile</span>

<span class="c1"># set CA to use</span>
<span class="n">ipa</span> <span class="n">acme</span><span class="o">-</span><span class="n">manage</span> <span class="o">--</span><span class="n">ca</span><span class="o">=&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ACME</span> <span class="n">sub</span><span class="o">-</span><span class="n">CA</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span>

<span class="c1"># set enabled challenges (http-01 enabled, dns-01 disabled)</span>
<span class="n">ipa</span> <span class="n">acme</span><span class="o">-</span><span class="n">manage</span> <span class="o">--</span><span class="n">challenges</span><span class="o">=</span><span class="n">http</span><span class="o">-</span><span class="mi">01</span>

<span class="c1"># show configuration</span>
<span class="n">ipa</span> <span class="n">acme</span><span class="o">-</span><span class="n">info</span>
</pre></div>
</div>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="overview-of-dogtag-acme-service">
<span id="id3"></span><h2>Overview of Dogtag ACME service<a class="headerlink" href="#overview-of-dogtag-acme-service" title="Permalink to this heading">¶</a></h2>
<p>The Dogtag ACME service is an optional component, implemented as a
Tomcat application. When deployed it runs as part of the <code class="docutils literal notranslate"><span class="pre">pki-tomcatd</span></code>
process alongside any other Dogtag subsystems (CA, KRA).</p>
<p>The implementation supports different <em>issuer</em> backends, e.g. Dogtag
(<code class="docutils literal notranslate"><span class="pre">PKIIssuer</span></code>) or a local NSS database (<code class="docutils literal notranslate"><span class="pre">NSSIssuer</span></code>). The ACME
service manages ACME accounts, orders and challenges and functions as a
<em>registration authority (RA)</em> that uses the configured issuer to issue
certificates.</p>
<p>The implementation supports different databases, including LDAP and
PostgreSQL.</p>
<p>Currently only the <code class="docutils literal notranslate"><span class="pre">dns</span></code> identifier and <code class="docutils literal notranslate"><span class="pre">http-01</span></code> and <code class="docutils literal notranslate"><span class="pre">dns-01</span></code>
challenges are implemented. This covers the primary use case and a large
majority of clients.</p>
<p>Apart from issuer and database, there are currently few configuration
options. These include whether to enable the service at all (i.e. to
service requests, or respond <code class="docutils literal notranslate"><span class="pre">503</span></code> to all requests), and whether to
allow wildcard certificates.</p>
<p>The configuration source is configurable but only local file-based
configuration has been implemented. This means that until a distributed
configuration source is implemented, the Dogtag ACME service must be
configured on a per-server basis.</p>
</section>
<section id="design-at-a-glance">
<span id="id4"></span><h2>Design at a glance<a class="headerlink" href="#design-at-a-glance" title="Permalink to this heading">¶</a></h2>
<p>The major aspects of the design are as follows. Each item is elaborated
in its own subsection.</p>
<ul class="simple">
<li><p>Deploy the Dogtag ACME service on all CA replicas</p></li>
<li><p>Configure Dogtag ACME service to use Dogtag CA to issue certificates,
using a suitable profile provided by FreeIPA.</p></li>
<li><p>Configure Dogtag ACME service to store ACME objects in LDAP under
<code class="docutils literal notranslate"><span class="pre">o=ipaca</span></code> subtree.</p></li>
<li><p>Provide commands to manage the FreeIPA ACME service, including
enable/disable.</p></li>
<li><p>Update the HTTP configuration to proxy ACME requests to Dogtag.</p></li>
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">ipa-ca.$DOMAIN</span></code> DNS name to the FreeIPA HTTP certificate
to enable ACME clients to use that domain name.</p></li>
</ul>
</section>
<section id="deploying-the-acme-service">
<span id="id5"></span><h2>Deploying the ACME service<a class="headerlink" href="#deploying-the-acme-service" title="Permalink to this heading">¶</a></h2>
<p>There are two main options on how to deploy the ACME capability within a
FreeIPA deployment.</p>
<ol class="arabic simple">
<li><p>Deploy ACME service on all CA replicas. This would mean clients could
use the established <code class="docutils literal notranslate"><span class="pre">ipa-ca.$DOMAIN</span></code> DNS name to access the ACME
service. No administrator actions are required to configure the ACME
service, other than to enable it. The ACME service will be
automatically deployed on new CA servers, and on existing CA servers
upon upgrade.</p></li>
<li><p>Deploy ACME service on select CA replicas. Define a new ACME server
role. Administrators choose the CA servers on which to configure the
ACME role. A new DNS name points to ACME servers in the topology
(e.g. <code class="docutils literal notranslate"><span class="pre">ipa-acme.$DOMAIN</span></code>). Implement behaviour to manage this DNS
name when using FreeIPA’s internal DNS. The requirement to manage
this DNS name is imposed on administrators when not using FreeIPA’s
internal DNS.</p></li>
</ol>
<p>Option #1 was chosen because it is simplier for administrators and the
implementation is simplier.</p>
<p>Because ACME requires the use of TLS, both options impose the
requirement to add a new DNS name to the FreeIPA HTTP certificate. See
<a class="reference external" href="#TLS_requirements">#TLS requirements</a> for details.</p>
<p>In addition to creating the configuration files as described in the
following sections, FreeIPA shall run the following two commands to
create and deploy the Dogtag ACME service instance:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pki</span><span class="o">-</span><span class="n">server</span> <span class="n">acme</span><span class="o">-</span><span class="n">create</span>
<span class="n">pki</span><span class="o">-</span><span class="n">server</span> <span class="n">acme</span><span class="o">-</span><span class="n">deploy</span>
</pre></div>
</div>
</section>
<section id="database">
<h2>Database<a class="headerlink" href="#database" title="Permalink to this heading">¶</a></h2>
<p>Configure the Dogtag ACME service to use the <code class="docutils literal notranslate"><span class="pre">ou=acme,o=ipaca</span></code> subtree
via <code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/acme/database.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">class</span><span class="o">=</span><span class="n">org</span><span class="o">.</span><span class="n">dogtagpki</span><span class="o">.</span><span class="n">acme</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">LDAPDatabase</span>
<span class="n">basedn</span><span class="o">=</span><span class="n">ou</span><span class="o">=</span><span class="n">acme</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
<span class="n">configFile</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">pki</span><span class="o">-</span><span class="n">tomcat</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">CS</span><span class="o">.</span><span class="n">cfg</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">configFile</span></code> directive tells the <code class="docutils literal notranslate"><span class="pre">LDAPDatabase</span></code> where to find
database connection settings.</p>
<p>The ACME schema is automatically added in new installations. See
<a class="reference external" href="#Upgrade">#Upgrade</a> for upgrade steps.</p>
<p>Create the ACME object heirarchy under <code class="docutils literal notranslate"><span class="pre">ou=acme,o=ipaca</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">nonces</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">acme</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalUnit</span>
<span class="n">ou</span><span class="p">:</span> <span class="n">nonces</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">accounts</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">acme</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalUnit</span>
<span class="n">ou</span><span class="p">:</span> <span class="n">accounts</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">orders</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">acme</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalUnit</span>
<span class="n">ou</span><span class="p">:</span> <span class="n">orders</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">authorizations</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">acme</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalUnit</span>
<span class="n">ou</span><span class="p">:</span> <span class="n">authorizations</span>

<span class="n">dn</span><span class="p">:</span> <span class="n">ou</span><span class="o">=</span><span class="n">challenges</span><span class="p">,</span><span class="n">ou</span><span class="o">=</span><span class="n">acme</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">ipaca</span>
<span class="n">objectClass</span><span class="p">:</span> <span class="n">organizationalUnit</span>
<span class="n">ou</span><span class="p">:</span> <span class="n">challenges</span>
</pre></div>
</div>
<section id="schema">
<h3>Schema<a class="headerlink" href="#schema" title="Permalink to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>attributeTypes: ( acmeExpires-oid NAME &#39;acmeExpires&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.24
  EQUALITY generalizedTimeMatch
  ORDERING generalizedTimeOrderingMatch
  SINGLE-VALUE )

attributeTypes: ( acmeValidatedAt-oid NAME &#39;acmeValidatedAt&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.24
  EQUALITY generalizedTimeMatch
  ORDERING generalizedTimeOrderingMatch
  SINGLE-VALUE )

attributeTypes: ( acmeStatus-oid NAME &#39;acmeStatus&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15
  EQUALITY caseIgnoreMatch
  SINGLE-VALUE )

attributeTypes: ( acmeError-oid NAME &#39;acmeError&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15
  SINGLE-VALUE )

attributeTypes: ( acmeNonceValue-oid NAME &#39;acmeNonceValue&#39;
  SUP name
  SINGLE-VALUE )

attributeTypes: ( acmeAccountId-oid NAME &#39;acmeAccountId&#39;
  SUP name
  SINGLE-VALUE )

attributeTypes: ( acmeAccountContact-oid NAME &#39;acmeAccountContact&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15
  EQUALITY caseIgnoreMatch
  SUBSTR caseIgnoreSubstringsMatch )

attributeTypes: ( acmeAccountKey-oid NAME &#39;acmeAccountKey&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15
  SINGLE-VALUE )

attributeTypes: ( acmeOrderId-oid NAME &#39;acmeOrderId&#39;
  SUP name
  SINGLE-VALUE )

attributeTypes: ( acmeIdentifier-oid NAME &#39;acmeIdentifier&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15
  EQUALITY caseIgnoreMatch )

attributeTypes: ( acmeAuthorizationId-oid NAME &#39;acmeAuthorizationId&#39;
  SUP name )

attributeTypes: ( acmeAuthorizationWildcard-oid NAME &#39;acmeAuthorizationWildcard&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.7
  EQUALITY booleanMatch
  SINGLE-VALUE )

attributeTypes: ( acmeChallengeId-oid NAME &#39;acmeChallengeId&#39;
  SUP name
  SINGLE-VALUE )

attributeTypes: ( acmeToken-oid NAME &#39;acmeToken&#39;
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )

objectClasses: ( acmeNonce-oid NAME &#39;acmeNonce&#39;
  STRUCTURAL
  MUST ( acmeNonceValue $ acmeExpires ) )

objectClasses: ( acmeAccount-oid NAME &#39;acmeAccount&#39;
  STRUCTURAL
  MUST ( acmeAccountId $ acmeAccountKey $ acmeStatus )
  MAY acmeAccountContact )

objectClasses: ( acmeOrder-oid NAME &#39;acmeOrder&#39;
  STRUCTURAL
  MUST ( acmeOrderId $ acmeAccountId $ acmeStatus $ acmeIdentifier $ acmeAuthorizationId )
  MAY ( acmeError $ userCertificate $ acmeExpires ) )

objectClasses: ( acmeAuthorization-oid NAME &#39;acmeAuthorization&#39;
  STRUCTURAL
  MUST ( acmeAuthorizationId $ acmeAccountId $ acmeIdentifier $ acmeStatus )
  MAY ( acmeExpires $ acmeAuthorizationWildcard ) )

objectClasses: ( acmeChallenge-oid NAME &#39;acmeChallenge&#39;
  ABSTRACT
  MUST ( acmeChallengeId $ acmeAccountId $ acmeAuthorizationId $ acmeStatus )
  MAY ( acmeValidatedAt $ acmeError )

objectClasses: ( acmeChallengeDns01-oid NAME &#39;acmeChallengeDns01&#39;
  SUP acmeChallenge
  STRUCTURAL
  MUST acmeToken )
</pre></div>
</div>
</section>
</section>
<section id="issuer">
<h2>Issuer<a class="headerlink" href="#issuer" title="Permalink to this heading">¶</a></h2>
<p>The template for <code class="docutils literal notranslate"><span class="pre">/etc/pki/pki-tomcat/acme/issuer.conf</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>class=org.dogtagpki.acme.issuer.PKIIssuer
url=https://$FQDN:8443
profile=acmeServerCert
username=$USER
password=$PASSWORD
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">class</span></code> tells the Dogtag ACME service to use the <code class="docutils literal notranslate"><span class="pre">PKIIssuer</span></code>
issuer implementation.</p>
<p><code class="docutils literal notranslate"><span class="pre">url</span></code> configures <code class="docutils literal notranslate"><span class="pre">PKIIssuer</span></code> to use the Dogtag CA on the same host.</p>
<p><code class="docutils literal notranslate"><span class="pre">profile</span></code> tells <code class="docutils literal notranslate"><span class="pre">PKIIssuer</span></code> what profile to use. See
<a class="reference external" href="#Profile">#Profile</a> for details of what this profile must contain.</p>
<p><code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code> tell <code class="docutils literal notranslate"><span class="pre">PKIIssuer</span></code> how to authenticate to
the Dogtag CA. <code class="docutils literal notranslate"><span class="pre">issuer.conf</span></code> must have ownership <code class="docutils literal notranslate"><span class="pre">pkiuser:pkiuser</span></code>
and mode <code class="docutils literal notranslate"><span class="pre">200</span></code>. See <a class="reference external" href="#Authentication_to_CA">#Authentication to CA</a>
for details.</p>
<section id="authentication-to-ca">
<span id="id6"></span><h3>Authentication to CA<a class="headerlink" href="#authentication-to-ca" title="Permalink to this heading">¶</a></h3>
<p>The PKI backend must authenticate to Dogtag. The IPA RA credential is
not suitable because the <code class="docutils literal notranslate"><span class="pre">pki-tomcatd</span></code> process cannot access it.
Furthermore the IPA RA credential is in the wrong format (Dogtag uses
JSS and requires an NSS DB) and we want to eventually get rid of the IPA
RA and use GSS-API proxy authentication for authentication between the
FreeIPA framework and Dogtag.</p>
<p>Remaining options considered were:</p>
<ol class="arabic simple">
<li><p>A shared “ACME RA” Dogtag (not IPA) user account, with password
authentication (we don’t want to introduce any more certificates).
The password would be distributed among CA replicas via Custodia and
must be stored so that only <code class="docutils literal notranslate"><span class="pre">pki-tomcatd</span></code> can read it. The account
requires permission to issue certificates using the configured
profile, and to revoke certificates issued by it.</p></li>
<li><p>A Dogtag user account per server with unique password (avoiding need
to replicate password securely). The accounts need the same
permission as the previous option, which could be achieved via a
group membership. The same file readership requirements apply.</p></li>
<li><p>Implement most of the remainder of the <a class="reference external" href="https://www.freeipa.org/page/V4/Dogtag_GSS-API_Authentication">GSS-API authentication to
Dogtag</a>
effort so that we can use GSS-API authentication between the ACME
service and the Dogtag CA subsystem. This is a complex (risky) and
time-consuming effort. The upside is that it’s a big step toward
resolving one of the biggest and longest-running problems in the
FreeIPA architecture.</p></li>
</ol>
<p>The chosen option was #2. Therefore the implementation is required to:</p>
<ul>
<li><p>Create the <code class="docutils literal notranslate"><span class="pre">ACME</span> <span class="pre">Agents</span></code> group (once only)</p></li>
<li><p>Add a Dogtag ACL allowing members of <code class="docutils literal notranslate"><span class="pre">ACME</span> <span class="pre">Agents</span></code> to revoke
certificates (once only):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">certServer</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">certs</span><span class="p">:</span><span class="n">execute</span>
  <span class="p">:</span><span class="n">allow</span> <span class="p">(</span><span class="n">execute</span><span class="p">)</span> <span class="n">group</span><span class="o">=&amp;</span><span class="n">quot</span><span class="p">;</span><span class="n">ACME</span> <span class="n">Agents</span><span class="o">&amp;</span><span class="n">quot</span><span class="p">;</span>
  <span class="p">:</span><span class="n">ACME</span> <span class="n">Agents</span> <span class="n">may</span> <span class="n">execute</span> <span class="n">cert</span> <span class="n">operations</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">execute</span></code> permission sounds like it has a large scope but it
indeed only grants permission to revoke (or unrevoke) a certificate.</p>
</li>
<li><p>For each CA server create the <code class="docutils literal notranslate"><span class="pre">acme-$FQDN</span></code> user, with membership in
<code class="docutils literal notranslate"><span class="pre">ACME</span> <span class="pre">Agents</span></code> and a unique password (to be written in
<code class="docutils literal notranslate"><span class="pre">issuer.conf</span></code>).</p></li>
</ul>
<p>Requirements for the certificate profile configuration are described in
<a class="reference external" href="#Profile">#Profile</a>.</p>
</section>
<section id="profile">
<h3>Profile<a class="headerlink" href="#profile" title="Permalink to this heading">¶</a></h3>
<p>The ACME profile shall be called <code class="docutils literal notranslate"><span class="pre">acmeServerCert</span></code>. As with other
<em>included profiles</em> it is defined as a template:
<code class="docutils literal notranslate"><span class="pre">/usr/share/ipa/profiles/acmeServerCert.cfg</span></code>. The definition is
similar to <code class="docutils literal notranslate"><span class="pre">caIPAserviceCert</span></code> but there are a few important
differences:</p>
<ul>
<li><p>Only members of the <code class="docutils literal notranslate"><span class="pre">ACME</span> <span class="pre">Agents</span></code> group can issue certificates
using this profile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>auth.instance_id=SessionAuthentication
authz.acl=group=&amp;quot;$ACME_AGENT_GROUP&amp;quot;
</pre></div>
</div>
</li>
<li><p>The certificate lifetime is 90 days:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">policyset</span><span class="o">.</span><span class="n">serverCertSet</span><span class="mf">.7</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">range</span><span class="o">=</span><span class="mi">90</span>
</pre></div>
</div>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">SANToCNDefault</span></code> component is used to populate the Subject DN
field because some ACME clients create CSRs with an empty Subject
field:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">policyset</span><span class="o">.</span><span class="n">serverCertSet</span><span class="mf">.9</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">class_id</span><span class="o">=</span><span class="n">sanToCNDefaultImpl</span>
<span class="n">policyset</span><span class="o">.</span><span class="n">serverCertSet</span><span class="mf">.9</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">SAN</span> <span class="n">to</span> <span class="n">CN</span> <span class="n">Default</span>
</pre></div>
</div>
</li>
</ul>
</section>
</section>
<section id="replicated-configuration">
<span id="id7"></span><h2>Replicated configuration<a class="headerlink" href="#replicated-configuration" title="Permalink to this heading">¶</a></h2>
<p><strong>Not yet implemented.</strong></p>
<p>Story: <em>As an administrator, I want to be able to configure and control
the FreeIPA ACME service deployment-wide, so that configuration is kept
consistent without additional effort.</em></p>
<p>This will require implementing an LDAP-based <em>configuration source</em> in
the Dogtag ACME service. Because the configuration will be managed by
ordinary FreeIPA users, it may be necessary to store that configuration
in the FreeIPA LDAP database (as opposed to <code class="docutils literal notranslate"><span class="pre">o=ipaca</span></code>). Therefore it
<em>might</em> be necessary for the configuration source to authenticate to
LDAP using a FreeIPA principal and GSS-API.</p>
<p>An appropriate service princpial already exists: <code class="docutils literal notranslate"><span class="pre">dogtag/$FQDN</span></code>. But
if GSS-API is required it will be necessary to achieve this via the
<em>ldapjdk</em> library. There does appear to be some GSS-API ldapbind code in
<em>ldapjdk</em> but its status is unknown.</p>
<p>The configuration source will either need to execute a persistent search
(preferred) or regularly poll the LDAP configuration object and look for
changes to the configuration.</p>
</section>
<section id="tls-requirements">
<span id="id8"></span><h2>TLS requirements<a class="headerlink" href="#tls-requirements" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="https://tools.ietf.org/html/rfc8555#section-6.1">ACME requires TLS</a>.
Therefore we must add the <code class="docutils literal notranslate"><span class="pre">ipa-ca.$DOMAIN</span></code> DNS name to the FreeIPA
HTTP certificate on each CA server.</p>
<p>To simplify the implementation, we actually add the <code class="docutils literal notranslate"><span class="pre">ipa-ca.$DOMAIN</span></code>
DNS name to the HTTP certificate on <em>every IPA server</em> whether or not it
is a CA replica. The DNS name does (or is expected to) only point at CA
servers, so this is not an operational issue. The security implication
(relative to having the name on the HTTP certs of CA servers) is that
HTTP TLS key compromise of an IPA server that is not a CA server allows
it to impersonate <code class="docutils literal notranslate"><span class="pre">ipa-ca.$DOMAIN</span></code> and therefore the ACME server. This
is a modest risk because compromise of that key is already a
catastrophe. The avoidance of complexity due the fact that IPA servers
can acquire the CA role at any time seems well worth it.</p>
<p>To implement this change we need to:</p>
<ul class="simple">
<li><p>on installation (including ipa-replica-install and ipa-ca-install)
ensure the HTTP service certificate gets (re)issued to include the
include the alias.</p></li>
<li><p>on upgrade (existing CA replicas), update the Certmonger tracking
request for the HTTP service certificate to include the alias, then
renew the cert.</p></li>
</ul>
<p>This change was implemented in <a class="reference external" href="https://pagure.io/freeipa/issue/8186">https://pagure.io/freeipa/issue/8186</a>.</p>
</section>
<section id="scalability">
<h2>Scalability<a class="headerlink" href="#scalability" title="Permalink to this heading">¶</a></h2>
<section id="pruning-expired-certificates">
<span id="id9"></span><h3>Pruning expired certificates<a class="headerlink" href="#pruning-expired-certificates" title="Permalink to this heading">¶</a></h3>
<p><strong>Not yet implemented.</strong></p>
<p>If ACME is used heavily, lots of short-lived certificates will pile up
in the Dogtag database. We should implement pruning of expired
certificates, with knobs to enable/disable (DISABLED by default). This
scenario is not ACME-specific and there is an existing ticket:
<a class="reference external" href="https://pagure.io/dogtagpki/issue/1750">https://pagure.io/dogtagpki/issue/1750</a>.</p>
</section>
<section id="pruning-expired-acme-objects">
<span id="id10"></span><h3>Pruning expired ACME objects<a class="headerlink" href="#pruning-expired-acme-objects" title="Permalink to this heading">¶</a></h3>
<p><strong>Not yet implemented.</strong></p>
<p>The ACME service database stores account, order, authorization and
challenge objects. The growth of the database will be approximately
linear in the number of orders (certificate requests), unless some
cleanup operations are performed.</p>
<p>Order objects may have an expiry. Expired orders could be pruned from
the database. The expiry could be set at (for example) 24 hours while
the order is not yet <code class="docutils literal notranslate"><span class="pre">valid</span></code> (i.e. before a certificate is actually
issued), and reset when the certificate is issued to the <code class="docutils literal notranslate"><span class="pre">notAfter</span></code>
date of the certificate. The order therefore expires when it seems the
client has “given up”, or when the certificate expires. It can then be
deleted.</p>
<p>Authorization and challenge objects can also expire, and be pruned in a
similar way.</p>
<p>Accounts themselves have no expiry in the data model and semantics of
ACME. But if needed, accounts could be pruned if they are at least some
minimum age, but have no orders. This indicates that the account is
inactive (all orders have expired and been removed; an active ACME
client will create new orders to renew the certificates it manages).</p>
</section>
<section id="nonces">
<h3>Nonces<a class="headerlink" href="#nonces" title="Permalink to this heading">¶</a></h3>
<p>ACME protocol nonces are currently created in the LDAP database. They
are therefore replicated. The performance impact has not been measured
but rapid additional and deletion of small objects throughout the
protocol steps may be some “low hanging fruit” if ACME load causes
replication issues.</p>
<p>Client behaviour has not been adequately analysed to know whether
restriction of nonces to a single server (e.g. an in-memory cache) is
viable when the ACME server’s DNS name points to several servers.</p>
</section>
</section>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Update the LDAP schema with the contents of
<code class="docutils literal notranslate"><span class="pre">/usr/share/pki/acme/database/ldap/schema.ldif</span></code>.</p></li>
<li><p>Deploy the ACME service using the same subroutine as used during
installation. This subroutine must already detect and skip “once per
deployment” operations that were already completed (e.g. creating the
LDAP object hierarchy) so there is no special consideration of these
scenarios during upgrade.</p></li>
</ul>
</section>
<section id="how-to-use">
<h1>How to use<a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h1>
<p>See <a class="reference external" href="#Feature_management">#Feature management</a> for a description of
administrator operations.</p>
<p>For the client side, use an ACME client program to create an ACME
account, request certificates and (if required) revoke certificates.
There are many ACME clients and elaborating all the usage scenarios is
out of scope of this document. But see <a class="reference external" href="#Test_plan">#Test plan</a> for
some specific scenarios using the <em>Certbot</em> and <em>mod_md</em> clients.</p>
<p>As a concrete example, here is how you could use <em>Certbot</em> to register
an account and acquire a certificate from the FreeIPA ACME service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># certbot --server https://ipa-ca.ipa.local/acme/directory \
  register -m ftweedal@redhat.com --agree-tos --no-eff-email

# certbot --server http://ipa-ca.ipa.local/acme/directory \
  certonly --standalone --domain $(hostname)
</pre></div>
</div>
</section>
<section id="test-plan">
<h1>Test plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p>ACME clients available on Fedora include <em>Certbot</em> (a general purpose
client) and <em>mod_md</em> (an Apache httpd module). These can be tested
independently.</p>
<p>The test setup is a single FreeIPA server with CA role, and a single
client. All steps in the test scenarios outlined below are on the client
unless stated otherwise.</p>
<section id="enabling-acme-service">
<span id="id11"></span><h2>Enabling ACME service<a class="headerlink" href="#enabling-acme-service" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>[Server] Deploy a server with CA.</p></li>
<li><p>[Client] Use <em>Curl</em> to request ACME directory object and ensure ACME
service responds 503 (it has not been enabled yet).</p></li>
<li><p>[Server] <code class="docutils literal notranslate"><span class="pre">ipa-acme-manage</span> <span class="pre">enable</span></code></p></li>
<li><p>[Client] Use <em>Curl</em> to request ACME directory object again; should
succeed.</p></li>
</ol>
</section>
<section id="certbot-http-challenge">
<span id="id12"></span><h2>Certbot HTTP challenge<a class="headerlink" href="#certbot-http-challenge" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Register account.</p></li>
<li><p>Request certificate using <code class="docutils literal notranslate"><span class="pre">--standalone</span></code> HTTP server. Succeeds.</p></li>
</ol>
</section>
<section id="certbot-dns-challenge">
<span id="id13"></span><h2>Certbot DNS challenge<a class="headerlink" href="#certbot-dns-challenge" title="Permalink to this heading">¶</a></h2>
<p><strong>Not yet implemented.</strong></p>
<p>Assume account already registered (previous test).</p>
<ol class="arabic simple">
<li><p>Request certificate using <code class="docutils literal notranslate"><span class="pre">dns-01</span></code> challenge and <code class="docutils literal notranslate"><span class="pre">--manual</span></code> mode
with hooks to create/clean up required TXT records. Succeeds.</p></li>
</ol>
</section>
<section id="certbot-revocation">
<span id="id14"></span><h2>Certbot revocation<a class="headerlink" href="#certbot-revocation" title="Permalink to this heading">¶</a></h2>
<p><strong>Not yet implemented.</strong></p>
<p>Assume account already registered and certificates have been
successfully issued (previous tests).</p>
<ol class="arabic simple">
<li><p>Revoke a certificate. Succeeds.</p></li>
<li><p>Confirm via <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">cert-show</span></code> command that certificate was revoked.</p></li>
</ol>
</section>
<section id="mod-md-http-challenge">
<span id="id15"></span><h2>mod_md HTTP challenge<a class="headerlink" href="#mod-md-http-challenge" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">httpd</span></code> configuration to use <code class="docutils literal notranslate"><span class="pre">mod_md</span></code> for machine’s FQDN.</p></li>
<li><p>Restart <code class="docutils literal notranslate"><span class="pre">httpd</span></code> (and wait a few seconds).</p></li>
<li><p>Gracefuly restart <code class="docutils literal notranslate"><span class="pre">htttpd</span></code> (to pick up certificate, assuming mod_md
was able to acquire one).</p></li>
<li><p>[Server] Use Curl to retrieve page hosted at client over HTTPS.
Succeeds.</p></li>
</ol>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/ACME.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
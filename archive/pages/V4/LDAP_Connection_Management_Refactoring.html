<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="hostname attribute in config" href="Manage_replication_topology.html" />
    <link rel="prev" title="Overview" href="Keytab_Retrieval_Management.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>Improvements in managing the LDAP connections have been made as a part o
the 4.5 refactoring effort. This document describes how to properly use
LDAP connections now and what changes have been made.</p>
<p>Historically, LDAP connections to Directory Server (DS) have been
established adhoc and there was duplicated code scattered around the
code base. Some connections weren’t closed properly. There were multiple
ways to connect to LDAP.</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<section id="in-framework">
<span id="id1"></span><h2>In framework<a class="headerlink" href="#in-framework" title="Permalink to this heading">¶</a></h2>
<p>When working with a framework, you can use api.Backend.ldap2.</p>
<p>You do not need to worry about connects and disconnects. These are
handled in an upper abstraction layer along with setting proper size and
time limits.</p>
</section>
<section id="local-server">
<span id="id2"></span><h2>Local server<a class="headerlink" href="#local-server" title="Permalink to this heading">¶</a></h2>
<p>When you’re writing a script that needs to connect to a local server,
you need to explicitly connect and disconnect from the LDAP server. The
following code will connect with LDAPI and use external bind:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ipalib</span> <span class="kn">import</span> <span class="n">api</span>

<span class="n">api</span><span class="o">.</span><span class="n">Backend</span><span class="o">.</span><span class="n">ldap2</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Use api.Backend.ldap2</span>
    <span class="c1"># ...</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">api</span><span class="o">.</span><span class="n">Backend</span><span class="o">.</span><span class="n">ldap2</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="remove-server">
<span id="id3"></span><h2>Remove server<a class="headerlink" href="#remove-server" title="Permalink to this heading">¶</a></h2>
<p>When connecting to a remote server, use LDAPClient. An example with
LDAPClient and simple_bind():</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ipapython</span> <span class="kn">import</span> <span class="n">ipaldap</span>

<span class="n">ldap_uri</span> <span class="o">=</span> <span class="n">ipaldap</span><span class="o">.</span><span class="n">get_ldap_uri</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="k">with</span> <span class="n">ipaldap</span><span class="o">.</span><span class="n">LDAPClient</span><span class="p">(</span><span class="n">ldap_uri</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">simple_bind</span><span class="p">(</span><span class="n">bind_dn</span><span class="p">,</span> <span class="n">bind_pw</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">unbind</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="proper-usage">
<span id="id4"></span><h1>Proper usage<a class="headerlink" href="#proper-usage" title="Permalink to this heading">¶</a></h1>
<section id="api-backend-ldap2">
<h2>api.Backend.ldap2<a class="headerlink" href="#api-backend-ldap2" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Use whenever accessing local directory server</p></li>
<li><p>Connect only at start and end of script</p></li>
<li><p>Connection is automatically re-established if DS is restarted</p></li>
<li><p>Uses ldapi</p></li>
</ul>
</section>
<section id="restarting-directory-server">
<span id="id5"></span><h2>Restarting Directory Server<a class="headerlink" href="#restarting-directory-server" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>Use start(), stop() and restart() methods of DsInstance</p>
<ul>
<li><p>These already manage the api.Backend.ldap2 connection</p></li>
</ul>
</li>
<li><p>Using knownservices to restart a DS instance is deprecated and
requires a manual dis/re/connect of api.Backend.ldap2</p></li>
</ul>
</section>
<section id="adhoc-connections">
<span id="id6"></span><h2>Adhoc connections<a class="headerlink" href="#adhoc-connections" title="Permalink to this heading">¶</a></h2>
<p>api.Backend.ldap2 should be always preferred if connecting to the local
server. In the cases, where you need to establish a connection to other
server, you can use an adhoc connection.</p>
<ul class="simple">
<li><p>Use get_ldap_uri() to generate ldap_uri from protocol, host, port,
…</p></li>
<li><p>Initialize the connection with LDAPClient</p></li>
<li><p>Make sure to properly close the connection when it is no longer used</p></li>
</ul>
</section>
<section id="ldap2">
<h2>ldap2<a class="headerlink" href="#ldap2" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>No time_limit and size_limit by default</p></li>
<li><p>Set time_limit=None and size_limit=None to respect values in ipa
config file</p></li>
</ul>
</section>
</section>
<section id="changes">
<h1>Changes<a class="headerlink" href="#changes" title="Permalink to this heading">¶</a></h1>
<p>The following improvements have been made as a part of the 4.5
refactoring effort.</p>
<section id="merge-ipadmin-to-ldapclient">
<span id="id7"></span><h2>Merge IPAdmin to LDAPClient<a class="headerlink" href="#merge-ipadmin-to-ldapclient" title="Permalink to this heading">¶</a></h2>
<p>IPAdmin was merged into LDAPClient and removed completely. The following
changes were made in ipaldap:</p>
<ul class="simple">
<li><p>Removed wait and timeout for establishing a connection (in IPAdmin).</p>
<ul>
<li><p>This code was obsolete, because there is a wait when the directory
server is start / restarted.</p></li>
</ul>
</li>
<li><p>Used simple_bind(), external_bind() and gssapi_bind() instead of
their <a href="#id11"><span class="problematic" id="id12">do_</span></a>* alternatives, which were removed.</p></li>
<li><p>Removed user name from external_bind() and always set it to effective
user name.</p></li>
<li><p>Removed obsolete and unused IPAdmin properties</p>
<ul>
<li><p>ldapi</p></li>
<li><p>realm</p></li>
<li><p>suffixes</p></li>
</ul>
</li>
<li><p>Moved the following IPAdmin properties to LDAPClient:</p>
<ul>
<li><p>host (automatically parsed from ldap_uri)</p></li>
<li><p>port (automatically parsed from ldap_uri)</p></li>
<li><p>cacert (IPAdmin) -&gt; _cacert (LDAPClient)</p></li>
</ul>
</li>
<li><p>Added the following options to LDAPClient constructor:</p>
<ul>
<li><p>cacert</p></li>
<li><p>sasl_nocanon</p></li>
</ul>
</li>
<li><p>Created get_ldap_uri() function to determine ldap_uri from former
IPAdmin constructor arguments</p></li>
<li><p>Replaced all occurrences of IPAdmin with LDAPClient</p>
<ul>
<li><p>get_ldap_uri() is used to construct ldap_uri</p></li>
<li><p>LDAPClient object is initialized with the ldap_uri</p></li>
</ul>
</li>
</ul>
</section>
<section id="use-ldapi-when-connecting-to-localhost">
<span id="id8"></span><h2>Use ldapi when connecting to localhost<a class="headerlink" href="#use-ldapi-when-connecting-to-localhost" title="Permalink to this heading">¶</a></h2>
<p>When a local connection is established, it should use ldapi whenever
possible. api.Backend.ldap2 was configured to use ldapi. Some adhoc
connections were replaced with api.Backend.ldap2.</p>
<p>ldap2 default time and size limit was set to unlimited. Limit for use in
rpc still respects the ipa config file.</p>
</section>
<section id="use-a-shared-ldap-connection-in-installers-and-install-tools">
<span id="id9"></span><h2>Use a shared LDAP connection in installers and install tools<a class="headerlink" href="#use-a-shared-ldap-connection-in-installers-and-install-tools" title="Permalink to this heading">¶</a></h2>
<p>In installers and install tools, an ldap connection (if needed) should
be established at the start of the script and properly closed at the end
of the script. When a directory server is started, stopped or restarted,
the connection should dis/re/connect accordingly.</p>
<ul class="simple">
<li><p>api.Backend.ldap2 was used across installers and install tools for
local LDAP connection</p></li>
<li><p>Directory Server installation required the following modifications:</p>
<ul>
<li><p>Enabled ldapi and configured autobind for root after instance
creation</p></li>
<li><p>Overriden start, stop and restart method of DsInstance to also
dis/re/connect the api.Backend.ldap2.connection</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="future-effors">
<span id="id10"></span><h1>Future effors<a class="headerlink" href="#future-effors" title="Permalink to this heading">¶</a></h1>
<p>Not all the issues with LDAP connection management were removed due to
time and scope constraints of this effort.</p>
<p>Future changes may include the following:</p>
<ul class="simple">
<li><p>Replaces instance creations of ldap2() with LDAPClient</p></li>
<li><p>Remove all unnecessary adhoc connections</p></li>
<li><p>Consider using a single adhoc connection to a replica during
install/promote instead of repeatedly connecting.</p></li>
<li><p>Remove modify_s()</p></li>
</ul>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/LDAP_Connection_Management_Refactoring.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
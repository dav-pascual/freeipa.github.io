<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="Pull-Request_CI.html" />
    <link rel="prev" title="Overview" href="Permissions_V2.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>In a topology with multiple CA replicas, only one of them acts as CA
renewal master and CRL generation master. Usually, the first server
where the CA was installed owns these 2 roles, but the system
administrator may want to move these roles to a different replica
(because the current instance will be decommissioned for instance).</p>
<p>FreeIPA already offers tools to change the CA renewal master, but the
CRL generation master configuration involves manual steps (to disable
CRL generation on the current CRL generation master, then enable CRL
generation on the new CRL generation master). This manual procedure is
error-prone and can leave the topology in a bad state.</p>
<p>This feature proposes to provide a tool in order to automate these
manual steps. See issue <a class="reference external" href="https://pagure.io/freeipa/issue/5803">5803</a>.</p>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>While FreeIPA framework offers an API to define a server role, the
framework itself counts with all the necessary information to be
available in the backend database. Assigning an IPA server as a CRL
master requires access to the filesystem (<a class="reference external" href="https://www.freeipa.org/page/Howto/Promote_CA_to_Renewal_and_CRL_Master">Promote CA to Renewal and CRL
Master</a>)
and therefore the server role framework should not be used, at least not
until PKI allows us to change this configuration aspect of the system
based on the values stored in the database.</p>
<p>The proposed solution does not store the name of the CRL generation
master in LDAP (otherwise inconsistencies between the actual Dogtag/HTTP
config and LDAP could occur and we did not want to implement a complex
solution based on a daemon reading the config and ensuring that it is
applied). As a consequence, the CRL generation master isn’t integrated
into the server role model that is used for other components (for
instance the GUI shows a table with “Enabled server roles” for each
master).</p>
<p>The feature will be provided as a set of 3 commands that interact with
the local master</p>
<ul class="simple">
<li><p>one command that basically answers the question “am I configured as a
CRL generation master”</p></li>
<li><p>one command that performs all the steps required to unconfigure CRL
generation on the local master</p></li>
<li><p>one command that performs all the steps required to configure CRL
generation on the local master</p></li>
</ul>
<p>Based on these 3 local commands, it will be possible to create an
Ansible playbook allowing to perform a modification of the CRL
generation master. The playbook would be a wrapper using the above
commands, to first find which server(s) is(are) configured for CRL
generation, then remove the role from this(these) server(s) and finally
configure the CRL generation on the target master.</p>
<p>The commands should be written in a way that allows Health Check tool to
internally use them, to avoid code duplication.</p>
<p>The project will modify the existing ipa-server-install –uninstall so
that it prevents removal of the local master if it is the CRL generation
master.</p>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>A new <strong>ipa-crlgen-manage</strong> command is created. This CLI will support 3
subcommands: enable, disable, status.</p>
<p>The script will query/modify the local configuration and restart the
required services. It will use interfaces provided in cainstance.py:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">class CAInstance(DogtagInstance):</span></code></div>
<div class="line">``    def is_crlgen_enabled(self):``</div>
<div class="line">``        “””Check if the local CA instance is generating CRL``</div>
<div class="line">``        Three conditions must be met to consider that the local CA is CRL``</div>
<div class="line">``        generation master:``</div>
<div class="line">``        - in CS.cfg ca.crl.MasterCRL.enableCRLCache=true``</div>
<div class="line">``        - in CS.cfg ca.crl.MasterCRL.enableCRLUpdates=true``</div>
<div class="line">``        - in /etc/httpd/conf.d/ipa-pki-proxy.conf the RewriteRule``</div>
<div class="line">``        ^/ipa/crl/MasterCRL.bin is disabled (commented or removed)``</div>
<div class="line">``        If the values are inconsistent, an exception is raised``</div>
<div class="line">``        :returns: True/False``</div>
<div class="line">``        :raises: InconsistentCRLGenConfigException if the config is``</div>
<div class="line">``                 inconsistent``</div>
<div class="line">``        “””``</div>
<div class="line">``    def setup_crlgen(self, setup_crlgen):``</div>
<div class="line">``        “””Configure the local host for CRL generation``</div>
<div class="line">``        :param setup_crlgen: if True enable CRL generation, if False, disable``</div>
<div class="line">``        “””``</div>
</div>
</section>
<section id="feature-management-cli">
<span id="id1"></span><h1>Feature management - CLI<a class="headerlink" href="#feature-management-cli" title="Permalink to this heading">¶</a></h1>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Arguments</p></th>
<th class="head"><p>Functionality</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ipa-crlgen-manage</p></td>
<td><p>status</p></td>
<td><p>Display whether the local host
is configured for CRL
generation, and if enabled,
print the date and number of
last update</p></td>
</tr>
<tr class="row-odd"><td><p>ipa-crlgen-manage</p></td>
<td><p>enable</p></td>
<td><p>Enable the CRL generation role
on the local host</p></td>
</tr>
<tr class="row-even"><td><p>ipa-crlgen-manage</p></td>
<td><p>disable</p></td>
<td><p>Disable the CRL generation role
on the local host</p></td>
</tr>
<tr class="row-odd"><td><p>ipa-server-install</p></td>
<td><p>–uninstall</p></td>
<td><p>If the local server is CRL
generation master, refuse to
uninstall unless
–ignore-last-of-role is
provided or (interactive mode)
the user confirmed he is OK
with uninstallation</p></td>
</tr>
</tbody>
</table>
<p>Usage:</p>
<p>Find whether the local host is configured for CRL generation:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit admin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa-crlgen-manage status</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">CRL generation: enabled</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Last CRL update: 2019-03-06 16:10:16</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Last CRL Number: 2</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">The ipa-crlgen-manage command was successful</span></code></div>
</div>
<p>Disable CRL generation on the local host</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit admin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa-crlgen-manage disable</span></code></div>
</div>
<p>Enable CRL generation on the local host</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit admin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa-crlgen-manage enable</span></code></div>
</div>
<section id="requirements-for-the-ipa-crlgen-manage-script">
<span id="id2"></span><h2>Requirements for the ipa-crlgen-manage script<a class="headerlink" href="#requirements-for-the-ipa-crlgen-manage-script" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>The script must be run as a root user</p></li>
<li><p>The script requires a Kerberos ticket as admin</p></li>
<li><p>The script requires ipa services to be up and running as it checks if
the local host is a CA master</p></li>
<li><p>If the script is executed on a host that is not an IPA server, it
must exit with 2</p></li>
<li><p>If the script fails to execute, it must exit with 1</p></li>
<li><p>If the script succeeds, it must exit with 0</p></li>
</ul>
<p>With “status” subcommand:</p>
<ul class="simple">
<li><p>If the script detects an inconsistent configuration, it must print an
error message and exit with 1</p></li>
<li><p>If the scripts detects that the server is not configured for CRL
generation/not a CA master, it must output “CRL generation: disabled”
and exit with 0</p></li>
<li><p>If the script detects that the server is properly configured for CRL
generation, it must output “CRL generation: enabled” and exit with 0.
If a CRL is available, the script must also print the date and number
of the last CRL update.</p></li>
</ul>
<p>With “enable” subcommand:</p>
<ul class="simple">
<li><p>The script must validate that the local host is a FreeIPA master and
provides a CA instance, and refuse to enable CRL generation if it’s
not the case</p></li>
<li><p>If the local host is already configured as CRL generation master, the
script must print that no modification was done and exit with 0</p></li>
<li><p>If the local host needs to be configured, the script must perform all
the config steps detailed in <a class="reference external" href="https://www.freeipa.org/page/Howto/Promote_CA_to_Renewal_and_CRL_Master">Promote CA to Renewal and CRL
Master</a>
and trigger the generation of a new CRL before exiting with 0</p></li>
</ul>
<p>With “disable” subcommand:</p>
<ul class="simple">
<li><p>If the local host is not a CA instance, the script must exit with 0</p></li>
<li><p>If the local host is not configured for CRL generation, the script
must print that no modification was done and exit with 0</p></li>
<li><p>If the local is configured for CRL generation, the script must
perform all the unconfiguration steps detailed in <a class="reference external" href="https://www.freeipa.org/page/Howto/Promote_CA_to_Renewal_and_CRL_Master">Promote CA to
Renewal and CRL
Master</a>
and exit with 0.</p></li>
</ul>
</section>
<section id="requirements-for-the-ipa-server-install-uninstall-script">
<span id="id3"></span><h2>Requirements for the ipa-server-install –uninstall script<a class="headerlink" href="#requirements-for-the-ipa-server-install-uninstall-script" title="Permalink to this heading">¶</a></h2>
<p>In interactive mode:</p>
<ul class="simple">
<li><p>When run on a host that is CRL generation master, the script must
warn the user that the uninstall operation will remove CRL generation
role and prompt for confirmation.</p></li>
</ul>
<p>In non-interactive mode:</p>
<ul class="simple">
<li><p>When run on a host that is CRL generation master, the script must
refuse to uninstall the server, unless the option
–ignore-last-of-role was provided. In any case, the uninstall script
must print a warning about removing a master with CRL generation
role.</p></li>
</ul>
</section>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<p>¯_(ツ)_/¯</p>
</section>
<section id="future-considerations">
<span id="id4"></span><h1>Future considerations<a class="headerlink" href="#future-considerations" title="Permalink to this heading">¶</a></h1>
<p>Hopefully, Dogtag will once implement CRL master configuration in LDAP
(<a class="reference external" href="https://pagure.io/dogtagpki/issue/1262">https://pagure.io/dogtagpki/issue/1262</a>). Should that ever happen, we
may consider the following:</p>
<ul class="simple">
<li><p>FreeIPA should provide a framework-based command allowing to find
which replica is currently handling the CRL generation</p></li>
<li><p>FreeIPA should provide a framework-based command allowing to move the
CRL generation to a different replica. It would be nice to have a
single command to disable CRL generation on the current CRL
generation master and enable CRL generation on the new CRL generation
master.</p></li>
</ul>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Promotion_to_CRL_generation_master.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
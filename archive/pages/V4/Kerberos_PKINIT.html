<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="Kerberos_principal_aliases.html" />
    <link rel="prev" title="Overview" href="KDC_Proxy.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>Kerberos authentication framework allows to obtain Kerberos tickets
based on a number of different mechanisms. Standard approach implies use
of a secret shared by both a Kerberos KDC and a Kerberos client.</p>
<p>RFC 4556 describes a way to allow initial authentication in Kerberos
protocol to happen with the help of Public Key Cryptography (PKINIT).</p>
<p>This feature page describes PKINIT implementation in FreeIPA.</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<p>Following use cases are defined for the scope of this FreeIPA feature:</p>
<ul class="simple">
<li><p>As an administrator, I want to enable use of PKINIT for Kerberos
authentication</p>
<ul>
<li><p>By default, FreeIPA CA should issue certificates for the KDCs</p></li>
<li><p>Externally provided certificates should be accepted as well when
deploying PKINIT configuration</p></li>
</ul>
</li>
<li><p>As an administrator, I want to allow users to issue certificates that
can be associated with their Kerberos identities</p></li>
<li><p>As an administrator, I want to define exact criteria for PKI
certificates to be accepted for PKINIT purpose by the Kerberos KDC.</p></li>
<li><p>As an administrator, I want to define exact criteria for PKI
certificates to be chosen for PKINIT purpose by Kerberos clients.</p></li>
<li><p>As a user, I want to be able to manage public key certificates
associated with my Kerberos identity, regardless which CA did issue
them.</p></li>
<li><p>As a user, I want to use Anonymous PKINIT feature to obtain an
initial ticket granting ticket (TGT) to allow FAST exchange with two
factor authentication without access to a different Kerberos
principal.</p></li>
</ul>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>MIT Kerberos KDC and a Kerberos client library already support PKINIT
for initial authentication. The scope of supported functionality is
defined in the manual page for `krb5.conf` in the section <strong>PKINIT
Options</strong>.</p>
<p>From Kerberos perspective, there are two separate actors: a Kerberos
client has to choose which PKI certificate to use for initial Kerberos
authentication, and a Kerberos KDC has to decide whether a PKINIT
authentication request with the selected PKI certificate can be accepted
to represent operations on behalf of the claimed Kerberos identity.</p>
<p>PKINIT initial authentication is implemented as a pre-authentication
scheme in Kerberos protocol. Briefly, RFC 4556 document defines the
following extensions to RFC 4120:</p>
<ol class="arabic simple">
<li><p>The client indicates the use of public-key authentication by
including a special preauthenticator in the initial request. This
preauthenticator contains the client’s public-key data and a
signature.</p></li>
<li><p>The KDC tests the client’s request against its authentication policy
and trusted Certification Authorities (CAs).</p></li>
<li><p>If the request passes the verification tests, the KDC replies as
usual, but the reply is encrypted using either:</p>
<ol class="arabic simple">
<li><p>a key generated through a Diffie-Hellman (DH) key exchange with
the client, signed using the KDC’s signature key; or</p></li>
<li><p>a symmetric encryption key, signed using the KDC’s signature key
and encrypted using the client’s public key.
Any keying material required by the client to obtain the
encryption key for decrypting the KDC reply is returned in a
pre-authentication field accompanying the usual reply.</p></li>
</ol>
</li>
<li><p>The client validates the KDC’s signature, obtains the encryption key,
decrypts the reply, and then proceeds as usual.</p></li>
</ol>
<p>Given that actual work to handle PKINIT is already implemented in MIT
Kerberos, high level scope for FreeIPA integration includes the
following changes:</p>
<ul class="simple">
<li><p>Changes to the FreeIPA server and replica installers to request
PKINIT-compatible certificates for use in KDC configuration</p></li>
<li><p>Addition of a special profile with Kerberos KDC specific extensions</p></li>
<li><p>Changes to certificate management plugin (<cite>cert.py</cite>) to allow
generating PKINIT-compatible certificate for KDC using the profile
defined above</p></li>
<li><p>Creation of a special principal to assist in Anonymous PKINIT initial
authentication</p></li>
</ul>
<p>Since the <a class="reference external" href="https://www.freeipa.org/page/V4/External_Authentication">External
Authentication</a>
workflow now isolates FreeIPA framework from all Kerberos keys/ccaches
care must be taken to ensure that the password logins to the master
(e.g. via WebUI) are able to leverage some FAST armoring mechanisms to
enable login using OTP. To allow this, local anonymous PKINIT may be
performed using a self-signed KDC keypair. Note that such PKINIT setup
is not usable on enrolled clients and should be employed only in cases
when proper external PKINIT certificates signed by IPA CA are not
available, e.g. in CA-less case or when PKINIT certificate issuance was
suppressed by installer option. In order to differentiate between
client-consumable PKINIT and the local variant, the former capability
will be advertised in LDAP and an API will be provided to display its’
status on individual masters.</p>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<section id="addition-of-a-special-profile-with-kerberos-kdc-specific-extensions">
<span id="id1"></span><h2>Addition of a special profile with Kerberos KDC specific extensions<a class="headerlink" href="#addition-of-a-special-profile-with-kerberos-kdc-specific-extensions" title="Permalink to this heading">¶</a></h2>
<p>A profile named <strong>KDCs_PKINIT_Certs</strong> is added to Dogtag and is loaded
into the LDAP store by means of an upgrade script.</p>
</section>
<section id="changes-to-certificate-management-plugin">
<span id="id2"></span><h2>Changes to certificate management plugin<a class="headerlink" href="#changes-to-certificate-management-plugin" title="Permalink to this heading">¶</a></h2>
<p>Certificate management plugin (<cite>cert.py</cite>) is changed to allow generating
PKINIT-compatible certificate for KDC using the <strong>KDCs_PKINIT_Certs</strong>
profile. The difference with normal certificate issuing workflow is that
the public certificate is not stored in the LDAP entry for the
coresponding principal, `krbtgt/REALM&#64;REALM`. Since KDC
pre-authentication pkinit module is configured through `kdc.conf`,
there is no need to store the public certificate in the LDAP at all.</p>
<p>As a result, each KDC will have own certificate issued for
<a class="reference external" href="mailto:`krbtgt/REALM&#37;&#52;&#48;REALM">`krbtgt/REALM<span>&#64;</span>REALM</a>` using <strong>KDCs_PKINIT_Certs</strong> profile.</p>
</section>
<section id="creation-of-a-special-principal-for-anonymous-pkinit">
<span id="id3"></span><h2>Creation of a special principal for Anonymous PKINIT<a class="headerlink" href="#creation-of-a-special-principal-for-anonymous-pkinit" title="Permalink to this heading">¶</a></h2>
<p>A special principal, `WELLKNOWN/ANONYMOUS&#64;REALM`, is created during KDC
configuration stage. A pre-authentication is set to be required for the
principal because PKINIT use requires pre-authentication mechanism.</p>
</section>
<section id="freeipa-server-and-replica-installer-changes">
<span id="id4"></span><h2>FreeIPA server and replica installer changes<a class="headerlink" href="#freeipa-server-and-replica-installer-changes" title="Permalink to this heading">¶</a></h2>
<p>MIT Kerberos KDC can be built with either NSS and OpenSSL libraries for
PKINIT support. Depending on the compile time default, when KDC is
configured to enable PKINIT, KDC and CA certificates are configured in a
different way. Both Red Hat Enterprise Linux and Fedora distributions
build MIT KDC with OpenSSL. Thus, KDC configuration must specify
separately a private key and a public certificate of the KDC
certificates.</p>
<p>Certmonger is capable to generate PKI certificates pair in separate
files but FreeIPA installer framework does not support this option. This
means certmonger shim in FreeIPA installer framework is extended to
support issuing certificates in ceparate private and public key files.</p>
</section>
<section id="backup-and-restore">
<h2>Backup and Restore<a class="headerlink" href="#backup-and-restore" title="Permalink to this heading">¶</a></h2>
<p>When backing the server up, KDC certificate pair needs to be backed up.
When restoring, KDC certificate pair needs to be properly restored,
including certmonger tracking of it.</p>
</section>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<p>Since anonymous PKINIT will now always be required given the changes
during Privilege separation, <strong>ipa pkinit-anonymous</strong> command will be
deprecated and do nothing but issue a warning. This is a safeguard to
prevent the locking of anonymous principal and hence breaking
password-based authentication to IPA framework (e.g. WebUI logins).</p>
<p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">config-show</span></code> will be enhanced to display active KDCs supporting
client PKINIT. To improve the usability of PKINIT in mixed topologies, a
separate command (<code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">pkinit-status</span></code>) will be provided to query
PKINIT status on selected master or on the whole topology.</p>
<p>To allow PKINIT authentication for users, their PKI certificates should
include SAN extensions that map them directly to their primary Kerberos
principal name. More details can be found in the PKINIT section of the
<strong>krb5.conf</strong> manual page.</p>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<p>[STRIKEOUT:For deployment with integrated CA PKINIT is always enabled.
For deployments with external CA it is possible to supply externally
signed KDC certificate pair.]</p>
<p>The exact PKINIT configuration when deploying new replica depends on the
domain level, FreeIPA version and CA status of the remote master as is
shown in the following table:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Remote master configuration</p></th>
<th class="head"><p>PKINIT feature status*</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>&lt;4.5, no CA</p></td>
<td><p>local PKINIT</p></td>
</tr>
<tr class="row-odd"><td><p>&lt;4.5 with CA</p></td>
<td><p>try out full PKINIT, fall back
to local configuration if it
fails</p></td>
</tr>
<tr class="row-even"><td><p>4.5 no CA, no external PKINIT
cert</p></td>
<td><p>local PKINIT</p></td>
</tr>
<tr class="row-odd"><td><p>4.5 no CA, external PKINIT cert</p></td>
<td><p>external PKINIT</p></td>
</tr>
<tr class="row-even"><td><p>4.5 with CA</p></td>
<td><p>full PKINIT</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>status: local PKINIT: locally configured KDC with self-signed
certificate, external PKINIT: proper PKINIT configured externally
provided KDC certificate and CA cert, full PKINIT: proper PKINIT
configured using certificate signed by IPA CA</p></li>
</ul>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">ipa-server-certinstall</span></code> command should be extended to
allow for installing a PKINIT certificate from PKCS#12 file or request a
new PKINIT keypair signed by integrated CA. This should allow users to
configure proper PKINIT support for clients post-hoc after
installing/upgrading masters with no client PKINIT support.</p>
<p>NOTE: The design does not consider completely disabled anonymous PKINIT
as a configuration option. In order to emulate disabled PKINIT the
administrator can provide a PKCS#12 file via <code class="docutils literal notranslate"><span class="pre">ipa-server-certinstall</span></code>
and just not distribute the trusted CA certificate as a pkinit anchor to
the clients. In this way the local PKINIT will work but clients would
not be able to issue anonymous tickets to clients. Since this state will
be recorded as a ‘external PKINIT’, the upgrade code will not attempt to
configure full PKINIT.</p>
</section>
</section>
<section id="upgrade">
<h1>Upgrade<a class="headerlink" href="#upgrade" title="Permalink to this heading">¶</a></h1>
<p>[STRIKEOUT:On upgrade PKINIT is not automatically enabled. To enable
PKINIT, run ipa-pkinit-manage command.]</p>
<p>The exact upgrade path depends on the state of the feature on the
master. We shall distinguish the following configurations:</p>
<ul class="simple">
<li><p>PKINIT is not configured at all (pre 4.5 masters)</p></li>
<li><p>only local PKINIT w/ self-signed KDC keypair is configured (DL0
masters, CA-less masters without supplied PKINT certificates)</p></li>
<li><p>PKINIT is configured with supplied 3rd party certificate</p></li>
<li><p>full PKINIT is configured with certificates signed by IPA CA</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Server
co
nfiguration</p></th>
<th class="head"><p>absent
PKINIT</p></th>
<th class="head"><p>local
PKINIT</p></th>
<th class="head"><p>external
PKINIT</p></th>
<th class="head"><p>full PKINIT</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>no CA</p></td>
<td><p>configure
local
PKINIT</p></td>
<td><p>no action</p></td>
<td><p>no action</p></td>
<td><p>N/A</p></td>
</tr>
<tr class="row-odd"><td><p>with CA on
the master</p></td>
<td><p>configure
full PKINIT</p></td>
<td><p>configure
full PKINIT</p></td>
<td><p>no action</p></td>
<td><p>no action</p></td>
</tr>
<tr class="row-even"><td><p>with CA not
on the
master</p></td>
<td><p>try to
configure
full
PKINIT,
fallback to
local
PKINIT</p></td>
<td><p>try to
configure
full
PKINIT,
fallback to
local
PKINIT</p></td>
<td><p>no action</p></td>
<td><p>no action</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>As can be inferred from the table, there may be failures arising from
PKINIT cert request being routed to a CA master which does not hold the
<strong>KDCs_PKINIT_Certs</strong> profile or does not yet possess upgraded cert.py
plugin. In this case the upgrader will issue a warning and fall back to
issuing self-signed PKINIT certificates.</p>
<section id="update-sep-1-2017">
<span id="id5"></span><h2>Update Sep 1 2017<a class="headerlink" href="#update-sep-1-2017" title="Permalink to this heading">¶</a></h2>
<p>Following information should be incorporated in the design page in order
to be up to date with what was implemented in FreeIPA 4.5.x</p>
<p>When you install 4.5 with –no-pkinit, the installer will generate
self-signed certificate for PKINIT. This certificate is only used and
trusted by IPA Web UI running on the same server to obtain an anonymous
ticket.</p>
<p>How to upgrade that certificate to a full-featured PKINIT KDC
certificate depends on what is your CA.</p>
<p>A new tool, ipa-pkinit-manage, exists in FreeIPA 4.5.</p>
<p><code class="docutils literal notranslate"><span class="pre">ipa-pkinit-manage status</span></code></p>
<p>will tell you current status. “Enabled” means you have properly working
PKINIT infrastructure on this system. “Disabled” means you only have
self-signed PKINIT.</p>
<p><code class="docutils literal notranslate"><span class="pre">ipa-pkinit-manage enable</span></code></p>
<p>will try to request PKINIT KDC certificate from IdM CA. You should make
sure that all IdM CAs are at the same level (FreeIPA 4.5+) before
running this command.</p>
<p>If you are not using IdM CA (external CA is in use), the tool will tell
you to use ipa-server-certinstall to install an externally procured KDC
certificate. That certificate should have following properties:</p>
<ul class="simple">
<li><p>it be issued with CN=fqdn,$SUBJECT_BASE</p></li>
<li><p>it should have Kerberos principal <a class="reference external" href="mailto:krbtgt/REALM&#37;&#52;&#48;REALM">krbtgt/REALM<span>&#64;</span>REALM</a></p></li>
<li><p>it should have id-pkinit-KPkdc OID (1.3.6.1.5.2.3.5)</p></li>
</ul>
<p>You can see /usr/share/ipa/profiles/KDCs_PKINIT_Certs.cfg which is the
KDC profile we use to issue this certificate with integrated Dogtag CA.
Compare it to /usr/share/ipa/profiles/caIPAserviceCert.cfg to see the
difference to a ‘normal’ IPA service certificate.</p>
</section>
</section>
<section id="how-to-use">
<h1>How to Use<a class="headerlink" href="#how-to-use" title="Permalink to this heading">¶</a></h1>
<p>FreeIPA clients are always configured to trust FreeIPA CA in their
<strong>/etc/krb5.conf</strong>. Thus, if PKINIT KDC certificate is issued by FreeIPA
CA, no additional configuration on the client side is needed.</p>
<p>[STRIKEOUT:To use Anonymous PKINIT, make sure ipa pkinit-anonymous
enable is run (default if installed with PKINIT enabled).]</p>
<p>Then any client can use</p>
<p>``   kinit -n``</p>
<p>to request an anonymous Kerberos ticket.</p>
<p>The ticket granting ticket (TGT) obtained as result of the <strong>kinit -n</strong>
request can only be used to create a FAST channel for second factor
authentication:</p>
<div class="line-block">
<div class="line">``   kinit -n``</div>
<div class="line">``   klist``</div>
<div class="line">``   ARMOR_CCACHE=$(klist|grep cache:<a href="#id6"><span class="problematic" id="id7">|</span></a>cut -d’ ‘ -f3-)``</div>
<div class="line">``   kinit -T $ARMOR_CCACHE <a class="reference external" href="mailto:principal&#37;&#52;&#48;REALM">principal<span>&#64;</span>REALM</a> ``</div>
</div>
<p><strong>-T</strong> option of kinit allows to specify existing credentials cache with
a valid TGT to create a FAST channel between the Kerberos client and the
KDC when requesting the initial ticket for the specified
<strong>principal&#64;REALM</strong>. This allows to safely pass details of the
multi-factor pre-authentication exchange to the KDC.</p>
<p>To query whether the master supports client PKINIT via <code class="docutils literal notranslate"><span class="pre">config-show</span></code>:</p>
<div class="line-block">
<div class="line">``  $ ipa config-show``</div>
<div class="line">``  Maximum username length: 32``</div>
<div class="line">``  Home directory base: /home``</div>
<div class="line">``  Default shell: /bin/sh``</div>
<div class="line">``  Default users group: ipausers``</div>
<div class="line">``  …``</div>
<div class="line">``  IPA masters supporting PKINIT: master1.ipa.test``</div>
<div class="line">``  …``</div>
</div>
<p>To obtain the same information via <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">pkinit-status</span></code>:</p>
<div class="line-block">
<div class="line">``  $ ipa pkinit-status``</div>
<div class="line">``  Server name: master1.ipa.test``</div>
<div class="line">``  PKINIT status: enabled``</div>
<div class="line">``  …``</div>
<div class="line">``  Server name: replica1.ipa.test``</div>
<div class="line">``  PKINIT status: disabled``</div>
<div class="line">``  …``</div>
</div>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/Kerberos_PKINIT.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
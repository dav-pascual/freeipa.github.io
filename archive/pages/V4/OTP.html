<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="OTP_Replay_Prevention.html" />
    <link rel="prev" title="Overview" href="Notification_system.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>One of the best ways to increase authentication security is to require
two factor authentication (2FA). One of the more popular options is to
use one-time passwords (OTP). This technique began in the proprietary
space, but over time some open standards emerged (HOTP: RFC 4226, TOTP:
RFC 6238).</p>
<p>This project adds support for these standard OTP mechanisms to FreeIPA.</p>
<p>One unique challenge of this project is to provide a mechanism to permit
gradual migrations from proprietary technologies to their related open
standards. Since nearly every proprietary technology supports the RADIUS
authentication protocol, we provide a way to proxy OTP requests to their
proprietary RADIUS servers. This provides a path for gradual migration.</p>
</section>
<section id="use-cases">
<h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<section id="native-otp-support">
<span id="id1"></span><h2>Native OTP Support<a class="headerlink" href="#native-otp-support" title="Permalink to this heading">¶</a></h2>
<p>All tokens used with FreeIPA native OTP support must implement either
HOTP (counter-based; RFC 4226) or TOTP (time-based; RFC 6238).</p>
<section id="administrator-managed-hardware-tokens">
<span id="id2"></span><h3>Administrator-Managed Hardware Tokens<a class="headerlink" href="#administrator-managed-hardware-tokens" title="Permalink to this heading">¶</a></h3>
<p>Two types of hardware tokens exist: programmable and non-programmable.
Both types are often purchased by an administrator in bulk and then
assigned to a user. An administrator enables token support for a user
(or globally) and adds hardware token(s) to the user’s account. These
hardware tokens work right away – no user configuration is required. So
on the first login, both password and a token code are required. While
the user can view this token, he or she does not manage it. Hence, no
modifications should be permitted.</p>
<section id="programmable-tokens">
<span id="id3"></span><h4>Programmable Tokens<a class="headerlink" href="#programmable-tokens" title="Permalink to this heading">¶</a></h4>
<p><a class="reference internal" href="../../../_images/Programmable_Tokens.png"><img alt="Programmable_Tokens.png" src="../../../_images/Programmable_Tokens.png" style="width: 240px;" /></a> Programmable hardware tokens are generally
programmed with fresh random data at the time they are assigned to the
user by the admin. FreeIPA will provide a command to generate any needed
random secret, create the FreeIPA token and assign it; all as one single
step. For most programmable tokens, the hardware specific protocol used
to write the secret and read the metadata will be left as an exercise to
the administrator. However, for some programmable tokens which have
adequate open source support, such as YubiKeys, FreeIPA will provide a
single command which automates the entire process (CLI-only due to
browser limitations).</p>
</section>
<section id="non-programmable-tokens">
<span id="id4"></span><h4>Non-programmable Tokens<a class="headerlink" href="#non-programmable-tokens" title="Permalink to this heading">¶</a></h4>
<p><a class="reference internal" href="../../../_images/Non-Programmable_Tokens.png"><img alt="Non-Programmable_Tokens.png" src="../../../_images/Non-Programmable_Tokens.png" style="width: 320px;" /></a> The non-programmable token vendor will
provide a digital record of the tokens’ secrets and metadata (usually in
an RFC 6030 XML file). The administrator should be able to execute a
server-side command (CLI-only; not generally available to regular users)
to import all of these tokens in a single pass. This may or may not
require per-user assignment after the import is complete.</p>
</section>
</section>
<section id="user-managed-tokens">
<span id="id5"></span><h3>User-Managed Tokens<a class="headerlink" href="#user-managed-tokens" title="Permalink to this heading">¶</a></h3>
<p>An administrator enables token support for a user (or globally) but does
not create any software tokens. The user is able to log in with just the
standard pre-defined password. Upon login, the user is able to create
software tokens in either the UI or CLI and provision them on a
smartphone or tablet using a QR code. After the first token is created,
subsequent logins require both password and a token code. The user
should retain full control of the token details, including most metadata
fields. Users should be able to create, edit or delete any of these
tokens so long as at least one active token remains. Attempts to delete
or deactivate the last active token should fail (active means not
disabled and within the specified validity time window).</p>
<p>One alternative to this scenario is the use of BYOD programmable
hardware tokens. These devices are exactly like the programmable
hardware tokens specified in the previous use case and all the above
criteria apply except that they must be created and managed by the user
like software tokens. Programming of hardware tokens will be CLI-only
due to browser limitations.</p>
</section>
<section id="token-synchronization">
<span id="id6"></span><h3>Token Synchronization<a class="headerlink" href="#token-synchronization" title="Permalink to this heading">¶</a></h3>
<p>If a token goes out of sync, the user should be able to re-synchronize
it. This should be possible regardless of what type of token it is and
whether or not the user has the ability to modify the token. This should
be possible on both the UI, via a helpful link on the login page, and
the CLI, without having to log in via Kerberos. The general process for
this is that the user must enter his or her password and two token codes
in a row. This confirms possession of the token.</p>
</section>
</section>
<section id="proprietary-otp-support">
<span id="id7"></span><h2>Proprietary OTP Support<a class="headerlink" href="#proprietary-otp-support" title="Permalink to this heading">¶</a></h2>
<p>Many administrators will be migrating from a proprietary OTP solution to
the FreeIPA integrated OTP support. However, for large deployments, an
all-at-once migration is often not possible. FreeIPA should handle this
case by providing a way to offload OTP validation to a 3rd-party RADIUS
server for a subset of the users.</p>
<p>To handle this, an administrator can create a set of RADIUS proxies
(each proxy can contain multiple individual RADIUS servers). A user can
be assigned to one of these proxies. While a user has a RADIUS proxy
assigned, all other mechanisms are bypassed. When the user is ready to
be migrated to the FreeIPA native OTP system, the RADIUS proxy
assignment for the user is simply removed.</p>
<p>FreeIPA provides no token management or synchronization support for
tokens in the 3rd-party system.</p>
</section>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<section id="high-level-architecture-and-workflow">
<span id="id8"></span><h2>High-Level Architecture and Workflow<a class="headerlink" href="#high-level-architecture-and-workflow" title="Permalink to this heading">¶</a></h2>
<figure class="align-default" id="id36">
<a class="reference internal image-reference" href="../../../_images/FreeIPA_OTP.png"><img alt="FreeIPA_OTP.png" src="../../../_images/FreeIPA_OTP.png" style="width: 500px;" /></a>
<figcaption>
<p><span class="caption-text">FreeIPA_OTP.png</span><a class="headerlink" href="#id36" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<ol class="arabic simple">
<li><p>An incoming Kerberos authentication request is received.</p></li>
<li><p>As in all Kerberos requests, the user’s information is loaded from
LDAP using the FreeIPA KDB plugin. This process will be augmented to
determine if OTP is required for the user.</p></li>
<li><p>If the previous check indicates that OTP authentication should be
used, the request will be forwarded to the ipa-otpd process using MIT
krb5’s
<a class="reference external" href="http://k5wiki.kerberos.org/wiki/Projects/OTPOverRADIUS">OTP-over-RADIUS</a>
support.</p></li>
<li><p>The ipa-otpd process will search LDAP to see if 3rd-party RADIUS or
native OTP support is configured for the user.</p></li>
<li><p>If the user is assigned to a 3rd-party RADIUS server, the request
will be forwarded immediately for validation. A mechanism will be
available to translate from the FreeIPA username to the username
expected by the 3rd-party RADIUS server. All other authentication
methods will be ignored. Note that this applies for kerberos
authentications only. When using RADIUS mode, LDAP binds will still
require the single factor configured for the user in LDAP and will
not reference the RADIUS second factor at all.</p></li>
<li><p>Otherwise, an LDAP bind will be attempted to engage FreeIPA’s native
OTP support. This support is implemented in the ipa-pwd-extop plugin
for the 389 directory server.</p></li>
<li><p>After the authentication is successful, a token’s counter or
watermark will be incremented. The ipa-otp-counter plugin guarantees
that all counter modifications are locally atomic, preventing
simultaneous multi-use of the token on a single server. To provide
similar protection on other servers, the counter/watermark will be
replicated. Until this replication is processed on the remote server,
it is possible the token might be reused there. However, the
ipa-otp-counter plugin also detects any counter discrepancies and
repairs them immediately, guaranteeing eventual consistency.</p></li>
<li><p>A third 389 directory server plugin (ipa-otp-lasttoken) is used to
ensure that no user can delete or disable the last active token
assigned to him or her.</p></li>
</ol>
</section>
<section id="authentication-methods">
<span id="id9"></span><h2>Authentication Methods<a class="headerlink" href="#authentication-methods" title="Permalink to this heading">¶</a></h2>
<p>In order to provide fine-grained controls over which authentication
methods are available to which users we have developed a notion of User
Auth Types. The User Auth Types can be set globally or on a per-user
basis and indicates which authentication methods are allowed. Because
this attribute is multi-valued, setting multiple values indicates a
logical OR. In other words, any of the specified methods may be used.</p>
<p>The following User Auth Types are defined (but not all may be
implemented):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">password</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">otp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pkinit</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">radius</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">disabled</span></code> (global only)</p></li>
</ul>
<p>If no value is set, <code class="docutils literal notranslate"><span class="pre">password</span></code> is assumed.</p>
<p>Note well that <code class="docutils literal notranslate"><span class="pre">otp</span></code> means “use a password and an otp value.” If only
<code class="docutils literal notranslate"><span class="pre">otp</span></code> is set, password-only authentication will be allowed only when
the user has no tokens defined.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">disabled</span></code> value can only be set globally and forces the user of
“password” on all users, regardless of their per-user settings.</p>
</section>
<section id="token-synchronization-1">
<span id="id10"></span><h2>Token Synchronization<a class="headerlink" href="#token-synchronization-1" title="Permalink to this heading">¶</a></h2>
<section id="https">
<h3>HTTPS<a class="headerlink" href="#https" title="Permalink to this heading">¶</a></h3>
<p>Support for synchronizing a token is available at /session/sync_token
using a POST request. This request takes the following parameters:</p>
<ul class="simple">
<li><p>user - Your username</p></li>
<li><p>password - Your first factor (password)</p></li>
<li><p>first_code - The current token code</p></li>
<li><p>second_code - The next token code</p></li>
<li><p>token - The name of the token (optional)</p></li>
</ul>
<p>Take care not to expose this URL in any way without TLS since your
password is sent over the wire.</p>
<p>The result of the operation is returned in the X-IPA-TokenSync-Result
header.</p>
</section>
<section id="ldap-bind-control">
<span id="id11"></span><h3>LDAP Bind Control<a class="headerlink" href="#ldap-bind-control" title="Permalink to this heading">¶</a></h3>
<p>Token synchronization is available via a bind control when doing a
simple bind. The OID of the control is: 2.16.840.1.113730.3.8.10.6. The
ASN.1 is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OTPSyncRequest</span> <span class="p">:</span><span class="o">:=</span> <span class="n">SEQUENCE</span> <span class="p">{</span>
    <span class="n">firstCode</span>   <span class="n">OCTET</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">secondCode</span>  <span class="n">OCTET</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">tokenDN</span>     <span class="n">OCTET</span> <span class="n">STRING</span> <span class="n">OPTIONAL</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="permissions">
<h2>Permissions<a class="headerlink" href="#permissions" title="Permalink to this heading">¶</a></h2>
<p>Tokens have either zero or one owner. If a token has no owner it is
considered unassigned. A token’s owner can do the following with the
token:</p>
<ul class="simple">
<li><p>read</p></li>
<li><p>authenticate</p></li>
<li><p>synchronize</p></li>
</ul>
<p>Tokens may have zero or more managers. A token’s manager may:</p>
<ul class="simple">
<li><p>read</p></li>
<li><p>write</p></li>
<li><p>delete (if token is self-owned, cannot delete last active token)</p></li>
</ul>
<p>Admins can create tokens that are either unassigned/unmanaged or are
owned and/or managed by any user. Users can create tokens if and only if
they are self-owned and self-managed.</p>
<p>Only administrators may change the User Auth Type (globally or
per-user).</p>
<section id="helpdesk">
<h3>Helpdesk<a class="headerlink" href="#helpdesk" title="Permalink to this heading">¶</a></h3>
<p>One tricky situation that is not yet accounted for is the helpdesk
scenario where a non-admin needs to perform some tasks related to
tokens. As a philosophy, the helpdesk role should not be able to perform
tasks that users can perform themselves. The proper response here is
organization-specific documentation and training. This makes for
self-sufficient users, lowering helpdesk costs.</p>
<p>Here is a list of possible helpdesk tasks:</p>
<ul class="simple">
<li><p>Bulk token import (assigned or unassigned)</p></li>
<li><p>Creating a programmable / software token on behalf of a new user
(before first login)</p></li>
<li><p>Manually adding / assigning a fixed-secret hardware token</p></li>
<li><p>Changing the per-user auth type</p></li>
<li><p>Deleting a user’s last active token</p></li>
<li><p>Editing a non-owner-managed token information</p></li>
</ul>
<p>Special care needs to be taken care to ensure that a member of the
helpdesk staff cannot create a new token for a user with higher
privileges (such as an admin). Doing so would make an escalation attack
feasible by compromising only the first factor and creating a new second
factor token.</p>
<p>A similar escalation attack is allowed if the helpdesk staff can disable
OTP for a user with higher privileges, either via deleting the user’s
last active token or by changing the per-user auth type.</p>
</section>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<p>Mixing the “password” and “otp” user auth types should not be used. It
currently works in LDAP, allowing either password or password+otp login.
However, it is not currently supported in krb5 where “otp” will be
forced. Support for mixed mode Kerberos authentication is in progress.</p>
<p>FAST support is currently required on the client to enable OTP
authentications. You get this for free when using a setup like SSSD.
However, kinit will not work without some additional configuration.</p>
<p>While IPA supports specifying multiple RADIUS proxy servers in LDAP,
ipa-otpd only uses the first returned server defined for the proxy. As a
work-around, DNS round-robin can provide failover support. For details,
see <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4682">the bug</a>.</p>
<p><a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4897">Upon testing</a>, OTP
works exactly the same for compat tree binds as it does for regular
binds.</p>
</section>
<section id="feature-management">
<h1>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h1>
<section id="ui">
<h2>UI<a class="headerlink" href="#ui" title="Permalink to this heading">¶</a></h2>
<section id="authentication-methods-1">
<span id="id12"></span><h3>Authentication Methods<a class="headerlink" href="#authentication-methods-1" title="Permalink to this heading">¶</a></h3>
<p>System-wide authentication methods will be available on the Server
settings tab.</p>
<p>Per-user authentication methods will be available on the User’s detail
page.</p>
</section>
<section id="radius-proxy-server-configuration">
<span id="id13"></span><h3>RADIUS Proxy Server Configuration<a class="headerlink" href="#radius-proxy-server-configuration" title="Permalink to this heading">¶</a></h3>
<p>Administrators will have the RADIUS Servers tab available for managing
RADIUS proxy servers. These servers can be assigned to individual users
on the specific user’s detail page.</p>
</section>
<section id="otp-tokens">
<span id="id14"></span><h3>OTP Tokens<a class="headerlink" href="#otp-tokens" title="Permalink to this heading">¶</a></h3>
<p>A tab for managing tokens will be available on the user self-service
page. This will permit the addition, deletion and editing of
self-assigned/managed tokens.</p>
<p>Administrators will receive a similar UI for managing tokens for all
users.</p>
<p>A link to a synchronization page is provided at the FreeIPA login page.</p>
</section>
</section>
<section id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this heading">¶</a></h2>
<section id="existing-commands-modified">
<span id="id15"></span><h3>Existing Commands Modified<a class="headerlink" href="#existing-commands-modified" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>config-mod</p></td>
<td><p>–user-auth-type=password/otp/radius</p></td>
</tr>
<tr class="row-odd"><td><p>user-mod</p></td>
<td><p>–user-auth-type=password/otp/radius –radius=STR
–radius-username=STR</p></td>
</tr>
</tbody>
</table>
</section>
<section id="new-radius-proxy-commands">
<span id="id16"></span><h3>New RADIUS Proxy Commands<a class="headerlink" href="#new-radius-proxy-commands" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>radiusproxy-add</p></td>
<td><p>–desc=STR –server=STR –secret –timeout=INT
–retries=INT –userattr=STR</p></td>
</tr>
<tr class="row-odd"><td><p>radiusproxy-find</p></td>
<td><p>–name=STR –desc=STR –server=STR –timeout=INT
–retries=INT –userattr=STR</p></td>
</tr>
<tr class="row-even"><td><p>radiusproxy-mod</p></td>
<td><p>–rename=STR –desc=STR –server=STR –secret
–timeout=INT –retries=INT –userattr=STR</p></td>
</tr>
<tr class="row-odd"><td><p>radiusproxy-del</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>radiusproxy-show</p></td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="new-otp-token-commands">
<span id="id17"></span><h3>New OTP Token Commands<a class="headerlink" href="#new-otp-token-commands" title="Permalink to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Options</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>otptoken-add</p></td>
<td><p>–type=STRENUM –desc=STR –owner=LOGIN
–disabled=BOOL –not-before=STR
–not-after=STR –vendor=STR
–model=STR –serial=STR –key=STR
–algo=STRENUM –digits=6/8
–offset=INT –interval=INT –no-qrcode</p></td>
</tr>
<tr class="row-odd"><td><p>otptoken-add-managedby</p></td>
<td><p>–users=STR</p></td>
</tr>
<tr class="row-even"><td><p>otptoken-add-yubikey</p></td>
<td><p>–desc=STR –owner=LOGIN
–disabled=BOOL –notbefore=STR
–not-after=STR –digits=6/8 –slot=1/2</p></td>
</tr>
<tr class="row-odd"><td><p>otptoken-del</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>otptoken-find</p></td>
<td><p>–type=STRENUM –desc=STR –owner=LOGIN
–disabled=BOOL –not-before=STR
–not-after=STR –vendor=STR
–model=STR –serial=STR –algo=STRENUM
–digits=6/8 –offset=INT
–interval=INT –id=STR</p></td>
</tr>
<tr class="row-odd"><td><p>otptoken-mod</p></td>
<td><p>–rename=STR –desc=STR –owner=LOGIN
–disabled=BOOL –not-before=STR
–not-after=STR –vendor=STR
–model=STR –serial=STR</p></td>
</tr>
<tr class="row-even"><td><p>otptoken-remove-managedby</p></td>
<td><p>–users=STR</p></td>
</tr>
<tr class="row-odd"><td><p>otptoken-show</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>otptoken-sync</p></td>
<td><p>–user=STR –password –first-code
–second-code</p></td>
</tr>
</tbody>
</table>
<section id="otp-import-command">
<span id="id18"></span><h4>OTP Import Command<a class="headerlink" href="#otp-import-command" title="Permalink to this heading">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ipa</span><span class="o">-</span><span class="n">otptoken</span><span class="o">-</span><span class="kn">import</span> <span class="p">[</span><span class="o">-</span><span class="n">k</span> <span class="n">KEYFILE</span><span class="p">]</span> <span class="o">&lt;</span><span class="n">PSKC</span> <span class="n">file</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">output</span> <span class="n">file</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This command imports the tokens specified in the PSKC (RFC 6030) file.
This command must be run on the IPA server by the admin. If the tokens
in the PSKC file are encrypted, the -k option MUST be specified. Any
tokens which fail to add will be written to the output file. This
permits the admin to review the tokens which failed, correct any
problems in the data file and re-import them.</p>
</section>
</section>
</section>
</section>
<section id="replication">
<h1>Replication<a class="headerlink" href="#replication" title="Permalink to this heading">¶</a></h1>
<p>It is at least theoretically possible that a server could issue a
replication request with a lower counter or watermark value but a higher
CSN. In order to guarantee eventual cluster consistency and to ensure
that higher counter/watermark values do not get erased, the
ipa-otp-counter plugin will enforce the highest counter/watermark value
and issue fix-up replications if an error is detected.</p>
</section>
<section id="new-dependencies">
<span id="id19"></span><h1>New Dependencies<a class="headerlink" href="#new-dependencies" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>python-qrcode</p></li>
<li><p>python-yubico (implicit: pyusb)</p></li>
<li><p>libverto-devel</p></li>
</ul>
</section>
<section id="how-to-test">
<span id="how-to-test31"></span><h1>How to Test<a class="headerlink" href="#how-to-test" title="Permalink to this heading">¶</a></h1>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">¶</a></h2>
<section id="creating-a-user">
<span id="id20"></span><h3>Creating a User<a class="headerlink" href="#creating-a-user" title="Permalink to this heading">¶</a></h3>
<p>We need to create a user to use when testing OTP. For the duration of
this guide, I will call this user: <code class="docutils literal notranslate"><span class="pre">otpuser</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kinit admin
Password for admin@EXAMPLE.COM:

$ ipa user-add otpuser
First name: OTP
Last name: User
--------------------
Added user &quot;otpuser&quot;
--------------------
  User login: otpuser
  First name: OTP
  Last name: User
  Full name: OTP User
  Display name: OTP User
  Initials: OU
  Home directory: /home/otpuser
  GECOS: OTP User
  Login shell: /bin/sh
  Kerberos principal: otpuser@EXAMPLE.COM
  Email address: otpuser@example.com
  UID: 1181600140
  GID: 1181600140
  Password: False
  Member of groups: ipausers
  Kerberos keys available: False

$ ipa passwd otpuser
New Password:
Enter New Password again to verify:
------------------------------------------
Changed password for &quot;otpuser@EXAMPLE.COM&quot;
------------------------------------------

$ kinit otpuser
Password for otpuser@EXAMPLE.COM:
Password expired.  You must change it now.
Enter new password:
Enter it again:
</pre></div>
</div>
</section>
<section id="enabling-otp-and-radius">
<span id="id21"></span><h3>Enabling OTP and RADIUS<a class="headerlink" href="#enabling-otp-and-radius" title="Permalink to this heading">¶</a></h3>
<p>Before OTP or RADIUS can be used, they needs to be enabled (either
globally or per-user). This involves setting the User Auth Type to
<code class="docutils literal notranslate"><span class="pre">otp</span></code> and/or <code class="docutils literal notranslate"><span class="pre">radius</span></code> either via the UI or the CLI:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>CLI</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Globally</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">c</span>
<span class="pre">onfig-mod</span> <span class="pre">--user-auth-type=otp</span> <span class="pre">--user-auth-type=radius</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Per-User</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-mo</span>
<span class="pre">d</span> <span class="pre">otpuser</span> <span class="pre">--user-auth-type=otp</span> <span class="pre">--user-auth-type=radius</span></code></p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>UI</p></td>
</tr>
<tr class="row-odd"><td><p>Globally</p></td>
<td><p>IPA Server -&gt; Configuration -&gt; Default user
authentication types</p></td>
</tr>
<tr class="row-even"><td><p>Per-User</p></td>
<td><p>Identity -&gt; otpuser -&gt; User authentication types</p></td>
</tr>
</tbody>
</table>
</section>
<section id="logging-in">
<span id="id22"></span><h3>Logging In<a class="headerlink" href="#logging-in" title="Permalink to this heading">¶</a></h3>
<section id="default-method">
<span id="id23"></span><h4>Default Method<a class="headerlink" href="#default-method" title="Permalink to this heading">¶</a></h4>
<p>Kerberos FAST is required for OTP operations. SSSD performs this
configuration automatically, so <code class="docutils literal notranslate"><span class="pre">su</span> <span class="pre">-</span> <span class="pre">otpuser</span></code> should work out of the
box. Testing with this method is preferred as it will test SSSD OTP
support as well.</p>
</section>
<section id="kinit-method">
<span id="id24"></span><h4>kinit Method<a class="headerlink" href="#kinit-method" title="Permalink to this heading">¶</a></h4>
<p>If you need to test with kinit, you will need to enable FAST manually.
The easiest way to configure FAST manually from the command line is to
kinit as a non-OTP user, then run klist to show the location of the
ticket cache. Once you have done this, you can kinit as your OTP user
using the -T option. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kinit admin
Password for admin@EXAMPLE.COM:

$ klist
Ticket cache: KEYRING:persistent:1000:1000
Default principal: admin@EXAMPLE.COM

Valid starting       Expires              Service principal
11/03/2014 15:38:43  11/04/2014 15:38:41  krbtgt/EXAMPLE.COM@EXAMPLE.COM

$ kinit -T KEYRING:persistent:1000:1000 otpuser
</pre></div>
</div>
<p>A failure to properly configure FAST will result in the following error
message once OTP is configured:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kinit otpuser
kinit: Generic preauthentication failure while getting initial credentials
</pre></div>
</div>
<p>Upstream work is ongoing to remove the need for FAST.</p>
</section>
</section>
</section>
<section id="self-managed-tokens">
<span id="id25"></span><h2>Self-Managed Tokens<a class="headerlink" href="#self-managed-tokens" title="Permalink to this heading">¶</a></h2>
<section id="software-tokens">
<span id="id26"></span><h3>Software Tokens<a class="headerlink" href="#software-tokens" title="Permalink to this heading">¶</a></h3>
<p>Make sure you have FreeOTP
<a class="reference external" href="https://play.google.com/store/apps/details?id=org.fedorahosted.freeotp&amp;hl=en">Android</a>
or
<a class="reference external" href="https://itunes.apple.com/us/app/freeotp-authenticator/id872559395?mt=8">iOS</a>
installed.</p>
<p>Adding a token is easy. If you are logged in as <code class="docutils literal notranslate"><span class="pre">otpuser</span></code>, you can
create a self-managed software token by running <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">otptoken-add</span></code>.
Alternatively, you can do this via the UI: OTP Tokens -&gt; Add. After
adding the token via either method, simply scan the QR code with
FreeOTP.</p>
<p>Now your token is provisioned. Try to log in
(<a class="reference external" href="V4/OTP#Logging_In">V4/OTP#Logging_In</a>). Remember to enter both your
password and your token code (in the form ). This should work without
problem. Now, try to log in again with the same password and token code.
This should fail since the OTP code was already used.</p>
<p>Feel free to add, edit and delete as many tokens as you’d like. You can
try this with both HOTP and TOTP tokens. Notice that you are not
permitted to remove the last active token.</p>
</section>
<section id="programmable-hardware-tokens">
<span id="id27"></span><h3>Programmable Hardware Tokens<a class="headerlink" href="#programmable-hardware-tokens" title="Permalink to this heading">¶</a></h3>
<p>This test will require a YubiKey token.</p>
<p>Because of browser limitations, this command is only available on the
CLI. Insert your YubiKey token and run: <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">otptoken-add-yubikey</span></code>. If
your YubiKey has an empty slot, the command will pick it automatically.
Otherwise, you will need to use the <code class="docutils literal notranslate"><span class="pre">--slot</span></code> argument to choose a slot
to overwrite.</p>
<p>This token should work exactly the same as a software token in the
previous example. All the same policy should apply.</p>
</section>
</section>
<section id="admin-managed-tokens">
<span id="id28"></span><h2>Admin-Managed Tokens<a class="headerlink" href="#admin-managed-tokens" title="Permalink to this heading">¶</a></h2>
<p>Administrators can create tokens on behalf of normal users. When this
happens, the user has read-only access to the token metadata.</p>
<p>To test this, make sure you log in
(<a class="reference external" href="V4/OTP#Logging_In">V4/OTP#Logging_In</a>) as the <code class="docutils literal notranslate"><span class="pre">admin</span></code> user. You
can test this with either a software token using FreeOTP or a YubiKey
Programmable Hardware token. The test procedure is exactly the same as
the above self-managed tokens except that you need to add the
<code class="docutils literal notranslate"><span class="pre">--owner=otpuser</span></code> option when adding a token assigned to someone else.</p>
<p>Notice that when you log back in
(<a class="reference external" href="V4/OTP#Logging_In">V4/OTP#Logging_In</a>) as <code class="docutils literal notranslate"><span class="pre">otpuser</span></code>, these tokens
work for authentication, but you are unable to modify them in any way.</p>
<section id="importing-tokens">
<span id="id29"></span><h3>Importing Tokens<a class="headerlink" href="#importing-tokens" title="Permalink to this heading">¶</a></h3>
<p>Testing the importing of non-programmable hardware tokens is much more
difficult. It requires access to a hardware token and its
secret/metadata XML file. You can test some fake imports using the
files: <code class="docutils literal notranslate"><span class="pre">ipatests/test_ipaserver/data/*.xml</span></code>. However, you will not be
able to test their functionality since this data does not correspond
with an actual hardware token.</p>
</section>
</section>
<section id="token-synchronization-2">
<span id="id30"></span><h2>Token Synchronization<a class="headerlink" href="#token-synchronization-2" title="Permalink to this heading">¶</a></h2>
<p>Currently, the authentication window is hard-coded at 3 steps/periods.
There is <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/4511">a patch</a> to
make this configurable.</p>
<p>To make your token go out of sync simply:</p>
<ul class="simple">
<li><p>click your HOTP token more than 3 times.</p></li>
<li><p>write down the TOTP code and wait more than 3 periods.</p></li>
</ul>
<p>Try to log in with this bad code to confirm failure. To synchronize, run
<code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">otptoken-sync</span></code> or click the “Sync OTP Token” link on the Web UI
Login page.</p>
</section>
<section id="radius-proxy">
<span id="id31"></span><h2>RADIUS Proxy<a class="headerlink" href="#radius-proxy" title="Permalink to this heading">¶</a></h2>
<p>To test the RADIUS proxy support, you will need access to a RADIUS
server.</p>
<ol class="arabic simple">
<li><p>Make sure that the <code class="docutils literal notranslate"><span class="pre">radius</span></code> User Auth Type is enabled
(<a class="reference external" href="V4/OTP#Enabling_OTP_and_RADIUS">V4/OTP#Enabling_OTP_and_RADIUS</a>).</p></li>
<li><p>Add a RADIUS proxy: <code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">radiusproxy-add</span> <span class="pre">testproxy</span></code> (follow
instructions)</p></li>
<li><p>Assign a user to this proxy:
<code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-mod</span> <span class="pre">radiususer</span> <span class="pre">--radius=testproxy</span></code></p></li>
<li><p>If needed, configure the username to send to RADIUS:
<code class="docutils literal notranslate"><span class="pre">ipa</span> <span class="pre">user-mod</span> <span class="pre">radiususer</span> <span class="pre">--radius-username=myradiususer</span></code></p></li>
<li><p>Log in (<a class="reference external" href="V4/OTP#Logging_In">V4/OTP#Logging_In</a>)</p></li>
</ol>
</section>
</section>
<section id="test-plan">
<h1>Test Plan<a class="headerlink" href="#test-plan" title="Permalink to this heading">¶</a></h1>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h2>
<p>For tests, we will require the python-pyotp package. This provides an
independant implementation of OATH (TOTP/HOTP) to test against.</p>
</section>
<section id="test-outline">
<span id="id32"></span><h2>Test Outline<a class="headerlink" href="#test-outline" title="Permalink to this heading">¶</a></h2>
<section id="preparation">
<h3>Preparation<a class="headerlink" href="#preparation" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Create a normal user</p></li>
<li><p>Ensure the user can login 1FA</p></li>
</ol>
</section>
<section id="global-otp-test">
<span id="id33"></span><h3>Global OTP Test<a class="headerlink" href="#global-otp-test" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Enable OTP globally</p></li>
<li><p>Ensure the user can login 1FA</p></li>
<li><p>Create two tokens for the user: TOTP, HOTP</p></li>
<li><p>Ensure the user cannot login 1FA</p></li>
<li><p>Test TOTP:</p>
<ul class="simple">
<li><p>Ensure the user cannot login with a past code beyond the auth
window</p></li>
<li><p>Ensure the user can login with a past code within the auth window</p></li>
<li><p>Ensure the user can login with the current code</p></li>
<li><p>Ensure the user cannot login with the current code again (rapidly)</p></li>
<li><p>Ensure the user can login with a future code within the auth
window</p></li>
<li><p>Ensure the user cannot login with a future code beyond the auth
window</p></li>
</ul>
</li>
<li><p>Test HOTP:</p>
<ul class="simple">
<li><p>Ensure the user can login</p></li>
<li><p>Ensure the user cannot login with the same code (rapidly)</p></li>
<li><p>Ensure the user cannot login with an old code</p></li>
<li><p>Ensure the user cannot login with a future code beyond the auth
window</p></li>
<li><p>Ensure the user can login with a future code within the auth
window</p></li>
</ul>
</li>
<li><p>Cleanup</p></li>
</ol>
</section>
<section id="local-otp-test">
<span id="id34"></span><h3>Local OTP Test<a class="headerlink" href="#local-otp-test" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Enable OTP per-user</p></li>
<li><p>Ensure the user can login 1FA</p></li>
<li><p>Create two tokens for the user: TOTP, HOTP</p></li>
<li><p>Ensure the user cannot login 1FA</p></li>
<li><p>Test TOTP:</p>
<ul class="simple">
<li><p>Ensure the user cannot login with a past code beyond the auth
window</p></li>
<li><p>Ensure the user can login with a past code within the auth window</p></li>
<li><p>Ensure the user can login with the current code</p></li>
<li><p>Ensure the user cannot login with the current code again (rapidly)</p></li>
<li><p>Ensure the user can login with a future code within the auth
window</p></li>
<li><p>Ensure the user cannot login with a future code beyond the auth
window</p></li>
</ul>
</li>
<li><p>Test HOTP:</p>
<ul class="simple">
<li><p>Ensure the user can login</p></li>
<li><p>Ensure the user cannot login with the same code (rapidly)</p></li>
<li><p>Ensure the user cannot login with an old code</p></li>
<li><p>Ensure the user cannot login with a future code beyond the auth
window</p></li>
<li><p>Ensure the user can login with a future code within the auth
window</p></li>
</ul>
</li>
<li><p>Cleanup</p></li>
</ol>
</section>
<section id="user-permissions-test">
<span id="id35"></span><h3>User Permissions Test<a class="headerlink" href="#user-permissions-test" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Login as the user.</p></li>
<li><p>Ensure the user can create self-managed TOTP, HOTP tokens</p></li>
<li><p>Ensure the user cannot create a non-self-managed token</p></li>
<li><p>Ensure the user cannot delete the last active token</p></li>
<li><p>Ensure the user can synchronize the token</p></li>
<li><p>Ensure admin can delete user’s last active token</p></li>
</ol>
</section>
</section>
</section>
<section id="links">
<h1>Links<a class="headerlink" href="#links" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="V4/OTP/Schema">V4/OTP/Schema</a></p></li>
<li><p><a class="reference external" href="V4/OTP/Detail">V4/OTP/Detail</a></p></li>
<li><p><a class="reference external" href="https://fedorahosted.org/sssd/wiki/DesignDocs/OTPRelatedImprovements">SSSD OTP
Support</a></p></li>
</ul>
</section>
<section id="rfe-author">
<h1>RFE Author<a class="headerlink" href="#rfe-author" title="Permalink to this heading">¶</a></h1>
<p>For questions or comments, please contact:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Nathaniel</span> <span class="n">McCallum</span>
<span class="n">Email</span><span class="p">:</span> <span class="n">npmccallum</span><span class="nd">@redhat</span><span class="o">.</span><span class="n">com</span>
<span class="n">IRC</span><span class="p">:</span> <span class="n">npmccallum</span>
</pre></div>
</div>
<p><a class="reference external" href="Category:FreeIPA_V4_Test_Plan">Category:FreeIPA V4 Test Plan</a>
<a class="reference external" href="Category:FreeIPA_Test_Plan">Category:FreeIPA Test Plan</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V4/OTP.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
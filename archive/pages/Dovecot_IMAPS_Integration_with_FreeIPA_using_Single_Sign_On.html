<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Gotcha’s &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Dovecot Integration with IPA" href="Dovecot_Integration.html" />
    <link rel="prev" title="About domain levels" href="Domain_Levels.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p><strong>HOWTO: Configure Dovecot to authenticate IPA users using Kerberos with
Single Sign On.</strong></p>
<p><strong>Provided by Dale Macartney</strong></p>
<p>The below details will walk you through how to add a Red Hat Enterprise
Linux 6.2 system to an IPA domain, and then configure Dovecot to allow
single sign on to user mailboxes with IMAP/S.</p>
<p>Details of this example are as follows</p>
<div class="line-block">
<div class="line">``   Domain name: example.com``</div>
<div class="line">``   IPA Server: ds01.example.com``</div>
<div class="line">``   Dovecot Server: mail01.example.com``</div>
<div class="line">``   IPA Client: workstation01.example.com``</div>
<div class="line">``   IPA User: user1 and user2``</div>
</div>
<p><strong>Please Note: This guide describes using SSL combined with Dovecot to
deliver IMAPS support. This guide is not designed to cover how to create
a valid SSL certificate. This guide uses the default dovecot generated
certificate and it is HIGHLY recommended that if you wish to deploy this
into a production environment, that you replace this certificate with
your own trusted/validated certificate</strong></p>
<section id="gotcha-s">
<h1>Gotcha’s<a class="headerlink" href="#gotcha-s" title="Permalink to this heading">¶</a></h1>
<p>I encounter a few gotcha’s around mailbox storage which would be
worthwhile remembering, or at least keep in mind for deployment
considerations.</p>
<p>Storing MailDir content in home directories is a very common method for
managing mailboxes.</p>
<p>If you use automount for your IPA based users (e.g. NFS Home
Directories), you need to keep in mind that Dovecot does not manage an
interactive login which would be when the automount normally occurs.</p>
<p>The result of this will mean that trying to store the MailDir folders in
a users network based home dir will fail as in the eyes of Dovecot, the
folder simply won’t exist. Basically, Dovecot will not be able to write
to your automount directory.</p>
<p>This guide will show you how to use local based storage to manage this
issue and create any directories which aren’t currently present.</p>
</section>
<section id="add-system-to-ipa-domain-ensure-dns-is-working-correctly-otherwise-this-step-will-fail">
<span id="id1"></span><h1>Add system to IPA Domain (ensure DNS is working correctly otherwise this step will fail)<a class="headerlink" href="#add-system-to-ipa-domain-ensure-dns-is-working-correctly-otherwise-this-step-will-fail" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-client-install -U -p admin -w mysecretpassword</span></code></p>
</section>
<section id="install-dovecot-and-set-service-to-start-on-boot">
<span id="id2"></span><h1>Install Dovecot and set service to start on boot<a class="headerlink" href="#install-dovecot-and-set-service-to-start-on-boot" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># yum install dovecot</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># chkconfig dovecot on</span></code></div>
</div>
</section>
<section id="edit-etc-dovecot-dovecot-conf-to-allow-imap">
<span id="edit-etcdovecotdovecot-conf-to-allow-imap"></span><h1>Edit /etc/dovecot/dovecot.conf to allow imap<a class="headerlink" href="#edit-etc-dovecot-dovecot-conf-to-allow-imap" title="Permalink to this heading">¶</a></h1>
<p>Find</p>
<p><code class="docutils literal notranslate"><span class="pre">#protocols = imap pop3 lmtp</span></code></p>
<p>and replace with</p>
<p><code class="docutils literal notranslate"><span class="pre">protocols = imap</span></code></p>
</section>
<section id="edit-etc-dovecot-conf-d-10-auth-conf-to-configure-kerberos-authentication">
<span id="edit-etcdovecotconf-d10-auth-conf-to-configure-kerberos-authentication"></span><h1>Edit /etc/dovecot/conf.d/10-auth.conf to configure kerberos authentication<a class="headerlink" href="#edit-etc-dovecot-conf-d-10-auth-conf-to-configure-kerberos-authentication" title="Permalink to this heading">¶</a></h1>
<p>Enter the below lines at the end of the file
/etc/dovecot/conf.d/10-auth.conf</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">userdb {</span></code></div>
<div class="line">``  driver = static``</div>
<div class="line">``  args = uid=dovecot gid=dovecot home=/var/spool/mail/%u``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">}</span></code></div>
</div>
<p>Next, find the below lines (these will be in various locations inside
the file)</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">auth_mechanisms = plain</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">#auth_gssapi_hostname =</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">#auth_krb5_keytab =</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">#auth_realms =</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">#auth_default_realm =</span></code></div>
</div>
<p>and replace with</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">auth_mechanisms = gssapi</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">auth_gssapi_hostname = mail01.example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">auth_krb5_keytab = /etc/dovecot/krb5.keytab</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">auth_realms = example.com</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">auth_default_realm = example.com</span></code></div>
</div>
</section>
<section id="create-new-ipa-group-for-mailbox-access">
<span id="id3"></span><h1>Create new IPA group for mailbox access<a class="headerlink" href="#create-new-ipa-group-for-mailbox-access" title="Permalink to this heading">¶</a></h1>
<p>From your IPA server, create a new group for your users to store their
mailbox</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">[root&#64;ds01 ~]# ipa group-add</span></code></div>
<div class="line">`` Group name: mailusers``</div>
<div class="line">`` Description: Mail User Group``</div>
<div class="line">`` ——————–``</div>
<div class="line">`` Added group “mailusers”``</div>
<div class="line">`` ——————–``</div>
<div class="line">`` Group name: mailusers``</div>
<div class="line">`` Description: Mail User Group``</div>
<div class="line">`` GID: 1427200003``</div>
<div class="line"><a href="#id4"><span class="problematic" id="id5">``</span></a>[<a class="reference external" href="mailto:root&#37;&#52;&#48;ds01">root<span>&#64;</span>ds01</a> ~]# ``</div>
</div>
</section>
<section id="add-users-to-mailusers-group">
<span id="id6"></span><h1>Add users to “mailusers” group<a class="headerlink" href="#add-users-to-mailusers-group" title="Permalink to this heading">¶</a></h1>
<p>Add your users to the new group</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">[root&#64;ds01 ~]# ipa group-add-member mailusers</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">[member user]: user1</span></code></div>
<div class="line"><a href="#id7"><span class="problematic" id="id8">``</span></a>[member group]: ``</div>
<div class="line">``  Group name: mailusers``</div>
<div class="line">``  Description: Mail User Group``</div>
<div class="line">``  GID: 1427200003``</div>
<div class="line">``  Member users: user1``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">-------------------------</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Number of members added 1</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">-------------------------</span></code></div>
<div class="line"><a href="#id9"><span class="problematic" id="id10">``</span></a>[<a class="reference external" href="mailto:root&#37;&#52;&#48;ds01">root<span>&#64;</span>ds01</a> ~]# ``</div>
</div>
</section>
<section id="create-new-directory-for-user-mailboxes">
<span id="id11"></span><h1>Create new directory for user mailboxes<a class="headerlink" href="#create-new-directory-for-user-mailboxes" title="Permalink to this heading">¶</a></h1>
<p>Create a new directory to be used as your mail store for the server.
Also remember to change the group membership to allow your “mailusers”
to be able to write to the folder.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">mkdir /mail</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">chmod 770 /mail</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">chgrp mailusers /mail</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">chcon -t user_home_t /mail</span></code></div>
</div>
<p>Note: If you wish to use file system quotas or add high availability to
your solution, having this folder on a shared file system would be very
beneficial.</p>
</section>
<section id="edit-etc-dovecot-conf-d-10-mail-conf-to-configure-the-mailbox-location">
<span id="edit-etcdovecotconf-d10-mail-conf-to-configure-the-mailbox-location"></span><h1>Edit /etc/dovecot/conf.d/10-mail.conf to configure the mailbox location<a class="headerlink" href="#edit-etc-dovecot-conf-d-10-mail-conf-to-configure-the-mailbox-location" title="Permalink to this heading">¶</a></h1>
<p>Find</p>
<p><code class="docutils literal notranslate"><span class="pre">#mail_location =</span></code></p>
<p>and replace with</p>
<p><code class="docutils literal notranslate"><span class="pre">mail_location = mbox:/mail/%u/:INBOX=/var/mail/%u</span></code></p>
</section>
<section id="generate-a-kerberos-keytab-for-dovecot-imap-access">
<span id="id12"></span><h1>Generate a kerberos keytab for Dovecot IMAP access<a class="headerlink" href="#generate-a-kerberos-keytab-for-dovecot-imap-access" title="Permalink to this heading">¶</a></h1>
<p>On the IPA server run:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit admin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Password for admin&#64;EXAMPLE.COM:</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa service-add imap/mail01.example.com</span></code></div>
</div>
<p>If successful, you will see the below output</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">----------------------------------------------------</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Added service &quot;imap/mail01.example.com&#64;EXAMPLE.COM&quot;</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">----------------------------------------------------</span></code></div>
<div class="line">``  Principal: <a class="reference external" href="mailto:imap/mail01&#46;example&#46;com&#37;&#52;&#48;EXAMPLE">imap/mail01<span>&#46;</span>example<span>&#46;</span>com<span>&#64;</span>EXAMPLE</a>.COM``</div>
<div class="line">``  Managed by: mail01.example.com``</div>
</div>
<p>On the Dovecot server run:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># kinit admin</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># ipa-getkeytab -s ds01.example.com -p imap/mail01.example.com -k /etc/dovecot/krb5.keytab</span></code></div>
</div>
<p>if successful, you will see the below output:</p>
<p><code class="docutils literal notranslate"><span class="pre">Keytab successfully retrieved and stored in: /etc/dovecot/krb5.keytab</span></code></p>
</section>
<section id="change-the-permissions-of-the-keytab-to-allow-dovecot-to-read-the-file-note-this-should-be-kept-secure-so-only-grant-enough-privileges-as-absolutely-necessary">
<span id="id13"></span><h1>Change the permissions of the keytab to allow Dovecot to read the file (Note, this should be kept secure, so only grant enough privileges as absolutely necessary.)<a class="headerlink" href="#change-the-permissions-of-the-keytab-to-allow-dovecot-to-read-the-file-note-this-should-be-kept-secure-so-only-grant-enough-privileges-as-absolutely-necessary" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># chown root:dovecot /etc/dovecot/krb5.keytab</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># chmod 640 /etc/dovecot/krb5.keytab</span></code></div>
</div>
</section>
<section id="restart-dovecot">
<span id="id14"></span><h1>Restart Dovecot<a class="headerlink" href="#restart-dovecot" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># service dovecot restart</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Stopping Dovecot IMAP: ................                           [  OK  ]</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Starting Dovecot IMAP: .                                          [  OK  ]</span></code></div>
</div>
</section>
<section id="send-a-test-email-to-your-user">
<span id="id15"></span><h1>Send a test email to your user<a class="headerlink" href="#send-a-test-email-to-your-user" title="Permalink to this heading">¶</a></h1>
<p>From your Dovecot server, run the following command:</p>
<p><code class="docutils literal notranslate"><span class="pre"># echo Hello | mail -s Hello user1&#64;example.com</span></code></p>
</section>
<section id="configure-thunderbird-to-connect-to-imap-server">
<span id="id16"></span><h1>Configure Thunderbird to connect to IMAP Server<a class="headerlink" href="#configure-thunderbird-to-connect-to-imap-server" title="Permalink to this heading">¶</a></h1>
<ol class="arabic simple">
<li><p>Open Thunderbird</p></li>
<li><p>Click the Edit Menu and select Account Settings</p></li>
<li><p>Under Account Actions (Bottom left), select “Add Mail Account”</p></li>
<li><p>Enter Name (user1), Email Address(<a class="reference external" href="mailto:user1&#37;&#52;&#48;example&#46;com">user1<span>&#64;</span>example<span>&#46;</span>com</a>) and leave
password blank, then click continue</p></li>
<li><p>Verify the username is user1 (not <a class="reference external" href="mailto:user1&#37;&#52;&#48;example&#46;com">user1<span>&#64;</span>example<span>&#46;</span>com</a>, Set the imcoming
server to mail01.example.com, select IMAP, Set port to 993, and
select SSL/TLS. Then click Manual Setup</p></li>
<li><p>Select Server Settings under your new mail account</p></li>
<li><p>Select Kerberos/GSSAPI as the Authentication Method, then click OK</p></li>
<li><p>Click Get Mail and you will be presented to accept an SSL
Certificate.</p></li>
<li><p>Once you have accepted the SSL Certificate, you will see your test
email you sent in the previous step.</p></li>
</ol>
</section>
<section id="verify-your-authentication-on-the-dovecot-server">
<span id="id17"></span><h1>Verify your authentication on the Dovecot server<a class="headerlink" href="#verify-your-authentication-on-the-dovecot-server" title="Permalink to this heading">¶</a></h1>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># tail /var/log/maillog</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Feb 10 13:31:22 mail01 dovecot: imap-login: Login: user=&lt;user1&#64;example.com&gt;, method=GSSAPI, rip=192.168.122.51, lip=192.168.122.63, mpid=1835, TLS</span></code></div>
</div>
<p>If everything has worked successfully, you will see in your logs that
your user has connected using the method GSSAPI and has validated their
session over TLS.</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/Dovecot_IMAPS_Integration_with_FreeIPA_using_Single_Sign_On.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
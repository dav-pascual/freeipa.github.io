<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Description &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="ISC_DHCPd_and_Dynamic_DNS_update.html" />
    <link rel="prev" title="Short feature description" href="IPA_locations.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="description">
<h1>Description<a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h1>
<p>This page explains how to setup and configure a KRA to an IPA server
installed with a <a class="reference external" href="http://pki.fedoraproject.org">Dogtag</a> CA. A KRA is
used for key escrow and recovery. This is also referred to as the Data
Recovery Manager (DRM).</p>
<p><strong>NOTE</strong>: This is being developed as a Proof-of-Concept.</p>
</section>
<section id="prerequisites">
<h1>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>Fedora 18</p></li>
<li><p>ipa-server 3.1.4</p></li>
<li><p>pki-core 10.0.3</p></li>
</ul>
<p>This procedure is only tested to work with the above versions</p>
</section>
<section id="install-and-configure-ipa-server">
<span id="id1"></span><h1>Install and configure IPA server<a class="headerlink" href="#install-and-configure-ipa-server" title="Permalink to this heading">¶</a></h1>
<section id="make-sure-all-packages-are-up-to-date">
<span id="id2"></span><h2>Make sure all packages are up to date<a class="headerlink" href="#make-sure-all-packages-are-up-to-date" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre"># yum update -y</span></code></p>
</section>
<section id="install-required-packages">
<span id="id3"></span><h2>Install required packages<a class="headerlink" href="#install-required-packages" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre"># yum install -y freeipa-server bind bind-dyndb-ldap pki-kra</span></code></p>
</section>
<section id="install-ipa-server">
<span id="id4"></span><h2>Install IPA server<a class="headerlink" href="#install-ipa-server" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre"># ipa-server-install -a mypassword1 -p mypassword2 --domain=</span></code><em>``ipa_domain``</em>`` –realm=``<em>``IPA_DOMAIN``</em>`` –setup-dns –no-forwarders -U``</p>
<p><strong>NOTE</strong>: This configures IPA with its own DNS server. This is not an
absolute requirement.</p>
</section>
</section>
<section id="install-the-kra">
<span id="id5"></span><h1>Install the KRA<a class="headerlink" href="#install-the-kra" title="Permalink to this heading">¶</a></h1>
<section id="create-kra-installation-configuration-file">
<span id="id6"></span><h2>Create KRA installation configuration file<a class="headerlink" href="#create-kra-installation-configuration-file" title="Permalink to this heading">¶</a></h2>
<p>Create a file with these contents somewhere in your filesystem. It is
only needed during installation of the KRA.</p>
<p>Replace the password, host name and realm names as appropriate to your
installation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">KRA</span><span class="p">]</span>
<span class="n">pki_security_domain_https_port</span><span class="o">=</span><span class="mi">443</span>
<span class="n">pki_security_domain_password</span><span class="o">=</span> <span class="n">mypassword2</span>
<span class="n">pki_security_domain_user</span><span class="o">=</span><span class="n">admin</span>
<span class="n">pki_enable_proxy</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pki_restart_configured_instance</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">pki_backup_keys</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pki_backup_password</span> <span class="o">=</span> <span class="n">mypassword2</span>
<span class="n">pki_client_database_dir</span> <span class="o">=</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">tmp</span><span class="o">-</span><span class="n">ce2oQN</span>
<span class="n">pki_client_database_password</span> <span class="o">=</span> <span class="n">mypassword2</span>
<span class="n">pki_client_database_purge</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">pki_client_pkcs12_password</span> <span class="o">=</span> <span class="n">mypassword2</span>
<span class="n">pki_admin_name</span> <span class="o">=</span> <span class="n">admin</span>
<span class="n">pki_admin_uid</span> <span class="o">=</span> <span class="n">admin</span>
<span class="n">pki_admin_email</span> <span class="o">=</span> <span class="n">root</span><span class="nd">@localhost</span>
<span class="n">pki_admin_password</span> <span class="o">=</span> <span class="n">mypassword2</span>
<span class="n">pki_admin_nickname</span> <span class="o">=</span> <span class="n">ipa</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">agent</span>
<span class="n">pki_admin_subject_dn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">=</span><span class="n">ipa</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">agent</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">pki_import_admin_cert</span><span class="o">=</span><span class="kc">True</span>
<span class="n">pki_admin_cert_file</span><span class="o">=/</span><span class="n">root</span><span class="o">/.</span><span class="n">dogtag</span><span class="o">/</span><span class="n">pki</span><span class="o">-</span><span class="n">tomcat</span><span class="o">/</span><span class="n">ca_admin</span><span class="o">.</span><span class="n">cert</span>
<span class="n">pki_client_admin_cert_p12</span> <span class="o">=</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ca</span><span class="o">-</span><span class="n">agent</span><span class="o">.</span><span class="n">p12</span>
<span class="n">pki_ds_ldap_port</span> <span class="o">=</span> <span class="mi">389</span>
<span class="n">pki_ds_password</span> <span class="o">=</span> <span class="n">mypassword2</span>
<span class="n">pki_ds_base_dn</span> <span class="o">=</span> <span class="n">o</span><span class="o">=</span><span class="n">ipakra</span>
<span class="n">pki_ds_database</span> <span class="o">=</span> <span class="n">ipakra</span>
<span class="n">pki_storage_subject_dn</span><span class="o">=</span><span class="n">cn</span><span class="o">=</span><span class="n">DRM</span> <span class="n">Storage</span> <span class="n">Certificate</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">pki_transport_subject_dn</span><span class="o">=</span><span class="n">cn</span><span class="o">=</span><span class="n">DRM</span> <span class="n">Transport</span> <span class="n">Certificate</span><span class="p">,</span><span class="n">o</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">pki_subsystem_subject_dn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">=</span><span class="n">DRM</span> <span class="n">Subsystem</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">pki_ssl_server_subject_dn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">=</span><span class="n">ipa</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">pki_audit_signing_subject_dn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">=</span><span class="n">DRM</span> <span class="n">Audit</span><span class="p">,</span><span class="n">O</span><span class="o">=</span><span class="n">EXAMPLE</span><span class="o">.</span><span class="n">COM</span>
<span class="n">pki_subsystem_nickname</span> <span class="o">=</span> <span class="n">subsystemCert</span> <span class="n">cert</span><span class="o">-</span><span class="n">pki</span><span class="o">-</span><span class="n">kra</span>
<span class="n">pki_ssl_server_nickname</span> <span class="o">=</span> <span class="n">Server</span><span class="o">-</span><span class="n">Cert</span> <span class="n">cert</span><span class="o">-</span><span class="n">pki</span><span class="o">-</span><span class="n">ca</span>
<span class="n">pki_audit_signing_nickname</span> <span class="o">=</span> <span class="n">auditSigningCert</span> <span class="n">cert</span><span class="o">-</span><span class="n">pki</span><span class="o">-</span><span class="n">kra</span>
<span class="n">pki_storage_nickname</span><span class="o">=</span><span class="n">storageCert</span> <span class="n">cert</span><span class="o">-</span><span class="n">pki</span><span class="o">-</span><span class="n">kra</span>
<span class="n">pki_transport_nickname</span><span class="o">=</span><span class="n">transportCert</span> <span class="n">cert</span><span class="o">-</span><span class="n">pki</span><span class="o">-</span><span class="n">kra</span>
</pre></div>
</div>
</section>
<section id="update-ipa-proxy-configuration">
<span id="id7"></span><h2>Update IPA proxy configuration<a class="headerlink" href="#update-ipa-proxy-configuration" title="Permalink to this heading">¶</a></h2>
<p>Replace /etc/httpd/conf.d/ipa-pki-proxy.conf with this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># VERSION 3 - DO NOT REMOVE THIS LINE</span>

<span class="n">ProxyRequests</span> <span class="n">Off</span>

<span class="c1"># matches for ee port</span>
<span class="o">&lt;</span><span class="n">LocationMatch</span> <span class="s2">&quot;^/ca/ee/ca/checkRequest|^/ca/ee/ca/getCertChain|^/ca/ee/ca/getTokenInfo|^/ca/ee/ca/profileSubmit|^/ca/ee/ca/tokenAuthenticate|^/ca/ocsp|^/ca/ee/ca/updateNumberRange|^/ca/ee/ca/getCRL&quot;</span><span class="o">&gt;</span>
    <span class="n">NSSOptions</span> <span class="o">+</span><span class="n">StdEnvVars</span> <span class="o">+</span><span class="n">ExportCertData</span> <span class="o">+</span><span class="n">StrictRequire</span> <span class="o">+</span><span class="n">OptRenegotiate</span>
    <span class="n">NSSVerifyClient</span> <span class="n">none</span>
    <span class="n">ProxyPassMatch</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
    <span class="n">ProxyPassReverse</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
<span class="o">&lt;/</span><span class="n">LocationMatch</span><span class="o">&gt;</span>

<span class="c1"># matches for admin port and installer</span>
<span class="o">&lt;</span><span class="n">LocationMatch</span> <span class="s2">&quot;^/ca/admin/ca/getCertChain|^/ca/admin/ca/getConfigEntries|^/ca/admin/ca/getCookie|^/ca/admin/ca/getStatus|^/ca/admin/ca/getSubsystemCert|^/ca/admin/ca/securityDomainLogin|^/ca/admin/ca/getDomainXML|^/ca/rest/installer/installToken|^/ca/admin/ca/updateNumberRange|^/ca/rest/securityDomain/domainInfo|^/ca/rest/account/login|^/ca/admin/ca/tokenAuthenticate|^/ca/admin/ca/updateConnector|^/ca/admin/ca/updateNumberRange|^/ca/admin/ca/updateDomainXML|^/ca/rest/account/logout|^/ca/rest/securityDomain/installToken&quot;</span><span class="o">&gt;</span>
    <span class="n">NSSOptions</span> <span class="o">+</span><span class="n">StdEnvVars</span> <span class="o">+</span><span class="n">ExportCertData</span> <span class="o">+</span><span class="n">StrictRequire</span> <span class="o">+</span><span class="n">OptRenegotiate</span>
    <span class="n">NSSVerifyClient</span> <span class="n">none</span>
    <span class="n">ProxyPassMatch</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
    <span class="n">ProxyPassReverse</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
<span class="o">&lt;/</span><span class="n">LocationMatch</span><span class="o">&gt;</span>

<span class="c1"># matches for agent port and eeca port</span>
<span class="o">&lt;</span><span class="n">LocationMatch</span> <span class="s2">&quot;^/ca/agent/ca/displayBySerial|^/ca/agent/ca/doRevoke|^/ca/agent/ca/doUnrevoke|^/ca/agent/ca/updateDomainXML|^/ca/eeca/ca/profileSubmitSSLClient&quot;</span><span class="o">&gt;</span>
    <span class="n">NSSOptions</span> <span class="o">+</span><span class="n">StdEnvVars</span> <span class="o">+</span><span class="n">ExportCertData</span> <span class="o">+</span><span class="n">StrictRequire</span> <span class="o">+</span><span class="n">OptRenegotiate</span>
    <span class="n">NSSVerifyClient</span> <span class="n">require</span>
    <span class="n">ProxyPassMatch</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
    <span class="n">ProxyPassReverse</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
<span class="o">&lt;/</span><span class="n">LocationMatch</span><span class="o">&gt;</span>

<span class="c1"># Only enable this on servers that are not generating a CRL</span>
<span class="c1">#RewriteRule ^/ipa/crl/MasterCRL.bin https://dart.greyoak.com/ca/ee/ca/getCRL?op=getCRL&amp;crlIssuingPoint=MasterCRL [L,R=301,NC]</span>

<span class="o">&lt;</span><span class="n">LocationMatch</span> <span class="s2">&quot;^/kra/agent/kra/connector&quot;</span><span class="o">&gt;</span>
    <span class="n">NSSOptions</span> <span class="o">+</span><span class="n">StdEnvVars</span> <span class="o">+</span><span class="n">ExportCertData</span> <span class="o">+</span><span class="n">StrictRequire</span> <span class="o">+</span><span class="n">OptRenegotiate</span>
    <span class="n">NSSVerifyClient</span> <span class="n">require</span>
    <span class="n">ProxyPassMatch</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
    <span class="n">ProxyPassReverse</span> <span class="n">ajp</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8009</span>
<span class="o">&lt;/</span><span class="n">LocationMatch</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
<section id="restart-httpd">
<span id="id8"></span><h2>Restart httpd<a class="headerlink" href="#restart-httpd" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre"># systemctl restart httpd.service</span></code></p>
</section>
<section id="add-the-kra">
<span id="id9"></span><h2>Add the KRA<a class="headerlink" href="#add-the-kra" title="Permalink to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre"># pkispawn -s KRA -f /path/to/kra.cfg</span></code></p>
</section>
</section>
<section id="restart-tomcat">
<span id="id10"></span><h1>Restart Tomcat<a class="headerlink" href="#restart-tomcat" title="Permalink to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre"># systemctl restart pki-tomcatd&#64;pki-tomcat.service</span></code></p>
</section>
<section id="configure-a-browser-for-kra-adminisrtrative-work">
<span id="id11"></span><h1>Configure a browser for KRA adminisrtrative work<a class="headerlink" href="#configure-a-browser-for-kra-adminisrtrative-work" title="Permalink to this heading">¶</a></h1>
<section id="copy-the-agent-pkcs-12-file">
<span id="copy-the-agent-pkcs12-file"></span><h2>Copy the Agent PKCS#12 file<a class="headerlink" href="#copy-the-agent-pkcs-12-file" title="Permalink to this heading">¶</a></h2>
<p>The PKCS#12 file that contains the IPA RA agent that we’ll use to do the
KRA work is in /root/ca-agent.p12. Copy this to your client machine, or
to a location on the server that is readable by the user you want to run
Firefox. Fix permissions as needed.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre"># cp /root/ca-agent.p12 /home/someuser</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre"># chown someuser /home/someuser/ca-agent.p12</span></code></div>
</div>
</section>
<section id="import-the-cert">
<span id="id12"></span><h2>Import the cert<a class="headerlink" href="#import-the-cert" title="Permalink to this heading">¶</a></h2>
<p>Start Firefox and select Edit -&gt; Preferences -&gt; Advanced -&gt; Encryption
-&gt; View Certificates</p>
<p>select Import</p>
<p>Enter the path to ca-agent.p12</p>
<p>Enter the PKCS#12 password (the Directory manager password, mypassword2
in the example)</p>
</section>
<section id="test-the-cert">
<span id="id13"></span><h2>Test the cert<a class="headerlink" href="#test-the-cert" title="Permalink to this heading">¶</a></h2>
<p>We will be using the CA directly as opposed to going through the IPA
GUI.</p>
<p>Browse to <a class="reference external" href="https://ipa.example.com:8443/">https://ipa.example.com:8443/</a></p>
<p>You may be prompted to trust the CA. You can import it directly by
instead by going to <a class="reference external" href="http://ipa.example.com/ipa/config/ca.crt">http://ipa.example.com/ipa/config/ca.crt</a></p>
<p>Select Agent Services and you should be prompted to select a client
certificate to use. If you imported the certificate correctly then
selecting it and clicking Ok should display the CA agent page.</p>
</section>
<section id="issue-and-recover-a-certificate">
<span id="id14"></span><h2>Issue and Recover a Certificate<a class="headerlink" href="#issue-and-recover-a-certificate" title="Permalink to this heading">¶</a></h2>
<p>There are further instructions for testing the KRA at
<a class="reference external" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Certificate_System/8.1/html/Admin_Guide/Testing_the_Key_Archival_and_Recovery_Setup.html">https://access.redhat.com/site/documentation/en-US/Red_Hat_Certificate_System/8.1/html/Admin_Guide/Testing_the_Key_Archival_and_Recovery_Setup.html</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/Howto/IPAv3_Add_a_KRA.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
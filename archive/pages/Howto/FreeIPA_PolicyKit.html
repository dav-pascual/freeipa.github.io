<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Howto/FreeIPA and PolicyKit &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="IPA with integrated BIND inside chroot" href="FreeIPA_with_integrated_BIND_inside_chroot.html" />
    <link rel="prev" title="Affected systems" href="Dogtag9ToDogtag10Migration.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="howto-freeipa-and-policykit">
<span id="howtofreeipa-and-policykit"></span><h1>Howto/FreeIPA and PolicyKit<a class="headerlink" href="#howto-freeipa-and-policykit" title="Permalink to this heading">¶</a></h1>
<p>Making PolicyKit recognize certain FreeIPA user as administrator on
local system requires following simple step
(<a class="reference external" href="https://fedorahosted.org/freeipa/ticket/3203">https://fedorahosted.org/freeipa/ticket/3203</a>), until more advanced
solution is provided, see <a class="reference external" href="https://fedorahosted.org/freeipa/ticket/5350">https://fedorahosted.org/freeipa/ticket/5350</a>:</p>
<ul class="simple">
<li><p>create file called 40-freeipa.rules in /etc/polkit-1/rules.d/ with
contents:</p></li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">polkit.addAdminRule(function(action, subject) {</span></code></div>
<div class="line">``    return [“unix-group:admins”, “unix-group:wheel”];``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">});</span></code></div>
</div>
<ul class="simple">
<li><p>(optional) make sure that file has at least 644 permissions (I’m
using default umask 077 and that caused me a bit of delay to make it
work)</p></li>
<li><p>(alternate approach would be) to use password-less access, fill the
same file with this contents instead:</p></li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">polkit.addRule(function(action, subject) {</span></code></div>
<div class="line">``    if (action.id == “org.freedesktop.policykit.exec” &amp;&amp;``</div>
<div class="line">``        subject.isInGroup(“admins”)) {``</div>
<div class="line">``        return polkit.Result.YES;``</div>
<div class="line">``    }``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">});</span></code></div>
</div>
<p>where ‘wheel’ is default local ‘administrative’ group on RHEL-based
systems (‘adm’ on Debian-based systems, I think) and admins is default
‘administrative’ group in FreeIPA. Without this custom rule
polkit/pkexec/… will be asking for password of root account, if there
is no user in local wheel group. If there is (I’m using 1 local
administrative account in case something with FreeIPA goes wrong), it
will be asking for that user(s) password instead, not involving root
user at all.</p>
<p>So, to sum up, step above turns this:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ id</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">uid=1293400001(ipauser) gid=1293400001(ipauser) groups=1293400001(ipauser),1293400000(admins) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ pkexec id</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">==== AUTHENTICATING FOR org.freedesktop.policykit.exec ===</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Authentication is needed to run `/usr/bin/id' as the super user</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Authenticating as: root</span></code></div>
<div class="line"><a href="#id1"><span class="problematic" id="id2">``</span></a>Password: ``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">==== AUTHENTICATION COMPLETE ===</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></code></div>
</div>
<p>or this:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ id</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">uid=1293400001(ipauser) gid=1293400001(ipauser) groups=1293400001(ipauser),1293400000(admins) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ pkexec id</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">==== AUTHENTICATING FOR org.freedesktop.policykit.exec ===</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Authentication is needed to run `/usr/bin/id' as the super user</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Authenticating as: SysAdmin (sysadmin)</span></code></div>
<div class="line"><a href="#id3"><span class="problematic" id="id4">``</span></a>Password: ``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">==== AUTHENTICATION COMPLETE ===</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></code></div>
</div>
<p>into this:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ id</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">uid=1293400001(ipauser) gid=1293400001(ipauser) groups=1293400001(ipauser),1293400000(admins) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ pkexec id</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">==== AUTHENTICATING FOR org.freedesktop.policykit.exec ===</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Authentication is needed to run `/usr/bin/id' as the super user</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Multiple identities can be used for authentication:</span></code></div>
<div class="line">`` 1. SysAdmin (sysadmin)  ``</div>
<div class="line">`` 2. Administrator (admin)``</div>
<div class="line">`` 3. IPA User (ipauser)``</div>
<div class="line">`` …``</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Choose identity to authenticate as (1-X): 3</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">Password:</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">==== AUTHENTICATION COMPLETE ===</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></code></div>
</div>
<p>It works also for graphical user interfaces (GNOME Shell in my case),
etc. Only when it comes to that GNOME Shell, user is shown as ‘Standard’
and not as ‘Administrator’ in Settings -&gt; Users.</p>
<section id="hbac-rule">
<span id="id5"></span><h2>HBAC Rule<a class="headerlink" href="#hbac-rule" title="Permalink to this heading">¶</a></h2>
<p>If FreeIPA has not been configured to <em>allow_all</em> for any service on any
host, you will have to add a HBAC Service named <strong>polkit-1</strong>, if this
does not already exist, and create an appropriate HBAC rule for users
accessing hosts with the above rule definition via the polkit-1 service.</p>
<p>Symptoms requiring this HBAC Rule include when running;</p>
<p><code class="docutils literal notranslate"><span class="pre">$ pkexec id</span></code></p>
<p>resulting in log messages such as;</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">$ journalctl -xe</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">...</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">polkit-agent-helper[3130]: pam_sss(polkit-1:account): Access denied for user ``\</span> <span class="pre">``: 6 (Permission denied)</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">...</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">gnome-shell.desktop[2372]: polkit-agent-helper-1: pam_acct_mgmt failed: Permission denied</span></code></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/Howto/FreeIPA_PolicyKit.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="IpaArchitectureV2.html" />
    <link rel="prev" title="Overview" href="Integration_testing_configuration.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>To support SELinux as an application the IPA shall have several
different kinds of plug-ins implemented. This article talks about these
plug-ins from the prospective of FreeIPA v2 plans.</p>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>We agreed that SELinux application would heavily leverage the policy
engine, role engine and pluggable PAM responder. The fact that PAM
responder is not planned to be pluggable in v2 complicates things a bit.
We agreed that we will hard code SELinux related functionality in PAM
responder in v2 and refactor it into a sepaFreeIPAv2:rate plug-in in v3
time frame.</p>
<section id="policy-engine">
<span id="id1"></span><h2>Policy Engine<a class="headerlink" href="#policy-engine" title="Permalink to this heading">¶</a></h2>
<p>So far we have identified three different areas where the IPA policy
engine can help to manage a large number of hosts running SELinux.</p>
<ul class="simple">
<li><p>download, install or remove SELinux policy modules</p></li>
<li><p>configure SELinux policy modules via SELinux policy booleans</p></li>
<li><p>manage the relation of Linux users to SELinux users (role
management?)</p></li>
</ul>
<p>These three areas map well to the policy section, action, configuration
and role respectively, we have identified. See <a class="reference external" href="FreeIPAv2:Overall_Design_of_Policy_Related_Components">FreeIPAv2:Overall Design
of Policy Related
Components</a>
for more details.</p>
<section id="download-install-or-remove-selinux-policy-modules-with-ipa-action-policy">
<span id="id2"></span><h3>Download, install or remove SELinux policy modules with IPA action policy<a class="headerlink" href="#download-install-or-remove-selinux-policy-modules-with-ipa-action-policy" title="Permalink to this heading">¶</a></h3>
<p>An IPA action policy has three parts, , and (see <a class="reference external" href="FreeIPAv2:Overall_Design_of_Policy_Related_Components">FreeIPAv2:Overall
Design of Policy Related
Components</a>
for more details). In the context of SELinux we can for example check
with the if SELinux is enabled at all and if yes download a SELinux
policy module and install it. The main section of a corresponding IPA
policy file might look like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ipaaction</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;/</span><span class="nb">bin</span><span class="o">/</span><span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">redhat</span><span class="o">-</span><span class="n">release</span><span class="o">&lt;/</span><span class="n">command</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">expected_output</span><span class="o">&gt;</span><span class="n">Fedora</span> <span class="n">release</span> <span class="mi">9</span> <span class="p">(</span><span class="n">Sulphur</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">expected_output</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">condition</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">my</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">my_selinux_policy</span><span class="o">.</span><span class="n">pp</span><span class="o">&lt;/</span><span class="n">url</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">path</span><span class="o">&gt;/</span><span class="n">tmp</span><span class="o">/</span><span class="n">my_selinux_policy</span><span class="o">.</span><span class="n">pp</span><span class="o">&lt;/</span><span class="n">path</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">owner</span><span class="o">&gt;</span><span class="n">root</span><span class="o">&lt;/</span><span class="n">owner</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">group</span><span class="o">&gt;</span><span class="n">root</span><span class="o">&lt;/</span><span class="n">group</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">access</span><span class="o">&gt;</span><span class="mi">0400</span><span class="o">&lt;/</span><span class="n">access</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">cleanup</span><span class="o">&gt;</span><span class="n">yes</span><span class="o">&lt;/</span><span class="n">cleanup</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">file</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">run</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">command</span><span class="o">&gt;/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">semodule</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">my_selinux_policy</span><span class="o">.</span><span class="n">pp</span><span class="o">&lt;/</span><span class="n">command</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">user</span><span class="o">&gt;</span><span class="n">root</span><span class="o">&lt;/</span><span class="n">user</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">run</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ipaaction</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This example shows how to download the binary SELinux policy module and
calling semodule to install it.</p>
<section id="xslt-processing">
<span id="id3"></span><h4>XSLT Processing<a class="headerlink" href="#xslt-processing" title="Permalink to this heading">¶</a></h4>
<p>This IPA action policy will be processed as any other IPA action policy.</p>
</section>
</section>
<section id="configure-selinux-policy-modules-via-selinux-policy-booleans-with-ipa-config-policy">
<span id="id4"></span><h3>Configure SELinux policy modules via SELinux policy booleans with IPA config policy<a class="headerlink" href="#configure-selinux-policy-modules-via-selinux-policy-booleans-with-ipa-config-policy" title="Permalink to this heading">¶</a></h3>
<p>SELinux policies can include conditional section to allow runtime
modification without having to load a new policy. These conditional
sections can be enable or disabled with the help of SELinux policy
booleans.</p>
<p>SELinux policy booleans are simple boolean variable which can be
manipulated with semanage or get/set/togglesebool. Call ‘semanage
boolean -l’ to get a list and a short description of all SELinux policy
booleans currently know to the system.</p>
<p>To make the SELinux policy booleans accessible to IPA a configuration
policy, selinux_booleans, is used. The main section of an IPA XML policy
file may look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">ipaconfig</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">selinux_boolean</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">webadm_manage_user_files</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">true</span><span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">selinux_boolean</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">selinux_boolean</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">ssh_sysadm_login</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="n">false</span><span class="o">&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">selinux_boolean</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ipaconfig</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="xslt-processing-1">
<span id="id5"></span><h4>XSLT Processing<a class="headerlink" href="#xslt-processing-1" title="Permalink to this heading">¶</a></h4>
<p>With the help of a XSL template the IPA config policy will be
transformed to a format suitable as a command line argument for
setseboot. The policy downloader will than call setsebool with the
result as defined by XSL metadata</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">md</span><span class="p">:</span><span class="n">output_handler</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">exec_with_args</span> <span class="n">command_name</span><span class="o">=</span><span class="s2">&quot;/usr/sbin/setsebool&quot;</span> <span class="n">user</span><span class="o">=</span><span class="s2">&quot;root&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">md</span><span class="p">:</span><span class="n">output_handler</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="manage-the-relation-of-linux-users-to-selinux-users-with-ipa-role-policy">
<span id="id6"></span><h3>Manage the relation of Linux users to SELinux users with IPA role policy<a class="headerlink" href="#manage-the-relation-of-linux-users-to-selinux-users-with-ipa-role-policy" title="Permalink to this heading">¶</a></h3>
<p>To give or take certain privileges to/from a user with the help of
SELinux we have to connect three SELinux element, namely</p>
<ul class="simple">
<li><p>the Linux user, e.g. luser</p></li>
<li><p>the SELinux user, e.g. seuser_u</p></li>
<li><p>the SELinux role, e.g. serole_r</p></li>
</ul>
<p>(It is a widespread convention to use suffix _u for SELinux users and
_r for SELinux roles.)</p>
<p>SELinux roles are defined by the SELinux policy or SELinux policy
modules. SELinux users can be connected to SELinux role with semanage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">semanage</span> <span class="n">user</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">R</span> <span class="s2">&quot;serole_r guest_r&quot;</span> <span class="n">seuser_u</span>
</pre></div>
</div>
<p>Linux user can mapped to SELinux user with semanage, too.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">semanage</span> <span class="n">login</span> <span class="o">-</span><span class="n">s</span> <span class="n">seuser_u</span> <span class="n">luser</span>
</pre></div>
</div>
<p>While the relation of SELinux users to roles should be created when the
corresponding SELinux policy modules is installed (see above), the
management of Linux users and SELinux users can be handled by IPA
policies. The simple mapping of a Linux user to a SELinux user can be
done with the help of an IPA action policy or using role defintion
policy. We will concentrate here an a role based approach where a Linux
user can be mapped with the help of pam_selinux to different SELinux
users depending if he logs in via an insecure, e.g. telnet, or secure,
e.g. console login, channel. The following IPA role definition policy
specifies three roles: “guest”, “user” and “admin”, with different
settings. Users which have the “guest” role on a specific host will
always associated with guest_u, independent of the channel they are
using to access the host. If a user logs in via ssh and is associated to
the admin role he will be mapped to staff_u.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">iparole</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">role</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">guest</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">default_context</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">selinux_user</span><span class="o">&gt;</span><span class="n">guest_u</span><span class="o">&lt;/</span><span class="n">selinux_user</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mls</span><span class="o">&gt;</span><span class="n">S0</span><span class="o">&lt;/</span><span class="n">mls</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">default_context</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">role</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="n">role</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">user</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">default_context</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">selinux_user</span><span class="o">&gt;</span><span class="n">guest_u</span><span class="o">&lt;/</span><span class="n">selinux_user</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mls</span><span class="o">&gt;</span><span class="n">S0</span><span class="o">&lt;/</span><span class="n">mls</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">default_context</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">service</span><span class="o">&gt;</span><span class="n">ssh</span><span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">service</span><span class="o">&gt;</span><span class="n">console</span><span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">selinux_user</span><span class="o">&gt;</span><span class="n">user_u</span><span class="o">&lt;/</span><span class="n">selinux_user</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mls</span><span class="o">&gt;</span><span class="n">S0</span><span class="o">&lt;/</span><span class="n">mls</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">context</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">role</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="n">role</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">admin</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">default_context</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">selinux_user</span><span class="o">&gt;</span><span class="n">guest_u</span><span class="o">&lt;/</span><span class="n">selinux_user</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mls</span><span class="o">&gt;</span><span class="n">S0</span><span class="o">&lt;/</span><span class="n">mls</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">default_context</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">service</span><span class="o">&gt;</span><span class="n">ssh</span><span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">selinux_user</span><span class="o">&gt;</span><span class="n">staff_u</span><span class="o">&lt;/</span><span class="n">selinux_user</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mls</span><span class="o">&gt;</span><span class="n">S0</span><span class="o">&lt;/</span><span class="n">mls</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">context</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">service</span><span class="o">&gt;</span><span class="n">login</span><span class="o">&lt;/</span><span class="n">service</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">selinux_user</span><span class="o">&gt;</span><span class="n">staff_u</span><span class="o">&lt;/</span><span class="n">selinux_user</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mls</span><span class="o">&gt;</span><span class="n">S0</span><span class="o">-</span><span class="n">S15</span><span class="o">&lt;/</span><span class="n">mls</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">context</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">role</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">iparole</span><span class="o">&gt;</span>
</pre></div>
</div>
<section id="xslt-processing-2">
<span id="id7"></span><h4>XSLT Processing<a class="headerlink" href="#xslt-processing-2" title="Permalink to this heading">¶</a></h4>
<p>The IPA role policy will be transformed to an LDIF format and written
into the LDB of the IPA client. Further processing has to be done
elsewhere, because the XSLT engine has no knowledge of the
user-host-role association.</p>
</section>
<section id="pam-ipa-and-pam-responder">
<span id="id8"></span><h4>pam_ipa and PAM Responder<a class="headerlink" href="#pam-ipa-and-pam-responder" title="Permalink to this heading">¶</a></h4>
<p>All the work for the pam_ipa is actually done in the PAM responder. At
the login moment the PAM responder will implement a specific SELinux
logic. Later in v3 it will be replaced with a proper plug-in. The IPA’s
PAM module will be higher in the stack than pam_selinux and will prepare
information for it to consume.</p>
<p>This logic will follow the following algorithm:</p>
<ul class="simple">
<li><p>If the user logging in is not known to IPA, e.g. a local account,
return PAM_USER_UNKNOWN and let the the following PAM modules decide</p></li>
<li><p>Get IPA pam_selinux role for user logging into the machine (this is
done via same internal calls as used to satisfy requests from EXT
library).</p></li>
<li><p>If there is no role for the user return PAM_USER_UNKNOWN and let the
the following PAM modules decide (maybe it would make sense to have
an configurable switch to force role association on certain host, in
this case PAM_AUTH_ERR/PAM_ABORT can be returned).</p></li>
<li><p>Get IPA pam_selinux role definition from the LDB (or other file if we
decide it is better to use a different storage)</p></li>
<li><p>Create a file for this user in the following format:</p></li>
</ul>
<p>``   <code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``:</span></code><code class="docutils literal notranslate"><span class="pre">:</span></code></p>
<p>with the example above it would look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">guest_u</span><span class="p">:</span><span class="o">*</span><span class="p">:</span><span class="n">S0</span>
<span class="n">staff_u</span><span class="p">:</span><span class="n">ssh</span><span class="p">:</span><span class="n">S0</span>
<span class="n">staff_u</span><span class="p">:</span><span class="n">login</span><span class="p">:</span><span class="n">S0</span><span class="o">-</span><span class="n">S15</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Put this file into</p></li>
</ul>
<p>``   /etc/SELinux/targeted/login/<code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``/seusers</span></code></p>
</section>
<section id="pam-selinux">
<h4>pam_selinux<a class="headerlink" href="#pam-selinux" title="Permalink to this heading">¶</a></h4>
<p>The current version of pam_selinux will only use
/etc/selinux/targeted/seusers but coming version of SELinux PAM will be
modified to look for</p>
<p>``   /etc/selinux/targeted/logins/<code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">``/seusers</span></code></p>
<p>file before falling back to default</p>
<p>``   /etc/selinux/targeted/seusers``</p>
<p>If there is no seusers file under specific user name directory or
directory does not exist at all then the default seusers files from
<strong>/etc/selinux/targeted/seusers</strong> will be used. If the file exists and
pam_selinux cannot decide what to do based content of the file the
authentication should fail and not use the default from
/etc/selinux/targeted/seusers.</p>
</section>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/Integration_with_SELinux.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
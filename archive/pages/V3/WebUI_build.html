<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>AMD modules and Web UI build &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Overview" href="WebUI_extensible_navigation.html" />
    <link rel="prev" title="Overview" href="Use_posix_attributes_defined_in_AD.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="amd-modules-and-web-ui-build">
<span id="id1"></span><h1>AMD modules and Web UI build<a class="headerlink" href="#amd-modules-and-web-ui-build" title="Permalink to this heading">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>One of the most recommended optimization techniques for web pages are
reduction of the number of http request and a minimization of JavaScript
file size. Web UI uses a lot of JavaScript files. These files can be
concatenated into a single file and then optimized by JavaScript
compiler which strips comments, white-spaces and does other
optimizations.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h2>
<p>The main idea is transform FreeIPA JavaScript files into AMD modules and
build them with a builder into single file, then the file will be
further optimized by JavaScript compiler.</p>
<section id="introducing-dojo">
<span id="id2"></span><h3>Introducing Dojo<a class="headerlink" href="#introducing-dojo" title="Permalink to this heading">¶</a></h3>
<p>This feature has two topics which are closely related: AMD modules with
AMD loader, and a builder. A loader from a dojo/dojo library is used as
a loader and a build tool from dojo/util library as a builder. Including
source codes of both libraries in FreeIPA repository is not desired
because of their number and size. Therefore FreeIPA git repository
contains only their compiled versions. The builder and a Dojo library
are both built by the builder itself.</p>
<p>Following tools were developed to simplify maintenance of Dojo
Libraries:</p>
<ul class="simple">
<li><p>util/prepare-dojo.sh - can checkout dojo/dojo or dojo/util from
github repositories to a directory outside FreeIPA directory. Then it
can apply custom patches on a builder and make symbolic links
src/dojo and src/build which points to the check-outed repositories.</p></li>
<li><p>util/make-dojo.sh - creates custom build of dojo/dojo. Requires
util/prepare-dojo.sh to be run before. Then it calls compile.sh to
minimize the build.</p></li>
<li><p>util/make-builder.sh - creates custom build of dojo/util/build
(builder). Requires util/prepare-dojo.sh to be run before. Then it
calls compile.sh to minimize the build.</p></li>
<li><p>util/compile.sh - compiles a build made by a builder using a
uglify.js compiler. Usually no need to use it alone.</p></li>
</ul>
</section>
<section id="uglify-js">
<h3>Uglify.js<a class="headerlink" href="#uglify-js" title="Permalink to this heading">¶</a></h3>
<p>Builder transforms AMD packages into single or more files and does basic
minimization like stripping of comments. For further minimization a
proper JavaScript compiler has to be used. Uglify.js was chosen because
of it’s capabilities and also because it can be run in rhino environment
and thus to avoid problems of not having a common compiler on targeted
platforms. For easier usage a wrapper scripted was developed:
<em>util/uglifyjs/uglify SOURCE TARGET</em>. It will be better to run under
node.js when all target platforms will support it.</p>
</section>
<section id="building-freeipa">
<span id="id3"></span><h3>Building FreeIPA<a class="headerlink" href="#building-freeipa" title="Permalink to this heading">¶</a></h3>
<p>Web UI JavaScript files can be divided into three sets: third party
libraries, FreeIPA code and Dojo library. Lets call them layers. FreeIPA
now uses 4 third party libs. 2 of them are already compiled and the rest
has small size. No bigger optimization techniques are required here.
Dojo is already prepared for optimization. The focus of optimization is
therefore on FreeIPA layer.</p>
</section>
<section id="amd-module-wrapping">
<span id="id4"></span><h3>AMD module wrapping<a class="headerlink" href="#amd-module-wrapping" title="Permalink to this heading">¶</a></h3>
<p>Dojo/util/build tool (builder) is used as a builder of both FreeIPA and
Dojo layer. The builder works best with AMD modules. Full modification
of FreeIPA layer into AMD modules would require splitting files by
component and redefining a lot of dependencies which is a huge tasks.
Different approach is taken to avoid this problem at the moment:
Existing files are only wrapped with AMD module definition. They should
be converted to proper modules - with single purpose and clean
dependencies, gradually in a future. Same applies on Web UI tests.</p>
</section>
<section id="build">
<h3>Build<a class="headerlink" href="#build" title="Permalink to this heading">¶</a></h3>
<p>A build of FreeIPA layer is done by calling <em>util/make-ui.sh</em>. This
script is run at make-all phase of an RPM build. Make-ui.sh is not
checking errors during the build because we don’t provide dojo/dojo
source codes and thus there are dependency errors. Dojo builder can’t be
configured to ignore certain dependency errors and also can’t be built
against already built library. The layer is built even though there are
dependency errors, it’s not a blocker but it will be nice to fix it in a
future (in dojo upstream or by custom patch).</p>
</section>
<section id="new-directory-structure">
<span id="id5"></span><h3>New directory structure<a class="headerlink" href="#new-directory-structure" title="Permalink to this heading">¶</a></h3>
<p>Web UI directory structure was change because the old one didn’t suffice
new needs which are:</p>
<ul class="simple">
<li><p>separate layers into own directories - for AMD</p></li>
<li><p>easy switch between source code version and built version during
testing</p></li>
</ul>
<p>Following directories in a ui directory were created:</p>
<ul class="simple">
<li><p>src - contains all source codes. Special pages (login, logout, reset
password) JS code was not moved yet. Not used in production.</p></li>
<li><p>js - a production directory. At production it should contain built
layers, at development symbolic links to related folders in src or
build directories.</p></li>
<li><p>release - working dir at build phase</p></li>
<li><p>build - contains output of make-ui.sh and make-dojo.sh scripts.</p></li>
</ul>
<p>All FreeIPA layer JS sources were move to src/freeipa folder. Libraries
(jquery, jquery ui, bbq, json2) were moved to src/libs.</p>
</section>
<section id="development-profiles">
<span id="id6"></span><h3>Development profiles<a class="headerlink" href="#development-profiles" title="Permalink to this heading">¶</a></h3>
<p>Several approaches of debugging of UI can be considered when developing
UI. Developer can either use a machine with installed FreeIPA or he can
start Web UI from a development directory. When the latter case is used,
the Web UI uses JSON files stored in test/data directory which simulates
JSON-RPC communication. Because there is no communication with server,
we can call this approach an ‘offline version’.</p>
<section id="offline-version">
<span id="id7"></span><h4>Offline version<a class="headerlink" href="#offline-version" title="Permalink to this heading">¶</a></h4>
<p>Offline version uses FreeIPA layer source codes and built version of
dojo/dojo library by default. It can use built version of FreeIPA layer
or source codes of dojo/dojo library by changing of symbolic links in
<em>js</em> directory. To make this task easier, an ‘util/change-profile.sh’
script was developed. The script can also set `git update-index
–assume-unchanged` to prevent git from notifying about this change.</p>
</section>
<section id="test-server">
<span id="id8"></span><h4>Test server<a class="headerlink" href="#test-server" title="Permalink to this heading">¶</a></h4>
<p>Different approach must be applied when using test server for debugging.
In this case source codes or built layers must be copied to
<em>/usr/share/ipa</em> directory on the test server. To make the task easier
<em>util/sync.sh</em> script was created. Developer can specify which parts of
the UI in which form he wants to copy. The tool contains directory
mappings so developer doesn’t have think about where source codes or
build versions are placed. Look to Use Cases chapter or tool’s help for
more information.</p>
</section>
</section>
</section>
<section id="use-cases">
<h2>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h2>
<section id="users">
<h3>Users<a class="headerlink" href="#users" title="Permalink to this heading">¶</a></h3>
<p>None</p>
</section>
<section id="developers">
<h3>Developers<a class="headerlink" href="#developers" title="Permalink to this heading">¶</a></h3>
<p>Note: all commands are run from install/ui directory of FreeIPA source
dir.</p>
<section id="make-new-freeipa-layer-build">
<span id="id9"></span><h4>Make new FreeIPA layer build<a class="headerlink" href="#make-new-freeipa-layer-build" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>only useful for debugging. It’s done automatically in make all phase
of RPM build.</p></li>
<li><p>run $ util/make-ui.sh</p></li>
</ul>
</section>
<section id="set-environment-to-debug-source-codes-of-freeipa-layer-using-offline-version">
<span id="id10"></span><h4>Set environment to debug source codes of FreeIPA layer using offline version<a class="headerlink" href="#set-environment-to-debug-source-codes-of-freeipa-layer-using-offline-version" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>it’s the default profile after checkout</p></li>
<li><p>to switch back from other profile:</p>
<ul>
<li><p>$ util/change-profile.sh -p source</p></li>
</ul>
</li>
<li><p>open index.html by a browser using <a class="reference external" href="file://">file://</a> protocol:</p>
<ul>
<li><p><a class="reference external" href="file:///home/login/path-to-freeipa/freeipa/install/ui/index.html">file:///home/login/path-to-freeipa/freeipa/install/ui/index.html</a></p></li>
<li><p>when using Chrome, run it with –disable-web-security option
otherwise XHR won’t work</p></li>
</ul>
</li>
</ul>
</section>
<section id="set-environment-to-debug-built-freeipa-layer-using-offline-version">
<span id="id11"></span><h4>Set environment to debug built FreeIPA layer using offline version<a class="headerlink" href="#set-environment-to-debug-built-freeipa-layer-using-offline-version" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>$ util/change-profile.sh -p compiled</p></li>
<li><p>open browser same way as in previous use case</p></li>
<li><p>note: this doesn’t create the compiled version, you have to run it
separately</p></li>
</ul>
</section>
<section id="copy-source-codes-of-freeipa-layer-on-test-server">
<span id="id12"></span><h4>Copy source codes of FreeIPA layer on test server<a class="headerlink" href="#copy-source-codes-of-freeipa-layer-on-test-server" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>$ util/sync.sh –host <a class="reference external" href="mailto:root&#37;&#52;&#48;test&#46;example&#46;com">root<span>&#64;</span>test<span>&#46;</span>example<span>&#46;</span>com</a> –freeipa</p></li>
<li><p>you can replace root with any user who can write into /usr/share/ipa</p></li>
<li><p>add –clean option if you want to delete all files from target dir</p></li>
<li><p>run $ util/sync.sh –help to get more information about others
folders (images, root dir, libs) and option shortcuts</p></li>
</ul>
</section>
<section id="copy-built-freeipa-layer-on-test-server">
<span id="id13"></span><h4>Copy built FreeIPA layer on test server<a class="headerlink" href="#copy-built-freeipa-layer-on-test-server" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>$ util/sync.sh –host <a class="reference external" href="mailto:root&#37;&#52;&#48;test&#46;example&#46;com">root<span>&#64;</span>test<span>&#46;</span>example<span>&#46;</span>com</a> –freeipa –compiled</p></li>
</ul>
</section>
<section id="update-internal-py-strings-for-web-ui-on-test-server">
<span id="id14"></span><h4>Update internal.py (strings for Web UI) on test server<a class="headerlink" href="#update-internal-py-strings-for-web-ui-on-test-server" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>$ util/sync.sh –host <a class="reference external" href="mailto:root&#37;&#52;&#48;test&#46;example&#46;com">root<span>&#64;</span>test<span>&#46;</span>example<span>&#46;</span>com</a> –strings –restart</p></li>
<li><p>note: –restart restarts httpd on test server (systemctl restart
httpd.service). Required for changes to take effect.</p></li>
</ul>
</section>
<section id="clone-dojo-repositories">
<span id="id15"></span><h4>Clone Dojo repositories<a class="headerlink" href="#clone-dojo-repositories" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>should be run only once</p></li>
<li><p>required only for Dojo and Builder build</p></li>
<li><p>$ util/prepare-dojo.sh –all</p>
<ul>
<li><p>creates dojo folder at the same dir as freeipa dir is. Can be
changed by –dir option, but it’s not well tested.</p></li>
<li><p>clones <a class="reference external" href="https://github.com/dojo/dojo.git">https://github.com/dojo/dojo.git</a> and
<a class="reference external" href="https://github.com/dojo/util.git">https://github.com/dojo/util.git</a> into dojo folder</p></li>
<li><p>checkouts both repos to tag 1.8.1 (should be change later when
updating dojo)</p></li>
<li><p>applies custom patches in util/build/patches dir on dojo/util repo</p></li>
<li><p>makes src/dojo and src/build symbolic links</p></li>
</ul>
</li>
<li><p>can be fine-tuned by running with different options, check –help</p></li>
</ul>
</section>
<section id="make-new-dojo-lib-build">
<span id="id16"></span><h4>Make new Dojo lib build<a class="headerlink" href="#make-new-dojo-lib-build" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>required when FreeIPA layer has new dependency</p></li>
<li><p>requires to have dojo cloned</p></li>
<li><p>new dependencies should be define in src/dojo.profile.js in
layer.include list</p></li>
<li><p>run $ util/make-dojo.sh</p></li>
</ul>
</section>
<section id="make-new-builder-build">
<span id="id17"></span><h4>Make new Builder build<a class="headerlink" href="#make-new-builder-build" title="Permalink to this heading">¶</a></h4>
<ul class="simple">
<li><p>required when a change in a builder is needed. Usually shouldn’t be.</p></li>
<li><p>requires to have dojo cloned</p></li>
<li><p>recommended workflow:</p>
<ul>
<li><p>clone dojo if not done: $ util/prepare-dojo.sh –all</p></li>
<li><p>checkout desired version, if needed $ util/prepare-dojo.sh –dojo
–util –checkout –branch VERSION</p></li>
<li><p>make required changes in dojo-root/util/build</p></li>
<li><p>run $ util/make-builder.sh</p></li>
<li><p>warning: builder is overwritten on successful build, use git reset
to change it back if needed</p></li>
<li><p>if all OK, create a patch file with the changes. Name should be:
XXX-dojo-build-NAME-YY-commit-message.patch, where XXX is a the
following number than in the last patch, NAME is your login, nick
and YY is your patch number starting from 00</p></li>
<li><p>store the patch into util/build/patches directory (will require a
force option on git add)</p></li>
<li><p>make patch of all these changes and send it for review</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h2>
<p>Any additional requirements or changes discovered during the
implementation phase.</p>
</section>
<section id="feature-management">
<h2>Feature Management<a class="headerlink" href="#feature-management" title="Permalink to this heading">¶</a></h2>
<p>From new user feature POV doesn’t affect Web UI or CLI.</p>
</section>
<section id="major-configuration-options-and-enablement">
<h2>Major configuration options and enablement<a class="headerlink" href="#major-configuration-options-and-enablement" title="Permalink to this heading">¶</a></h2>
<p>No configuration options.</p>
</section>
<section id="replication">
<h2>Replication<a class="headerlink" href="#replication" title="Permalink to this heading">¶</a></h2>
<p>No impact.</p>
</section>
<section id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h2>
<p>rhino 1.7R3 on build machine (minimum version with common JS modules
support)</p>
</section>
<section id="impact-on-other-development-teams">
<span id="id18"></span><h2>Impact on other development teams<a class="headerlink" href="#impact-on-other-development-teams" title="Permalink to this heading">¶</a></h2>
<p>No impact.</p>
</section>
<section id="impact-to-web-ui-and-other-components">
<span id="id19"></span><h2>Impact to Web UI and other components<a class="headerlink" href="#impact-to-web-ui-and-other-components" title="Permalink to this heading">¶</a></h2>
<p>Pure Web UI change. Speeds up Web UI load.</p>
</section>
<section id="rfe-author">
<h2>RFE author<a class="headerlink" href="#rfe-author" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="User:Pvoborni">Petr Vobornik</a></p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V3/WebUI_build.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Refactorings and infrastructure improvements" href="Refactorings.html" />
    <link rel="prev" title="Overview" href="Realm_Domains.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <p>__NOTOC__</p>
<section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>IPA uses the 389-ds Distributed Numeric Assignment (DNA) plugin to
automatically manage POSIX uid/gid assignment. This plugin manages the
range of available IDs cross all masters.
<a class="reference external" href="https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Directory_Server/8.1/html/Configuration_and_Command_Reference/dna-attributes.html">https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Directory_Server/8.1/html/Configuration_and_Command_Reference/dna-attributes.html</a></p>
<p>When a master is deleted then its range is not recovered, potentially
leaving a huge hole in the number of available entries. For example, the
first master gets half the range. The second gets the other half. If
either of these is deleted, or replaced, then half the available range
is gone as well.</p>
<p>A master does not receive a range until the DNA plugin is first used, so
it is perfectly possible for a master to have no defined range.</p>
</section>
<section id="use-cases">
<span id="use-cases10k"></span><h1>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this heading">¶</a></h1>
<section id="a-master-has-run-out-of-ids">
<span id="id1"></span><h2>A master has run out of IDs<a class="headerlink" href="#a-master-has-run-out-of-ids" title="Permalink to this heading">¶</a></h2>
<p>The simplest case is that a master has exhaused its range and its
request for more was not fulfilled.</p>
<p>The admin is going to need to evaluate the current range usage and
re-adjust as necessary. This may involve manually splitting an existing
range or extending past the initial 200k entries we configure.</p>
</section>
<section id="way-ipa-mmr-delete-one-lose-half-the-range">
<span id="id2"></span><h2>3-way IPA MMR, delete one, lose half the range<a class="headerlink" href="#way-ipa-mmr-delete-one-lose-half-the-range" title="Permalink to this heading">¶</a></h2>
<p>Install initial server with –idstart=100000 –idmax=102000 giving a
total range of 2k users (and groups). Install two additional masters
from this master (so A-&gt;B and A-&gt;C) and create a user on B and C.</p>
<p>Start with two masters:</p>
<p>master A:</p>
<ul class="simple">
<li><p>dnaNextValue: 100000</p></li>
<li><p>dnaMaxValue: 101000</p></li>
</ul>
<p>master B:</p>
<ul class="simple">
<li><p>dnaNextValue: 101002</p></li>
<li><p>dnaMaxValue: 102000</p></li>
</ul>
<p>Note that master A original had the full range. After master B is added
the max went to 101000).</p>
<p>master C:</p>
<ul class="simple">
<li><p>dnaNextValue: 100502</p></li>
<li><p>dnaMaxValue: 101000</p></li>
</ul>
<p>master A dnaMaxValue goes to 100500.</p>
<p>If master B is deleted we lose half the range which will quickly lead to
the previous use case.</p>
</section>
<section id="dead-master-lose-the-range">
<span id="id3"></span><h2>Dead master, lose the range<a class="headerlink" href="#dead-master-lose-the-range" title="Permalink to this heading">¶</a></h2>
<p>A master has died for some reason and it will be deleted. We perhaps
can’t know the range, or can’t connect to the server to detect the
range. In this case the range will be lost and a tool will be required
to manually recover the range.</p>
</section>
</section>
<section id="design">
<h1>Design<a class="headerlink" href="#design" title="Permalink to this heading">¶</a></h1>
<p>This solution will consist of two parts:</p>
<ol class="arabic simple">
<li><p>Attempt to recover any lost ranges into the “on-deck” range of
another master</p></li>
<li><p>Provide a tool to manage the current and on-base ranges of masters</p></li>
</ol>
<p>The on-deck range is used internally by DNA when a range transfer takes
place. If a replica hits the configured low-water mark (the
“dnaThreshold” attribute), it will request a range transfer from another
replica. It might still have some active range values left to use, so it
puts the transferred range on-deck and swaps it to the active range once
the active range is fully exhausted. When you are trying to choose a
server to reassign the deleted replica range to, you should make sure it
doesn’t already have another range on-deck.</p>
<p>The on-deck range is defined by the “dnaNextRange” attribute, which
takes a value in the form “-” (“500-1000” would be an example).</p>
<p>The tool will be an extension to ipa-replica-manage to list and modify
the on-deck range. I don’t believe we want to allow modifying the active
range itself.</p>
<section id="additional-aci-permissions">
<span id="id4"></span><h2>Additional ACI Permissions<a class="headerlink" href="#additional-aci-permissions" title="Permalink to this heading">¶</a></h2>
<p>We will need to write a new ACI to allow admins to write a subset of DNA
attributes, including dnaNextRange, dnaNextValue and dnaMaxValue. This
will look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span><span class="p">:</span> <span class="n">cn</span><span class="o">=</span><span class="n">Posix</span> <span class="n">IDs</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">Distributed</span> <span class="n">Numeric</span> <span class="n">Assignment</span> <span class="n">Plugin</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span><span class="n">cn</span><span class="o">=</span><span class="n">config</span>
<span class="n">changetype</span><span class="p">:</span> <span class="n">modify</span>
<span class="n">add</span><span class="p">:</span> <span class="n">aci</span>
<span class="n">aci</span><span class="p">:</span> <span class="p">(</span><span class="n">targetattr</span><span class="o">=</span><span class="n">dnaNextRange</span> <span class="o">||</span> <span class="n">dnaNextValue</span> <span class="o">||</span> <span class="n">dnaMaxValue</span><span class="p">)(</span><span class="n">version</span> <span class="mf">3.0</span><span class="p">;</span><span class="n">acl</span> <span class="s2">&quot;permission:Modify DNA Range&quot;</span><span class="p">;</span><span class="n">allow</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="n">groupdn</span> <span class="o">=</span> <span class="s2">&quot;ldap:///cn=Modify DNA Range,cn=permissions,cn=pbac,$SUFFIX&quot;</span><span class="p">;)</span>
</pre></div>
</div>
<p>A new permission will need to be added and included in the privilege
‘Replication Administrators’.</p>
</section>
<section id="setting-the-on-deck-range">
<span id="id5"></span><h2>Setting the on-deck range<a class="headerlink" href="#setting-the-on-deck-range" title="Permalink to this heading">¶</a></h2>
<p>In the del operation of ipa-replica-manage we will query the values of
dnaNextValue and dnaMaxValue from the server to be removed. We will then
walk the rest of the masters. The first one with no dnaNextRange value
will have it added in the form of dnaNextValue-dnaMaxValue.</p>
<p>If no servers have an empty dnaNextRange we will WARN about the range of
values that will be lost and inform the user of the command to manage
it.</p>
<p>We will NOT try to modify the current DNA range configuration.</p>
</section>
<section id="determining-if-a-replica-has-a-range">
<span id="id6"></span><h2>Determining if a replica has a range<a class="headerlink" href="#determining-if-a-replica-has-a-range" title="Permalink to this heading">¶</a></h2>
<p>Identifying the on-deck range is easy, use dnaNextRange.</p>
<p>To see if a range has been assigned, the replication agreement is by
default pre-configured with an exhausted range with dnaNextValue = 1101
and the dnaMaxValue = 1100.</p>
<p>Note too that one can also look in the dnaSharedCfgDN value for the
replica, something like:</p>
<p><code class="docutils literal notranslate"><span class="pre">dnaHostname=dart.example.com+dnaPortNum=389,cn=posix-ids,cn=dna,cn=ipa,cn=etc,dc=example,dc=com</span></code></p>
<p>dnaRemainingValues will be 0.</p>
</section>
<section id="enhancing-ipa-replica-manage">
<span id="id7"></span><h2>Enhancing ipa-replica-manage<a class="headerlink" href="#enhancing-ipa-replica-manage" title="Permalink to this heading">¶</a></h2>
<p>Four new commands will be added, in sets of two: dnarange-show and
dnarange-set and dnanextrange-show and dnanextrange-set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa-replica-manage dnarange-show</span>
<span class="n">masterA</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="mi">100</span><span class="o">-</span><span class="mi">500</span>
<span class="n">masterB</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="mi">500</span><span class="o">-</span><span class="mi">1000</span>
<span class="n">masterC</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="n">No</span> <span class="nb">range</span> <span class="nb">set</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa-replica-manage dnarange-show masterA.example.com</span>
 <span class="n">masterA</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="mi">100</span><span class="o">-</span><span class="mi">500</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa-replica-manage dnarange-set masterA.example.com 250-499</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa-replica-manage dnanextrange-show</span>
<span class="n">masterA</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="mi">1001</span><span class="o">-</span><span class="mi">1500</span>
<span class="n">masterB</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="n">No</span> <span class="n">on</span><span class="o">-</span><span class="n">deck</span> <span class="nb">range</span> <span class="nb">set</span>
<span class="n">masterC</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="n">No</span> <span class="n">on</span><span class="o">-</span><span class="n">deck</span> <span class="nb">range</span> <span class="nb">set</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa-replica-manage dnanextrange-show masterA.example.com</span>
<span class="n">masterA</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span> <span class="mi">1001</span><span class="o">-</span><span class="mi">1500</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ipa-replica-manage dnanextrange-set masterB.example.com 1001-5000</span>
</pre></div>
</div>
<p>A show on no specific host will show them all. A show on a specific host
will show only that host.</p>
<p>The list of masters comes from cn=masters.</p>
<p>When any range is set we will need to make sure that it does not overlap
with existing DNA ranges AND any existing on-deck ranges.</p>
<p>Setting a range of 0-0 in an on-deck range deletes the range (removes
the attribute altogether). We do not allow removing the main DNA range.</p>
<p>NOTE: We will need to be clear that this range has nothing to do with
Trust ranges.</p>
<p>That doesn’t remove our responsibility to not test for overlaps in the
idranges though. We will need to verify that the manual configuration
changes do:</p>
<ul class="simple">
<li><p>not overlap with ranges from trusted domains
(objectclass=ipatrustedaddomainrange) in cn=ranges,cn=etc,$SUFFIX, or
reject the change otherwise.</p></li>
<li><p>overlap completely with ranges from the local IPA domain
(objectclass=ipaDomainIDRange) in cn=ranges,cn=etc,$SUFFIX, or give a
warning otherwise which asks the user to add a new suitable idrange.”</p></li>
</ul>
<p>Codewise the logic could be:</p>
<ol class="arabic simple">
<li><p>check if the new range is a subset of a local idrange(s), if yes, all
is fine</p></li>
<li><p>if not, check if it overlaps with an idrange of a trusted domain, if
yes, reject</p></li>
<li><p>if not, reject and ask to add a new idrange for the local domain</p></li>
</ol>
<p>The overall logic for deleting a master and saving the range(s):</p>
<ol class="arabic simple">
<li><p>Connect to the remote master</p></li>
<li><p>If the connection fails, report this and ask to continue (and lose
the range(s)). If so, skip the rest and delete the master.</p></li>
<li><p>Put the remote master into read-only and force a sync</p></li>
<li><p>Retrieve the DNA range and on-deck values (if any)</p></li>
<li><p>Check for overlap (just in case)</p></li>
<li><p>If overlap, report the overlap and skip the range</p></li>
<li><p>Search through list of masters, excluding the one we’re deleting to
find one without an on-deck</p></li>
<li><p>Set first any valid DNA range on the first available master with an
on-deck</p></li>
<li><p>Search for another available master if the deleted master has an
on-deck and set that</p></li>
<li><p>Report errors as needed</p></li>
</ol>
<section id="hosts-that-are-down">
<span id="id8"></span><h3>Hosts that are down<a class="headerlink" href="#hosts-that-are-down" title="Permalink to this heading">¶</a></h3>
<p>We need specially handling for hosts that are not up. This could be
either a temporary or a permanent issue. I think that when modifying a
range we need to prompt that an overlap can occur if they continue.</p>
<p>The –force flag will be used to avoid the prompt. The default answer to
the Proceed question is No.</p>
</section>
</section>
</section>
<section id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p>No special handling was needed to deal with hosts that are down
because the –force flag is required to get very far at all. A
message was added that any range on the host would be lost, but no
additional prompts were added.</p></li>
</ul>
</section>
<section id="feature-managment">
<span id="id9"></span><h1>Feature Managment<a class="headerlink" href="#feature-managment" title="Permalink to this heading">¶</a></h1>
<p>It will not have a UI component.</p>
<p>The ipa-replica-manage tool.</p>
</section>
<section id="major-configuration-options-and-enablement">
<h1>Major configuration options and enablement<a class="headerlink" href="#major-configuration-options-and-enablement" title="Permalink to this heading">¶</a></h1>
<p>None.</p>
</section>
<section id="replication">
<h1>Replication<a class="headerlink" href="#replication" title="Permalink to this heading">¶</a></h1>
<p>Indirectly. It can affect the available range(s) to a replica. If a
replica runs out and not enough values are left then the DNA plugin will
give up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># ipa user-add --first=tim --last=user tuser4
ipa: ERROR: Operations error: Allocation of a new value for range cn=posix ids,cn=distributed numeric assignment plugin,cn=plugins,cn=config failed! Unable to proceed.
</pre></div>
</div>
<p>Managing ranges can be dangerous. If there are overlapping ranges you
run the risk of 2 different masters assigning the same value. This will
then cause grief when the entries are replicated.</p>
</section>
<section id="updates-and-upgrades">
<h1>Updates and Upgrades<a class="headerlink" href="#updates-and-upgrades" title="Permalink to this heading">¶</a></h1>
<p>No</p>
</section>
<section id="dependencies">
<h1>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this heading">¶</a></h1>
<p>No</p>
</section>
<section id="external-impact">
<h1>External Impact<a class="headerlink" href="#external-impact" title="Permalink to this heading">¶</a></h1>
<p>No</p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/archive/pages/V3/Recover_DNA_Ranges.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>
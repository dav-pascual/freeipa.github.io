<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview &#8212; FreeIPA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Overview" href="Samba_4_Attribute_Indexing.html" />
    <link rel="prev" title="Samba Schema" href="Samba_3_Schema.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h1>
<p>Samba relies on the LDAP backend to perform attribute dereferencing to
generate extended DN. Samba uses an LDB module to send the request and
handle the response. Currently the module assumes the backend will be
OpenLDAP. It needs to be modified to work with DS.</p>
<p>This is a prerequisite for <a class="reference external" href="Obsolete:Samba_4_Storing_SID_in_String_Format">storing SID in string
format</a>.</p>
</section>
<section id="current-code">
<span id="id1"></span><h1>Current Code<a class="headerlink" href="#current-code" title="Permalink to this heading">¶</a></h1>
<section id="provisioning-tool">
<span id="id2"></span><h2>Provisioning Tool<a class="headerlink" href="#provisioning-tool" title="Permalink to this heading">¶</a></h2>
<p>The provisioning tool uses extended_dn_out_dereference module for both
OpenLDAP and DS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ldap_backend</span><span class="o">.</span><span class="n">ldap_backend_type</span> <span class="o">==</span> <span class="s2">&quot;fedora-ds&quot;</span><span class="p">:</span>
    <span class="n">tdb_modules_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;extended_dn_out_dereference&quot;</span><span class="p">]</span>

<span class="k">elif</span> <span class="n">ldap_backend</span><span class="o">.</span><span class="n">ldap_backend_type</span> <span class="o">==</span> <span class="s2">&quot;openldap&quot;</span><span class="p">:</span>
    <span class="n">tdb_modules_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;extended_dn_out_dereference&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="module-definition">
<span id="id3"></span><h2>Module Definition<a class="headerlink" href="#module-definition" title="Permalink to this heading">¶</a></h2>
<p>The module is defined in
source/dsdb/samdb/ldb_modules/extended_dn_out.c:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_PUBLIC_</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">ldb_module_ops</span> <span class="n">ldb_extended_dn_out_dereference_module_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">name</span>         <span class="o">=</span> <span class="s2">&quot;extended_dn_out_dereference&quot;</span><span class="p">,</span>
    <span class="o">.</span><span class="n">search</span>       <span class="o">=</span> <span class="n">extended_dn_out_search</span><span class="p">,</span>
    <span class="o">.</span><span class="n">init_context</span> <span class="o">=</span> <span class="n">extended_dn_out_dereference_init</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="initialization-method">
<span id="id4"></span><h2>Initialization Method<a class="headerlink" href="#initialization-method" title="Permalink to this heading">¶</a></h2>
<p>The initialization method is contains OpenLDAP-specific attribute
entryUUID.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_dereference_init</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">cur</span> <span class="o">=</span> <span class="n">schema</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">;</span> <span class="n">cur</span><span class="p">;</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="nb">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">static</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;entryUUID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;objectSID&quot;</span><span class="p">,</span>
            <span class="n">NULL</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="search-method">
<span id="id5"></span><h2>Search Method<a class="headerlink" href="#search-method" title="Permalink to this heading">¶</a></h2>
<p>The search method specifies a callback function when constructing a
search request.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_search</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ldb_build_search_req_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">down_req</span><span class="p">,</span>
        <span class="n">ldb_module_get_ctx</span><span class="p">(</span><span class="n">module</span><span class="p">),</span> <span class="n">ac</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span>
        <span class="n">const_attrs</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span>
        <span class="n">ac</span><span class="p">,</span> <span class="n">extended_callback</span><span class="p">,</span>
        <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="callback-function">
<span id="id6"></span><h2>Callback Function<a class="headerlink" href="#callback-function" title="Permalink to this heading">¶</a></h2>
<p>The callback function calls a handler function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">extended_callback</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_reply</span> <span class="o">*</span><span class="n">ares</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">handle_dereference</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span>
        <span class="n">dereference_control</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="handler-function">
<span id="id7"></span><h2>Handler Function<a class="headerlink" href="#handler-function" title="Permalink to this heading">¶</a></h2>
<p>The handler function uses OpenLDAP-specific attribute entryUUID.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">handle_dereference</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_dn</span> <span class="o">*</span><span class="n">dn</span><span class="p">,</span>
    <span class="n">struct</span> <span class="n">dsdb_openldap_dereference_result</span> <span class="o">**</span><span class="n">dereference_attrs</span><span class="p">,</span>
    <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">const</span> <span class="n">DATA_BLOB</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">entryUUIDblob</span> <span class="o">=</span> <span class="n">ldb_msg_find_ldb_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_msg</span><span class="p">,</span> <span class="s2">&quot;entryUUID&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">entryUUIDblob</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GUID_from_data_blob</span><span class="p">(</span><span class="n">entryUUIDblob</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid</span><span class="p">);</span>
        <span class="n">ndr_push_struct_blob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">guid_blob</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid</span><span class="p">,</span>
            <span class="p">(</span><span class="n">ndr_push_flags_fn_t</span><span class="p">)</span><span class="n">ndr_push_GUID</span><span class="p">);</span>
        <span class="n">ldb_dn_set_extended_component</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s2">&quot;GUID&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid_blob</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">sid_blob</span> <span class="o">=</span> <span class="n">ldb_msg_find_ldb_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_msg</span><span class="p">,</span> <span class="s2">&quot;objectSID&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sid_blob</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ldb_dn_set_extended_component</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s2">&quot;SID&quot;</span><span class="p">,</span> <span class="n">sid_blob</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="proposed-changes">
<span id="id8"></span><h1>Proposed Changes<a class="headerlink" href="#proposed-changes" title="Permalink to this heading">¶</a></h1>
<section id="provisioning-tool-1">
<span id="id9"></span><h2>Provisioning Tool<a class="headerlink" href="#provisioning-tool-1" title="Permalink to this heading">¶</a></h2>
<p>The provisioning tool should be changed to use different modules for
OpenLDAP and DS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">ldap_backend</span><span class="o">.</span><span class="n">ldap_backend_type</span> <span class="o">==</span> <span class="s2">&quot;fedora-ds&quot;</span><span class="p">:</span>
    <span class="n">tdb_modules_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;extended_dn_out_fds&quot;</span><span class="p">]</span>

<span class="k">elif</span> <span class="n">ldap_backend</span><span class="o">.</span><span class="n">ldap_backend_type</span> <span class="o">==</span> <span class="s2">&quot;openldap&quot;</span><span class="p">:</span>
    <span class="n">tdb_modules_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;extended_dn_out_openldap&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="module-definition-1">
<span id="id10"></span><h2>Module Definition<a class="headerlink" href="#module-definition-1" title="Permalink to this heading">¶</a></h2>
<p>The extended_dn_out_dereference module should be replaced by
extended_dn_out_openldap and extended_dn_out_fds modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_PUBLIC_</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">ldb_module_ops</span> <span class="n">ldb_extended_dn_out_openldap_module_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">name</span>         <span class="o">=</span> <span class="s2">&quot;extended_dn_out_openldap&quot;</span><span class="p">,</span>
    <span class="o">.</span><span class="n">search</span>       <span class="o">=</span> <span class="n">extended_dn_out_openldap_search</span><span class="p">,</span>
    <span class="o">.</span><span class="n">init_context</span> <span class="o">=</span> <span class="n">extended_dn_out_openldap_init</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">_PUBLIC_</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">ldb_module_ops</span> <span class="n">ldb_extended_dn_out_fds_module_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">name</span>         <span class="o">=</span> <span class="s2">&quot;extended_dn_out_fds&quot;</span><span class="p">,</span>
    <span class="o">.</span><span class="n">search</span>       <span class="o">=</span> <span class="n">extended_dn_out_fds_search</span><span class="p">,</span>
    <span class="o">.</span><span class="n">init_context</span> <span class="o">=</span> <span class="n">extended_dn_out_fds_init</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="initialization-method-1">
<span id="id11"></span><h2>Initialization Method<a class="headerlink" href="#initialization-method-1" title="Permalink to this heading">¶</a></h2>
<p>The original initialization method should be generalized to take an
attribute list. There will be separate initialization methods for
OpenLDAP and DS which will call the generic initialization method and
supply the appropriate attribute list for the backend.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_dereference_init</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span>
    <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[])</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">cur</span> <span class="o">=</span> <span class="n">schema</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">;</span> <span class="n">cur</span><span class="p">;</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="nb">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_openldap_init</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">static</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;entryUUID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;objectSID&quot;</span><span class="p">,</span>
        <span class="n">NULL</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">extended_dn_out_dereference_init</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_fds_init</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">static</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;nsUniqueId&quot;</span><span class="p">,</span>
        <span class="s2">&quot;objectSID&quot;</span><span class="p">,</span>
        <span class="n">NULL</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="n">extended_dn_out_dereference_init</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="search-method-1">
<span id="id12"></span><h2>Search Method<a class="headerlink" href="#search-method-1" title="Permalink to this heading">¶</a></h2>
<p>The original search method should be changed to take a callback
function. There will be separate search methods for OpenLDAP and DS
which will call the generic search method and supply the appropriate
callback function for the backend.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_search</span><span class="p">(</span>
    <span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
    <span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_reply</span> <span class="o">*</span><span class="n">ares</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ldb_build_search_req_ex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">down_req</span><span class="p">,</span>
        <span class="n">ldb_module_get_ctx</span><span class="p">(</span><span class="n">module</span><span class="p">),</span> <span class="n">ac</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">.</span><span class="n">search</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span>
        <span class="n">const_attrs</span><span class="p">,</span>
        <span class="n">req</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span>
        <span class="n">ac</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span>
        <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_openldap_search</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">extended_dn_out_search</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">extended_callback_openldap</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">extended_dn_out_fds_search</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_module</span> <span class="o">*</span><span class="n">module</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">extended_dn_out_search</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">extended_callback_fds</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="callback-function-1">
<span id="id13"></span><h2>Callback Function<a class="headerlink" href="#callback-function-1" title="Permalink to this heading">¶</a></h2>
<p>The original callback function should be changed to take a handler
function. There will be separate callback functions for OpenLDAP and DS
which will call the generic callback function and supply the appropriate
handler function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">extended_callback</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_reply</span> <span class="o">*</span><span class="n">ares</span><span class="p">,</span>
    <span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">handle_dereference</span><span class="p">)(</span><span class="n">struct</span> <span class="n">ldb_dn</span> <span class="o">*</span><span class="n">dn</span><span class="p">,</span>
        <span class="n">struct</span> <span class="n">dsdb_openldap_dereference_result</span> <span class="o">**</span><span class="n">dereference_attrs</span><span class="p">,</span>
        <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">const</span> <span class="n">DATA_BLOB</span> <span class="o">*</span><span class="n">val</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">handle_dereference</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span>
        <span class="n">dereference_control</span><span class="o">-&gt;</span><span class="n">attributes</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">elements</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">extended_callback_openldap</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_reply</span> <span class="o">*</span><span class="n">ares</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">extended_callback</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ares</span><span class="p">,</span> <span class="n">handler_dereference_openldap</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">extended_callback_fds</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="n">struct</span> <span class="n">ldb_reply</span> <span class="o">*</span><span class="n">ares</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">extended_callback</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ares</span><span class="p">,</span> <span class="n">handler_dereference_fds</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="handler-function-1">
<span id="id14"></span><h2>Handler Function<a class="headerlink" href="#handler-function-1" title="Permalink to this heading">¶</a></h2>
<p>The original handler function that reads the entryUUID attribute should
be used for OpenLDAP only. A new handler function that reads nsUniqueId
should be used for DS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">handle_dereference_openldap</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_dn</span> <span class="o">*</span><span class="n">dn</span><span class="p">,</span>
    <span class="n">struct</span> <span class="n">dsdb_openldap_dereference_result</span> <span class="o">**</span><span class="n">dereference_attrs</span><span class="p">,</span>
    <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">const</span> <span class="n">DATA_BLOB</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">entryUUIDblob</span> <span class="o">=</span> <span class="n">ldb_msg_find_ldb_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_msg</span><span class="p">,</span> <span class="s2">&quot;entryUUID&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">entryUUIDblob</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">GUID_from_data_blob</span><span class="p">(</span><span class="n">entryUUIDblob</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid</span><span class="p">);</span>
        <span class="n">ndr_push_struct_blob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">guid_blob</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid</span><span class="p">,</span>
            <span class="p">(</span><span class="n">ndr_push_flags_fn_t</span><span class="p">)</span><span class="n">ndr_push_GUID</span><span class="p">);</span>
        <span class="n">ldb_dn_set_extended_component</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s2">&quot;GUID&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid_blob</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">sid_blob</span> <span class="o">=</span> <span class="n">ldb_msg_find_ldb_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_msg</span><span class="p">,</span> <span class="s2">&quot;objectSID&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sid_blob</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ldb_dn_set_extended_component</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s2">&quot;SID&quot;</span><span class="p">,</span> <span class="n">sid_blob</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">handle_dereference_fds</span><span class="p">(</span><span class="n">struct</span> <span class="n">ldb_dn</span> <span class="o">*</span><span class="n">dn</span><span class="p">,</span>
    <span class="n">struct</span> <span class="n">dsdb_openldap_dereference_result</span> <span class="o">**</span><span class="n">dereference_attrs</span><span class="p">,</span>
    <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="n">const</span> <span class="n">DATA_BLOB</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">nsUniqueIdBlob</span> <span class="o">=</span> <span class="n">ldb_msg_find_ldb_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_msg</span><span class="p">,</span> <span class="s2">&quot;nsUniqueId&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nsUniqueIdBlob</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NS_GUID_from_string</span><span class="p">((</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">nsUniqueIdBlob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid</span><span class="p">);</span>
        <span class="n">ndr_push_struct_blob</span><span class="p">(</span><span class="o">&amp;</span><span class="n">guid_blob</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid</span><span class="p">,</span>
            <span class="p">(</span><span class="n">ndr_push_flags_fn_t</span><span class="p">)</span><span class="n">ndr_push_GUID</span><span class="p">);</span>
        <span class="n">ldb_dn_set_extended_component</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s2">&quot;GUID&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">guid_blob</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">sid_blob</span> <span class="o">=</span> <span class="n">ldb_msg_find_ldb_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_msg</span><span class="p">,</span> <span class="s2">&quot;objectSID&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sid_blob</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ldb_dn_set_extended_component</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s2">&quot;SID&quot;</span><span class="p">,</span> <span class="n">sid_blob</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="patches">
<h1>Patches<a class="headerlink" href="#patches" title="Permalink to this heading">¶</a></h1>
<p>The following patch has been applied into the source repository:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://gitweb.samba.org/?p=samba.git;a=commit;h=1fc19ee7d0021e963923911bb440463aa79184fc">s4:dsdb - Fixed attribute dereferencing for 389
DS</a></p></li>
</ul>
</section>
<section id="references">
<h1>References<a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="http://www.openldap.org/devel/cvsweb.cgi/~checkout~/doc/drafts/draft-masarati-ldap-deref-xx.txt">LDAP Dereference
Control</a></p></li>
</ul>
<p><a class="reference external" href="Category:Obsolete">Category:Obsolete</a></p>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/freeipa-logo-small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, FreeIPA Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.0.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/archive/pages/Samba_4_Attribute_Dereferencing.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>